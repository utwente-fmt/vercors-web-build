
<!DOCTYPE HTML>
<!--
VerCors Tool --- Formal Methods and Tools Group (EWI)
University of Twente, Enschede, The Netherlands
-->
<html lang="en">
    <head>
        <title>Tutorial Â· VerCors Tool FMT | UTwente </title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <meta name="description" content="">
        <meta name="keywords" content="">

        <link rel="stylesheet" href="/css/codemirror.css">
        <link rel="stylesheet" href="/css/codemirror-monokai.css">
        <link rel="stylesheet" href="/css/highlight/default.css">
        <link rel="stylesheet" href="/css/datatables.min.css">
        <link rel="stylesheet" href="/css/style.css">

        <script src="/js/jquery.min.js"></script>
        <script src="/js/highlight.pack.js"></script>
        <script src="/js/codemirror.js"></script>
        <script src="/js/datatables.min.js"></script>
        <script src="/js/vercorsonline.js"></script>
        <script src="/js/init.js"></script>

        <!--<script type="text/javascript">
            hljs.initHighlightingOnLoad();
        </script>-->
    </head>
    <body class="no-sidebar">
        <div id="header">
            <h1 id="logo" style="position: relative">
                <span id="hamburger" onclick="document.querySelector('#nav').classList.toggle('open')" class="fa fa-bars"></span>
                <a href="/">The VerCors Verifier</a>
            </h1>
            <nav id="nav">
                <ul>
                    <li>
                        <a href="/wiki/#introduction">Getting Started</a>
                        <ul>
                            <li><a href="/wiki/#introduction">Introduction</a></li>
                            <li><a href="/wiki/#installing-and-running-vercors">Installation Guide</a></li>
                            <li><a href="/wiki/">Tutorial</a></li>
                            <li>
                                <a href="//github.com/utwente-fmt/vercors/issues" target="_blank">
                                    Issue Tracker
                                    <span class="fa fa-external-link" style="font-size: 10pt"></span>
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li><a href="/try_online/examples/">Showcases</a></li>
                    <li><a href="/news/">News</a></li>
                    <li><a href="/publications/">Publications</a></li>
                    <li>
                        <a href="/about/">About</a>
                        <ul>
                            <li><a href="/about/#Team">VerCors Team</a></li>
                            <li><a href="/about/#Contact">Contact</a></li>
                            <li><a href="/about/#Credits">Credits</a></li>
                            <li><a href="/license/">License</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
            <div class="container">
                <div id="banner">
                    <div class="container">
                        <section>
                            
                            <p>
                                <a href="//github.com/utwente-fmt/vercors" class="button alt" target="_blank">
                                    View on Github
                                </a>
                                <a href="/try_online/" class="button alt">Try VerCors Online</a>
                            </p>
                        </section>
                    </div>
                </div>
            </div>
        </div>

        
<div id="main" class="style1 wrapper">
    <div class="container">
        
<div class="row" style="width: 100%; vertical-align: top">
    <span style="width: 75%; display: inline-block" id="wiki-content">
        
<h1 id="introduction">Introduction</h1>
<p><strong>Welcome</strong> to the VerCors tutorial! In this tutorial, we will look at what VerCors is, what it can do, and how <em>you</em> can use it.</p>
<p>VerCors is a toolset for software verification. It can be used to reason about programs written in Java, C, OpenCL and PVL, which is a <em>Prototypal Verification Language</em> that is developed alongside VerCors and often used to demonstrate and test the capabilities of VerCors.</p>
<p>In this tutorial, we will first take a brief look at where VerCors fits into the bigger picture of software verification. As this is only a brief look, we recommend users that are unfamiliar with software verification to take a look at the chapter <a href="../Background">"Background"</a> that gives more information on software verification and some of the terms used below. Then, we will discuss the syntax of <a href="https://github.com/utwente-fmt/vercors/wiki/Prototypal-Verification-Language">PVL</a> and <a href="https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax">Specifications in VerCors</a>. Once we have a basic idea of how things work, we look at several more advanced concepts, either of VerCors (e.g. <a href="https://github.com/utwente-fmt/vercors/wiki/Resources-and-Predicates">resources</a>) or of the input languages (e.g. <a href="https://github.com/utwente-fmt/vercors/wiki/Inheritance">inheritance</a>). You can find an overview of the chapters on the right.</p>
<h2 id="vercors">VerCors</h2>
<p>VerCors is a verification tool that uses <em>static analysis</em> to prove <em>partial correctness</em> of a given piece of code. It requires users (e.g. software developers) to add <em>annotations in the code</em>, which specify the expected behaviour. The chapter <a href="https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax">"Specification Syntax"</a> of this tutorial describes the syntax for these annotations. VerCors particularly targets parallel and concurrent programs, using the permission-based <em>Concurrent Separation Logic (CSL)</em> as its logical foundation. CSL is a program logic that has a very strong notion of <em>ownership</em> in the form of <em>(fractional) permissions</em>: A thread can only read from, or write to, shared memory if it owns enough permission to do so. An advantage of concurrent separation logic is that, due to the explicit handling of ownership, we get properties like data-race freedom and memory safety for free; these properties are consequences of the soundness argument of the logic. A disadvange is that it causes significant overhead to always deal with permissions explicitly. Therefore, if you only wish to verify sequential algorithms, it may be worthwhile to look at alternative tools such as <a href="http://www.openjml.org/">OpenJML</a> and <a href="https://www.key-project.org/">KeY</a>, which do not use CSL as their logical foundation. For more info on CSL, ownership and permissions, see the chapter <a href="https://github.com/utwente-fmt/vercors/wiki/Permissions">"Permissions"</a>.</p>
<p>VerCors' analysis is <em>modular</em>, proving each method in isolation: Each method has a contract specifying the pre-conditions that must be met before calling the method, and the post-conditions that are certain when the method call finishes. Analysis of a method body happens solely based on the contract, not considering any actual calling environments.</p>
<p>While VerCors currently supports Java, C (incl. OpenMP), OpenCL and PVL, it is designed to be extensible, in the sense that support for other input languages with parallel and concurrent language constructs (for example C#) can be added without much difficulty. For that, the aim for VerCors is to allow reasoning over many different general concurrency structures, like statically-scoped concurrency (e.g. GPU kernels), dynamically-scoped concurrency (e.g. fork/join parallelism), and automated parallelism (e.g. programs that are automatically parallelised using OpenMP).</p>
<p>Note that VerCors checks for <em>partial correctness</em>, meaning that if the program terminates, then it satisfies its post-conditions. No proof is attempted to check whether the program actually terminates.</p>
<p>It is worth noting that VerCors is not the only tool that can perform static verification on annotated programs; there are actually many tools that can do a very similar job. Examples of such tools are: <a href="http://research.microsoft.com/dafny">Dafny</a>, <a href="http://www.openjml.org/">OpenJML</a>, <a href="https://www.key-project.org/">KeY</a>, <a href="https://github.com/verifast/verifast">VeriFast</a>, and <a href="https://research.microsoft.com/vcc">VCC</a>. However, VerCors distinguishes itself by focussing on <em>different parallel and concurrent language constructs</em> (e.g. Dafny, OpenJML, and KeY only allow verifying sequential programs) of <em>various high-level programming languages</em> (e.g. VCC only allows to verify C programs). Moreover, VerCors is not designed to be language-dependent, and instead focusses on verification techniques for <em>general</em> concurrency patterns.</p>
<p>Internally, VerCors uses the <a href="https://www.pm.inf.ethz.ch/research/viper.html">Viper backend</a>, which in turn uses the SMT solver <a href="https://github.com/Z3Prover/z3">Z3</a>. <img src="https://vercors.ewi.utwente.nl/images/vct-arch-narrow_edit.png" alt="VerCors architecture" /></p>
<h1 id="background">Background</h1>
<p>In this chapter, we explain some of the terms related to VerCors, for example <em>static analysis</em>. If you are already an experienced user of software verification tools, feel free to skip it. If you are new to the topic, we recommend reading this chapter to better understand the other chapters.</p>
<h2 id="software-verification">Software Verification</h2>
<p>Nowadays, we as a society rely heavily on software, and software errors can have a major impact, even causing deaths. Thus, software developers strive to reduce the number of software errors as much as possible. <em>Software verification</em> is the task of reasoning about the behaviour of the software, in order to ensure that it behaves correctly. The most basic case could be considered to be the compiler, which checks that the program e.g. does not misspell a name. Only if the compiler does not find any errors, then the program can be executed. However, many errors that are more intricate can slip past the compiler. To catch these, there are two possibilities: <em>Static analysis</em> and <em>dynamic analysis</em>. Dynamic analysis runs the program and watches its behaviour. One example is testing, where you provide the software with a concrete input, let it compute an output and check that it is the expected one. While this can show errors, it cannot guarantee the absence of errors: Maybe it only works for this specific input, and even that only in non-leap years. <em>Static analysis</em> looks at the source code itself, and can thus reason in more general terms. The compiler is part of this category, and so is VerCors.</p>
<p>Different tools provide different levels of analysis. As an example, let's take a division by zero, which is not allowed in mathematics and would cause the software to misbehave. In the most simple case, we could search for expressions like <code>1/0</code>, which we recognise as bad immediately. But what about <code>1/x</code>? Maybe <code>x</code> is zero, maybe not. Some tools will check the program to find all possible values that <code>x</code> can take. But this is often difficult to decide, and the tools often approximate (e.g. instead of saying "-1, 1 or 2", they say "the interval [-1,2]", thereby also including the value 0 even though it cannot occur in reality). This can lead to false results, e.g. complaining about programs that are actually correct. Other tools require the user (meaning the software developer) to specify which values <code>x</code> can take. This requires much more effort by the user, who has to <em>annotate</em> the code, i.e. provide additional information inside the program that is not needed to run the program, but only for analysing it. As a reward for the additional effort, the user can get more accurate results. VerCors follows this approach, requiring the user to provide specifications as annotations. The chapter <a href="https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax">"Specification Syntax"</a> of this tutorial describes the syntax for these annotations.</p>
<p>Annotations can have different purposes, and two are particularly relevant: <em>Assertions</em> or <em>proof obligations</em> are properties the user wants to be proven, for instance that a function computes the correct value. <em>Assumptions</em> provide the tool with additional knowledge to help its proof; the tool takes them as given facts and does <em>not</em> prove them. A common example are method pre-conditions, where the user specifies the context in which the method is called. That way, when analysing the method itself, the tool can reason more accurately e.g. about the values of input parameters. However, that means that the analysis results is only applicable if the respective assumptions are met. So users (particularly new users) should pay attention what facts were actually proven, and what was assumed, and be aware under which conditions the analysis result holds.</p>
<p>As an example, consider the following code:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb1-1" title="1"><span class="dt">int</span> <span class="fu">foo</span>(<span class="dt">int</span> arg) {</a>
<a class="sourceLine" id="cb1-2" title="2">  <span class="kw">return</span> <span class="dv">10</span>/arg;</a>
<a class="sourceLine" id="cb1-3" title="3">}</a></code></pre></div>
<p>If we <em>assume</em> that the method is only invoked with arguments <code>arg&gt;0</code>, then we can <em>assert</em> (or <em>prove</em>) that no division by zero occurs, and even that the result is between 0 and 10. Note that if the assumption is unsatisfiable (e.g. two contradictory conditions, or a simple <code>false</code>), then we can derive any boolean statement, because the implication "if assumption then statement" is trivially true. Thus, users must be careful in their choice of assumptions.</p>
<h2 id="separation-logic">Separation Logic</h2>
<p>VerCors particularly targets parallel and concurrent programs, as they are more difficult to understand intuitively and thus are more error-prone than sequential programs. One typical example is two parts of the program accessing the same memory location at the same time. This can lead to the unintuitive fact that, right after one thread wrote a value to a variable, that variable might already have an entirely different value due to the other thread jumping in between and changing it. To avoid one thread invalidating the properties and invariants maintained and observed by the other threads, VerCors uses <em>Permission-Based Separation Logic (PBSL)</em> as its logical foundation. PBSL is a program logic that has a very strong notion of <em>ownership</em> in the form of <em>(fractional) permissions</em>: A thread can only read from, or write to, shared memory if it owns enough permission to do so. So just because a variable is on the heap, shared and technically accessible by everyone, that does not mean that just anyone can go ahead and use it; they need to coordinate with the others by getting permission first. The specification language of VerCors has constructs to deal with ownership and permissions (see the chapter <a href="https://github.com/utwente-fmt/vercors/wiki/Permissions">"Permissions"</a>). An advantage of this approach is that, due to the explicit handling of ownership, we get properties like data-race freedom and memory safety for free; these properties are consequences of the soundness argument of the logic. You will notice that the handling of permissions makes up a significant part of the verification effort, and <em>"Insufficient Permissions"</em> is a frequent complaint by VerCors in the beginning. And while VerCors can be used to analyse sequential programs, it always requires this overhead of managing permissions. Therefore, if you only wish to verify sequential algorithms, it may be worthwhile to look at alternative tools such as <a href="http://www.openjml.org/">OpenJML</a> and <a href="https://www.key-project.org/">KeY</a>, which do not use PBSL as their logical foundation.</p>
<h1 id="installing-and-running-vercors">Installing and Running VerCors</h1>
<p>The installation and running instructions can be found on the <a href="https://github.com/utwente-fmt/vercors">Github homepage</a> of this project.</p>
<h2 id="syntax-highlighting">Syntax highlighting</h2>
<p>When writing a program in PVL, the Prototypal Verification Language of VerCors, syntax highlighting can be obtained in the following way:</p>
<p>VerCors provides syntax highlighting support for PVL in <a href="https://macromates.com/download">TextMate 2</a> (MacOS X) and <a href="https://www.sublimetext.com">Sublime Text</a> (Linux and Windows) as a TextMate Bundle. The bundle is located at <code>./util/VercorsPVL.tmbundle</code>. On MacOS X for TextMate 2 you can simply double click the <code>.tmbundle</code> file to install it. Sublime Text requires you to copy the bundle content to some directory:</p>
<ol>
<li>In Sublime Text, click on the <code>Preferences &gt; Browse Packagesâ¦</code> menu.</li>
<li>Create a new directory and name it <code>VercorsPVL</code>.</li>
<li>Move the contents of <code>VercorsPVL.tmbundle</code> (that is, the <code>./Syntaxes</code> directory) into the directory you just created.</li>
<li>Restart Sublime Text.</li>
</ol>
<p><a href="https://code.visualstudio.com">Visual Studio Code</a> (VS Code) also has support for TextMate bundles to do syntax highlighting (VS Code runs on Windows, Linux and OSX). Click <a href="https://code.visualstudio.com/docs/extensions/themes-snippets-colorizers">here</a> for instructions on how to install this (this has not been tested however).</p>
<h1 id="prototypical-verification-language">Prototypical Verification Language</h1>
<p>This page discusses the language features of PVL, the Prototypal Verification Language of VerCors. The language is similar to Java, so it has classes, methods, etc. It doesn't have modifiers like public and private. This language is used for research too, so some special constructs like the <a href="https://github.com/utwente-fmt/vercors/wiki/Tutorial-Parallel-Blocks">par-block</a> have been added to it. This section elaborates on the basic language features of PVL. The more advanced features are described in later sections. A complete reference overview of the PVL language and specification syntax can be found <a href="https://github.com/utwente-fmt/vercors/wiki/PVL-Syntax-Reference">here</a>.</p>
<h3 id="basic-types-and-expressions">Basic types and expressions</h3>
<p>Currently, VerCors supports the types <code>int</code>, <code>boolean</code>, and <code>void</code> (for return types of methods). Identifiers, e.g. variables and method names, can consist of the characters a-z, A-Z, 0-9 and _. However, they must start with a letter (a-z, A-Z). The following words are reserved and can therefore not be used as identifiers:</p>
<p><code>create, action, destroy, send, recv, use, open, close, atomic, from, merge, split, process, apply, label, \result, write, read, none, empty, current_thread</code></p>
<p>Standard operators can be used to form expressions from values and variables of type <code>int</code> or <code>boolean</code>:</p>
<ul>
<li>boolean operators: <code>&amp;&amp;, ||, !, ==&gt;, ==, !=, &lt;, &lt;=, &gt;, &gt;=</code></li>
<li>arithmetic operators: <code>+, -, *, /, ++, --</code></li>
<li>if-then-else expression: <code>b ? e1 : e2</code> where <code>b</code> is a boolean expressions, and <code>e1</code> and <code>e2</code> are expressions of the same type</li>
</ul>
<p>Other expressions:</p>
<ul>
<li>Create new object: <code>new T(...)</code> where <code>T(...)</code> is defined by the constructor of class <code>T</code></li>
<li>Create an array: <code>new T[i]</code> where <code>T</code> is a type (so <code>int</code>, <code>boolean</code>, or a class <code>T</code>) and <code>i</code> a non-negative integer.</li>
</ul>
<h3 id="classes-fields-methods">Classes, fields, methods</h3>
<p>A program consists of one of more classes. Classes have a name, zero or more fields, zero or more constructors, and zero or more methods. Below we show a small example class:</p>
<pre><code>class MyForest {
    int nrTrees;
    
    MyForest(int nr) {
        nrTrees = nr;
    }

    void plantTrees(int nr) {
        nrTrees = nrTrees + nr;
    }
}
</code></pre>
<p>The keyword <code>this</code> can be used to refer to the current object. The modifier <code>static</code> can be added to methods that do not change any fields or call any non-static methods.</p>
<h3 id="control-flow-return-if-while-for">Control flow: return, if, while, for</h3>
<p>A method body consists of statements. The basic statements of PVL are:</p>
<ul>
<li>assignment: <code>x = e;</code> where <code>x</code> is a variable and <code>e</code> an expression.</li>
<li>return: <code>return e;</code>, where e is an expression of the type of the method</li>
<li>if-statement: <code>if (b) then { s1 }</code> or <code>if (b) then { s1 } else { s2 }</code>, where <code>b</code> is a boolean expression and <code>s1</code> and <code>s2</code> are (sequences of) statements.</li>
<li>while-loop: <code>while (b) { s1 }</code>, where <code>b</code> is a boolean expression and <code>s1</code> a (sequence of) statement.</li>
<li>for-loop: <code>for(int i = e1; b; e2)</code>, where <code>i</code> is an identifier <code>e1</code> is an integer expression, <code>b</code> a boolean about <code>i</code> and <code>e2</code> an update of <code>i</code>.</li>
<li>comments: single line comments <code>// put a comment here</code>, or multiline comments <code>/* put a comment here */</code>.</li>
</ul>
<p>Below we show a method using these constructs:</p>
<pre><code>int myExampleMethod(int nr) {
    nr = nr + 3;
    if(nr &gt; 10) { /* here is a multi-line comment
                     in the if-branch */
        nr = nr-3;
        for(int i = 0; i &lt; 2 &amp;&amp; nr &gt; 5; i++) {
            nr = nr/2;
        }
    } else { //we subtract a bit
        while (nr &gt; 2) {
            nr--;
        }
    }
    return nr + 5;
}
</code></pre>
<h1 id="specification-syntax">Specification Syntax</h1>
<p><em>This section describes the syntax of the specification language, which is independent of the target language. Thus, unless otherwise stated, all features are supported for all input languages.</em></p>
<p>In this part of the tutorial, we will take a look at how specifications are expressed in VerCors. While this tutorial provides more detailed explanations of the various constructs, a concise list can be found in the <a href="https://github.com/utwente-fmt/vercors/wiki/PVL-Syntax-Reference">PVL Syntax Reference</a> in the annex. The specification language is similar to <a href="http://www.eecs.ucf.edu/~leavens/JML/index.shtml">JML</a>.</p>
<p>Depending on the input language, specification are embedded into the target code in two different ways: In most languages, such as Java and C, the specifications are provided in special comments. These special comments are either line comments starting with <code>//@</code>, or block comments wrapped in <code>/*@</code> and <code>@*/</code>. Since these are simply a kind of comment, regular compilers ignore them and can still compile the program. However, the <code>@</code> signals VerCors to interpret them as annotations. Note that this style of comment comes from JML, so VerCors is not the only tool using them. However, the exact interpretation of the comments may vary between tools, so a valid specification in VerCors may not be recognised by another tool and vice versa.</p>
<p>As an example, a method pre-condition (see following section) can look like this:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ requires x&gt;0;
public int increment(int x) { /* ... */ }

/*@
requires x&gt;0;
requires y&gt;0;
@*/
public int add(int x, int y) { /* ... */ }
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-1
//:: verdict Pass
//:: tools silicon
final class Test {
    //@ requires x&gt;0;
    public int increment(int x) { /* ... */ }
    
    /*@
    requires x&gt;0;
    requires y&gt;0;
    @*/
    public int add(int x, int y) { /* ... */ }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p><strong>Tip</strong> Always remember to place the <code>@</code>! It can be aggravating to spend significant time debugging, just to realise that parts of the specification were put in regular comments and ignored by the tool.</p>
<p>For PVL, the specifications are inserted directly into the code, <em>without</em> the special comments around them:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">requires x&gt;0;
int increment(int x) { /* ... */ }

requires x&gt;0;
requires y&gt;0;
int add(int x, int y) { /* ... */ }
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-2
//:: verdict Pass
//:: tools silicon
class Test {
    requires x&gt;0;
    int increment(int x) { /* ... */ }
    
    requires x&gt;0;
    requires y&gt;0;
    int add(int x, int y) { /* ... */ }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Given that the syntax is otherwise identical, we will use the commented version in the rest of the tutorial, to make the separation between specifications and target code more obvious. The examples in this chapter are in Java, but you can find the respective examples in other languages on the <a href="https://vercors.ewi.utwente.nl/try_online/examples?ExampleSearch%5Bid%5D=&amp;ExampleSearch%5Btitle%5D=&amp;ExampleSearch%5Bfeature%5D=&amp;ExampleSearch%5Bsource%5D=1&amp;ExampleSearch%5Blanguagename%5D=">website</a> (as well as a Java file of all the examples below).</p>
<p>Most annotation constructs have to end with a semicolon.</p>
<p>In principle, we can distinguish two kinds of annotations: Specifications in the form of <em>method contracts</em> that specify the observable behaviour of the respective method; and <em>auxiliary annotations</em> that guide the prover towards its goal and are for example used inside a method's body, or to define helper functions. We will first look at the former, then at the latter, and conclude with a description of the kind of expressions that VerCors supports (e.g. boolean connectives). For the earlier parts, it suffices to know that expressions in VerCors specifications are an extension of whatever expressions the target language supports.</p>
<h2 id="method-contracts">Method Contracts</h2>
<p>Method contracts specify the behaviour of the method that is visible to the calling environment, by means of pre-conditions and post-conditions. <em>Pre-conditions</em> use the keyword <code>requires</code> and restrict the situations in which the method can be invoked, e.g. restricting parameters to be non-null. <em>Post-conditions</em> use the keyword <code>ensures</code> and describe the behaviour of the method by defining the program state after the call finishes. The method contract is placed above the method header, and these keywords can only be used in combination with a method header.</p>
<p>Two useful keywords to define the post-state (i.e. the state after the method finishes) are <code>\result</code> to refer to the return value of the (non-void) method, and <code>\old(expr)</code> to refer to the value of <code>expr</code> <em>before</em> the method's execution.</p>
<!-- test -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Test {
  /*@
  requires x &gt;= 0;
  requires y &gt;= 0;
  ensures \result == x+y;
  ensures \result &gt;= 0;
  @*/
  public int add(int x, int y) {
    return x+y;
  }

  /*@
  requires xs != null;
  ensures \result != null;
  ensures \result.length == \old(xs.length)+1;
  ensures \result.length &gt; 0;
  @*/
  public int[] append(int[] xs, int y) {
    int[] xsCopy = new int[xs.length + 1];
    /* ... */
    return xsCopy;
  }
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-method-contracts-1
//:: verdict Pass
//:: tools silicon
class Test {
  /*@
  requires x &gt;= 0;
  requires y &gt;= 0;
  ensures \result == x+y;
  ensures \result &gt;= 0;
  @*/
  public int add(int x, int y) {
    return x+y;
  }

  /*@
  requires xs != null;
  ensures \result != null;
  ensures \result.length == \old(xs.length)+1;
  ensures \result.length &gt; 0;
  @*/
  public int[] append(int[] xs, int y) {
    int[] xsCopy = new int[xs.length + 1];
    /* ... */
    return xsCopy;
  }
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Recall that VerCors analyses methods in isolation, purely based on their contract and independent from any actual calling contexts. It tries to prove that if the pre-condition is satisfied before the method body is executed, then the post-condition holds afterwards. In the example of the <code>add</code> method above, <em>if</em> the input parameters are non-negative, <em>then</em> the result is, too. Note that the pre-condition <code>x&gt;=0</code> is not actually required for executing the method body, but it is necessary to prove the post-condition. In contrast, in the example of <code>append</code>, the pre-condition <code>xs!=null</code> is actually needed for <code>\old(xs.length)</code> to be well-defined, and potentially to prove absence of null-pointer dereferences in the method body. Note that, to fully specify the correct behaviour of <code>append</code>, one would have to compare the values inside of <code>xs</code> and <code>\result</code>. Since these values are stored on the heap (and not on the stack like the reference <code>xs</code> itself), this would require access permissions, which will be introduced in the next chapter <a href="https://github.com/utwente-fmt/vercors/wiki/Permissions">"Permissions"</a>.</p>
<p><strong>Note</strong> Method contracts must not have side effects, so for example calls to (non-pure) methods are forbidden inside contracts. Pre- and post-conditions are processed in-order, so for example swapping the order of two pre-conditions could result in a failed verification (e.g. you need to specify that an integer variable is within range before you can use it as an array index in another pre-condition). Note that unsatisfiable pre-conditions (e.g. contradictory conditions, or simply <code>false</code>) can lead to unexpected results, because the implication "if pre-condition before, then post-condition after" becomes trivially true for any post-condition, and VerCors is able to prove any arbitrary statement.</p>
<p>Sometimes, the same expression is needed as a pre- and as a post-condition, for example the fact that a global variable is not null. In that case, the keyword <code>context</code> can be used as a short-hand notation: <code>context xs != null;</code> stands for <code>requires xs!=null; ensures xs!=null;</code>. An even further reaching short-hand is <code>context_everywhere expr;</code>, which adds <code>expr</code> as a pre- and as a post-condition, as well as a loop invariant for all loops inside the method body (see below).</p>
<h2 id="auxiliary-annotations">Auxiliary Annotations</h2>
<p>When method bodies become more complicated than the toy examples above, it becomes more difficult for VerCors to prove by itself that the post-conditions hold after executing the method, and additional annotations are needed inside the method body to guide the verification. These can take the form of loop invariants, assumptions and assertions, or ghost code. Ghost code can also occur outside of methods, for instance to define helper functions.</p>
<h3 id="loop-invariants">Loop Invariants</h3>
<p>Loop invariants are similar to the <code>context</code> in a method contracts, but for loops: They specify expressions that must hold before entering the loop (like a pre-condition), as well as after each loop iteration, incl. the last iteration (like a post-condition). Loop invariants use the keyword <code>loop_invariant</code> and are placed above the loop header:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ requires a&gt;0 &amp;&amp; b&gt;0;
//@ ensures \result == a*b;
public int mult(int a, int b) {
  int res = 0;
  //@ loop_invariant res == i*a;
  //@ loop_invariant i &lt;= b;
  for (int i=0; i&lt;b; i++) {
    res = res + a;
  }
  return res;
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-loop-invariants-1
//:: verdict Pass
//:: tools silicon
final class Test {
    //@ requires a&gt;0 &amp;&amp; b&gt;0;
    //@ ensures \result == a*b;
    public int mult(int a, int b) {
      int res = 0;
      //@ loop_invariant res == i*a;
      //@ loop_invariant i &lt;= b;
      for (int i=0; i&lt;b; i++) {
        res = res + a;
      }
      return res;
    }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Let us examine why this program verifies (you can skip this paragraph if you are familiar with software verification and loop invariants): The first loop invariant holds before we start the loop, because we initialise both <code>i</code> and <code>res</code> to zero, and <code>0 == 0*a</code> is true. Then in each iteration, we increase <code>i</code> by one and <code>res</code> by <code>a</code>, so if <code>res == i*a</code> held before the iteration, then it will also hold afterwards. Looking at the second invariant, we see that it holds before the loop execution because <code>i</code> is initialised to zero and <code>b</code> is required to be greater than zero. To understand why the invariant holds after each iteration, we also have to consider the loop condition, <code>i&lt;b</code>. This condition has to be true at the beginning of the iteration, otherwise the loop would have stopped iterating. Since <code>i</code> and <code>b</code> are integers and <code>i&lt;b</code> at the beginning of the iteration, an increment of <code>i</code> by one during the iteration will ensure that at the end of the iteration, <code>i&lt;=b</code> still holds. Note that if <code>i</code> or <code>b</code> were floating point numbers, <code>i</code> might have gone from <code>b-0.5</code> to <code>b+0.5</code>, and we would not have been able to assert the loop invariant. Likewise, any increment by more than one could step over <code>b</code>. Only the combination of all these factors lets us assert the invariant at the end of the loop iteration. When the loop stops iterating, we know three things: Each of the two loop invariants holds, and the loop condition does no longer hold (otherwise we would still be iterating). Note that the combination of the second loop invariant and the negated loop condition, <code>i&lt;=b &amp;&amp; !(i&lt;b)</code>, ensures that <code>i==b</code>. Combining that with the first invariant ensures the post-condition of the method.</p>
<p>Remember that VerCors checks for partial correctness, so there is no check whether the loop actually stops iterating at some point. It just asserts that <em>if</em> the loop stops, then the post-condition holds.</p>
<p>As mentioned above, <code>context_everywhere expr;</code> in the method contract will implicitly add <code>expr</code> as a loop invariant to <em>all</em> loops in the method body. This can be useful for expressions that hold for the entirety of the method, e.g. in the case of <code>xs!=null</code>; but it can also be a subtle cause for errors if it adds invariants to a loop that were not intended there (especially in the case of multiple loops). For example, a method to insert an element into a sorted array may add the new value at the end, and then step by step restore the ordering of the array; in that case, adding a sortedness property as <code>context_everywhere</code> would not verify.</p>
<h3 id="assumptions-and-assertions">Assumptions and Assertions</h3>
<p>Sometimes, VerCors has trouble deriving a post-condition from the given code and established facts (like pre-conditions), and it requires explicitly specifying an intermediate step to guide the verification. VerCors first proves these intermediate steps, and then can use them to derive the desired facts. This can be done with the keyword <code>assert</code>:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ ensures a==0 ? \result == 0 : \result &gt;= 10;
public int mult10(int a) {
  int res = a;
  if (res &lt; 0) {
    res = 0-res;
  }
  //@ assert res &gt;= 0;
  return 10*res;
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-assumptions-and-assertions-1
//:: verdict Pass
//:: tools silicon
final class Test {
    //@ ensures a==0 ? \result == 0 : \result &gt;= 10;
    public int mult10(int a) {
      int res = a;
      if (res &lt; 0) {
        res = 0-res;
      }
      //@ assert res &gt;= 0;
      return 10*res;
    }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>(Note that VerCors would be able to verify this example even without the assertion, but this demonstrates how to use <code>assert</code>.)</p>
<p><strong>Tip</strong> Assertions can also be useful for debugging: If VerCors fails to prove the post-condition, adding <code>assert</code> statements throughout the method body can help to pinpoint where the verification fails, either because of a shortcoming of VerCors or because of an actual error in the code. Additionally, <code>assert false;</code> should always fail, so if the verification does not seem to terminate, adding such statements throughout the method can show where VerCors gets stuck. Finally, remember that a contradiction e.g. in the pre-conditions can imply anything; even <code>false</code>. So <code>assert false;</code> can be used to check that no such contradiction occurred: If it verifies, something went seriously wrong.</p>
<p>While assertions add additional proof obligations, <em>assumptions</em> introduce additional facts that VerCors just takes for granted afterwards, similar to pre-conditions. This is done via the keyword <code>assume</code>. This can be dangerous if the assumptions contradict the actual state of the program:</p>
<!-- testBlock -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">int x = 2;
//@ assume x == 1;
int y = x + 3;
//@ assert y == 4;
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-assumptions-and-assertions-2
//:: verdict Pass
//:: tools silicon
final class Test {
    void test() {
        int x = 2;
        //@ assume x == 1;
        int y = x + 3;
        //@ assert y == 4;
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>This snippet verifies, even though the actual value of <code>y</code> at the end is 5. However, based on the (wrong) assumptions that <code>x==1</code> on Line 2, the assertion holds. Therefore, <strong>assumptions should be used with caution!</strong></p>
<p>Nevertheless, assumptions can be useful, e.g. for debugging purposes. Also, while still being in the process of verifying the code, it can be useful to assume certain basic facts to prove the bigger picture, and then drill deeper and prove that the assumed facts actually hold.</p>
<p>VerCors also supports a <code>refute</code> statement, which is the opposite of <code>assert</code>. Internally, <code>refute expr;</code> is transformed into <code>assert !(expr);</code>, i.e. asserting the negation. Note that a failing <code>assert expr;</code> is not equivalent to a successful <code>refute expr;</code>. For example, if we know nothing about the value of a variable <code>a</code>, then both <code>assert a&gt;0;</code> and <code>refute a&gt;0;</code> will fail, as <code>a</code> <em>could</em> be greater than zero, but it also could be less.</p>
<h3 id="ghost-code">Ghost Code</h3>
<p>Recall that annotations must never have side-effects on the program state, otherwise the results of methods would be different between VerCors (which takes the annotations into account) and the compiler (which treats them as comments). However, it can be useful to extend the program state, for example introducing additional helper variables to keep track of intermediate results. This helper code, which only exists for the purpose of verification, is called <em>ghost code</em>, and the respective variables form the <em>ghost state</em>.</p>
<p>Ghost code can occur inside method bodies, but also outside, for instance as global ghost variables. In principle, ghost code can be any construct that the target language supports; for example when verifying Java programs, you could define ghost classes, and in C programs, you may use pointers in ghost code. Additionally, the ghost code can use the extensions that the specification language adds to the target language, such as the new type <code>seq&lt;T&gt;</code> (see section "Expressions" below).</p>
<p>Keep in mind that ghost code does not exist for the compiler, so it cannot have side effects on the program state, and "real" code cannot refer e.g. to ghost variables. However, it is possible to read from "regular" variables (e.g. to create a ghost variable with the same value).</p>
<p>When using constructs from the target language (such as variable declarations), the keyword <code>ghost</code> is required before the use of the construct.</p>
<p>Here is an example for ghost code inside a method:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
  requires x&gt;=0 &amp;&amp; y&gt;=0;
  ensures \result == (x&lt;y ? 5*x : 5*y);
@*/
public int minTimes5(int x, int y) {
  //@ ghost int min = (x&lt;y ? x : y);
  int res = 0;
  //@ loop_invariant i&lt;=5;
  //@ loop_invariant res == i*min;
  //@ loop_invariant min&lt;=x &amp;&amp; min&lt;=y &amp;&amp; (min==x || min==y); 
  for (int i=0; i&lt;5; i++) {
    if (x&lt;y) {
      res = res + x;
    } else {
      res = res + y;
    }
  }
  /*@ 
  ghost if (x&lt;y) {
    assert res == 5*x;
  } else {
    assert res == 5*y;
  }
  @*/
  return res;
}

<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-ghost-code-1
//:: verdict Pass
//:: tools silicon
final class Test {
    /*@
      requires x&gt;=0 &amp;&amp; y&gt;=0;
      ensures \result == (x&lt;y ? 5*x : 5*y);
    @*/
    public int minTimes5(int x, int y) {
      //@ ghost int min = (x&lt;y ? x : y);
      int res = 0;
      //@ loop_invariant i&lt;=5;
      //@ loop_invariant res == i*min;
      //@ loop_invariant min&lt;=x &amp;&amp; min&lt;=y &amp;&amp; (min==x || min==y); 
      for (int i=0; i&lt;5; i++) {
        if (x&lt;y) {
          res = res + x;
        } else {
          res = res + y;
        }
      }
      /*@ 
      ghost if (x&lt;y) {
        assert res == 5*x;
      } else {
        assert res == 5*y;
      }
      @*/
      return res;
    }
    
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Note the definition of a ghost variable <code>min</code> at the beginning of the method, and the ghost <code>if</code> statement at its end.</p>
<h4 id="ghost-methods-and-functions">Ghost Methods and Functions</h4>
<p>You can use ghost code not only within methods but also to declare entire ghost methods:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
requires x &gt; 0;
ensures \result == (cond ? x+y : x);
ghost static int cond_add(bool cond, int x, int y) {
  if (cond) {
    return x+y;
  } else {
    return x;
  }
}
@*/

//@ requires val1 &gt; 0 &amp;&amp; val2&gt;0 &amp;&amp; z==val1+val2;
void some_method(int val1, int val2, int z) {
  //@ ghost int z2 = cond_add(val2&gt;0, val1, val2);
  //@ assert z == z2;
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-ghost-code-ghost-methods-and-functions-1
//:: verdict Pass
//:: tools silicon
final class Test {
    /*@
    requires x &gt; 0;
    ensures \result == (cond ? x+y : x);
    ghost static int cond_add(bool cond, int x, int y) {
      if (cond) {
        return x+y;
      } else {
        return x;
      }
    }
    @*/
    
    //@ requires val1 &gt; 0 &amp;&amp; val2&gt;0 &amp;&amp; z==val1+val2;
    void some_method(int val1, int val2, int z) {
      //@ ghost int z2 = cond_add(val2&gt;0, val1, val2);
      //@ assert z == z2;
    }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>The conditional addition <code>cond_add</code> is defined as a ghost method. Otherwise, it looks like any normal method, including having a method contract (in this case, just a single precondition). Note that the precondition is not wrapped in the special comment <code>//@</code>, like the precondition of <code>some_method</code> is, because the entire ghost method already is inside a special comment <code>/*@</code>. We then use this ghost method in the body of <code>some_method</code> (but only inside annotations!).</p>
<h5 id="pure-functions-and-methods">Pure Functions and Methods</h5>
<p><em>Pure functions</em> are, in a way, a special kind of ghost methods. They look like any method, but have an additional keyword <code>pure</code> in the method head and their body is a single expression following an <code>=</code>, rather than a block of statements:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
requires x &gt; 0;
static pure int cond_add(bool cond, int x, int y) 
  = cond ? x+y : x;
@*/
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-ghost-code-ghost-methods-and-functions-pure-functions-and-methods-1
//:: verdict Pass
//:: tools silicon
final class Test {
    /*@
    requires x &gt; 0;
    static pure int cond_add(bool cond, int x, int y) 
      = cond ? x+y : x;
    @*/
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Note that the <code>ghost</code> keyword is not used: It is only required when using a construct from the target language (e.g. <code>if</code>, variable declarations, etc), <em>not</em> for specification-internal constructs like defining a pure function. However, using a stand-alone call statement to call the function (e.g. invoke a lemma directly and not in an <code>assert</code>) still needs the <code>ghost</code> keyword, as method calls are constructs from the target language: <code>//@ ghost myLemma();</code>. The important distinction to normal methods, apart from the fact that they have just one expression, is that pure functions <em>must be without side-effects</em>, even on the ghost state. Thus, the body cannot contain for instance calls to non-pure methods.</p>
<p>Remember that in VerCors, only the contract of a method is used to reason about the behaviour of a method call, the actual behaviour of the method body is not taken into account at this point. For functions, this restriction is not as strict: For simple functions like the one above, VerCors actually uses the "real" behaviour of the function to analyse the behaviour of a call to that function. Thus, the behaviour does not need to be specified explicitly in a post-condition, like it does for other methods. However, this only works for simple functions, and for example a recursive function may still need a post-condition specifying its behaviour.</p>
<p>You can also add the <code>pure</code> keyword to a "real" method. This indicates that the method does not have side-effects, and can therefore be used e.g. in method contracts, while still being accessible by the "real" code. However, for a method to be pure, it has to be actually without side-effects, therefore only a limited number of constructs are allowed in methods that are designated pure: <code>if</code> statements, return statements and variable declarations.</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
requires x &gt; 0;
@*/
static /*@ pure @*/ int cond_add(boolean cond, int x, int y) {
  if (cond) {
    return x+y;
  } else {
    return x;
  }
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-ghost-code-ghost-methods-and-functions-pure-functions-and-methods-2
//:: verdict Pass
//:: tools silicon
final class Test {
    /*@
    requires x &gt; 0;
    @*/
    static /*@ pure @*/ int cond_add(boolean cond, int x, int y) {
      if (cond) {
        return x+y;
      } else {
        return x;
      }
    }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h5 id="abstract-methods-and-functions">Abstract Methods and Functions</h5>
<p>Ghost functions and methods do not require a body. Sometimes, you are only interested in the assertions that a function or method gives in its post-condition, and do not care about the actual implementation. In such a case, you can omit the body, turning the method or function <em>abstract</em>. Given that method calls are usually reasoned about only based on the contract, the call site does not see a difference between an abstract method and a "real" method. However, this removes the assurance that it is actually possible to derive the post-condition from the pre-condition by some computation. Consider a post-condition <code>false</code>: The call site will simply assume that the method establishes its post-condition, and treat it as a known fact. Normally, verifying the method body will check that the post-condition is actually fulfilled; but for an abstract method, this check is missing. Since <code>false</code> implies everything, this can easily lead to unsoundness. Therefore, from the perspective of correctness, it is always better to have a body proving that the post-condition can actually be established based on the pre-condition.</p>
<p>However, making a method abstract relieves VerCors from the effort to check that the method body actually adheres to the contract. Therefore, it can be an interesting option to speed up the re-run of an analysis: Once you proved that a method can indeed derive its post-condition, you can turn the method abstract and focus on other parts of the code without checking this method every time you re-run the analysis.</p>
<p>Syntactically, an abstract method or function has a semicolon in place of its body:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ requires a&gt;0 &amp;&amp; b&gt;0;
//@ ensures \result == a*b;
public int mult(int a, int b);
// commented out body for the sake of speeding up the analysis:
//{
//  int res = 0;
//  // loop_invariant res == i*a;
//  // loop_invariant i &lt;= b;
//  for (int i=0; i&lt;b; i++) {
//    res += a;
//  }
//  return res;
//}

/*@
requires a&gt;0 &amp;&amp; b&gt;0;
ensures \result == a+b;
public pure int add(int a, int b);
@*/
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-ghost-code-ghost-methods-and-functions-abstract-methods-and-functions-1
//:: verdict Pass
//:: tools silicon
final class Test {
    //@ requires a&gt;0 &amp;&amp; b&gt;0;
    //@ ensures \result == a*b;
    public int mult(int a, int b);
    // commented out body for the sake of speeding up the analysis:
    //{
    //  int res = 0;
    //  // loop_invariant res == i*a;
    //  // loop_invariant i &lt;= b;
    //  for (int i=0; i&lt;b; i++) {
    //    res += a;
    //  }
    //  return res;
    //}
    
    /*@
    requires a&gt;0 &amp;&amp; b&gt;0;
    ensures \result == a+b;
    public pure int add(int a, int b);
    @*/
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Note that VerCors can also work with abstract methods that are not ghost methods (like <code>mult</code> in the example above), but your compiler may complain about missing method definitions.</p>
<h5 id="inline-functions">Inline Functions</h5>
<p>Inline functions are like macros in C: You can write an expression that occurs frequently in your code as a macro and then use it as if it were a function; but before verifying the program, VerCors replaces every call to the inline function with the function's body as if you had written out the body in place of the function call. Therefore, during the analysis, the "real" behaviour of the function is taken into account, rather than just the specification of the function's contract. However, inline functions are only possible if the body of the function is simple enough; for example a recursive function cannot be used in that way, otherwise there would be an infinite loop of replacing a function call with the body, which again contains a call. Inline functions are declared using the <code>inline</code> keyword.</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ pure inline int min(int x, int y) = (x&lt;y ? x : y);
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-ghost-code-ghost-methods-and-functions-inline-functions-1
//:: verdict Pass
//:: tools silicon
final class Test {
    //@ pure inline int min(int x, int y) = (x&lt;y ? x : y);
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Note that the <code>inline</code> keyword is also used for inline predicates (see chapter <a href="https://github.com/utwente-fmt/vercors/wiki/Predicates">"Predicates"</a>), which are a similar concept.</p>
<h4 id="ghost-parameters-and-results">Ghost Parameters and Results</h4>
<p>You can extend the header of an existing method, by adding additional parameters and return values to a method. This is done by using the <code>given</code> and <code>yields</code> keywords in the method contract, respectively. To assign and retrieve the values when calling the method, use <code>with</code> and <code>then</code>, respectively:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
given int x;
given int y;
yields int modified_x;
requires x &gt; 0;
ensures modified_x &gt; 0;
@*/
int some_method(boolean real_arg) {
  int res = 0;
  /* ... */
  //@ ghost modified_x = x + 1;
  /* ... */
  return res;
}

void other_method() {
  //@ ghost int some_ghost;
  int some_result = some_method(true) /*@ with {y=3; x=2;} then {some_ghost=modified_x;} @*/;
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-ghost-code-ghost-parameters-and-results-1
//:: verdict Pass
//:: tools silicon
final class Test {
    /*@
    given int x;
    given int y;
    yields int modified_x;
    requires x &gt; 0;
    ensures modified_x &gt; 0;
    @*/
    int some_method(boolean real_arg) {
      int res = 0;
      /* ... */
      //@ ghost modified_x = x + 1;
      /* ... */
      return res;
    }
    
    void other_method() {
      //@ ghost int some_ghost;
      int some_result = some_method(true) /*@ with {y=3; x=2;} then {some_ghost=modified_x;} @*/;
    }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>There are several points of interest in this example: Note that the pre- and post-condition of <code>some_method</code> can reference the ghost parameter and result just like normal parameters. However, as stated before, the method contract is processed in the order it is given, so the <code>given int x;</code> must appear before the <code>requires</code> that mentions <code>x</code>. If the ghost parameters and results are not just primitive integers, but heap objects, then permissions are needed to access them, just like with normal parameters and results (see <a href="https://github.com/utwente-fmt/vercors/wiki/Permissions">following chapter</a>). There is no explicit <code>return</code> statement for the ghost result; instead, the ghost result is whatever value the variable has when the method returns. Therefore, make sure when your method returns that you always have a defined value assigned to your ghost result variable! In <code>other_method</code>, the <code>with</code> keyword is followed by a block of statements that assign values to the ghost parameters. The parameters are named, so the assignment can be in any order, and need not adhere to the order in which the ghost parameters are defined. Make sure to assign a value to each ghost parameter! Otherwise, the method will be missing a parameter, just as if you called a method <code>void foo(int x)</code> as <code>foo();</code>. Similarly, the <code>then</code> keyword is followed by a block of statements that can use the ghost result, in particular storing their value in local variables. The respective local variable, <code>some_ghost</code>, must be a ghost variable, otherwise you would affect the "real" program state from inside an annotation. Both the <code>with</code> and the <code>then</code> are placed in a specification comment between the method call and the respective semicolon.</p>
<h3 id="expressions">Expressions</h3>
<p>As mentioned above, expressions in specifications are an extension of the expressions available in the target language. So if you analyse a Java program, you can use expressions like <code>a&amp;&amp;b</code> or <code>x==y+1</code> in the specifications just like in Java. However, specifications must be free of side-effects (on the program state) and for example calls to non-pure methods are not allowed.</p>
<p>VerCors extends the expressions of the target language by a few more features that you can use in specifications. One of them is the implication operator <code>==&gt;</code>, which works like you would expect from a logical implication. A common usage is <code>requires x!=null ==&gt; &lt;some statement about fields of x&gt;</code>. Note that the implication binds less than equality or conjunction, so <code>a==&gt;b&amp;&amp;c</code> is equivalent to <code>a==&gt;(b&amp;&amp;c)</code>. You need to explicitly use parentheses if the operators shall associate differently.</p>
<p>A related new operator is the single arrow <code>-&gt;</code>. It can be used as <code>expr-&gt;fun(args)</code>, which is a shorthand for <code>expr!=null ==&gt; expr.fun(args)</code>. One use-case, where this comes in handy, is when using predicates in the place of the function <code>fun</code> (see chapter <a href="https://github.com/utwente-fmt/vercors/wiki/Predicates">"Predicates"</a>).</p>
<p>Two other new operators are <code>**</code> and <code>-*</code> from separation logic. <code>**</code> is the separating conjunct, while <code>-*</code> is the separating implication (or "magic wand"). For more on this, see the chapters on <a href="https://github.com/utwente-fmt/vercors/wiki/Permissions">Permissions</a> and <a href="https://github.com/utwente-fmt/vercors/wiki/Magic-Wands">Magic Wands</a>.</p>
<p>The target language is also extended to include new data types. A simple case is the boolean type <code>bool</code>, which can be useful in specifications if the target language has no boolean type (e.g. old C). If the target language does support boolean (e.g. Java), this is not needed (but can be used nonetheless). More interestingly, the new types include generic axiomatic data types such as <code>set&lt;T&gt;</code> and <code>option&lt;T&gt;</code> (with <code>T</code> being a type). For more information on them and their supported operations (such as getting the size, and indexing elements), see the <a href="https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types">respective chapter</a>.</p>
<p>An important new type are fractions, <code>frac</code>. VerCors uses concurrent separation logic (CSL) to manage the ownership and permissions to access heap locations. A permission is a value from the interval [0,1], and the type <code>frac</code> represents such a value. To give a value to a variable of type <code>frac</code>, the new operator of <em>fractional division</em> can be used: While <code>2/3</code> indicates the classical integer division, which in this example gives <code>0</code>, using the backslash instead gives a fraction: <code>2\3</code>. For more on this topic, including some additional keywords for short-hand notations, see the chapter <a href="https://github.com/utwente-fmt/vercors/wiki/Permissions">"Permissions"</a>.</p>
<p>Sometimes, you might create complicated expressions and want to use helper variables to simplify them. However, certain constructs only allow for expressions, and not for statements such as variable declarations. To alleviate that, there is the <code>\let</code> construct, which defines a variable just for a single expression: <code>( \let type name = expr1 ; expr2 )</code>, where <code>type</code> is the type of the helper variable, <code>name</code> its name, <code>expr1</code> defines its value, and <code>expr2</code> the complicated expression that you can now simplify by using the helper variable. Example:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb4-1" title="1"><span class="co">//@ assert (\let int abs_x = (x&lt;0 ? -x : x); y==(z==null ? abs_x : 5*abs_x));</span></a></code></pre></div>
<h4 id="quantifiers">Quantifiers</h4>
<p>Note that most target languages, such as Java and C, support array types, such as <code>int[]</code>. Sometimes, you might want to reason about all elements of the array. To do that, VerCors supports using <em>quantifiers</em> in the specifications: <code>(\forall varDecl; cond; expr)</code>. The syntax is similar to the header of a for loop: <code>varDecl</code> declares a variable (e.g. <code>int i</code>); <code>cond</code> is a boolean expression describing a boundary condition, restricting the declared variable to the applicable cases (e.g. defining the range of the integer <code>0&lt;=i &amp;&amp; i&lt;arr.length</code>); and <code>expr</code> is the boolean expression you are interested in, such as a statement you want to assert. Note that the parentheses are mandatory. Here is an example to specify that all elements in the given array are positive:</p>
<!-- standaloneSnip Quantifiers1
//:: cases Quantifiers1
//:: tools silicon
//:: verdict Pass

class Test {
//@ requires arr != null;
//@ requires Perm(arr[*], 1\2);
-->

<!-- codeSnip Quantifiers1 -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ requires arr != null;
//@ requires (\forall int i ; 0&lt;=i &amp;&amp; i&lt;arr.length ; arr[i]&gt;0);
void foo(int[] arr) { /* ... */ }
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases Quantifiers1
//:: tools silicon
//:: verdict Pass

class Test {
//@ requires arr != null;
//@ requires Perm(arr[*], 1\2);
//@ requires arr != null;
//@ requires (\forall int i ; 0&lt;=i &amp;&amp; i&lt;arr.length ; arr[i]&gt;0);
void foo(int[] arr) { /* ... */ }
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<!-- standaloneSnip Quantifiers1
}
-->

<p>Note that in practice, you would also have to specify permissions to access the values in the array. More on that in the <a href="https://github.com/utwente-fmt/vercors/wiki/Permissions">next chapter</a>.</p>
<p><strong>Tip</strong> If you want to quantify over more than one variable (e.g. saying <code>arr1[i] != arr2[j]</code> for all <code>i</code> and <code>j</code>), use nesting: <code>(\forall int i; 0&lt;=i &amp;&amp; i&lt;arr1.length; (\forall int j; 0&lt;=j &amp;&amp; j&lt;arr2.length; arr1[i]!=arr2[j]))</code>.</p>
<p>If your boundary condition is an interval (like in the examples above), you can use the shorter notation <code>(\forall type name = e1 .. e2 ; expr)</code>, where <code>type</code> is a type that supports comparison with <code>&lt;</code> (e.g. integer, fraction), <code>name</code> is the name of the quantified variable, <code>e1</code> and <code>e2</code> are expressions defining the interval bounds (lower bound inclusive, upper bound exclusive) and <code>expr</code> is the expression you are interested in: <code>(\forall int i = 0 .. arr.length ; arr[i]&gt;0)</code>. Note that, depending on the circumstances, spaces are necessary around the <code>..</code>.</p>
<p>There also is an <code>\exists</code> quantifier analogous to the <code>forall</code> quantifier: <code>(\exists varDecl; cond; expr)</code>. For instance, we could use a similar example as above, but requiring that <em>at least one</em> array element is positive:</p>
<!-- standaloneSnip Quantifiers2
//:: cases Quantifiers2
//:: tools silicon
//:: verdict Pass

class Test {
//@ requires arr != null;
//@ requires Perm(arr[*], 1\2);
-->

<!-- codeSnip Quantifiers2 -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ requires arr != null;
//@ requires (\exists int i ; 0&lt;=i &amp;&amp; i&lt;arr.length ; arr[i]&gt;0);
void foo(int[] arr) { /* ... */ }
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases Quantifiers2
//:: tools silicon
//:: verdict Pass

class Test {
//@ requires arr != null;
//@ requires Perm(arr[*], 1\2);
//@ requires arr != null;
//@ requires (\exists int i ; 0&lt;=i &amp;&amp; i&lt;arr.length ; arr[i]&gt;0);
void foo(int[] arr) { /* ... */ }
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<!-- standaloneSnip Quantifiers2
}
-->

<p>Again, note that in practice, you would also have to specify permissions to access the values in the array.</p>
<p><strong>Note</strong> <code>\forall</code> quantifiers are easier to reason about than <code>\exists</code>, because they can be applied indiscriminately whenever an element is encountered, while <code>\exists</code> needs to find the element to which it can be applied. Therefore, <code>\exists</code> quantifiers are more likely to cause problems with VerCors (e.g. non-termination of the analysis), and they should be <strong>used with care</strong>!</p>
<h5 id="triggers">Triggers</h5>
<p><em>Note: This an advanced concept and new users may skip this section.</em></p>
<p>A quantifier <code>(\forall int i = 0 .. arr.length ; arr[i]&gt;0)</code> is a rather generic piece of knowledge; to apply it to a concrete case, for example when encountering <code>arr[1]</code>, the quantifier must be <em>instantiated</em>. This basically replaces the quantified variable(s), in this case <code>i</code>, with concrete values. But this is only done when necessary, so when the concrete case <code>arr[1]</code> is actually encountered. Recognising that the quantifier must be instantiated was fairly easy in this case, but for more complex expression it can become rather difficult. In those cases, VerCors might use heuristics, and even randomisation. This can lead to VerCors verifying a program successfully, and when you call it again with the exact same program, the analysis takes forever. So if you experience such behaviour, quantified expressions are a likely cause.</p>
<p>To avoid that, you can explicitly tell VerCors what kind of expression should cause instantiating the quantifier, disabling the internal heuristics. This is called a <em>trigger</em> (or <em>pattern</em>, e.g. by Z3); for more information see the <a href="http://viper.ethz.ch/tutorial/?page=1&amp;section=#quantifiers">Viper tutorial on triggers</a>. In VerCors, to mark a part of an expression as a trigger, it is enclosed in <code>{:</code> and <code>:}</code>:</p>
<!-- standaloneSnip Triggers1
//:: cases Triggers1
//:: tools silicon
//:: verdict Pass

class Test {
//@ requires arr != null;
//@ requires Perm(arr[*], 1\2);
-->

<!-- codeSnip Triggers1 -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ requires arr!=null &amp;&amp; arr.length&gt;3;
//@ requires (\forall int i ; 0&lt;=i &amp;&amp; i&lt;arr.length ; {: arr[i] :} &gt; 0);
void foo(int[] arr) {
  assert arr[3]&gt;0;   // the trigger recognises &#34;arr[3]&#34; and instantiates the quantifier, setting i to 3
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases Triggers1
//:: tools silicon
//:: verdict Pass

class Test {
//@ requires arr != null;
//@ requires Perm(arr[*], 1\2);
//@ requires arr!=null &amp;&amp; arr.length&gt;3;
//@ requires (\forall int i ; 0&lt;=i &amp;&amp; i&lt;arr.length ; {: arr[i] :} &gt; 0);
void foo(int[] arr) {
  assert arr[3]&gt;0;   // the trigger recognises &#34;arr[3]&#34; and instantiates the quantifier, setting i to 3
}
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<!-- standaloneSnip Triggers1
}
-->

<p>(Again, <a href="https://github.com/utwente-fmt/vercors/wiki/Permissions">Permissions</a> were omitted.)</p>
<p>Note that the trigger must involve all quantified variables. So if you have a nested quantifier <code>(\forall int i; ... ; (\forall int j; ... ; expr))</code>, a trigger in <code>expr</code> must be about both <code>i</code> and <code>j</code>. Also note that you cannot use complex expressions like arithmetic expressions or relations as triggers. For instance in the example above, <code>{: arr[i]&gt;0 :}</code> would <strong>not</strong> be a valid trigger.</p>
<p><strong>Warning</strong> A wrong choice of triggers can lead to failed verifications of true statements:</p>
<!-- testMethod Fail -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@ pure @*/ int f(int a, int b);
    
//@ requires x&gt;0;
//@ requires (\forall int k ; 0&lt;=k &amp;&amp; k&lt;=x ; {: f(k, y) :} == 0);
//@ requires (\forall int k ; 0&lt;=k &amp;&amp; k&lt;=x ; {: f(k, y) :} == 0 ==&gt; f(k, z) == 0);
void bar(int x, int y, int z) {
    //@ assert f(x, y) == 0;     // this assertion verifies, because &#34;f(x,y)&#34; triggers the first quantifier
    //@ assert f(x/2, z) == 0;   // this assertion fails, even though the quantifiers includes this knowledge
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-expressions-quantifiers-triggers-1
//:: verdict Fail
//:: tools silicon
final class Test {
    /*@ pure @*/ int f(int a, int b);
        
    //@ requires x&gt;0;
    //@ requires (\forall int k ; 0&lt;=k &amp;&amp; k&lt;=x ; {: f(k, y) :} == 0);
    //@ requires (\forall int k ; 0&lt;=k &amp;&amp; k&lt;=x ; {: f(k, y) :} == 0 ==&gt; f(k, z) == 0);
    void bar(int x, int y, int z) {
        //@ assert f(x, y) == 0;     // this assertion verifies, because &#34;f(x,y)&#34; triggers the first quantifier
        //@ assert f(x/2, z) == 0;   // this assertion fails, even though the quantifiers includes this knowledge
    }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>In this example, the first quantifier asserts that <code>f(x/2, y) == 0</code>. From that, the second quantifier could derive <code>f(x/2, z) == 0</code>, so the second assertion should hold. However, the second quantifier has no trigger for <code>f(k,z)</code>, so the quantifier does not get instantiated and the knowledge remains hidden. Removing the trigger around <code>f(k,y)</code> in the second quantifier leads to a successful verification, because without explicit triggers, VerCors' heuristics finds the correct trigger <code>f(k,z)</code> automatically.</p>
<h6 id="other-trigger-sources">Other trigger sources</h6>
<p>We recommend the following sources for more examples and explanations of how triggers work.</p>
<ul>
<li><a href="https://github.com/dafny-lang/dafny/wiki/FAQ#how-does-dafny-handle-quantifiers-ive-heard-about-triggers-what-are-those">Dafny FAQ: How does Dafny handle quantifiers? I've heard about "triggers", what are those?</a></li>
<li><a href="http://viper.ethz.ch/tutorial/?page=1&amp;section=#quantifiers">Viper tutorial on triggers</a></li>
<li><a href="https://stackoverflow.com/questions/50668693/what-are-triggers-in-dafny-boogie">Stack Overflow: quantifiers - What are triggers in Dafny/Boogie?</a></li>
<li><a href="http://purl.utwente.nl/essays/80892">Extending Support for Axiomatic Datatypes in VerCors, Section 2.3</a>. Masters thesis by Ãmer Åakar. Includes a visual explanation of the workings of triggers using Axiom Profiler, a quantifier instantiation debugging tool.</li>
</ul>
<h1 id="permissions">Permissions</h1>
<p><em>This feature is supported for all languages.</em></p>
<p>This section discusses the basics of handling ownership using a simple toy example. Ownership is used to express whether a thread (or synchronization object) has access to a specific element on the heap. This access can be shared among multiple threads (or synchronization objects), which allows the threads to read the value of this element, or it can be unique to one, in which case the value can written to or read from. Permission annotations are used to express ownership. We start by considering the following simple example program, written in Java:</p>
<!-- test Fail -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Counter {
  public int val;

  void incr(int n) {
    this.val = this.val + n;
  }
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases permissions-1
//:: verdict Fail
//:: tools silicon
class Counter {
  public int val;

  void incr(int n) {
    this.val = this.val + n;
  }
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>If you wish, you can store this file as, say, <code>counter.java</code>, and try to run VerCors on this file by running <code>vct --silicon counter.java</code> in a console (assuming you have VerCors installed). This program currently does not contain any annotations, but we will eventually annotate the program to verify the following simple property: after calling the <code>incr</code> function, the value of <code>val</code> has been increased by an amount <code>n</code>. This can be expressed as a postcondition for the <code>incr</code> method: <code>ensures this.val == \old(this.val) + n</code>.</p>
<p>However, if you run VerCors on this example, as it is now, you will see that VerCors fails to verify the correctness of the program and reports an 'AssignmentFailed: InsufficientPermission' error, since the caller of the method has insufficient permission to access <code>this.val</code>. First observe that <code>this.val</code> is shared-memory; there may be other threads that also access the <code>val</code> field, since the field is public. In order to prevent other threads from accessing <code>this.val</code> while the calling thread is executing <code>incr</code>, we need to specify that threads may only call <code>c.incr</code> (on any object <code>c</code> that is an instance of <code>Counter</code>) when they have <em>write permission</em> for <code>c.val</code>:</p>
<!-- test -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Counter {
  public int val;

  /*@
    requires Perm(this.val, 1);
    ensures Perm(this.val, 1);
    ensures this.val == \old(this.val) + n;
  */
  void incr(int n) {
    this.val = this.val + n;
  }
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases permissions-2
//:: verdict Pass
//:: tools silicon
class Counter {
  public int val;

  /*@
    requires Perm(this.val, 1);
    ensures Perm(this.val, 1);
    ensures this.val == \old(this.val) + n;
  */
  void incr(int n) {
    this.val = this.val + n;
  }
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>We added three things to the counter program. The first is a <code>requires</code> clause, which is a precondition expressing that <code>incr</code> can only be called when the calling thread has permission to write to <code>val</code>. The second is an <code>ensures</code> clause, which is a postcondition expressing that, given that the <code>incr</code> function terminates (which is trivial in the above example), the function returns write permission for <code>val</code> to the thread that made the call to <code>incr</code>. The third is a postcondition that states that after <code>incr</code> has terminated, the value of <code>this.val</code> has indeed been increased by <code>n</code>. If you run this annotated program with VerCors, you will see that it now passes. The remainder of this section mostly focuses on how to use the <code>Perm</code> ownership predicates.</p>
<p>Observe that the clause <code>Perm(this.val, 1)</code> expresses write permission for <code>this.val</code>. Recall that VerCors has a very explicit notion of ownership, and that ownership is expressed via fractional permissions. The second argument to the <code>Perm</code> predicate is a <em>fractional permission</em>; a rational number <code>q</code> in the range <code>0 &lt; q &lt;= 1</code>. The ownership system in VerCors enforces that all permissions for a shared memory location together cannot exceed <code>1</code>. This implies that, if some thread has permission <code>1</code> for a shared-memory location at some point, then no other thread can have any permission predicate for that location at that point, for otherwise the total amount of permissions for that location exceeds <code>1</code> (since fractional permissions are strictly larger than <code>0</code>). For this reason, we refer to permission predicates of the form <code>Perm(o.f, 1)</code> as <em>write permissions</em>, and <code>Perm(o.f, q)</code> with <code>q &lt; 1</code> as <em>read permissions</em>. Threads are only allowed to read from shared memory if they have read permission for that shared memory, and may only write to shared memory if they have write permission. In the above example, the function <code>incr</code> both reads and writes <code>this.val</code>, which is fine: having write permission for a field implies having read permission for that field.</p>
<p>Let us now go a bit deeper into the ownership system of VerCors. If one has a permission predicate <code>Perm(o.f, q)</code>, then this predicate can be <em>split</em> into <code>Perm(o.f, q\2) ** Perm(o.f, q\2)</code>. Moreover, a formula of the form <code>Perm(o.f, q1) ** Perm(o.f, q2)</code> can be <em>merged</em> back into <code>Perm(o.f, q1 + q2)</code>. For example, if we change the program annotations as shown below, the program still verifies successfully:</p>
<!-- standaloneSnip mergedPerm 
//:: case MergedPermission
//:: tools silicon
//:: verdict Pass
class Counter {
public int val;
-->

<!-- codeSnip mergedPerm -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
  requires Perm(this.val, 1\2) ** Perm(this.val, 1\2);
  ensures Perm(this.val, 1\2) ** Perm(this.val, 1\2);
  ensures this.val == \old(this.val) + n;
*/
void incr(int n) {
  this.val = this.val + n;
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: case MergedPermission
//:: tools silicon
//:: verdict Pass
class Counter {
public int val;
/*@
  requires Perm(this.val, 1\2) ** Perm(this.val, 1\2);
  ensures Perm(this.val, 1\2) ** Perm(this.val, 1\2);
  ensures this.val == \old(this.val) + n;
*/
void incr(int n) {
  this.val = this.val + n;
}
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<!-- standaloneSnip mergedPerm
}
-->

<p>For splitting and merging we use the <code>**</code> operator, which is known as the separating conjunction, a connective from separation logic. A formula of the form <code>P ** Q</code> can be read as: "<code>P</code>, and <em>separately</em> <code>Q</code>", and comes somewhat close to the standard logical conjunction. In essence, <code>P ** Q</code> expresses that the subformulas <code>P</code> and <code>Q</code> both hold, and in addition, that all ownership resources in <code>P</code> and <code>Q</code> are together <em>disjoint</em>, meaning that all the permission components together do not exceed <code>1</code> for any field. Consider the formula <code>Perm(x.f, 1) ** Perm(y.f, 1)</code>. The permissions for a field <code>f</code> cannot exceed <code>1</code>, therefore we can deduce that <code>x != y</code>.</p>
<p>One may also try to verify the following alteration, which obviously does not pass, since write permission for <code>this.val</code> is needed, but only read permission is obtained via the precondition. VerCors will again give an 'InsufficientPermission' failure on this example.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb5-1" title="1"><span class="co">/*@</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="co">  requires Perm(this.val, 1\2);</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="co">  ensures Perm(this.val, 1\2);</span></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="co">  ensures this.val == \old(this.val) + n;</span></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="co">*/</span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="dt">void</span> <span class="fu">incr</span>(<span class="dt">int</span> n) {</a>
<a class="sourceLine" id="cb5-7" title="7">  <span class="kw">this</span>.<span class="fu">val</span> = <span class="kw">this</span>.<span class="fu">val</span> + n;</a>
<a class="sourceLine" id="cb5-8" title="8">}</a></code></pre></div>
<p>If you replace both ownership predicates for <code>Perm(this.val, 3/2)</code>, then the tool will report a 'MethodPreConditionUnsound: MethodPreConditionFalse' error because the precondition can then never by satisfied by any caller, since no thread can have permission greater than <code>1</code> for any shared-memory location. VerCors is a verification tool for <em>partial correctness</em>; if the precondition of a method cannot be satisfied because it is absurd, then the program trivially verifies. To illustrate this, try to change the precondition into <code>requires false</code> and see what happens when running VerCors. Note that VerCors does try to help the user identify these cases by showing a 'MethodPreConditionUnsound' if it can derive that the precondition is unsatisfiable. But one has to be a bit careful about the assumptions made on the program as preconditions.</p>
<h2 id="self-framing">Self-framing</h2>
<p>Consider the following variant on our program. Would this verify?</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb6-1" title="1"><span class="co">/*@</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="co">  requires Perm(this.val, 1);</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co">  ensures this.val == \old(this.val) + n;</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="co">*/</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="dt">void</span> <span class="fu">incr</span>(<span class="dt">int</span> n) {</a>
<a class="sourceLine" id="cb6-6" title="6">  <span class="kw">this</span>.<span class="fu">val</span> = <span class="kw">this</span>.<span class="fu">val</span> + n;</a>
<a class="sourceLine" id="cb6-7" title="7">}</a></code></pre></div>
<p>This program does not verify and gives an 'InsufficientPermission' failure when given to VerCors. The reason is that, also in the specifications one cannot read from shared-memory without the required permissions. In this program, the <code>ensures</code> clause accesses <code>this.val</code>, however no ownership for <code>this.val</code> is ensured by the <code>incr</code> method. Note that, without a notion of ownership, one cannot establish the postcondition: perhaps some other thread changed the contents of <code>this.val</code> while evaluating the postcondition. By having a notion of ownership, no other thread can change the contents of <code>this.val</code> while we evaluate the postcondition of the call, since no other threads can have resources to do so.</p>
<p>Moreover, the order of specifying permissions and functional properties does matter. For example, the following program also does not verify, even though it ensures enough permissions to establish the postcondition:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb7-1" title="1"><span class="co">/*@</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="co">  requires Perm(this.val, 1);</span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="co">  ensures this.val == \old(this.val) + n;</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="co">  ensures Perm(this.val, 1);</span></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="co">*/</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="dt">void</span> <span class="fu">incr</span>(<span class="dt">int</span> n) {</a>
<a class="sourceLine" id="cb7-7" title="7">  <span class="kw">this</span>.<span class="fu">val</span> = <span class="kw">this</span>.<span class="fu">val</span> + n;</a>
<a class="sourceLine" id="cb7-8" title="8">}</a></code></pre></div>
<p>VerCors enforces that shared-memory accesses are <em>framed</em> by ownership resources. Before accessing <code>this.val</code> in the first <code>ensures</code> clause, the permissions for <code>this.val</code> must already be known! In the program given above, the access to <code>this.val</code> in the postcondition is <em>not</em> framed by the ownership predicate: it comes too late.</p>
<h2 id="permission-leaks">Permission leaks</h2>
<p>So what about the following change? Can VerCors successfully verify the following program?</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb8-1" title="1"><span class="co">/*@</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="co">  requires Perm(this.val, 1);</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="co">  ensures Perm(this.val, 1\2);</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="co">  ensures this.val == \old(this.val) + n;</span></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="co">*/</span></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="dt">void</span> <span class="fu">incr</span>(<span class="dt">int</span> n) {</a>
<a class="sourceLine" id="cb8-7" title="7">  <span class="kw">this</span>.<span class="fu">val</span> = <span class="kw">this</span>.<span class="fu">val</span> + n;</a>
<a class="sourceLine" id="cb8-8" title="8">}</a></code></pre></div>
<p>VerCors is able to verify the example program given above. However, less permission for <code>this.val</code> is ensured then is required, meaning that any thread that calls <code>c.incr</code> will need to give up write permission for <code>c.val</code>, but only receives read permission back in return, after <code>incr</code> has terminated. So this example has a <em>permission leak</em>. Recall that threads need full permission in order to write to shared heap locations, so essentially, calling <code>c.incr</code> has the effect of losing the ability to ever write to <code>c.val</code> again. In some cases this can be problematic, while in other cases this can be helpful, as losing permissions in such a way causes shared-memory to become read-only, specification-wise. However, in the scenario given below the permission leak will prevent successful verification:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb9-1" title="1"><span class="co">/*@</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co">  requires Perm(this.val, 1);</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="co">  ensures Perm(this.val, 1\2);</span></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="co">  ensures this.val == \old(this.val) + n;</span></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="co">*/</span></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="dt">void</span> <span class="fu">incr</span>(<span class="dt">int</span> n) {</a>
<a class="sourceLine" id="cb9-7" title="7">  <span class="kw">this</span>.<span class="fu">val</span> = <span class="kw">this</span>.<span class="fu">val</span> + n;</a>
<a class="sourceLine" id="cb9-8" title="8">}</a>
<a class="sourceLine" id="cb9-9" title="9">  </a>
<a class="sourceLine" id="cb9-10" title="10"><span class="co">/*@</span></a>
<a class="sourceLine" id="cb9-11" title="11"><span class="co">  requires Perm(this.val, 1);</span></a>
<a class="sourceLine" id="cb9-12" title="12"><span class="co">*/</span></a>
<a class="sourceLine" id="cb9-13" title="13"><span class="dt">void</span> <span class="fu">incr2</span>(<span class="dt">int</span> n) {</a>
<a class="sourceLine" id="cb9-14" title="14">  <span class="fu">incr</span>(n);</a>
<a class="sourceLine" id="cb9-15" title="15">  <span class="fu">incr</span>(n);</a>
<a class="sourceLine" id="cb9-16" title="16">}</a></code></pre></div>
<p>In the <code>incr2</code> method, the first call <code>incr(n)</code> will consume write permission for <code>this.val</code>, but only produce read permission in return. Therefore, the requirements of the second call <code>incr(n)</code> cannot be satisfied, which causes the verification to be unsuccessful.</p>
<h2 id="some-extra-notation">Some extra notation</h2>
<p>We end the section by mentioning some notational enhancements for handling permissions. Instead of writing <code>Perm(o.f, 1)</code>, one may also write <code>Perm(o.f, write)</code>, which is perhaps a more readable way to express write permission for <code>o.f</code>.</p>
<p>Similarly, one can write <code>Perm(o.f, read)</code> to express a non-zero read permission. Note that if this is used in a pre- and postcondition, it is not guaranteed to be the same amount of permissions. The underlying amount of permissions is an unspecified fraction and can therefore not be merged back into a write permission. This can be observed in the following program where the <code>assert</code> fails:</p>
<pre><code>class Counter {
    int val;

    /*@
    requires Perm(this.val, write);
    ensures Perm(this.val, write);
    ensures this.val == \old(this.val) + n;
    */
    void incr(int n) {
        int oldValue = getValue();
        //@ assert Perm(this.val, write);
        this.val = oldValue + n;
    }
    
    /*@
    requires Perm(this.val, read);
    ensures Perm(this.val, read);
    ensures \result == this.val;
    */
    int getValue() {
        return this.val;
    }
}
</code></pre>
<p><code>read</code> is mostly useful for specifying immutable data structures. One can also write <code>Value(o.f)</code> to express read permission to <code>o.f</code>, where the value of the fractional permission does not matter. Consequently, <code>Value</code> ownership predicates can be split indefinitely.</p>
<p>If you want to express that a thread has no ownership over a certain heap element, then one can use the keyword <code>none</code>, e.g. <code>Perm(o.f, none)</code>.</p>
<p>If you want to express permissions to multiple locations, one may use <code>\forall* vars; range; expr</code>. For example, <code>(\forall* int j; j &gt;= 0 &amp;&amp; j &lt; array.length; Perm(array[j], write)</code> denotes that the thread has write access to all elements in <code>array</code>. It is equivalent to writing <code>Perm(array[0], write) ** Perm(array[1], write) ** â¦ ** Perm(array[array.length-1], write)</code>. Another way to specify permissions of all array elements is to use <code>Perm(array[*], write)</code> which is equivalent to the previous expression.</p>
<p>If you want to reason about the value that the variable refers to as well then you can use <code>PointsTo(var, p, val)</code> which denotes that you have permission <code>p</code>for variable <code>var</code> which has value <code>val</code>. It is similar to saying <code>Perm(var, p)</code> and <code>var == val</code>.</p>
<h1 id="gpgpu-verification">GPGPU Verification</h1>
<p>This section explains how to verify GPGPU programs in VerCors. The tool supports both OpenCL and CUDA languages. The synchronization feature (i.e., barrier) in these languages is also supported by VerCors. To demonstrate GPGPU verification, we show two examples in both OpenCl and CUDA, one without barrier and the other one with barrier.</p>
<h3 id="openclcuda-without-barrier">OpenCL/CUDA without Barrier</h3>
<p>This simple method shows an OpenCL program that adds two arrays and stores the result in another array:</p>
<!-- test -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">#include &lt;opencl.h&gt;
/* 1  */ /*@
         context \pointer_index(a, get_global_id(0), read);
         context \pointer_index(b, get_global_id(0), read);
         context \pointer_index(c, get_global_id(0), write);
         ensures c[get_global_id(0)] == a[get_global_id(0)] + b[get_global_id(0)];
         @*/
/* 7  */ __kernel void openCLAdd(int a[], int b[], int c[]) {
/* 8  */    int tid = get_global_id(0);
/* 9  */    c[tid] = a[tid] + b[tid];
/* 10 */ }  
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases gpgpu-verification-?-openclcuda-without-barrier-1
//:: verdict Pass
//:: tools silicon
#include &lt;opencl.h&gt;
/* 1  */ /*@
         context \pointer_index(a, get_global_id(0), read);
         context \pointer_index(b, get_global_id(0), read);
         context \pointer_index(c, get_global_id(0), write);
         ensures c[get_global_id(0)] == a[get_global_id(0)] + b[get_global_id(0)];
         @*/
/* 7  */ __kernel void openCLAdd(int a[], int b[], int c[]) {
/* 8  */    int tid = get_global_id(0);
/* 9  */    c[tid] = a[tid] + b[tid];
/* 10 */ }  
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>and this method shows the same example in CUDA:</p>
<!-- test -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">#include &lt;cuda.h&gt;
/* 1  */  /*@
          context \pointer_index(a, threadIdx.x, read);
          context \pointer_index(b, threadIdx.x, read);
          context \pointer_index(c, threadIdx.x, write);
          ensures c[threadIdx.x] == a[threadIdx.x] + b[threadIdx.x];
          @*/
/* 7  */  __global__ void CUDAAdd(int a[], int b[], int c[]) {
/* 8  */     int tid = threadIdx.x;
/* 9  */     c[tid] = a[tid] + b[tid];
/* 10 */  }  
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases gpgpu-verification-?-openclcuda-without-barrier-2
//:: verdict Pass
//:: tools silicon
#include &lt;cuda.h&gt;
/* 1  */  /*@
          context \pointer_index(a, threadIdx.x, read);
          context \pointer_index(b, threadIdx.x, read);
          context \pointer_index(c, threadIdx.x, write);
          ensures c[threadIdx.x] == a[threadIdx.x] + b[threadIdx.x];
          @*/
/* 7  */  __global__ void CUDAAdd(int a[], int b[], int c[]) {
/* 8  */     int tid = threadIdx.x;
/* 9  */     c[tid] = a[tid] + b[tid];
/* 10 */  }  
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>In both examples, first we should include the header files (i.g., opencl.h and cuda.h). Next we obtain thread identifiers and then each thread does the computation (lines 8-9 of OpenCL and 8-9 of CUDA examples). As we can see obtaining the global thread identifiers are different in OpenCL and CUDA.</p>
<p>In the specification of the methods, we specify read permission for each thread in arrays "<em>a</em>" and "<em>b</em>" and write permission in array "<em>c</em>" as pre- and postcondition. The keyword "\<em>pointer_index</em>" is used with three arguments, array name, index and permission to indicate which thread has what permission to which location. Finally in the last postcondition we specify the result of the methods that each location in array "<em>c</em>" contains the sum of the values in the corresponding locations in arrays "<em>a</em>" and "<em>b</em>". Note that in the specification we can use the shorthand keyword "\<em>gid</em>" instead of "<em>get_global_id(0)</em>" and "<em>threadIdx.x</em>" in the tool.</p>
<p><em>Note:</em> In CUDA, to compute the global id, normally <code>threadIdx</code> is combined with <code>blockDim</code>. Unfortunately, <code>blockDim</code> is not yet supported in VerCors, so the examples in this chapter only use <code>threadIdx</code>.</p>
<h3 id="openclcuda-with-barrier">OpenCL/CUDA with Barrier</h3>
<p>In GPU programming, when there is only one thread block, there is a mechanism to sunchronize threads. This example shows an OpenCL program that uses barrier to synchronize threads:</p>
<!-- No test is added here because I couldn't get the example working with vercors from the dev branch as of 2021-11-03.
     Besides the fact that "array.length" doesn't work (which can be worked around with "\pointer(array, size, 0)"),
     there is also a triggering problem. Some forall in the produced viper code cannot be proven, even though it is there
     as a precondition.
-->

<div class="sourceCode" id="cb11"><pre class="sourceCode opencl"><code class="sourceCode opencl"><a class="sourceLine" id="cb11-1" title="1"><span class="ot">#include &lt;opencl.h&gt;</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="co">/* 1  */</span> </a>
<a class="sourceLine" id="cb11-3" title="3"><span class="co">/* 2  */</span></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="co">/* 3  */</span> <span class="co">/*@</span></a>
<a class="sourceLine" id="cb11-5" title="5"><span class="co">         context_everywhere opencl_gcount == 1;</span></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="co">         context_everywhere array != null &amp;&amp; array.length == size;</span></a>
<a class="sourceLine" id="cb11-7" title="7"><span class="co">         requires get_local_id(0) != size-1 ==&gt; \pointer_index(array, get_local_id(0)+1, 1\2);</span></a>
<a class="sourceLine" id="cb11-8" title="8"><span class="co">         requires get_local_id(0) == size-1 ==&gt; \pointer_index(array, 0, 1\2);</span></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="co">         ensures \pointer_index(array, get_local_id(0), 1);</span></a>
<a class="sourceLine" id="cb11-10" title="10"><span class="co">         ensures get_local_id(0) != size-1 ==&gt; array[get_local_id(0)] == \old(array[get_local_id(0)+1]);</span></a>
<a class="sourceLine" id="cb11-11" title="11"><span class="co">         ensures get_local_id(0) == size-1 ==&gt; array[get_local_id(0)] == \old(array[0]);</span></a>
<a class="sourceLine" id="cb11-12" title="12"><span class="co">         @*/</span></a>
<a class="sourceLine" id="cb11-13" title="13"><span class="co">/* 12 */</span> <span class="kw">__kernel</span> <span class="dt">void</span> openCLLeftRotation(<span class="dt">int</span> array[], <span class="dt">int</span> size) {</a>
<a class="sourceLine" id="cb11-14" title="14"><span class="co">/* 13 */</span>    <span class="dt">int</span> tid = get_local_id(<span class="dv">0</span>);</a>
<a class="sourceLine" id="cb11-15" title="15"><span class="co">/* 14 */</span>    <span class="dt">int</span> temp;</a>
<a class="sourceLine" id="cb11-16" title="16"><span class="co">/* 15 */</span>    <span class="kw">if</span>(tid != size<span class="dv">-1</span>){</a>
<a class="sourceLine" id="cb11-17" title="17"><span class="co">/* 16 */</span>     temp = array[tid+<span class="dv">1</span>];</a>
<a class="sourceLine" id="cb11-18" title="18"><span class="co">/* 17 */</span>    }<span class="kw">else</span>{</a>
<a class="sourceLine" id="cb11-19" title="19"><span class="co">/* 18 */</span>     temp = array[<span class="dv">0</span>];</a>
<a class="sourceLine" id="cb11-20" title="20"><span class="co">/* 19 */</span>    }</a>
<a class="sourceLine" id="cb11-21" title="21"><span class="co">/* 20 */</span></a>
<a class="sourceLine" id="cb11-22" title="22"><span class="co">/* 21 */</span>    <span class="co">/*@</span></a>
<a class="sourceLine" id="cb11-23" title="23"><span class="co">            requires get_local_id(0) != size-1 ==&gt; \pointer_index(array, get_local_id(0)+1, 1\2);</span></a>
<a class="sourceLine" id="cb11-24" title="24"><span class="co">            requires get_local_id(0) == size-1 ==&gt; \pointer_index(array, 0, 1\2);</span></a>
<a class="sourceLine" id="cb11-25" title="25"><span class="co">            ensures \pointer_index(array, get_local_id(0), 1);</span></a>
<a class="sourceLine" id="cb11-26" title="26"><span class="co">            @*/</span></a>
<a class="sourceLine" id="cb11-27" title="27"><span class="co">/* 26 */</span>    barrier(CLK_LOCAL_MEM_FENCE);</a>
<a class="sourceLine" id="cb11-28" title="28"><span class="co">/* 27 */</span></a>
<a class="sourceLine" id="cb11-29" title="29"><span class="co">/* 28 */</span>    array[tid] = temp;</a>
<a class="sourceLine" id="cb11-30" title="30"><span class="co">/* 29 */</span> }  </a></code></pre></div>
<p>And this is the CUDA version of the example:</p>
<!-- This example is also not included in testing, for similar reasons as above.
     If the above example works fine, then this one should also be enabled.
-->

<pre class="cuda"><code>#include &lt;cuda.h&gt;
/* 1  */ 
/* 2  */
/* 3  */ /*@
         context_everywhere opencl_gcount == 1;
         context_everywhere array.length == size;
         requires threadIdx.x != size-1 ==&gt; \pointer_index(array, threadIdx.x+1, 1\2);
         requires threadIdx.x == size-1 ==&gt; \pointer_index(array, 0, 1\2);
         ensures \pointer_index(array, threadIdx.x, 1);
         ensures threadIdx.x != size-1 ==&gt; array[threadIdx.x] == \old(array[threadIdx.x+1]);
         ensures threadIdx.x == size-1 ==&gt; array[threadIdx.x] == \old(array[0]);
         @*/
/* 12 */ __global__ void CUDALeftRotation(int array[], int size) {
/* 13 */    int tid = threadIdx.x;
/* 14 */    int temp;
/* 15 */    if(tid != size-1){
/* 16 */     temp = array[tid+1];
/* 17 */    }else{
/* 18 */     temp = array[0];
/* 19 */    }
/* 20 */
/* 21 */    /*@
            requires threadIdx.x != size-1 ==&gt; \pointer_index(array, threadIdx.x+1, 1\2);
            requires threadIdx.x == size-1 ==&gt; \pointer_index(array, 0, 1\2);
            ensures \pointer_index(array, threadIdx.x, 1);
            @*/
/* 26 */    __syncthreads();
/* 27 */
/* 28 */    array[tid] = temp;
/* 29 */ }  
</code></pre>
<p>The above examples illustrate GPU programs that rotates the elements of an array to the left. Each thread ("<em>tid</em>") stores its right neighbor in a temporary location (i.e., "<em>temp</em>"), except thread "<em>size</em>-1" which stores the first element in the array (lines 15-19). Then each thread synchronizes in a barrier (line 26). After that, each thread writes the value read into its own location at index "<em>tid</em>" in the array (line 28).</p>
<p>We specify that there is only one thread block in the specification of the programs using the keyword "<em>opencl_gcount</em>" (the first precondition). The precondition of the barrier follows from the precondition of the function and the computations before the barrier. If the precondition of the barrier holds, the postcondition can be assumed after the barrier. Then, the postcondition of the method can follow from the postcondition of the barrier. Note that in the specification we can use the shorthand keyword "\<em>lid</em>" instead of "<em>get_local_id(0)</em>" and "<em>threadIdx.x</em>" in the tool.</p>
<h1 id="axiomatic-data-types">Axiomatic Data Types</h1>
<p><em>This section discusses axiomatic data types supported by VerCors.</em></p>
<p>Axiomatic data types are data types that are defined by a set of uninterpreted functions and axioms that define the behavior of these functions. This is in contrast to concrete data types which are defined by their implementation in a programming language such as Java or C++.</p>
<p>In the sections below, we are going to go over all ADTs supported by VerCors, give the definition of each, and show examples of common operations defined on them. A reference table can be found at the end showing all the operations defined on the ADTs.</p>
<p>The axiomatizations used by VerCors and its back end Viper can be found <a href="https://github.com/viperproject/silicon/tree/master/src/main/resources/dafny_axioms">here</a> (for sequences sets and bags) and <a href="https://github.com/utwente-fmt/vercors/blob/dev/src/main/universal/res/config/prelude.sil">here</a> (for the other ADTs).</p>
<h2 id="sequence">Sequence</h2>
<p>Sequences are an ordered/enumerated collection also commonly referred to as lists. Sequences are finite and immutable (i.e. once created they cannot be altered).</p>
<p>There are two ways to construct a sequence: the explicit syntax and the implicit syntax. The explicit syntax requires the type of the sequence to be explicitly defined. For example, <code>s1</code> is a sequence of integers initialized with the values 1, 2 and 3 and <code>s2</code> is an empty sequence of integers.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">seq&lt;int&gt; s1 = seq&lt;int&gt; { 1, 2, 3 };
seq&lt;int&gt; s2 = seq&lt;int&gt; { };
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        seq&lt;int&gt; s1 = seq&lt;int&gt; { 1, 2, 3 };
        seq&lt;int&gt; s2 = seq&lt;int&gt; { };
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>The implicit syntax is a shorter syntax. If the sequence is initialized with at least one value (using the implicit syntax), VerCors infers the type of the sequence. An empty sequence can be constructed by providing the type of the sequence. For example, <code>s3</code> is equivalent to <code>s1</code> and <code>s4</code> is equivalent to <code>s2</code>. Notice how there is no space between <code>[</code> and <code>t</code>, this is mandated by the VerCors grammar.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">seq&lt;int&gt; s3 = [ 1, 2, 3 ];
seq&lt;int&gt; s4 = [t: int ];
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-2
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        seq&lt;int&gt; s3 = [ 1, 2, 3 ];
        seq&lt;int&gt; s4 = [t: int ];
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<br>

<p>Once we have a sequence, we can query different properties of that sequence. The syntax <code>s5[i]</code> can be used to retrieve the element at index <code>i</code> from sequence <code>s5</code>. The function <code>head(s5)</code> is shorthand for <code>s5[0]</code>. The length of a sequence <code>s5</code> can be obtained by using the notation <code>|s5|</code>. Two sequences can be compared using the <code>==</code> operator where they are equal iff they are of the same length and the elements at the same indices are equal.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">seq&lt;int&gt; s5 = [ 1, 2, 4, 8, 16 ];
assert s5[3] == 8;
assert |s5| == 5;
assert s5 == seq&lt;int&gt; { 1, 2, 4, 8, 16 };
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-3
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        seq&lt;int&gt; s5 = [ 1, 2, 4, 8, 16 ];
        assert s5[3] == 8;
        assert |s5| == 5;
        assert s5 == seq&lt;int&gt; { 1, 2, 4, 8, 16 };
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<br>

<h3 id="constructing-sequences-from-existing-sequences">Constructing sequences from existing sequences</h3>
<p>As mentioned above sequences are immutable, however it is possible to construct a new sequence from an existing sequence.</p>
<p>Elements can be added to a sequence in two ways. The first way is by concatenating two sequences <code>s6 + s7</code>. This expression represents a new sequence with the elements of <code>s6</code> followed by the elements of <code>s7</code>. The second way is to add a single value to either the front or the back of a sequence. The syntax <code>e::s6</code> is used to prepend <code>e</code> at the front of <code>s6</code> and the syntax <code>s6 ++ e</code> is used to append <code>e</code> at the end of <code>s6</code>.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">seq&lt;int&gt; s6 = [ 1, 2, 4, 8, 16 ];
assert 0::s6 == [ 0, 1, 2, 4, 8, 16 ];
assert s6 ++ 32 == [ 1, 2, 4, 8, 16, 32 ];

seq&lt;int&gt; s7 = [ 32, 64, 128 ];
assert s6 + s7 == [ 1, 2, 4, 8, 16, 32, 64, 128 ];
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-constructing-sequences-from-existing-sequences-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        seq&lt;int&gt; s6 = [ 1, 2, 4, 8, 16 ];
        assert 0::s6 == [ 0, 1, 2, 4, 8, 16 ];
        assert s6 ++ 32 == [ 1, 2, 4, 8, 16, 32 ];
        
        seq&lt;int&gt; s7 = [ 32, 64, 128 ];
        assert s6 + s7 == [ 1, 2, 4, 8, 16, 32, 64, 128 ];
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>It is also possible to take a subsequence from an existing sequence. The syntax <code>s8[i..j]</code> is used to take the elements from <code>s8</code> from index <code>i</code> to index <code>j</code> (exclusive). By omitting either the lower bound or upper bound, one can take or drop from a sequence. The function <code>tail(s8)</code> can be used as a shorthand for <code>s8[1..]</code>.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">seq&lt;int&gt; s8 = [ 1, 2, 4, 8, 16 ];
assert s8[1..4] == [ 2, 4, 8 ];
assert s8[..2] == [ 1, 2 ];
assert tail(s8) == s8[1..]; 
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-constructing-sequences-from-existing-sequences-2
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        seq&lt;int&gt; s8 = [ 1, 2, 4, 8, 16 ];
        assert s8[1..4] == [ 2, 4, 8 ];
        assert s8[..2] == [ 1, 2 ];
        assert tail(s8) == s8[1..]; 
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="examples">Examples</h3>
<h4 id="sortedness">Sortedness</h4>
<p>Sortedness is a property that is often used in the verification of sorting algorithms. The sortedness property for a sequence of integers could be defined as follows:</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">pure static boolean sorted(seq&lt;int&gt; xs) = (\forall int i ; 0 &lt;= i &amp;&amp; i &lt; |xs|-1; xs[i] &lt;= xs[i+1]);
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-examples-sortedness-1
//:: verdict Pass
//:: tools silicon
class Test {
    pure static boolean sorted(seq&lt;int&gt; xs) = (\forall int i ; 0 &lt;= i &amp;&amp; i &lt; |xs|-1; xs[i] &lt;= xs[i+1]);
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h4 id="distinct-element">Distinct Element</h4>
<p>Another property on sequences is the uniqueness of the elements. This property could be expressed for a sequence of integers as follows:</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">pure boolean distinct(seq&lt;int&gt; s) =
    (\forall int i; 0 &lt;= i &amp;&amp; i &lt; s.length; 
        (\forall int j; 0 &lt;= j &amp;&amp; j &lt; s.length &amp;&amp; s[i] == s[j]; i == j)
    );
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-examples-distinct-element-1
//:: verdict Pass
//:: tools silicon
class Test {
    pure boolean distinct(seq&lt;int&gt; s) =
        (\forall int i; 0 &lt;= i &amp;&amp; i &lt; s.length; 
            (\forall int j; 0 &lt;= j &amp;&amp; j &lt; s.length &amp;&amp; s[i] == s[j]; i == j)
        );
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h4 id="maximum-element">Maximum element</h4>
<p>Recursive functions are often used to transform or reduce a sequence. The example below goes over a sequence to get its maximum value. This function could be defined for a sequence of integers as follows:</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">requires |xs| &gt; 0;
ensures (\forall int i; 0 &lt;= i &amp;&amp; i &lt; |xs|; xs[i] &lt;= \result);
pure static int max(seq&lt;int&gt; xs) =
    1 == |xs| ?
        xs[0]:
        (xs[0] &gt; max(xs[1..]) ?
            xs[0]:
            max(xs[1..]
        )
);
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-examples-maximum-element-1
//:: verdict Pass
//:: tools silicon
class Test {
    requires |xs| &gt; 0;
    ensures (\forall int i; 0 &lt;= i &amp;&amp; i &lt; |xs|; xs[i] &lt;= \result);
    pure static int max(seq&lt;int&gt; xs) =
        1 == |xs| ?
            xs[0]:
            (xs[0] &gt; max(xs[1..]) ?
                xs[0]:
                max(xs[1..]
            )
    );
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h2 id="set">Set</h2>
<p>Sets are an unordered collection with unique values. Sets are finite and immutable (i.e. once created they cannot be altered).</p>
<p>Similar to sequences, there are two ways to construct a set: the explicit syntax and the implicit syntax. The explicit syntax requires the type of the set explicitly defined. For example, <code>s1</code> is a set of integers initialized with the values 1, 2 and 3 and <code>s2</code> is an empty set of integers.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">set&lt;int&gt; s1 = set&lt;int&gt; { 1, 2, 3, 2 };
set&lt;int&gt; s2 = set&lt;int&gt; { };
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-set-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        set&lt;int&gt; s1 = set&lt;int&gt; { 1, 2, 3, 2 };
        set&lt;int&gt; s2 = set&lt;int&gt; { };
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>The implicit syntax is a shorter syntax. If the set is initialized with at least one value (using the implicit syntax), VerCors infers the type of the set. An empty set can be constructed by providing the type of the set. For example, <code>s3</code> is equivalent to <code>s1</code> and <code>s4</code> is equivalent to <code>s2</code>. Notice how there is no space between <code>{</code> and <code>t</code>, this is mandated by the VerCors grammar.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">set&lt;int&gt; s3 = { 1, 2, 2, 3 };
set&lt;int&gt; s4 = {t: int };
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-set-2
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        set&lt;int&gt; s3 = { 1, 2, 2, 3 };
        set&lt;int&gt; s4 = {t: int };
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Once we have a set, we can query different properties of that set. The length of a set <code>s5</code> can be obtained by using the notation <code>|s5|</code>. Two set <code>s6</code> and <code>s7</code> can be compared using the <code>==</code> operator where they are equal iff all elements of <code>s6</code> are in <code>s7</code> and all elements of <code>s7</code> are in <code>s6</code>. The syntax <code>e1 in s8</code> is used to check if set <code>s8</code> contains the element <code>e1</code>. The <code>&lt;</code> and <code>&lt;=</code> operators denote the strict subset and subset operators respectively.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">set&lt;int&gt; s5 = { 1, 2, 2, 3 };
set&lt;int&gt; s6 = { 3, 4, 5, 6 };
set&lt;int&gt; s7 = { 1, 2 };
set&lt;int&gt; s8 = { 2, 3 };
int e1 = 3;

assert |s5| == 3;
assert s6 != s7;
assert e1 in s8;
assert s8 &lt; s5;
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-set-3
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        set&lt;int&gt; s5 = { 1, 2, 2, 3 };
        set&lt;int&gt; s6 = { 3, 4, 5, 6 };
        set&lt;int&gt; s7 = { 1, 2 };
        set&lt;int&gt; s8 = { 2, 3 };
        int e1 = 3;
        
        assert |s5| == 3;
        assert s6 != s7;
        assert e1 in s8;
        assert s8 &lt; s5;
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="constructing-sets-from-existing-sets">Constructing sets from existing sets</h3>
<p>As mentioned above sets are immutable, however it is possible to construct a new set from an existing set.</p>
<p>There are several operations defined on sets that are part of set theory. The union of two sets is denoted by <code>s5 + s6</code>, the difference between two sets is denoted by <code>s5 - s6</code> and the intersection of two sets is denoted by <code>s5 * s6</code>.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">set&lt;int&gt; s5 = { 1, 2, 2, 3 };
set&lt;int&gt; s6 = { 3, 4, 5, 6 };

assert s5 + s6 == { 1, 2, 3, 4, 5, 6 };
assert s5 - s6 == { 1, 2 };
assert s6 - s5 == { 4, 5, 6};
assert s5 * s6 == { 3 };
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-set-constructing-sets-from-existing-sets-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        set&lt;int&gt; s5 = { 1, 2, 2, 3 };
        set&lt;int&gt; s6 = { 3, 4, 5, 6 };
        
        assert s5 + s6 == { 1, 2, 3, 4, 5, 6 };
        assert s5 - s6 == { 1, 2 };
        assert s6 - s5 == { 4, 5, 6};
        assert s5 * s6 == { 3 };
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="set-comprehension">Set comprehension</h3>
<p>An advanced way to create a set is using <em>set comprehension</em>. The syntax is <code>set&lt;T&gt; { main | variables; selector }</code> and consists of three parts: the <code>main</code>, the <code>variables</code> and the <code>selector</code>.</p>
<p>The <code>variables</code> are the variables that are quantified over and these variables can be bound or unbound. From the quantified variables, we can select specific values by using the <code>selector</code> expression. This is a Boolean expression that selects (a part of) the quantified variables. With the selected set of variables to quantify over, we express the value that is going to be part of the resulting set using the <code>main</code> expression.</p>
<p>For example, we can construct the set of all even integers from 0 to 9 as follows:</p>
<pre><code>set&lt;int&gt; {x | int x &lt;- {0, 1, 2, 3, 4, 5, 6, 7, 8, 9}; x % 2 == 0};
</code></pre>
<p>To use more complex <code>main</code> expressions (i.e. non-identity functions), it is recommended to wrap the expression in a function and use that function in the <code>main</code> expression. For example, suppose we have a set of integers from 0 to 5 (inclusive) and we want to construct the set of integers where each element is doubled, we could use set comprehension as follows:</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class SetComp {
    requires 0 &lt;= j &amp;&amp; j &lt; 5;
    void myMethod(int j) {
       set&lt;int&gt; a = set&lt;int&gt; {SetComp.plus(x, x) | int x; x &gt;= 0 &amp;&amp; x &lt;= 5 };
       assert plus(1, 1) in a; 
       assert plus(j, j) in a; 
    }

    pure static int plus(int a, int b) = a+b;
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-set-set-comprehension-1
//:: verdict Pass
//:: tools silicon
class SetComp {
    requires 0 &lt;= j &amp;&amp; j &lt; 5;
    void myMethod(int j) {
       set&lt;int&gt; a = set&lt;int&gt; {SetComp.plus(x, x) | int x; x &gt;= 0 &amp;&amp; x &lt;= 5 };
       assert plus(1, 1) in a; 
       assert plus(j, j) in a; 
    }

    pure static int plus(int a, int b) = a+b;
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Here we define a function <code>plus</code> to wrap the expression <code>a+b</code> and use an invokation of the <code>plus</code> function as the <code>main</code> of our set comprehension.</p>
<h2 id="bag">Bag</h2>
<p>Bags are an unordered collection. Bags are finite and immutable (i.e. once created they cannot be altered).</p>
<p>Similar to sequences and sets, there are two ways to construct a bag: the explicit syntax and the implicit syntax. The explicit syntax requires the type of the bag explicitly defined. For example, <code>b1</code> is a bag of integers initialized with the values 1, 2, 2 and 3 and <code>b2</code> is an empty bag of integers.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">bag&lt;int&gt; b1 = bag&lt;int&gt; { 1, 2, 3, 2 };
bag&lt;int&gt; b2 = bag&lt;int&gt; { };
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-bag-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        bag&lt;int&gt; b1 = bag&lt;int&gt; { 1, 2, 3, 2 };
        bag&lt;int&gt; b2 = bag&lt;int&gt; { };
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>The implicit syntax is a shorter syntax. If the bag is initialized with at least one value (using the implicit syntax), VerCors infers the type of the bag. An empty bag can be constructed by providing the type of the bag. For example, <code>b3</code> is equivalent to <code>b1</code> and <code>b4</code> is equivalent to <code>b2</code>. Notice how there is no space between <code>b{</code> and <code>t</code>, this is mandated by the VerCors grammar.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">bag&lt;int&gt; b3 = b{ 1, 2, 2, 3 };
bag&lt;int&gt; b4 = b{t: int };
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-bag-2
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        bag&lt;int&gt; b3 = b{ 1, 2, 2, 3 };
        bag&lt;int&gt; b4 = b{t: int };
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Once we have a bag, we can query different properties of that bag. The length of a bag <code>b5</code> can be obtained by using the notation <code>|b5|</code>. The syntax <code>e1 in b6</code> is used to get the multiplicity (or number of occurrences) of an element <code>e1</code> in the bag <code>b6</code>. Two bags <code>b7</code> and <code>b8</code> can be compared using the <code>==</code> operator where they are equal iff for all elements <code>e2</code>, the multiplicity of <code>e2</code> in <code>b7</code> and <code>b8</code> are equal. The <code>&lt;</code> and <code>&lt;=</code> operators denote the strict subset and subset operators respectively.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">bag&lt;int&gt; b5 = b{ 1, 2, 2, 3 };
bag&lt;int&gt; b6 = b{ 3, 4, 5, 6, 5 };
bag&lt;int&gt; b7 = b{ 1, 2, 3, 2, 2, 6 };
bag&lt;int&gt; b8 = b{ 6, 1, 2, 2, 2, 3 };
int e1 = 5;


assert |b5| == 4;
assert (e1 in b6) == 2;
assert b5 &lt;= b7 &amp;&amp; b5 &lt; b8;
assert b7 == b8;
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-bag-3
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        bag&lt;int&gt; b5 = b{ 1, 2, 2, 3 };
        bag&lt;int&gt; b6 = b{ 3, 4, 5, 6, 5 };
        bag&lt;int&gt; b7 = b{ 1, 2, 3, 2, 2, 6 };
        bag&lt;int&gt; b8 = b{ 6, 1, 2, 2, 2, 3 };
        int e1 = 5;
        
        
        assert |b5| == 4;
        assert (e1 in b6) == 2;
        assert b5 &lt;= b7 &amp;&amp; b5 &lt; b8;
        assert b7 == b8;
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="constructing-bags-from-existing-bags">Constructing bags from existing bags</h3>
<p>As mentioned above bags are immutable, however it is possible to construct a new bag from an existing bag.</p>
<p>The union of two bags is denoted by <code>b9 + b10</code>, the difference between two bags is denoted by <code>b11 - b12</code> and the intersection of two bags is denoted by <code>b13 * b14</code>.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">bag&lt;int&gt; b9 = bag&lt;int&gt; { 3 };
bag&lt;int&gt; b10 = bag&lt;int&gt; { 3, 4 };
bag&lt;int&gt; b11 = bag&lt;int&gt; { 1, 2, 2, 3 };
bag&lt;int&gt; b12 = bag&lt;int&gt; { 2, 3, 3, 4 };
bag&lt;int&gt; b13 = bag&lt;int&gt; { 1, 1, 2, 3 };
bag&lt;int&gt; b14 = bag&lt;int&gt; { 2, 3, 3, 4 };

assert b9 + b10 == bag&lt;int&gt; { 3, 3, 4 };
assert b12 - b11 == bag&lt;int&gt; { 3, 4 };
assert b11 - b12 == bag&lt;int&gt; { 1, 2 };
assert b13 * b14 == bag&lt;int&gt; { 2, 3 };
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-bag-constructing-bags-from-existing-bags-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        bag&lt;int&gt; b9 = bag&lt;int&gt; { 3 };
        bag&lt;int&gt; b10 = bag&lt;int&gt; { 3, 4 };
        bag&lt;int&gt; b11 = bag&lt;int&gt; { 1, 2, 2, 3 };
        bag&lt;int&gt; b12 = bag&lt;int&gt; { 2, 3, 3, 4 };
        bag&lt;int&gt; b13 = bag&lt;int&gt; { 1, 1, 2, 3 };
        bag&lt;int&gt; b14 = bag&lt;int&gt; { 2, 3, 3, 4 };
        
        assert b9 + b10 == bag&lt;int&gt; { 3, 3, 4 };
        assert b12 - b11 == bag&lt;int&gt; { 3, 4 };
        assert b11 - b12 == bag&lt;int&gt; { 1, 2 };
        assert b13 * b14 == bag&lt;int&gt; { 2, 3 };
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="examples-1">Examples</h3>
<p><code>TODO</code></p>
<h2 id="map">Map</h2>
<p>Maps are an unordered, collection of key/value pairs with unique keys. Maps are finite and immutable (i.e. once created they cannot be altered).</p>
<p>A map can be constructed using the syntax <code>map&lt;K,V&gt; { k1 -&gt; v1, k2 -&gt; v2, ...}</code>. This syntax constructs a map with keys/value pairs <code>(k1, v1)</code> and <code>(k2, v2)</code> (of type <code>K</code> and type <code>V</code> respectively). An empty map can be constructed by declaring no key/value pair.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">map&lt;int, boolean&gt; m1 = map&lt;int,boolean&gt;{1 -&gt; true, 2 -&gt; true, 0 -&gt; false};
map&lt;int, boolean&gt; m2 = map&lt;int,boolean&gt;{1 -&gt; true, 2 -&gt; true, 0 -&gt; false, 1 -&gt; false, 1 -&gt; true};
assert m1 == m2;
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-map-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        map&lt;int, boolean&gt; m1 = map&lt;int,boolean&gt;{1 -&gt; true, 2 -&gt; true, 0 -&gt; false};
        map&lt;int, boolean&gt; m2 = map&lt;int,boolean&gt;{1 -&gt; true, 2 -&gt; true, 0 -&gt; false, 1 -&gt; false, 1 -&gt; true};
        assert m1 == m2;
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Once we have a map, we can query different properties of that map. Given a key <code>k1</code>, we can get its associated value in map <code>m1</code> using the syntax <code>map[k1]</code> or <code>getFromMap(m1, k1)</code>. The cardinality/size of the map can be queried using the syntax <code>|m1|</code> or <code>cardMap(m1)</code>. The size of a map is equivalent to the size of its key set. The key, value and key/value pair sets can be obtained using the functions <code>keysMap(m1)</code>, <code>valuesMap(m1)</code> and <code>itemsMap(m1)</code> respectively.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">map&lt;int, boolean&gt; m1 = map&lt;int,boolean&gt;{1 -&gt; true, 2 -&gt; true, 0 -&gt; false};

assert |m1| == 3;
assert m1[0] == false;
assert m1[1] == true;
assert m1[2] == true;

assert keysMap(m1) == { 1, 2, 0 };
assert valuesMap(m1) == { true, false };
assert tuple&lt;int, boolean&gt; { 0, false } in itemsMap(m1);
assert tuple&lt;int, boolean&gt; { 1, true } in itemsMap(m1);
assert tuple&lt;int, boolean&gt; { 2, true } in itemsMap(m1);
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-map-2
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        map&lt;int, boolean&gt; m1 = map&lt;int,boolean&gt;{1 -&gt; true, 2 -&gt; true, 0 -&gt; false};
        
        assert |m1| == 3;
        assert m1[0] == false;
        assert m1[1] == true;
        assert m1[2] == true;
        
        assert keysMap(m1) == { 1, 2, 0 };
        assert valuesMap(m1) == { true, false };
        assert tuple&lt;int, boolean&gt; { 0, false } in itemsMap(m1);
        assert tuple&lt;int, boolean&gt; { 1, true } in itemsMap(m1);
        assert tuple&lt;int, boolean&gt; { 2, true } in itemsMap(m1);
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>We can add a key/value pair <code>(k4, v4)</code> to the map <code>m4</code> using the syntax <code>m4 + (k4, v4)</code> or <code>buildMap(m4, k4, v4)</code>. If the key was already present in <code>m4</code>, its value gets updated. We can also remove a key <code>k5</code> from a map <code>m5</code> using the function <code>removeFromMap(m1, k1)</code>.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">map&lt;int, int&gt; m1 = map&lt;int,int&gt;{};
map&lt;int, int&gt; m2 = m1 ++ (1, 1) ++ (2, 4) ++ (3, 9);
map&lt;int, int&gt; m3 = removeFromMap(m2, 2);
map&lt;int, int&gt; m4 = removeFromMap(removeFromMap(m3, 3), 1);

assert |m1| == 0;
assert m2[1] == 1;
assert m2[2] == 4;
assert m2[3] == 9;

assert !(2 in keysMap(m3));
assert m3[1] == 1;
assert m3[3] == 9;

assert |m4| == 0;
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-map-3
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        map&lt;int, int&gt; m1 = map&lt;int,int&gt;{};
        map&lt;int, int&gt; m2 = m1 ++ (1, 1) ++ (2, 4) ++ (3, 9);
        map&lt;int, int&gt; m3 = removeFromMap(m2, 2);
        map&lt;int, int&gt; m4 = removeFromMap(removeFromMap(m3, 3), 1);
        
        assert |m1| == 0;
        assert m2[1] == 1;
        assert m2[2] == 4;
        assert m2[3] == 9;
        
        assert !(2 in keysMap(m3));
        assert m3[1] == 1;
        assert m3[3] == 9;
        
        assert |m4| == 0;
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="examples-2">Examples</h3>
<p><code>TODO</code></p>
<h2 id="tuple">Tuple</h2>
<p>A tuple is an ordered, immutable collection containing exactly two elements.</p>
<p>A tuple can be constructed using the syntax <code>tuple&lt;F,S&gt; { fst, snd }</code>. This syntax constructs a tuple with the first value <code>fst</code> of type <code>F</code> and the second value <code>snd</code> of type <code>S</code>. A tuple can also be deconstructed into its first and second value by using the functions <code>getFst(t2)</code> and <code>getSnd(t2)</code> respectively. For example, a tuple <code>t1</code> with values <code>(1, false)</code> is constructed as:</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">tuple&lt;int, boolean&gt; t1 = tuple&lt;int, boolean&gt; { 1, false };
assert getFst(t1) == 1;
assert getSnd(t1) == false;
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-tuple-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        tuple&lt;int, boolean&gt; t1 = tuple&lt;int, boolean&gt; { 1, false };
        assert getFst(t1) == 1;
        assert getSnd(t1) == false;
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="examples-3">Examples</h3>
<p><code>TODO</code></p>
<h2 id="option">Option</h2>
<p>The option data type is a container that either represents the presence of an element in the container or the absence of it.</p>
<p>An option type can be constructed with the constructors <code>Some(e)</code> or <code>None</code>. The constructor <code>Some(e)</code> represents the presence of the value <code>e</code> in the option type and the constructor <code>None</code> represents the absence of an element.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">option&lt;int&gt; o1 = None;
option&lt;int&gt; o2 = Some(3);
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-option-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        option&lt;int&gt; o1 = None;
        option&lt;int&gt; o2 = Some(3);
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Option types can be compared to each other where two options <code>o3</code> and <code>o4</code> are equivalent iff they both contain an element <code>e3</code> and <code>e4</code> respectively and <code>e3</code> equals <code>e4</code>.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">option&lt;int&gt; o3 = Some(6);
option&lt;int&gt; o4 = Some(6);
option&lt;int&gt; o5 = Some(1);
option&lt;int&gt; o6 = None;

assert o3 == o4;
assert o4 != o5;
assert o5 != o6;
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-option-2
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        option&lt;int&gt; o3 = Some(6);
        option&lt;int&gt; o4 = Some(6);
        option&lt;int&gt; o5 = Some(1);
        option&lt;int&gt; o6 = None;
        
        assert o3 == o4;
        assert o4 != o5;
        assert o5 != o6;
        
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="examples-4">Examples</h3>
<p><code>TODO</code></p>
<h2 id="adt-reference">ADT Reference</h2>
<p>The tables below are a reference for all the functions/operations that are defined on the different ADTs.</p>
<h3 id="sequence-1">Sequence</h3>
<table>
<thead>
<tr class="header">
<th>Short Description</th>
<th>Return type</th>
<th>Syntax</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Constructor</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>seq&lt;T&gt; { e1, e2, ... }</code><br>Constructs a sequence with elements of type <code>T</code> initiliazed with values <code>e1</code>, <code>e2</code>, etc. When the sequence is not initialized, an empty sequence is constructed.</td>
</tr>
<tr class="even">
<td>Constructor</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>[ e1, e2, ... ]</code><br>Constructs a sequence with elements of type <code>T</code> initiliazed with values <code>e1</code>, <code>e2</code>, etc. This syntax requires the sequence to be initiliazed.</td>
</tr>
<tr class="odd">
<td>Constructor</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>[t: T ]</code><br>Constructs an empty sequence with element of type <code>T</code></td>
</tr>
<tr class="even">
<td>Length</td>
<td><code>int</code></td>
<td><code>|s1|</code> <br>Returns the length/cardinality of the sequence <code>s1</code></td>
</tr>
<tr class="odd">
<td>Comparison</td>
<td><code>boolean</code></td>
<td><code>s1 == s2</code><br>Returns <code>true</code> if <code>s1</code> and <code>s2</code> are equivalent</td>
</tr>
<tr class="even">
<td>Concatenation</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>s1 + s2</code><br>Denotes the sequence with elements from <code>s1</code> followed by the elements of <code>s2</code></td>
</tr>
<tr class="odd">
<td>Contains</td>
<td><code>boolean</code></td>
<td><code>(e \memberof xs)</code>. True if <code>e</code> is in <code>xs</code>. Note that the parenthesis around the <code>\memberof</code> expression are mandatory.</td>
</tr>
<tr class="even">
<td>Indexing</td>
<td><code>T</code></td>
<td><code>s1[i]</code><br>Returns the element at index <code>i</code> of sequence <code>s1</code></td>
</tr>
<tr class="odd">
<td>Head</td>
<td><code>T</code></td>
<td><code>head(s1)</code><br>Returns the first element of sequence <code>s1</code></td>
</tr>
<tr class="even">
<td>Tail</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>tail(s1)</code><br>Denotes the sequence with the elements from <code>s1</code> excluding the first element</td>
</tr>
<tr class="odd">
<td>Append</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>xs ++ x</code><br>Denotes the sequence with elements of <code>xs</code> appended with the element <code>x</code></td>
</tr>
<tr class="even">
<td>Prepend</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>x::xs</code><br>Denotes the sequence with elements of <code>xs</code> prepended with the element <code>x</code></td>
</tr>
<tr class="odd">
<td>Slicing</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>s1[i..j]</code><br>Denotes the subsequence of sequence <code>s1</code> from index <code>i</code> until index <code>j</code> (exlusive)</td>
</tr>
<tr class="even">
<td>Updating</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>s1[i -&gt; v]</code><br>Denotes the sequence with elements from <code>s1</code> where index <code>i</code> has been updated to value <code>v</code></td>
</tr>
<tr class="odd">
<td>Summation</td>
<td>int</td>
<td><code>(\sum int i; low &lt;=i &amp;&amp; i&lt; up; s1[i]);</code><br>Sum the elements of a sequence of integers <code>s1</code> between the indices <code>low</code> and <code>up</code> (exclusive)</td>
</tr>
</tbody>
</table>
<h3 id="set-1">Set</h3>
<table>
<thead>
<tr class="header">
<th>Short Description</th>
<th>Return type</th>
<th>Syntax</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Constructor</td>
<td><code>set&lt;T&gt;</code></td>
<td><code>set&lt;T&gt; { e1, e2, ... }</code><br>Constructs a set with elements of type <code>T</code> initiliazed with values <code>e1</code>, <code>e2</code>, etc. When the set is not initialized, an empty set is constructed.</td>
</tr>
<tr class="even">
<td>Constructor</td>
<td><code>set&lt;T&gt;</code></td>
<td><code>{ e1, e2, ... }</code><br>Constructs a set with elements of type <code>T</code> initiliazed with values <code>e1</code>, <code>e2</code>, etc. This syntax requires the set to be initiliazed.</td>
</tr>
<tr class="odd">
<td>Constructor</td>
<td><code>set&lt;T&gt;</code></td>
<td><code>{t: T }</code><br>Constructs an empty set with element of type <code>T</code></td>
</tr>
<tr class="even">
<td>Length</td>
<td><code>int</code></td>
<td><code>|s1|</code><br>Returns the length/cardinality of the set <code>s1</code></td>
</tr>
<tr class="odd">
<td>Comparison</td>
<td><code>boolean</code></td>
<td><code>s1 == s2</code><br>Returns <code>true</code> if <code>s1</code> and <code>s2</code> are equivalent</td>
</tr>
<tr class="even">
<td>Membership</td>
<td><code>boolean</code></td>
<td><code>e in s1</code><br>Returns <code>true</code> if the value <code>e</code> is in the set <code>s1</code></td>
</tr>
<tr class="odd">
<td>Set Union</td>
<td><code>set&lt;T&gt;</code></td>
<td><code>s1 + s2</code><br>Denotes the set of all elements from sets <code>s1</code> and <code>s2</code> of the same type <code>T</code></td>
</tr>
<tr class="even">
<td>Set Difference</td>
<td><code>set&lt;T&gt;</code></td>
<td><code>s1 - s2</code><br>Denotes the set of all elements from set <code>s1</code> that are not in set <code>s2</code></td>
</tr>
<tr class="odd">
<td>Subset</td>
<td><code>boolean</code></td>
<td><code>s1 &lt;= s2</code><br>Returns <code>true</code> if set <code>s1</code> is a subset of set <code>s2</code></td>
</tr>
<tr class="even">
<td>Strict Subset</td>
<td><code>boolean</code></td>
<td><code>s1 &lt; s2</code> <br>Returns <code>true</code> if set <code>s1</code> is a strict subset of set <code>s2</code></td>
</tr>
<tr class="odd">
<td>Intersection</td>
<td><code>set&lt;T&gt;</code></td>
<td><code>s1 * s2</code><br>Denotes the set of all elements that are both in sets <code>s1</code> and <code>s2</code></td>
</tr>
<tr class="even">
<td>Set Comprehension</td>
<td><code>set&lt;T&gt;</code></td>
<td><code>set&lt;T&gt; { main | variables; selector }</code><br>Constructs a set of elements of the form <code>main</code> over the quantified variables in <code>variables</code> that match <code>selector</code></td>
</tr>
</tbody>
</table>
<h3 id="bag-1">Bag</h3>
<table>
<thead>
<tr class="header">
<th>Short Description</th>
<th>Return type</th>
<th>Syntax</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Constructor</td>
<td><code>bag&lt;T&gt;</code></td>
<td><code>bag&lt;T&gt; { e1, e2, ... }</code><br>Constructs a bag with elements of type <code>T</code> initiliazed with values <code>e1</code>, <code>e2</code>, etc. When the bag is not initialized, an empty bag is constructed.</td>
</tr>
<tr class="even">
<td>Constructor</td>
<td><code>bag&lt;T&gt;</code></td>
<td><code>b{ e1, e2, ... }</code><br>Constructs a bag with elements of type <code>T</code> initiliazed with values <code>e1</code>, <code>e2</code>, etc. This syntax requires the bag to be initiliazed.</td>
</tr>
<tr class="odd">
<td>Constructor</td>
<td><code>bag&lt;T&gt;</code></td>
<td><code>b{t: T }</code><br>Constructs an empty bag with element of type <code>T</code></td>
</tr>
<tr class="even">
<td>Length</td>
<td><code>int</code></td>
<td><code>|b1|</code><br>Returns the length/cardinality of the bag <code>b1</code></td>
</tr>
<tr class="odd">
<td>Multiplicity</td>
<td><code>int</code></td>
<td><code>e in b1</code><br>Returns the number of occurrences of value <code>e</code> in bag <code>b1</code></td>
</tr>
<tr class="even">
<td>Comparison</td>
<td><code>boolean</code></td>
<td><code>b1 == b2</code><br>Returns <code>true</code> if <code>b1</code> and <code>b2</code> are equivalent</td>
</tr>
<tr class="odd">
<td>Bag Union</td>
<td><code>bag&lt;T&gt;</code></td>
<td><code>b1 + b2</code><br>Denotes the bag of all elements from bags <code>b1</code> and <code>b2</code> of the same type <code>T</code></td>
</tr>
<tr class="even">
<td>Bag Difference</td>
<td><code>bag&lt;T&gt;</code></td>
<td><code>b1 - b2</code><br>Denotes the bag of all elements from bag <code>b1</code> that are not in bag <code>b2</code></td>
</tr>
<tr class="odd">
<td>Subset</td>
<td><code>boolean</code></td>
<td><code>b1 &lt;= b2</code><br>Returns <code>true</code> if bag <code>b1</code> is a subset of bag <code>b2</code></td>
</tr>
<tr class="even">
<td>Strict Subset</td>
<td><code>boolean</code></td>
<td><code>b1 &lt; b2</code> <br>Returns <code>true</code> if bag <code>b1</code> is a strict subset of bag <code>b2</code></td>
</tr>
<tr class="odd">
<td>Intersection</td>
<td><code>bag&lt;T&gt;</code></td>
<td><code>b1 * b2</code><br>Denotes the bag of all elements that are both in bags <code>b1</code> and <code>b2</code></td>
</tr>
</tbody>
</table>
<h3 id="map-1">Map</h3>
<table>
<thead>
<tr class="header">
<th>Short Description</th>
<th>Return type</th>
<th>Syntax</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Constructor</td>
<td><code>map&lt;K,V&gt;</code></td>
<td><code>map&lt;K,V&gt; { k1 -&gt; v1, k2 -&gt; v2, ...}</code><br>Constructs a map with key-value pairs of type <code>K</code> and <code>V</code> respectively initiliazed with pairs <code>k1,v1</code>, <code>k2,v2</code>, etc.</td>
</tr>
<tr class="even">
<td>Build/Add</td>
<td><code>map&lt;K,V&gt;</code></td>
<td><code>buildMap(m1, k1, v1)</code>or <code>m1 + (k1, v1)</code><br>Adds the key/value pair <code>(k1,v1)</code> to the map <code>m1</code>. If the key is already present in <code>m1</code>, update the value of the key.</td>
</tr>
<tr class="odd">
<td>GetByKey</td>
<td><code>V</code></td>
<td><code>getFromMap(m1, k1)</code> or <code>map[k1]</code><br>Gets the value mapped by the key <code>k1</code> from the map <code>m1</code>.</td>
</tr>
<tr class="even">
<td>Remove</td>
<td><code>map&lt;K,V&gt;</code></td>
<td><code>removeFromMap(m1, k1)</code><br>Removes the key <code>k1</code> and its associated value from the map <code>m1</code>.</td>
</tr>
<tr class="odd">
<td>Length</td>
<td><code>int</code></td>
<td><code>cardMap(m1)</code> or <code>|m1|</code><br>Returns the length/cardinality of the map <code>m1</code></td>
</tr>
<tr class="even">
<td>Comparison</td>
<td><code>boolean</code></td>
<td><code>equalsMap(m1, m2)</code> or <code>m1 == m2</code><br>Returns <code>true</code> if the keysets of <code>m1</code> and <code>m2</code> are equivalent and the keys map to the same values.</td>
</tr>
<tr class="odd">
<td>Key Set</td>
<td><code>set&lt;K&gt;</code></td>
<td><code>keysMap(m1)</code><br>Returns a set of keys in map <code>m1</code></td>
</tr>
<tr class="even">
<td>Value Set</td>
<td><code>set&lt;V&gt;</code></td>
<td><code>valuesMap(m1)</code><br>Returns a set of the values in map <code>m1</code></td>
</tr>
<tr class="odd">
<td>Item Set</td>
<td><code>set&lt;tuple&lt;K,V&gt;&gt;</code></td>
<td><code>itemsMap(m1)</code><br>Returns a set of tuples corresponding to the key-value pairs in map <code>m1</code></td>
</tr>
<tr class="even">
<td>Disjoint</td>
<td><code>boolean</code></td>
<td><code>disjointMap(m1, m2)</code><br>Returns <code>true</code> if no key is in both the key set of <code>m1</code> and the key set of <code>m2</code>.</td>
</tr>
</tbody>
</table>
<h3 id="tuple-1">Tuple</h3>
<table>
<thead>
<tr class="header">
<th>Short Description</th>
<th>Return type</th>
<th>Syntax</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Constructor</td>
<td><code>tuple&lt;F,S&gt;</code></td>
<td><code>tuple&lt;F,S&gt; {fst, snd}</code><br>Construct a tuple with first element <code>fst</code> (of type <code>F</code>) and second element <code>snd</code> (of type <code>S</code>)</td>
</tr>
<tr class="even">
<td>Get First Element</td>
<td><code>F</code></td>
<td><code>getFst(t)</code><br> Get the first element of the tuple <code>t</code> (of type <code>tuple&lt;F,S&gt;</code>)</td>
</tr>
<tr class="odd">
<td>Get Second Element</td>
<td><code>S</code></td>
<td><code>getSnd(t)</code><br> Get the second element of the tuple <code>t</code> (of type <code>tuple&lt;F,S&gt;</code>)</td>
</tr>
</tbody>
</table>
<h3 id="option-1">Option</h3>
<table>
<thead>
<tr class="header">
<th>Short Description</th>
<th>Return type</th>
<th>Syntax</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Constructor</td>
<td><code>option&lt;T&gt;</code></td>
<td><code>Some(e)</code><br> Constructs an option which contains the element <code>e</code> of type <code>T</code></td>
</tr>
<tr class="even">
<td>Constructor</td>
<td><code>option&lt;T&gt;</code></td>
<td><code>None</code><br> Returns the option <code>None</code></td>
</tr>
<tr class="odd">
<td>Comparison</td>
<td><code>boolean</code></td>
<td><code>o1 == o2</code> <br> Returns <code>true</code> if the element contained in the option <code>o1</code> is equivalent to the element wrapped in the option <code>o2</code></td>
</tr>
</tbody>
</table>
<h1 id="arrays-and-pointers">Arrays and Pointers</h1>
<p><em>This tutorial explains how to specify arrays and pointers in vercors. Java and PVL support arrays, whereas C and the GPGPU frontends only support pointers. The tutorial assumes you are familiar with arrays and pointers already.</em></p>
<h2 id="array-permissions">Array permissions</h2>
<p>We have learned already how to specify ownership of variables on the heap. Arrays generalize this concept by treating each element of the array as a separate location on the heap. For example, you might specify:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb14-1" title="1"><span class="co">/*@</span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="co">requires ar != null &amp;&amp; ar.length == 3;</span></a>
<a class="sourceLine" id="cb14-3" title="3"><span class="co">context Perm(ar[0], write) ** Perm(ar[1], write) ** Perm(ar[2], write);</span></a>
<a class="sourceLine" id="cb14-4" title="4"><span class="co">*/</span></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="dt">void</span> <span class="fu">example1</span>(<span class="dt">int</span>[] ar);</a></code></pre></div>
<p>This means we require the length to be 3, and require and return permission over each of the elements of the array. Length is treated in a special way here: even though it is a "field", we do not need permission to read it, because the length of an array cannot be changed and it is baked into Vercors.</p>
<p>Of course writing a specific length and manually asserting permission over each location is cumbersome, so we can write a contract that accepts arrays of any length as such:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb15-1" title="1"><span class="co">/*@</span></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="co">requires ar != null;</span></a>
<a class="sourceLine" id="cb15-3" title="3"><span class="co">context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; ar.length; Perm(ar[i], write));</span></a>
<a class="sourceLine" id="cb15-4" title="4"><span class="co">*/</span></a>
<a class="sourceLine" id="cb15-5" title="5"><span class="dt">void</span> <span class="fu">example2</span>(<span class="dt">int</span>[] ar);</a></code></pre></div>
<p>As mentioned in the permissions tutorial, the permissions are combined with <code>**</code> to <code>Perm(ar[0], write) ** Perm(ar[1], write) ** â¦ ** Perm(ar[ar.length-1], write)</code>. Please note the <code>*</code> after <code>forall</code>, which denotes that the body of the forall is combined with separating conjunction (<code>**</code>) and not boolean conjunction (<code>&amp;&amp;</code>).</p>
<p>As you might expect, we can also use forall to specify properties about the values of the array:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb16-1" title="1"><span class="co">/*@</span></a>
<a class="sourceLine" id="cb16-2" title="2"><span class="co">requires ar != null;</span></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="co">context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; ar.length; Perm(ar[i], write));</span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="co">ensures (\forall int i; 0 &lt;= &amp;&amp; i &lt; ar.length; ar[i] == i);</span></a>
<a class="sourceLine" id="cb16-5" title="5"><span class="co">*/</span></a>
<a class="sourceLine" id="cb16-6" title="6"><span class="dt">void</span> <span class="fu">identity</span>(<span class="dt">int</span>[] ar) {</a>
<a class="sourceLine" id="cb16-7" title="7">    <span class="kw">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; ar.<span class="fu">length</span>; i++)</a>
<a class="sourceLine" id="cb16-8" title="8">    <span class="co">/*@</span></a>
<a class="sourceLine" id="cb16-9" title="9"><span class="co">    loop_invariant (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; ar.length; Perm(ar[i], write));</span></a>
<a class="sourceLine" id="cb16-10" title="10"><span class="co">    loop_invariant (\forall int j; 0 &lt;= j &amp;&amp; j &lt; i; ar[j] == j); */</span></a>
<a class="sourceLine" id="cb16-11" title="11">    {</a>
<a class="sourceLine" id="cb16-12" title="12">        ar[i] = i;</a>
<a class="sourceLine" id="cb16-13" title="13">    }</a>
<a class="sourceLine" id="cb16-14" title="14">}</a></code></pre></div>
<h2 id="syntactic-sugar">Syntactic sugar</h2>
<p>Specifying arrays quickly leads to prefix a lot of statements with <code>\forall* int i; 0 &lt;= i &amp;&amp; i &lt; ar.length;</code>, so there is some syntactic sugar. First, you might want to use <code>context_everywhere</code> for the permission specification of the array, so that it is automatically propagates to loop invariants:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb17-1" title="1"><span class="co">/*@</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="co">context_everywhere (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; ar.length; Perm(ar[i], write));</span></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="co">ensures (\forall int i; 0 &lt;= &amp;&amp; i &lt; ar.length; ar[i] == i);</span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="co">*/</span></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="dt">void</span> <span class="fu">identity</span>(<span class="dt">int</span>[] ar) {</a>
<a class="sourceLine" id="cb17-6" title="6">    <span class="kw">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; ar.<span class="fu">length</span>; i++)</a>
<a class="sourceLine" id="cb17-7" title="7">    <span class="co">/*@</span></a>
<a class="sourceLine" id="cb17-8" title="8"><span class="co">    loop_invariant (\forall int j; 0 &lt;= j &amp;&amp; j &lt; i; ar[j] == j); */</span></a>
<a class="sourceLine" id="cb17-9" title="9">    {</a>
<a class="sourceLine" id="cb17-10" title="10">        ar[i] = i;</a>
<a class="sourceLine" id="cb17-11" title="11">    }</a>
<a class="sourceLine" id="cb17-12" title="12">}</a></code></pre></div>
<p>This whole forall* can also be written as <code>Perm(ar[*], write)</code>, which still means write permission over all the elements of the array:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb18-1" title="1"><span class="co">/*@</span></a>
<a class="sourceLine" id="cb18-2" title="2"><span class="co">requires ar != null;</span></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="co">context_everywhere Perm(ar[*], write);</span></a>
<a class="sourceLine" id="cb18-4" title="4"><span class="co">ensures (\forall int i; 0 &lt;= &amp;&amp; i &lt; ar.length; ar[i] == i);</span></a>
<a class="sourceLine" id="cb18-5" title="5"><span class="co">*/</span></a>
<a class="sourceLine" id="cb18-6" title="6"><span class="dt">void</span> <span class="fu">identity</span>(<span class="dt">int</span>[] ar) {</a>
<a class="sourceLine" id="cb18-7" title="7">    <span class="kw">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; ar.<span class="fu">length</span>; i++)</a>
<a class="sourceLine" id="cb18-8" title="8">    <span class="co">/*@</span></a>
<a class="sourceLine" id="cb18-9" title="9"><span class="co">    loop_invariant (\forall int j; 0 &lt;= j &amp;&amp; j &lt; i; ar[j] == j); */</span></a>
<a class="sourceLine" id="cb18-10" title="10">    {</a>
<a class="sourceLine" id="cb18-11" title="11">        ar[i] = i;</a>
<a class="sourceLine" id="cb18-12" title="12">    }</a>
<a class="sourceLine" id="cb18-13" title="13">}</a></code></pre></div>
<p>If you want to specify the length of an array, you can write as well: <code>\array(ar, N)</code> which is equivalent to <code>ar != null &amp;&amp; ar.length == N</code>. More interestingly, there is also <code>\matrix(mat, M, N)</code>, which is equivalent to:</p>
<pre><code>mat != null ** mat.length == M **
(\forall* int i; 0 &lt;= i &amp;&amp; i &lt; M; Perm(mat[i], read)) **
(\forall int i; 0 &lt;= i &amp;&amp; i &lt; M; mat[i].length == N) **
(\forall int i; 0 &lt;= i &amp;&amp; i &lt; M; (\forall int j; 0 &lt;= j &amp;&amp; j &lt; M &amp;&amp; mat[i] == mat[j]; i == j))
</code></pre>
<p>The last line is interesting here. In Java there is no such thing as a true matrix: instead we can make an array of arrays. However, there is nothing preventing you from putting the same row array instance in multiple rows. The last statement says that if we have valid row indices i, j, we know that <code>i != j ==&gt; mat[i] != mat[j]</code> (and the contrapositive).</p>
<h2 id="pointers">Pointers</h2>
<p>Pointers themselves are quite well-supported, but we don't support casting and structs in C, making the end result quite limited. For the support that we do have, pointers can be specified with two constructs: <code>\pointer</code> and <code>\pointer_index</code>.</p>
<p>We write <code>\pointer(p, size, perm)</code> to express that <code>p != NULL</code>, the pointer <code>p</code> is valid from (at least) <code>0</code> to <code>size-1</code>, and we assert <code>perm</code> permission over those locations.</p>
<p>We write <code>\pointer_index(p, index, perm)</code> to express that <code>p != NULL</code>, <code>(p+i)</code> is a valid location, and we have permission <code>perm</code> at that location.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb20-1" title="1"><span class="co">/*@</span></a>
<a class="sourceLine" id="cb20-2" title="2"><span class="co">requires \pointer(a, 10, write);</span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="co">*/</span></a>
<a class="sourceLine" id="cb20-4" title="4"><span class="dt">void</span> test(<span class="dt">int</span> *a) {</a>
<a class="sourceLine" id="cb20-5" title="5">    <span class="co">//@ assert \pointer(a, 10, write);</span></a>
<a class="sourceLine" id="cb20-6" title="6">    <span class="co">//@ assert \pointer(a, 8, write);</span></a>
<a class="sourceLine" id="cb20-7" title="7">    <span class="co">//@ assert (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; 10; \pointer_index(a, i, write));</span></a>
<a class="sourceLine" id="cb20-8" title="8">    <span class="dt">int</span> *b = a+<span class="dv">5</span>;</a>
<a class="sourceLine" id="cb20-9" title="9">    <span class="co">//@ assert a[5] == b[0];</span></a>
<a class="sourceLine" id="cb20-10" title="10">    <span class="co">//@ assert \pointer(b, 5, write);</span></a>
<a class="sourceLine" id="cb20-11" title="11">}</a></code></pre></div>
<h2 id="injectivity-object-arrays-and-efficient-verification">Injectivity, object arrays and efficient verification</h2>
<p><em>This section contains advanced information, and can be skipped on a first read.</em></p>
<p>Due to a technical limitation in the backend of VerCors, the location denoted by a permission expression in a quantified expression must be unique for each binding of the quantifier. For example, if we write:</p>
<!-- test Fail -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Box {
    int value;

    void test() {
        Box box1 = new Box();
        seq&lt;Box&gt; boxes = seq&lt;Box&gt;{box1, box1};
        exhale (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; |boxes|; Perm(boxes[i].value, 1\10));
    }
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases arrays-and-pointers-injectivity-object-arrays-and-efficient-verification-1
//:: verdict Fail
//:: tools silicon
class Box {
    int value;

    void test() {
        Box box1 = new Box();
        seq&lt;Box&gt; boxes = seq&lt;Box&gt;{box1, box1};
        exhale (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; |boxes|; Perm(boxes[i].value, 1\10));
    }
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>This could be correct: we only exhale <code>2\10</code> permission of <code>box1.value</code>. The expression is however not well-formed: <code>i==0</code> and <code>i==1</code> cause the expression <code>boxes[i].value</code> to point to the same location. (Please note that it seems that the error from our backend currently is not propagated correctly. Silicon reports "Receiver of boxes[i].value might not be injective." and VerCors translates this into "ExhaleFailed:InsufficientPermission".)</p>
<p>The reason we refer to this as injectivity, is that we should be able to construct a function that assigns bindings for a location, e.g. for a given <code>Box</code> we can either find a unique <code>i</code> that points to the <code>Box</code>, or the <code>Box</code> does not appear in <code>boxes</code>. That function is the inverse of the expression in the <code>Perm</code>. The truth value of a <code>\forall*</code> carries with it this property of injectivity. This means, for example, that in a method definition a requirement assumes that <code>\forall*</code> statements are injective with repsect to locations, whereas we must prove it in ensures statements. This usually follows directly from a requirement. In method invokations then as per usual it's the opposite: we must prove that <code>\forall*</code> statements in the requirements are injective and may assume it for ensures statements.</p>
<p>This limitation is especially important in for example arrays of objects:</p>
<!-- test Fail -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Box {
    int value;

    requires a != null ** (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; a.length; Perm(a[i], read));
    requires (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; a.length; a[i] != null ** Perm(a[i].value, write));
    void test(Box[] a) {
        
    }

    void foo() {
        Box box = new Box();
        Box[] boxes = new Box[2];
        boxes[0] = box;
        boxes[1] = box;
        test(boxes); // fails
    }
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases arrays-and-pointers-injectivity-object-arrays-and-efficient-verification-2
//:: verdict Fail
//:: tools silicon
class Box {
    int value;

    requires a != null ** (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; a.length; Perm(a[i], read));
    requires (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; a.length; a[i] != null ** Perm(a[i].value, write));
    void test(Box[] a) {
        
    }

    void foo() {
        Box box = new Box();
        Box[] boxes = new Box[2];
        boxes[0] = box;
        boxes[1] = box;
        test(boxes); // fails
    }
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>In common use however we have to know about duplicate elements anyway. For example, in the example above we require <code>write</code> permission over the boxes, so indirectly we already require all the boxes to be distinct. As for the array elements themselves: we have an internal axiom about arrays that expresses exactly that the locations of an array correspond to only one index and one array.</p>
<h1 id="parallel-blocks">Parallel Blocks</h1>
<p>In this section we explain how to verify parallel algorithms by creating parallel blocks in PVL. First, we give an example of a simple method using parallel block. Then, we discuss a more complex example with a barrier inside the parallel block. A barrier is used to synchronize threads inside a parallel block.</p>
<h3 id="simple-parallel-blocks">Simple Parallel Blocks</h3>
<h4 id="parallel-block-without-barrier">Parallel Block without Barrier</h4>
<p>This example shows a simple method that adds two arrays in parallel and stores the result in another array:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/* 1  */ context_everywhere a != null &amp;&amp; b != null &amp;&amp; c != null;
/* 2  */ context_everywhere a.length == size &amp;&amp; b.length == size &amp;&amp; c.length == size;
/* 3  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(a[i], 1\2));
/* 4  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(b[i], 1\2));
/* 5  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(c[i], 1));
/* 6  */ ensures (\forall int i; i &gt;= 0 &amp;&amp;  i &lt; size; c[i] == a[i] + b[i]);
/* 7  */ void Add(int[] a, int[] b, int[] c, int size){
/* 8  */
/* 9  */    par threads (int tid = 0 .. size)
/* 10 */     context Perm(a[tid], 1\2) ** Perm(b[tid], 1\2) ** Perm(c[tid], 1);
/* 11 */     ensures c[tid] == a[tid] + b[tid];
/* 12 */    {
/* 13 */       c[tid] = a[tid] + b[tid];
/* 14 */    }
/* 15 */  }
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases parallel-blocks-?-simple-parallel-blocks-parallel-block-without-barrier-1
//:: verdict Pass
//:: tools silicon
class Test {
    /* 1  */ context_everywhere a != null &amp;&amp; b != null &amp;&amp; c != null;
    /* 2  */ context_everywhere a.length == size &amp;&amp; b.length == size &amp;&amp; c.length == size;
    /* 3  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(a[i], 1\2));
    /* 4  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(b[i], 1\2));
    /* 5  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(c[i], 1));
    /* 6  */ ensures (\forall int i; i &gt;= 0 &amp;&amp;  i &lt; size; c[i] == a[i] + b[i]);
    /* 7  */ void Add(int[] a, int[] b, int[] c, int size){
    /* 8  */
    /* 9  */    par threads (int tid = 0 .. size)
    /* 10 */     context Perm(a[tid], 1\2) ** Perm(b[tid], 1\2) ** Perm(c[tid], 1);
    /* 11 */     ensures c[tid] == a[tid] + b[tid];
    /* 12 */    {
    /* 13 */       c[tid] = a[tid] + b[tid];
    /* 14 */    }
    /* 15 */  }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>In this method there is a parallel block (lines 9-14) named "<em>threads</em>". The keyword "<em>par</em>" is used to define a parallel block, followed by an arbitrary name after that defines the name of that block. Moreover, we define the number of threads in the parallel block as well as a name for the thread identifier. In this example, we have "<em>size</em>" threads in the range from 0 to "<em>size</em>-1" and "<em>tid</em>" is used as thread identifier to refer to each thread.</p>
<p>In addition to the specification of the method (lines 1-6), we add thread-level specification to the parallel block (lines 10-11). The precondition of the method indicates that we have read permission over all locations in arrays "<em>a</em>" and "<em>b</em>" and write permission for array "<em>c</em>" (lines 3-5). In the parallel block, we specify that each thread ("<em>tid</em>") has read permission to its own location in arrays "<em>a</em>" and "<em>b</em>" and write permission to its own location in array "<em>c</em>" (line 10). After termination of the parallel block as postcondition (1) we have the same permission (line 10) and (2) the result of each location in array "<em>c</em>" is the sum of the two corresponding locations in arrays "<em>a</em>" and "<em>b</em>" (line 11). From the postcondition of the parallel block, we can derive the postcondition of the method using universal quantifier for all locations in the arrays (line 3-6).</p>
<h4 id="parallel-block-with-barrier">Parallel Block with Barrier</h4>
<p>Next we show an example of a parallel block which uses a barrier to synchronize threads:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/* 1  */ context_everywhere array != null &amp;&amp; array.length == size;
/* 2  */ requires (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(array[i], write));
/* 3  */ ensures (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(array[i], write));
/* 4  */ ensures (\forall int i; i &gt;= 0 &amp;&amp;  i &lt; size; (i != size-1 ==&gt; array[i] == \old(array[i+1])) &amp;&amp; 
/* 5  */                                              (i == size-1 ==&gt; array[i] == \old(array[0])) );
/* 6  */ void leftRotation(int[] array, int size){
/* 7  */
/* 8  */   par threads (int tid = 0 .. size)
/* 9  */    requires tid != size-1 ==&gt; Perm(array[tid+1], write);
/* 10 */    requires tid == size-1 ==&gt; Perm(array[0], write);
/* 11 */    ensures Perm(array[tid], write);
/* 12 */    ensures tid != size-1 ==&gt; array[tid] == \old(array[tid+1]);
/* 13 */    ensures tid == size-1 ==&gt; array[tid] == \old(array[0]);
/* 14 */   {
/* 15 */      int temp;
/* 16 */      if (tid != size-1) {
/* 17 */        temp = array[tid+1];
/* 18 */      } else {
/* 19 */        temp = array[0];
/* 20 */      }
/* 21 */
/* 22 */      barrier(threads)
/* 23 */      requires tid != size-1 ==&gt; Perm(array[tid+1], write);
/* 24 */      requires tid == size-1 ==&gt; Perm(array[0], write);
/* 25 */      ensures Perm(array[tid], write);
/* 26 */      { /* Automatic proof */ }
/* 27 */
/* 28 */      array[tid] = temp;
/* 29 */   }
/* 30 */ }
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases parallel-blocks-?-simple-parallel-blocks-parallel-block-with-barrier-1
//:: verdict Pass
//:: tools silicon
class Test {
    /* 1  */ context_everywhere array != null &amp;&amp; array.length == size;
    /* 2  */ requires (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(array[i], write));
    /* 3  */ ensures (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(array[i], write));
    /* 4  */ ensures (\forall int i; i &gt;= 0 &amp;&amp;  i &lt; size; (i != size-1 ==&gt; array[i] == \old(array[i+1])) &amp;&amp; 
    /* 5  */                                              (i == size-1 ==&gt; array[i] == \old(array[0])) );
    /* 6  */ void leftRotation(int[] array, int size){
    /* 7  */
    /* 8  */   par threads (int tid = 0 .. size)
    /* 9  */    requires tid != size-1 ==&gt; Perm(array[tid+1], write);
    /* 10 */    requires tid == size-1 ==&gt; Perm(array[0], write);
    /* 11 */    ensures Perm(array[tid], write);
    /* 12 */    ensures tid != size-1 ==&gt; array[tid] == \old(array[tid+1]);
    /* 13 */    ensures tid == size-1 ==&gt; array[tid] == \old(array[0]);
    /* 14 */   {
    /* 15 */      int temp;
    /* 16 */      if (tid != size-1) {
    /* 17 */        temp = array[tid+1];
    /* 18 */      } else {
    /* 19 */        temp = array[0];
    /* 20 */      }
    /* 21 */
    /* 22 */      barrier(threads)
    /* 23 */      requires tid != size-1 ==&gt; Perm(array[tid+1], write);
    /* 24 */      requires tid == size-1 ==&gt; Perm(array[0], write);
    /* 25 */      ensures Perm(array[tid], write);
    /* 26 */      { /* Automatic proof */ }
    /* 27 */
    /* 28 */      array[tid] = temp;
    /* 29 */   }
    /* 30 */ }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>This example illustrates a method named "<em>leftRotation</em>" that rotates the elements of an array to the left. In this example, we also have "<em>size</em>" threads in the range from 0 to "<em>size</em>-1" and "<em>tid</em>" is used as thread identifier. Inside the parallel block each thread ("<em>tid</em>") stores its right neighbor in a temporary location (i.e., "<em>temp</em>"), except thread "<em>size</em>-1" which stores the first element in the array (lines 15-20). Then each thread synchronizes at the barrier (line 22). The keyword "<em>barrier</em>" and the name of the parallel block as an argument (e.g., "<em>threads</em>" in the example) are used to define a barrier in PVL. After that, each thread writes the value read into its own location at index "<em>tid</em>" in the array (line 28).</p>
<p>To verify this method in VerCors, we annotate the barrier, in addition to the method and the parallel block. As precondition of the method, we have read permission over all locations in the array (line 2). At the beginning of the parallel block, each thread reads from its right neighbor, except thread "<em>size</em>-1" which reads from location 0 (lines 16-20). Therefore, we specify read permissions as precondition of the parallel block in lines 9-10. Since after the barrier each thread ("<em>tid</em>") writes into its own location at index ("<em>tid</em>"), we change the permissions in the barrier in such that each thread has write permissions to its own location (lines 23-25). When a thread reaches the barrier, it has to fulfill the barrier preconditions, and then it may assume the barrier postconditions. Moreover, the barrier postconditions must follow from the barrier preconditions.</p>
<p>As postcondition of the parallel block (1) first each thread has write permission to its own location (this comes from the postcondition of the barrier) in line 11 and (2) the elements are truly shifted to the left (lines 12-13). From the postcondition of the parallel block, we can establish the same postcondition for the method (lines 3-5).</p>
<h4 id="caution-barrier-syntax">Caution: barrier syntax</h4>
<p>In this chapter syntax is introduced for barriers. There is a caveat to using barriers, which we want to explain first so it is not missed. Barrier syntax in VerCors has two forms. Form 1:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb21-1" title="1">barrier(barrierName) {</a>
<a class="sourceLine" id="cb21-2" title="2">  requires P;</a>
<a class="sourceLine" id="cb21-3" title="3">  ensures Q;</a>
<a class="sourceLine" id="cb21-4" title="4">}</a></code></pre></div>
<p>Form 2:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb22-1" title="1">barrier(barrierName)</a>
<a class="sourceLine" id="cb22-2" title="2">  requires P;</a>
<a class="sourceLine" id="cb22-3" title="3">  ensures Q;</a>
<a class="sourceLine" id="cb22-4" title="4">{ }</a></code></pre></div>
<p>Notice how in form 1, the contract is inside the curly braces. In form 2, the contract resides between the barrier declaration and the curly braces.</p>
<p>There is a <em>big</em> difference between these two syntaxes. In form 1, the contract of the barrier <em>is not actually checked</em> by VerCors. This means that if you would add <code>ensures false;</code> to your barrier using the syntax of form 1, VerCors will not indicate this is a problematic contract. For form 2, however, the contract <em>is actually checked</em>. Therefore, when using barriers, form 2 should be preferred. Form 1 should only be used if there is a proof external to VerCors.</p>
<h3 id="complicated-parallel-blocks">Complicated Parallel Blocks</h3>
<h4 id="nested-parallel-blocks">Nested Parallel Blocks</h4>
<p>In the previous examples, we defined a parallel block of threads to work on one-dimensional arrays. It is also possible to define two-dimensional thread layouts to work on two-dimensional arrays. As an example we define a two-dimensional thread layout to transpose a matrix in parallel:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">context_everywhere inp != null &amp;&amp; out != null; /// &amp;&amp; out == size;
context_everywhere inp.length == size &amp;&amp; out.length == size; 
context_everywhere (\forall int i; 0 &lt;= i &amp;&amp; i &lt; size; inp[i].length == size &amp;&amp; out[i].length == size);
context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
         (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(inp[i][j], read)));
context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
         (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(out[i][j], write)));
ensures (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
         (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; out[i][j] == inp[j][i]));
void transpose(int[][] inp, int[][] out, int size){

  par threadX (int tidX = 0 .. size)
   context (\forall* int i; i &gt;= 0 &amp;&amp; i &lt; size; Perm(inp[i][tidX], read));
   context (\forall* int i; i &gt;= 0 &amp;&amp; i &lt; size; Perm(out[tidX][i], write));
   ensures (\forall int i; i &gt;= 0 &amp;&amp; i &lt; size; out[tidX][i] == inp[i][tidX]);
  {
    par threadY (int tidY = 0 .. size)
     context Perm(inp[tidY][tidX], read);
     context Perm(out[tidX][tidY], write);
     ensures out[tidX][tidY] == inp[tidY][tidX];
    {
      out[tidX][tidY] = inp[tidY][tidX]; 
    } 
  }
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases parallel-blocks-?-complicated-parallel-blocks-nested-parallel-blocks-1
//:: verdict Pass
//:: tools silicon
class Test {
    context_everywhere inp != null &amp;&amp; out != null; /// &amp;&amp; out == size;
    context_everywhere inp.length == size &amp;&amp; out.length == size; 
    context_everywhere (\forall int i; 0 &lt;= i &amp;&amp; i &lt; size; inp[i].length == size &amp;&amp; out[i].length == size);
    context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
             (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(inp[i][j], read)));
    context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
             (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(out[i][j], write)));
    ensures (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
             (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; out[i][j] == inp[j][i]));
    void transpose(int[][] inp, int[][] out, int size){
    
      par threadX (int tidX = 0 .. size)
       context (\forall* int i; i &gt;= 0 &amp;&amp; i &lt; size; Perm(inp[i][tidX], read));
       context (\forall* int i; i &gt;= 0 &amp;&amp; i &lt; size; Perm(out[tidX][i], write));
       ensures (\forall int i; i &gt;= 0 &amp;&amp; i &lt; size; out[tidX][i] == inp[i][tidX]);
      {
        par threadY (int tidY = 0 .. size)
         context Perm(inp[tidY][tidX], read);
         context Perm(out[tidX][tidY], write);
         ensures out[tidX][tidY] == inp[tidY][tidX];
        {
          out[tidX][tidY] = inp[tidY][tidX]; 
        } 
      }
    }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>As we can see defining nested parallel blocks allow us to define thread layout in different dimensions. We can simplify the above example syntactically into one parallel block:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">context_everywhere inp != null &amp;&amp; out != null;
context_everywhere inp.length == size &amp;&amp; out.length == size; 
context_everywhere (\forall int i; 0 &lt;= i &amp;&amp; i &lt; size; inp[i].length == size &amp;&amp; out[i].length == size);
context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
         (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(inp[i][j], read)));
context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
         (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(out[i][j], write)));
ensures (\forall int i; 0 &lt;= i &amp;&amp; i &lt; size; 
         (\forall int j; 0 &lt;= j &amp;&amp; j &lt; size; out[i][j] == inp[j][i]));
void transpose(int[][] inp, int[][] out, int size){

  par threadXY (int tidX = 0 .. size, int tidY = 0 .. size)
   context Perm(inp[tidY][tidX], read);
   context Perm(out[tidX][tidY], write);
   ensures out[tidX][tidY] == inp[tidY][tidX];
  {
    out[tidX][tidY] = inp[tidY][tidX]; 
  } 
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases parallel-blocks-?-complicated-parallel-blocks-nested-parallel-blocks-2
//:: verdict Pass
//:: tools silicon
class Test {
    context_everywhere inp != null &amp;&amp; out != null;
    context_everywhere inp.length == size &amp;&amp; out.length == size; 
    context_everywhere (\forall int i; 0 &lt;= i &amp;&amp; i &lt; size; inp[i].length == size &amp;&amp; out[i].length == size);
    context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
             (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(inp[i][j], read)));
    context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
             (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(out[i][j], write)));
    ensures (\forall int i; 0 &lt;= i &amp;&amp; i &lt; size; 
             (\forall int j; 0 &lt;= j &amp;&amp; j &lt; size; out[i][j] == inp[j][i]));
    void transpose(int[][] inp, int[][] out, int size){
    
      par threadXY (int tidX = 0 .. size, int tidY = 0 .. size)
       context Perm(inp[tidY][tidX], read);
       context Perm(out[tidX][tidY], write);
       ensures out[tidX][tidY] == inp[tidY][tidX];
      {
        out[tidX][tidY] = inp[tidY][tidX]; 
      } 
    }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h4 id="simultaneous-parallel-blocks">Simultaneous Parallel Blocks</h4>
<p>There might be some scenarios that we have multiple parallel blocks and all threads in each parallel block are working in disjoint memory locations. In this case we can define multiple parallel blocks to run simultaneously. That means, threads in each parallel block run independently of other threads in different parallel blocks. Below is an example of such a scenario:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/* 1  */ context_everywhere a != null &amp;&amp; b != null &amp;&amp; c != null;
/* 2  */ context_everywhere a.length == size &amp;&amp; b.length == size &amp;&amp; c.length == size; 
/* 3  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(a[i], write));
/* 4  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(b[i], write));
/* 5  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(c[i], write));
/* 6  */ ensures (\forall int i; i &gt;= 0 &amp;&amp;  i &lt; size; a[i] == \old(a[i]) + 1 &amp;&amp; b[i] == \old(b[i]) + 1 &amp;&amp; 
/* 7  */                                              c[i] == \old(c[i]) + 1);
/* 8  */ void simPar(int[] a, int[] b, int[] c, int size){
/* 9  */
/* 10 */   par thread1 (int tid1 = 0 .. size)
/* 11 */    context Perm(a[tid1], write);
/* 12 */    ensures a[tid1] == \old(a[tid1]) + 1;
/* 13 */   {
/* 14 */     a[tid1] = a[tid1] + 1; 
/* 15 */   } and
/* 16 */   thread2 (int tid2 = 0 .. size)
/* 17 */    context Perm(b[tid2], write);
/* 18 */    ensures b[tid2] == \old(b[tid2]) + 1;
/* 19 */   {
/* 20 */     b[tid2] = b[tid2] + 1;
/* 21 */   } and
/* 22 */   thread3 (int tid3 = 0 .. size)
/* 23 */    context Perm(c[tid3], write);
/* 24 */    ensures c[tid3] == \old(c[tid3]) + 1;
/* 25 */   {
/* 26 */     c[tid3] = c[tid3] + 1;
/* 27 */   }
/* 28 */ }
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases parallel-blocks-?-complicated-parallel-blocks-simultaneous-parallel-blocks-1
//:: verdict Pass
//:: tools silicon
class Test {
    /* 1  */ context_everywhere a != null &amp;&amp; b != null &amp;&amp; c != null;
    /* 2  */ context_everywhere a.length == size &amp;&amp; b.length == size &amp;&amp; c.length == size; 
    /* 3  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(a[i], write));
    /* 4  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(b[i], write));
    /* 5  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(c[i], write));
    /* 6  */ ensures (\forall int i; i &gt;= 0 &amp;&amp;  i &lt; size; a[i] == \old(a[i]) + 1 &amp;&amp; b[i] == \old(b[i]) + 1 &amp;&amp; 
    /* 7  */                                              c[i] == \old(c[i]) + 1);
    /* 8  */ void simPar(int[] a, int[] b, int[] c, int size){
    /* 9  */
    /* 10 */   par thread1 (int tid1 = 0 .. size)
    /* 11 */    context Perm(a[tid1], write);
    /* 12 */    ensures a[tid1] == \old(a[tid1]) + 1;
    /* 13 */   {
    /* 14 */     a[tid1] = a[tid1] + 1; 
    /* 15 */   } and
    /* 16 */   thread2 (int tid2 = 0 .. size)
    /* 17 */    context Perm(b[tid2], write);
    /* 18 */    ensures b[tid2] == \old(b[tid2]) + 1;
    /* 19 */   {
    /* 20 */     b[tid2] = b[tid2] + 1;
    /* 21 */   } and
    /* 22 */   thread3 (int tid3 = 0 .. size)
    /* 23 */    context Perm(c[tid3], write);
    /* 24 */    ensures c[tid3] == \old(c[tid3]) + 1;
    /* 25 */   {
    /* 26 */     c[tid3] = c[tid3] + 1;
    /* 27 */   }
    /* 28 */ }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>As we can see we use "<em>and</em>" between each parallel block (lines 15 and 21) to define simultaneous parallel blocks. This construction can be used in a situation where we decide to run simultaneous instructions. That means, we do not define threads in the parallel blocks, but the par blocks run simultaneously. Below is an example in this situation where "<em>a</em>", "<em>b</em>" and "<em>c</em>" are objects included a field "<em>val</em>":</p>
<!-- test -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class HasVal {
    int val;
}

class Main {
    context Perm(a.val, write) ** Perm(b.val, write) ** Perm(c.val, write);
    ensures a.val == \old(a.val) + 1 &amp;&amp; b.val == \old(b.val) + 1 &amp;&amp; c.val == \old(c.val) + 1;                                            
    void IncPar(HasVal a, HasVal b, HasVal c){
      par 
       context Perm(a.val, write);
       ensures a.val == \old(a.val) + 1;
      {
        a.val = a.val + 1; 
      } and
       context Perm(b.val, write);
       ensures b.val == \old(b.val) + 1;
      {
        b.val = b.val + 1;
      } and
       context Perm(c.val, write);
       ensures c.val == \old(c.val) + 1;
      {
        c.val = c.val + 1;
      }
    }
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases parallel-blocks-?-complicated-parallel-blocks-simultaneous-parallel-blocks-2
//:: verdict Pass
//:: tools silicon
class HasVal {
    int val;
}

class Main {
    context Perm(a.val, write) ** Perm(b.val, write) ** Perm(c.val, write);
    ensures a.val == \old(a.val) + 1 &amp;&amp; b.val == \old(b.val) + 1 &amp;&amp; c.val == \old(c.val) + 1;                                            
    void IncPar(HasVal a, HasVal b, HasVal c){
      par 
       context Perm(a.val, write);
       ensures a.val == \old(a.val) + 1;
      {
        a.val = a.val + 1; 
      } and
       context Perm(b.val, write);
       ensures b.val == \old(b.val) + 1;
      {
        b.val = b.val + 1;
      } and
       context Perm(c.val, write);
       ensures c.val == \old(c.val) + 1;
      {
        c.val = c.val + 1;
      }
    }
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>In the above example, for each object we increase its "<em>val</em>" by one in parallel. As we can see, thread blocks are without names and thread identifiers in this case.</p>
<h1 id="atomics-and-locks">Atomics and Locks</h1>
<!--

## Example folders of interest for atomics/locks writing

- atomics
    - Only chalice examples, should these be deleted?
    - Or maybe ported?
- synchronizers
    - Only chalice examples, delete or port?
- parallel
- carp
- demo
- futures
- layers
    - Java6Lock.java?
    - Some still use "Value" instead of "read"
- waitnotify
- manual
    - Worker.pvl?
    - OwickiGries.java?

## Subjects

- General:
    - `lock_invariant`
        - explain where the lock_invariant holds/can be used as an assumption, e.g. before/after wait this, lock this, unlock this, notify this
- Advanced:
    - "Atomic..." syntax?
        - This is used in the "Layers" paper, so also in the layers example folder
        - Seems to work for both Java & PVL
        - For the Java syntax, maybe require "synchronized"?
- PVL:
    - lock x/unlock x
    - invariant inv(assertion) { ... }
    - atomic(inv) { ... }
    - wait/notify
- Java
    - synchronized

-->

<p>VerCors supports three forms of synchronization primitives. Two can only be used in PVL, one can only be used in Java. Each form will be discussed individually.</p>
<h2 id="pvl-intrinsic-locks">PVL: Intrinsic locks</h2>
<!-- 

- 3 parts:
    - lock invariant
    - lock statement
    - unlock statement
- lock invariant
    - specified on a class, therefore tied to an object instance
    - could be, permission for a field, and field > 2
    - established at end of constructor
- lock statement
    - gives access to the lock invariant
    - relies on runtime guarantee: exclusive access
        - blocks if lock is not available
- unlock statement
    - releases the lock
    - before release, the lock invariant must be established again
        - this ensures that the next time a thread acquires the lock, the lock invariant can be assumed
    - runtime guarantee: other threads can now acquire the lock
- caveats:
    - locks cannot be locked in the constructor, but vercors does not check for this
    - non-reentrant: deadlock if acquired twice
    - some interleavings might deadlock; vercors does not check for this either

-->

<p>Intrinsic locking in PVL consists of three parts:</p>
<ul>
<li>Lock invariants</li>
<li>The <code>lock</code> statement</li>
<li>The <code>unlock</code> statement</li>
</ul>
<h3 id="lock-invariants">Lock invariants</h3>
<p>A lock invariant can be defined within a class with the following syntax:</p>
<pre class="pvl"><code>class C {
    ...
    resource lock_invariant() = /* resource expression involving permissions and boolean assertions */ ;
    ...
}
</code></pre>
<p>This syntax is very similar to the syntax used for defining predicates. You can find more info about predicates <a href="https://github.com/utwente-fmt/vercors/wiki/Predicates">here</a>. However, knowledge of predicates is not needed to understand and use locks in VerCors.</p>
<p>Because a lock invariant is defined in a class, it is always related to a specific class instance. Therefore, it is possible to make assertions about instance fields in the lock invariant. For example, a lock invariant could be specified that contains the permissions for a field, and also the fact that that field must have a value greater than 10, using the following syntax:</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class C {
    int f;

    resource lock_invariant() = Perm(f, write) ** f &gt; 10;
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases atomics-and-locks-pvl-intrinsic-locks-lock-invariants-1
//:: verdict Pass
//:: tools silicon
class C {
    int f;

    resource lock_invariant() = Perm(f, write) ** f &gt; 10;
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>A lock</p>
<h2 id="pvl-atomics">PVL: Atomics</h2>
<h2 id="java-synchronized">Java: Synchronized</h2>
<h1 id="process-algebra-models">Process Algebra Models</h1>
<p>TODO @Raul (Histories + Futures)</p>
<h1 id="predicates">Predicates</h1>
<!-- 
* Why predicates?
  * Permissions are useful for indicating access rights and modifications to data
  * But this leaks implementation details
  * Consider the following example
    * It is clear that the counter class modifies some internal state to the client
    * But when the counter changes implementation, client code will have to be modified as well
  * It is desirable that permissions are managed such that client code does not depend on irrelevant details
  * Predicates allow this.
* Predicate syntax and usage
  * A predicate is defined as follows
    * Consists of arguments and a body where arguments can be used
  * To gain a predicate, the contents of the body must be exchanged for a predicate instance
    * This is called "folding"
  * A predicate can also be "unfolded"
    * This exchanges a predicate instance for its body
* Previous example, with predicates
  * Note how the counter class is now free to change its internal composition
  * Only relevant details are exposed through the predicate
    * In this case, the value of the counter
* Reserved/internal predicates
  * ```lock_invariant```
    * See atomics/locks
  * Threads
    * held, idle, running
    * See PVL-Syntax
* Advanced usage
  * Recursive predicates
  * Scaling & splitting
  * Inline predicates
  * Inheritance
* Known problems
  * Using predicates in while loops
-->

<p>This section discusses syntax and semantics of predicates. First a motivating example is given why predicates are needed. Then an overview is given of the syntax and semantics of predicates. The introductory example is then rewritten using predicates. Finally, we discuss some internal and reserved predicates, and finish this part of the tutorial with a brief overview of advanced usages of predicates and known problems.</p>
<p>In this section, the language used for the code examples is Java. However, the concepts presented apply to PVL as well.</p>
<h2 id="why-predicates">Why predicates?</h2>
<p>Permissions are useful for indicating access rights and modifications to data. But, adding permissions to private members in the contract leaks implementation details. Consider the following example:</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Counter {
  int count;
  
  //@ context Perm(count, write);
  //@ ensures count == \old(count) + n;
  void increment(int n);
}

class MyProgram {
  //@ requires c != null;
  //@ requires Perm(c.count, write);
  //@ requires c.count == 0;
  void foo(Counter c) {
    //@ assert c.count == 0;
    c.increment(2);
    //@ assert c.count == 2;
  }
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-why-predicates-1
//:: verdict Pass
//:: tools silicon
class Counter {
  int count;
  
  //@ context Perm(count, write);
  //@ ensures count == \old(count) + n;
  void increment(int n);
}

class MyProgram {
  //@ requires c != null;
  //@ requires Perm(c.count, write);
  //@ requires c.count == 0;
  void foo(Counter c) {
    //@ assert c.count == 0;
    c.increment(2);
    //@ assert c.count == 2;
  }
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>It is clear from the contract of <code>increment</code> that it modifies the internal state of the <code>Counter</code> object. Therefore, when <code>Counter</code> changes its internal layout, client code will have to be modified as well. For example, if in the previous example <code>Counter</code> adds some internal field, the client code will also have to be changed. This is shown in the next example:</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class CounterExtended {
  int count;
  int numIncrements;
  
  //@ context Perm(count, write) ** Perm(numIncrements, write);
  //@ ensures count == \old(count) + n;
  //@ ensures numIncrements == \old(numIncrements) + 1;
  void increment(int n);
}

class MyProgram {
  //@ requires c != null;
  //@ requires Perm(c.count, write) ** Perm(c.numIncrements, write);
  //@ requires c.count == 0;
  void foo(CounterExtended c) {
    //@ assert c.count == 0;
    c.increment(2);
    //@ assert c.count == 2;
  }
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-why-predicates-2
//:: verdict Pass
//:: tools silicon
class CounterExtended {
  int count;
  int numIncrements;
  
  //@ context Perm(count, write) ** Perm(numIncrements, write);
  //@ ensures count == \old(count) + n;
  //@ ensures numIncrements == \old(numIncrements) + 1;
  void increment(int n);
}

class MyProgram {
  //@ requires c != null;
  //@ requires Perm(c.count, write) ** Perm(c.numIncrements, write);
  //@ requires c.count == 0;
  void foo(CounterExtended c) {
    //@ assert c.count == 0;
    c.increment(2);
    //@ assert c.count == 2;
  }
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>It is desirable that permissions are managed such that client code does not depend on irrelevant details, to avoid this rippling effect of modifications. Predicates help with this.</p>
<h2 id="predicate-syntax-and-usage">Predicate syntax and usage</h2>
<p>A predicate is declared as follows:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb24-1" title="1"><span class="co">//@ resource myPredicate(int a, bool b, ...) = body;</span></a></code></pre></div>
<p>A predicate consists of the name of the predicate, zero or more arguments, and a body where arguments can be used. In Java, the declaration must be written as a verification annotation (e.g. using <code>//@</code>). In PVL, it is a plain declaration.</p>
<p>One can think of a predicate as a function returning type <code>resource</code>, similar to how a permission (<code>Perm</code>) is a <code>resource</code>. Except that, predicates are never called, but created and destroyed using unfold and folds. We will explain this next.</p>
<p>To create a predicate instance, the contents of the predicate body must be exchanged for a predicate instance. This is called "folding". Specifically, folding a predicate means any permissions present in the predicate body are removed from the program state. In return, an instance of the predicate is added to the state. In the following example folding is shown. The method <code>foo</code> receives a permission for the field <code>x</code>. At the end of the method, the permission for this field <code>x</code> has been exchanged for an instance of the predicate <code>state</code>. Note how the permission for <code>x</code> and the predicate <code>state</code> are mutually exclusive: both cannot be in the program state simultaneously.</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">int x;

//@ resource state(int val) = Perm(x, write) ** x == val;

//@ requires Perm(x, write) ** x == n;
//@ ensures state(n);
void foo(int n) {
    // Now we have Perm(x, write).
    //@ fold state(n);
    // Now Perm(x, write) is gone, but state(n) is present.
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-predicate-syntax-and-usage-1
//:: verdict Pass
//:: tools silicon
final class Test {
    int x;
    
    //@ resource state(int val) = Perm(x, write) ** x == val;
    
    //@ requires Perm(x, write) ** x == n;
    //@ ensures state(n);
    void foo(int n) {
        // Now we have Perm(x, write).
        //@ fold state(n);
        // Now Perm(x, write) is gone, but state(n) is present.
    }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>A predicate can also be "unfolded". This exchanges a predicate instance for its body.</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">int x;

//@ resource state(int val) = Perm(x, write) ** x == val;

//@ requires state(n);
//@ ensures Perm(x, write) ** x == n;
void foo(int n) {
    // Now we have state(n);
    //@ unfold state(n);
    // Now state(n) is gone, but Perm(x, write) is present.
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-predicate-syntax-and-usage-2
//:: verdict Pass
//:: tools silicon
final class Test {
    int x;
    
    //@ resource state(int val) = Perm(x, write) ** x == val;
    
    //@ requires state(n);
    //@ ensures Perm(x, write) ** x == n;
    void foo(int n) {
        // Now we have state(n);
        //@ unfold state(n);
        // Now state(n) is gone, but Perm(x, write) is present.
    }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>The previous two examples also show that fields of the current class can be used in the predicate body. This is because a predicate instance is implicitly bound to an instance of the class it is defined in. The following example verifies, because the <code>this</code> part of the predicate instance is implicit. It also shows how to name predicates on objects other than <code>this</code>.</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">final class Cell {
    int x;

    //@ resource state(int val) = Perm(x, write) ** x == val;

    // &#34;this&#34; is implicit:
    //@ requires this.state(n);
    //@ ensures state(n);
    void foo(int n) {

    }

    // Predicates can appear on distinct objects too:
    //@ given int n;
    //@ given int m;
    //@ context other.state(m);
    //@ requires state(n);
    //@ ensures state(n+m);
    void combine(Cell other) {
        //@ unfold state(n);
        //@ unfold other.state(m);
        x += other.x;
        //@ fold other.state(m);
        //@ fold state(n+m);
    }
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-predicate-syntax-and-usage-3
//:: verdict Pass
//:: tools silicon
final class Cell {
    int x;

    //@ resource state(int val) = Perm(x, write) ** x == val;

    // &#34;this&#34; is implicit:
    //@ requires this.state(n);
    //@ ensures state(n);
    void foo(int n) {

    }

    // Predicates can appear on distinct objects too:
    //@ given int n;
    //@ given int m;
    //@ context other.state(m);
    //@ requires state(n);
    //@ ensures state(n+m);
    void combine(Cell other) {
        //@ unfold state(n);
        //@ unfold other.state(m);
        x += other.x;
        //@ fold other.state(m);
        //@ fold state(n+m);
    }
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Predicates can be used anywhere <code>Perm</code> can be used, and hence must also be composed using the separating conjunction (<code>**</code>) operator.</p>
<h2 id="the-counter-example-now-with-predicates">The <code>Counter</code> example, now with predicates</h2>
<p>In the next snippet we redefine the <code>Counter</code> class to use predicates, instead of plain permissions:</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Counter {
  int count;

  //@ resource state(int val) = Perm(count, write) ** count == val;
  
  //@ given int oldCount;
  //@ requires state(oldCount);
  //@ ensures state(oldCount + n);
  void increment(int n);
}

class MyProgram {
  //@ requires c != null ** c.state(0);
  //@ ensures c.state(2);
  void foo(Counter c) {
    //@ assert c.state(0);
    c.increment(2) /*@ with { oldCount = 0; } @*/;
    //@ assert c.state(2);
  }
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-the-counter-example-now-with-predicates-1
//:: verdict Pass
//:: tools silicon
class Counter {
  int count;

  //@ resource state(int val) = Perm(count, write) ** count == val;
  
  //@ given int oldCount;
  //@ requires state(oldCount);
  //@ ensures state(oldCount + n);
  void increment(int n);
}

class MyProgram {
  //@ requires c != null ** c.state(0);
  //@ ensures c.state(2);
  void foo(Counter c) {
    //@ assert c.state(0);
    c.increment(2) /*@ with { oldCount = 0; } @*/;
    //@ assert c.state(2);
  }
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>The client only uses the predicate when expressing how it manipulates the counter. Therefore, the counter class is now free to change its internal composition without affecting any of its clients. This is possible because only relevant details are exposed through the predicate. In this case, this is the value of the counter. For example, adding a plain field does not break the client.</p>
<p>If the interface of <code>Counter</code> changes, the client code will have to change too. However, the client code does not have to manage any extra permissions: it only has to specify how it uses the interface from <code>CounterExtended</code>. The next example shows this.</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class CounterExtended {
  int count;
  int numIncrements;

  /*@ resource state(int val, int val2) = Perm(count, write) ** count == val 
        ** Perm(numIncrements, write) ** numIncrements == val2;
    @*/
  
  //@ given int oldCount;
  //@ given int oldIncrements;
  //@ requires state(oldCount, oldIncrements);
  //@ ensures state(oldCount + n, oldIncrements + 1);
  void increment(int n);
}

class MyProgram {
  //@ given int oldIncrements;
  //@ requires c != null ** c.state(0, oldIncrements);
  //@ ensures c.state(2, oldIncrements + 1);
  void foo(CounterExtended c) {
    //@ assert c.state(0, oldIncrements);
    c.increment(2) /*@ with { oldCount = 0; oldIncrements = oldIncrements; } @*/;
    //@ assert c.state(2, oldIncrements + 1);
  }
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-the-counter-example-now-with-predicates-2
//:: verdict Pass
//:: tools silicon
class CounterExtended {
  int count;
  int numIncrements;

  /*@ resource state(int val, int val2) = Perm(count, write) ** count == val 
        ** Perm(numIncrements, write) ** numIncrements == val2;
    @*/
  
  //@ given int oldCount;
  //@ given int oldIncrements;
  //@ requires state(oldCount, oldIncrements);
  //@ ensures state(oldCount + n, oldIncrements + 1);
  void increment(int n);
}

class MyProgram {
  //@ given int oldIncrements;
  //@ requires c != null ** c.state(0, oldIncrements);
  //@ ensures c.state(2, oldIncrements + 1);
  void foo(CounterExtended c) {
    //@ assert c.state(0, oldIncrements);
    c.increment(2) /*@ with { oldCount = 0; oldIncrements = oldIncrements; } @*/;
    //@ assert c.state(2, oldIncrements + 1);
  }
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>To summarise, predicates are very effective at hiding implementation details. They allow encapsulation. However, predicates do not protect the client from breaking changes. If the interface changes, any clients will have to change too.</p>
<h2 id="reservedinternal-predicates">Reserved/internal predicates</h2>
<p>There are a few situations where VerCors attaches special meanings to certain predicate names.</p>
<h3 id="for-atomicslocks">For atomics/locks</h3>
<p>For atomics and locks a predicate <code>lock_invariant</code> is defined. This predicate cannot be folded/unfolded, and has to be manipulated through locking and unlocking.</p>
<p>Additionally, it can be checked if a lock is currently held through the <code>held(x)</code> syntax. <code>held</code> is in this case effectively a predicate that cannot be unfolded. Therefore, any semantics and techniques for manipulating predicates discussed in this part of the tutorial can be applied to <code>held</code>, such as splitting and scaling, except for folding and unfolding.</p>
<p>For more information, see the <a href="https://github.com/utwente-fmt/vercors/wiki/Atomics-and-Locks">Atomics and Locks</a> section.</p>
<h3 id="threads">Threads</h3>
<p>A thread can be in several states, such as idle and running. The syntax for this is <code>idle(thread)</code> and <code>running(thread)</code>. <code>idle</code> and <code>running</code> are effectively predicates that cannot be unfolded. Therefore, any semantics and techniques for manipulating predicates discussed in this part of the tutorial can be applied to <code>held</code> (such as splitting and scaling).</p>
<p>See the <a href="https://github.com/utwente-fmt/vercors/wiki/PVL-Syntax-Reference">PVL Syntax Reference</a> section for more details.</p>
<h2 id="advanced-usage-of-predicates">Advanced usage of predicates</h2>
<h3 id="unfolding-predicates-within-expressions-using-unfolding">Unfolding predicates within expressions using <code>\unfolding</code></h3>
<p><strong>Note: use of <code>\unfolding</code> causes an error in the Java compiler. To work around this, VerCors will support the <code>\Unfolding</code> (notice the capital U) syntax instead of <code>\unfolding</code> for the Java frontend in the future. For progress, please see <a href="https://github.com/utwente-fmt/vercors/issues/485">the relevant issue</a></strong></p>
<p>Sometimes it is necessary to briefly open a predicate within an expression, for example, to temporarily gain access to a field. This can be achieved using the <code>\unfolding</code> operator. It has the following concrete syntax:</p>
<pre><code>\unfolding myPredicate(arg1, arg2, ...) \in expression
</code></pre>
<p>It takes the instance of the predicate that needs unfolding, followed by <code>\in</code>, and then an expression in which the predicate must be unfolded. After evaluating the internal expression, the predicate is folded again, without any changes to the predicate or the program state.</p>
<p>Below is an example usage of <code>\unfolding</code> in a <code>Cell</code> class where the predicate does not have a parameter for the value inside the <code>Cell</code>. To work around this, <code>\unfolding</code> is used.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb26-1" title="1"><span class="kw">class</span> Cell {</a>
<a class="sourceLine" id="cb26-2" title="2">  <span class="co">//@ ensures state() ** \unfolding state() \in x == 0;</span></a>
<a class="sourceLine" id="cb26-3" title="3">  <span class="fu">Cell</span>() {</a>
<a class="sourceLine" id="cb26-4" title="4">    x = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb26-5" title="5">    <span class="co">//@ fold state();</span></a>
<a class="sourceLine" id="cb26-6" title="6">  }</a>
<a class="sourceLine" id="cb26-7" title="7"></a>
<a class="sourceLine" id="cb26-8" title="8">  <span class="co">//@ resource state() = Perm(x, write);</span></a>
<a class="sourceLine" id="cb26-9" title="9">  <span class="dt">int</span> x;</a>
<a class="sourceLine" id="cb26-10" title="10">}</a>
<a class="sourceLine" id="cb26-11" title="11"></a>
<a class="sourceLine" id="cb26-12" title="12"><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span>() {</a>
<a class="sourceLine" id="cb26-13" title="13">  Cell c = <span class="kw">new</span> <span class="fu">Cell</span>();</a>
<a class="sourceLine" id="cb26-14" title="14">  <span class="co">//@ assert \unfolding c.state() \in c.x == 0;</span></a>
<a class="sourceLine" id="cb26-15" title="15">}</a></code></pre></div>
<h3 id="recursive-predicates">Recursive predicates</h3>
<p>Predicates can directly and indirectly recurse without problems, provided they are not <code>inline</code>. This can be used to for example model permissions over data structures with a size that cannot be known statically, such as a linked list. In the below code example, an instance of <code>state</code> predicate of the class <code>LinkedListNode</code> contains the permission for one field, as well as permissions for all fields of the tail of the list. Additionally, the argument of the <code>state</code> predicate reflects the numbers stored in the linked list.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb27-1" title="1"><span class="kw">class</span> LinkedListNode {</a>
<a class="sourceLine" id="cb27-2" title="2">  <span class="co">//@ resource state(seq&lt;int&gt; data) = Perm(v, write) ** Perm(next, write) ** v == data[0] ** (next != null ==&gt; next.state(tail(data)));</span></a>
<a class="sourceLine" id="cb27-3" title="3"></a>
<a class="sourceLine" id="cb27-4" title="4">  <span class="dt">int</span> v;</a>
<a class="sourceLine" id="cb27-5" title="5">  LinkedListNode next;</a>
<a class="sourceLine" id="cb27-6" title="6">}</a></code></pre></div>
<h3 id="scaling--splitting">Scaling &amp; splitting</h3>
<p>VerCors offers syntax to specify fractions of predicates, similar to how permissions can be specified in fractions. This can be useful to, for example, allow one half of a state predicate to be passed to one thread, and one to another. For a predicate <code>state(args)</code> on a variable <code>x</code>, the syntax for specifying a fraction <code>f</code> of the predicate is: <code>[f]x.state(args)</code>. The code below shows an example of how scaling can be used.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb28-1" title="1"><span class="kw">class</span> Cell {</a>
<a class="sourceLine" id="cb28-2" title="2">  <span class="co">//@ ensures state(0);</span></a>
<a class="sourceLine" id="cb28-3" title="3">  <span class="fu">Cell</span>() {</a>
<a class="sourceLine" id="cb28-4" title="4">    <span class="co">//@ fold state(0);</span></a>
<a class="sourceLine" id="cb28-5" title="5">  }</a>
<a class="sourceLine" id="cb28-6" title="6"></a>
<a class="sourceLine" id="cb28-7" title="7">  <span class="co">//@ resource state(int v) = Perm(x, write) ** v == x;</span></a>
<a class="sourceLine" id="cb28-8" title="8">  <span class="dt">int</span> x;</a>
<a class="sourceLine" id="cb28-9" title="9">}</a>
<a class="sourceLine" id="cb28-10" title="10"></a>
<a class="sourceLine" id="cb28-11" title="11"><span class="co">//@ requires [1\2]c.state(0);</span></a>
<a class="sourceLine" id="cb28-12" title="12"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">startThread</span>(Cell c);</a>
<a class="sourceLine" id="cb28-13" title="13"></a>
<a class="sourceLine" id="cb28-14" title="14"><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span>() {</a>
<a class="sourceLine" id="cb28-15" title="15">  Cell c = <span class="kw">new</span> <span class="fu">Cell</span>();</a>
<a class="sourceLine" id="cb28-16" title="16">  <span class="co">// Constructing a cell yields a state predicate</span></a>
<a class="sourceLine" id="cb28-17" title="17">  <span class="co">//@ assert c.state(0);</span></a>
<a class="sourceLine" id="cb28-18" title="18">  <span class="co">// We can split this into fractions of a predicate</span></a>
<a class="sourceLine" id="cb28-19" title="19">  <span class="co">//@ assert [1\2]c.state(0) ** [1\2]c.state(0);</span></a>
<a class="sourceLine" id="cb28-20" title="20"></a>
<a class="sourceLine" id="cb28-21" title="21">  <span class="co">// startThread will claim half of the predicate</span></a>
<a class="sourceLine" id="cb28-22" title="22">  <span class="fu">startThread</span>(c);</a>
<a class="sourceLine" id="cb28-23" title="23"></a>
<a class="sourceLine" id="cb28-24" title="24">  <span class="co">// The other half can be used for something else</span></a>
<a class="sourceLine" id="cb28-25" title="25">  <span class="co">//@ assert [1\2]c.state(0);</span></a>
<a class="sourceLine" id="cb28-26" title="26">}</a></code></pre></div>
<h3 id="inline-predicates">Inline predicates</h3>
<p>Predicates can be given the <code>inline</code> attribute:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb29-1" title="1"><span class="kw">class</span> C {</a>
<a class="sourceLine" id="cb29-2" title="2">  <span class="co">//@ inline resource state() = Perm(x, write);</span></a>
<a class="sourceLine" id="cb29-3" title="3">  <span class="dt">int</span> x;</a>
<a class="sourceLine" id="cb29-4" title="4">}</a></code></pre></div>
<p>If the <code>inline</code> attribute is given to a predicate, VerCors will inline the definition of that predicate wherever the predicate occurs. This means that the following code snippet:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb30-1" title="1"><span class="co">//@ requires c.state();</span></a>
<a class="sourceLine" id="cb30-2" title="2"><span class="dt">void</span> <span class="fu">foo</span>(C c) {</a>
<a class="sourceLine" id="cb30-3" title="3">  <span class="co">//@ assert c.state();</span></a>
<a class="sourceLine" id="cb30-4" title="4">}</a></code></pre></div>
<p>Is equal to:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb31-1" title="1"><span class="co">//@ requires Perm(c.x, write);</span></a>
<a class="sourceLine" id="cb31-2" title="2"><span class="dt">void</span> <span class="fu">foo</span>(C c) {</a>
<a class="sourceLine" id="cb31-3" title="3">  <span class="co">//@ assert Perm(c.x, write);</span></a>
<a class="sourceLine" id="cb31-4" title="4">}</a></code></pre></div>
<p>Because of this inlining semantics, <code>inline</code> predicates cannot be recursive. However, besides that limitation they are equal to regular predicates, and hence support arguments and scaling.</p>
<p>Furthermore, because of this inlining semantics, folding and unfolding inline predicates do not change the program state. However, for the ease of flexibility, VerCors allows them, interpreting them as a check for whether or not the contents of a predicate is present.</p>
<h3 id="inheritance">Inheritance</h3>
<p>Inheritance is not yet supported for predicates.</p>
<h2 id="known-problems">Known problems</h2>
<h3 id="vercors-crashes-when-predicates-are-unfolded">VerCors crashes when predicates are unfolded</h3>
<p>When using predicates, VerCors might yield the following error:</p>
<pre><code>Verification aborted exceptionally: java.util.concurrent.ExecutionException: java.util.concurrent.ExecutionException: java.util.NoSuchElementException: None.get
  Cause: java.util.concurrent.ExecutionException: java.util.NoSuchElementException: None.get
</code></pre>
<p>This is because the current implementation of Java inheritance in VerCors is incomplete. There are two workarounds for this.</p>
<p>First, a predicate declaration can be marked as <code>final</code>. This ensures that the inheritance-related logic in VerCors is not applied to that predicate, which means it can be used as described in this chapter. In the code below we show an example usage of this workaround.</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">int x;

//@ final resource state(int val) = Perm(x, write) ** x == val;

//@ requires Perm(x, write) ** x == n;
//@ ensures state(n);
void foo(int n) {
    //@ fold state(n);
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-known-problems-vercors-crashes-when-predicates-are-unfolded-1
//:: verdict Pass
//:: tools silicon
final class Test {
    int x;
    
    //@ final resource state(int val) = Perm(x, write) ** x == val;
    
    //@ requires Perm(x, write) ** x == n;
    //@ ensures state(n);
    void foo(int n) {
        //@ fold state(n);
    }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Second, if a class has many predicates, or the first workaround does not seem to work, the whole class can be marked as <code>final</code>. This ensures the inheritance-related logic in VerCors is not applied to the class at all.</p>
<p>Both workarounds do not change the semantics of Java code that does not use inheritance.</p>
<p>Finally, if neither of the workarounds work, please file an issue.</p>
<h3 id="interaction-between-loop-conditions-and-predicates">Interaction between loop conditions and predicates</h3>
<p>Consider the following example:</p>
<!-- testMethod Fail -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ resource wrapX(int val) = Perm(x, write) ** x == val;
int x;

//@ requires wrapX(5);
void m() {
  //@ ghost int i = 5;

  //@ loop_invariant wrapX(i);
  //@ loop_invariant \unfolding wrapX(i) \in 5 &lt;= x &amp;&amp; x &lt;= 10;
  while (x &lt; 10) {
    //@ unfold wrapX(i);
    x++;
    //@ ghost i++;
    //@ fold wrapX(i);
  } 
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-known-problems-interaction-between-loop-conditions-and-predicates-1
//:: verdict Fail
//:: tools silicon
final class Test {
    //@ resource wrapX(int val) = Perm(x, write) ** x == val;
    int x;
    
    //@ requires wrapX(5);
    void m() {
      //@ ghost int i = 5;
    
      //@ loop_invariant wrapX(i);
      //@ loop_invariant \unfolding wrapX(i) \in 5 &lt;= x &amp;&amp; x &lt;= 10;
      while (x &lt; 10) {
        //@ unfold wrapX(i);
        x++;
        //@ ghost i++;
        //@ fold wrapX(i);
      } 
    }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>This will give an error on the <code>while</code> condition, stating that there is no permission for <code>x</code>. This is to be expected, since permission for <code>x</code> is contained in the predicate <code>wrapX(i)</code>. Since we did not give instructions to <code>unfold</code> it, the loop condition cannot access <code>x</code>. Intuitively, the following extra syntax should work:</p>
<!-- testMethod Error -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ resource wrapX(int val) = Perm(x, write) ** x == val;
int x;

//@ requires wrapX(5);
void m() {
  //@ ghost int i = 5;

  //@ loop_invariant wrapX(i);
  //@ loop_invariant \unfolding wrapX(i) \in 5 &lt;= x &amp;&amp; x &lt;= 10;
  while (/*@ \unfolding wrapX(i) \in @*/ x &lt; 10) {
    //@ unfold wrapX(i);
    x++;
    //@ ghost i++;
    //@ fold wrapX(i);
  } 
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-known-problems-interaction-between-loop-conditions-and-predicates-2
//:: verdict Error
//:: tools silicon
final class Test {
    //@ resource wrapX(int val) = Perm(x, write) ** x == val;
    int x;
    
    //@ requires wrapX(5);
    void m() {
      //@ ghost int i = 5;
    
      //@ loop_invariant wrapX(i);
      //@ loop_invariant \unfolding wrapX(i) \in 5 &lt;= x &amp;&amp; x &lt;= 10;
      while (/*@ \unfolding wrapX(i) \in @*/ x &lt; 10) {
        //@ unfold wrapX(i);
        x++;
        //@ ghost i++;
        //@ fold wrapX(i);
      } 
    }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>However, this syntax is currently <em>not</em> supported by VerCors. Instead, it is recommended to use an inline predicate if possible (see the <a href="#inline-predicates">Inline Predicates</a> section for more info). Applying this workaround results in the following program:</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ inline resource wrapX(int val) = Perm(x, write) ** x == val;
int x;

//@ requires wrapX(5);
void m() {
  //@ ghost int i = 5;

  //@ loop_invariant wrapX(i);
  //@ loop_invariant 5 &lt;= x &amp;&amp; x &lt;= 10;
  while (x &lt; 10) {
    x++;
    //@ ghost i++;
  } 
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-known-problems-interaction-between-loop-conditions-and-predicates-3
//:: verdict Pass
//:: tools silicon
final class Test {
    //@ inline resource wrapX(int val) = Perm(x, write) ** x == val;
    int x;
    
    //@ requires wrapX(5);
    void m() {
      //@ ghost int i = 5;
    
      //@ loop_invariant wrapX(i);
      //@ loop_invariant 5 &lt;= x &amp;&amp; x &lt;= 10;
      while (x &lt; 10) {
        x++;
        //@ ghost i++;
      } 
    }
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Alternatively, the condition can be lifted into its own boolean variable as in the example below. However, this 1) leads to verbose code, and 2) requires modification of non-ghost code. Note that, for presentation reasons, the loop condition <code>p</code> is also more strict than in the previous examples.</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ resource wrapX(int val) = Perm(x, write) ** x == val;
int x;

//@ requires wrapX(5);
void m() {
  // Put the loop condition in a separate variable. This requires unfolding the predicate temporarily.
  //@ unfold wrapX(5);
  boolean p = 5 &lt;= x &amp;&amp; x &lt; 10;
  //@ fold wrapX(5);

  //@ ghost int i = 5;

  //@ loop_invariant wrapX(i);
  //@ loop_invariant \unfolding wrapX(i) \in 5 &lt;= x &amp;&amp; x &lt;= 10;
  // Require that loop maintains that p equals the previous loop condition
  //@ loop_invariant p == \unfolding wrapX(i) \in (5 &lt;= x &amp;&amp; x &lt; 10);
  while (p) {
    //@ unfold wrapX(i);
    x++;
    //@ ghost i++;

    // Before the while loop ends, check the loop condition manually
    // And put the result in p again.
    p = 5 &lt;= x &amp;&amp; x &lt; 10;
    //@ fold wrapX(i);
  }

  //@ assert wrapX(10);
}

<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-known-problems-interaction-between-loop-conditions-and-predicates-4
//:: verdict Pass
//:: tools silicon
final class Test {
    //@ resource wrapX(int val) = Perm(x, write) ** x == val;
    int x;
    
    //@ requires wrapX(5);
    void m() {
      // Put the loop condition in a separate variable. This requires unfolding the predicate temporarily.
      //@ unfold wrapX(5);
      boolean p = 5 &lt;= x &amp;&amp; x &lt; 10;
      //@ fold wrapX(5);
    
      //@ ghost int i = 5;
    
      //@ loop_invariant wrapX(i);
      //@ loop_invariant \unfolding wrapX(i) \in 5 &lt;= x &amp;&amp; x &lt;= 10;
      // Require that loop maintains that p equals the previous loop condition
      //@ loop_invariant p == \unfolding wrapX(i) \in (5 &lt;= x &amp;&amp; x &lt; 10);
      while (p) {
        //@ unfold wrapX(i);
        x++;
        //@ ghost i++;
    
        // Before the while loop ends, check the loop condition manually
        // And put the result in p again.
        p = 5 &lt;= x &amp;&amp; x &lt; 10;
        //@ fold wrapX(i);
      }
    
      //@ assert wrapX(10);
    }
    
    
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h1 id="inheritance-1">Inheritance</h1>
<p>Currently, support for inheritance is very limited. Bob Rubbens is working on improving support for inheritance as part of his PhD position. You can read theoretical work on this in his masters thesis: <a href="https://essay.utwente.nl/81338/">https://essay.utwente.nl/81338/</a>, or contact Bob at <a href="r.b.rubbens@utwente.nl">r.b.rubbens@utwente.nl</a>. As support improves, this wiki page will improve accordingly.</p>
<h1 id="exceptions--goto">Exceptions &amp; Goto</h1>
<p>This section discusses support for exceptions and goto in VerCors. The following topics are discussed:</p>
<ul>
<li>The support that is currently implemented and support that is still being worked on is listed <a href="https://github.com/utwente-fmt/vercors/wiki/Exceptions-&amp;-Goto#support">here</a>.</li>
<li>Then a brief summary of exceptions in Java is given <a href="https://github.com/utwente-fmt/vercors/wiki/Exceptions-&amp;-Goto#java-exceptions-example">here</a>.</li>
<li>Then we discuss the <code>signals</code> contract clause <a href="https://github.com/utwente-fmt/vercors/wiki/Exceptions-&amp;-Goto#the-signals-clause">here</a>, which models exceptions in VerCors.</li>
<li>Finally, support for goto is discussed <a href="https://github.com/utwente-fmt/vercors/wiki/Exceptions-&amp;-Goto#goto-and-labels">here</a>.</li>
</ul>
<h2 id="exceptions">Exceptions</h2>
<h3 id="support">Support</h3>
<p>VerCors currently only supports Java exceptions. They are not supported in PVL. We also do not support signal handlers in C. The table below lists which facets of exceptions in Java are currently supported in VerCors.</p>
<table>
<thead>
<tr class="header">
<th>Feature</th>
<th>Supported</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>throw</code></td>
<td>Yes</td>
</tr>
<tr class="even">
<td><code>throws</code></td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><code>try-catch</code></td>
<td>Yes</td>
</tr>
<tr class="even">
<td><code>try-finally</code></td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><code>try-catch-finally</code></td>
<td>Yes</td>
</tr>
<tr class="even">
<td><code>try-with-resources</code></td>
<td>No</td>
</tr>
<tr class="odd">
<td>Multi-catch</td>
<td>No</td>
</tr>
<tr class="even">
<td>Defining custom exceptions</td>
<td>Yes, but only if directly inheriting from one of: Exception, RuntimeException, Throwable, Error. This limitation is temporary.</td>
</tr>
<tr class="odd">
<td>JML <code>signals</code></td>
<td>Yes</td>
</tr>
<tr class="even">
<td>JML <code>signals_only</code></td>
<td>No</td>
</tr>
</tbody>
</table>
<p>Support for exceptions is still being worked on currently. Progress on the implementation can be followed <a href="https://github.com/utwente-fmt/vercors/pull/464">here</a>.</p>
<h3 id="java-exceptions-example">Java Exceptions Example</h3>
<p>We will now discuss a basic artificial example of exception usage in Java. For a more thorough overview, we refer the reader to the Java tutorial on exceptions: <a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/index.html">https://docs.oracle.com/javase/tutorial/essential/exceptions/index.html</a>.</p>
<p>In the following code example, the <code>find</code> method determines if an array contains a specific integer value:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb33-1" title="1"><span class="kw">class</span> MyFind {</a>
<a class="sourceLine" id="cb33-2" title="2">    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">boolean</span> <span class="fu">find</span>(<span class="dt">int</span>[] xs, <span class="dt">int</span> value) <span class="kw">throws</span> <span class="bu">Exception</span> {</a>
<a class="sourceLine" id="cb33-3" title="3">        <span class="kw">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; xs.<span class="fu">length</span>; i++) {</a>
<a class="sourceLine" id="cb33-4" title="4">            <span class="kw">if</span> (xs[i] == value) {</a>
<a class="sourceLine" id="cb33-5" title="5">                <span class="kw">return</span> <span class="kw">true</span>;</a>
<a class="sourceLine" id="cb33-6" title="6">            } <span class="kw">else</span> <span class="kw">if</span> (xs[i] &lt; <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb33-7" title="7">                <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">Exception</span>();</a>
<a class="sourceLine" id="cb33-8" title="8">            }</a>
<a class="sourceLine" id="cb33-9" title="9">        }</a>
<a class="sourceLine" id="cb33-10" title="10"></a>
<a class="sourceLine" id="cb33-11" title="11">        <span class="kw">return</span> <span class="kw">false</span>;</a>
<a class="sourceLine" id="cb33-12" title="12">    }</a>
<a class="sourceLine" id="cb33-13" title="13"></a>
<a class="sourceLine" id="cb33-14" title="14">    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span>(<span class="bu">String</span>[] args) {</a>
<a class="sourceLine" id="cb33-15" title="15">        <span class="dt">int</span>[] myXs = <span class="dt">int</span>[<span class="dv">3</span>];</a>
<a class="sourceLine" id="cb33-16" title="16">        myXs[<span class="dv">0</span>] = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb33-17" title="17">        myXs[<span class="dv">1</span>] = <span class="dv">10</span>;</a>
<a class="sourceLine" id="cb33-18" title="18">        myXs[<span class="dv">2</span>] = -<span class="dv">3</span>;</a>
<a class="sourceLine" id="cb33-19" title="19">       </a>
<a class="sourceLine" id="cb33-20" title="20">        <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb33-21" title="21">            <span class="fu">find</span>(myXs, <span class="dv">22</span>);</a>
<a class="sourceLine" id="cb33-22" title="22">        } <span class="kw">catch</span> (<span class="bu">Exception</span> e) {</a>
<a class="sourceLine" id="cb33-23" title="23">            <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;An error occurred&quot;</span>);</a>
<a class="sourceLine" id="cb33-24" title="24">        }</a>
<a class="sourceLine" id="cb33-25" title="25">    }</a>
<a class="sourceLine" id="cb33-26" title="26">}</a></code></pre></div>
<p>If the <code>find</code> method encounters a negative array element while searching, it throws an exception. The fact that the method throws an exception at all is indicated by the <code>throws Exception</code> modifier when the <code>find</code> method is defined. Specifically, the exception is thrown by the <code>throw new Exception()</code> statement in the <code>find</code> method.</p>
<p>The thrown exception is handled in the <code>main</code> method by wrapping the call to <code>find</code> in a <code>try-catch</code> block. Whenever an exception is thrown within a <code>try-catch</code> block, the exception is passed to the <code>catch</code> block of the type of the exception that matches the type of the <code>catch</code> block. This catch block can then handle the exception to allow the program to continue, or perform cleanup such that the program can exit safely. If none of the catch blocks can handle the exception, it is passed further up the call stack, possibly terminating the program if it is not caught and handled.</p>
<!-- this should not be visible -->

<h3 id="the-signals-clause">The signals clause</h3>
<p>The signals clause supported in VerCors is very similar to the signals clauses supported in JML (documented <a href="http://www.eecs.ucf.edu/~leavens/JML/jmlrefman/jmlrefman_9.html#SEC109">here</a>). It is a contract element like <code>requires</code> or <code>ensures</code>, and declares the postcondition in case an exception is thrown. The declared postcondition holds when the thrown type matches the type stated in the <code>signals</code> clause. When an exception is thrown, normal <code>ensures</code> post-conditions never hold, and instead only relevant <code>signals</code> clauses hold.</p>
<p>As an artificial example, we can define a <code>signals</code> clause for a method that sums two numbers. The method throws an exception if one of the numers is equal to five.</p>
<!--
TODO: Nice example would be overflowing addition here. But we do not have that yet in vercors
-->

<!-- standalone-snip plainSum
class C {
-->

<!-- snip plainSum -->

<div class="sourceCode" id="cb34"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb34-1" title="1"><span class="co">//@ signals (Exception e) a == 5 || b == 5;</span></a>
<a class="sourceLine" id="cb34-2" title="2"><span class="co">//@ ensures \result == (a + b);</span></a>
<a class="sourceLine" id="cb34-3" title="3"><span class="dt">void</span> <span class="fu">sum</span>(<span class="dt">int</span> a, <span class="dt">int</span> b) <span class="kw">throws</span> <span class="bu">Exception</span> {</a>
<a class="sourceLine" id="cb34-4" title="4">    <span class="kw">if</span> (a == <span class="dv">5</span> || b == <span class="dv">5</span>) {</a>
<a class="sourceLine" id="cb34-5" title="5">        <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">Exception</span>();</a>
<a class="sourceLine" id="cb34-6" title="6">    } <span class="kw">else</span> {</a>
<a class="sourceLine" id="cb34-7" title="7">        <span class="kw">return</span> a + b;</a>
<a class="sourceLine" id="cb34-8" title="8">    }</a>
<a class="sourceLine" id="cb34-9" title="9">}</a></code></pre></div>
<!-- standalone-snip plainSum
}
-->

<p>Similar to the <code>throws</code> attribute, the <code>signals</code> clause can name both checked and unchecked exceptions. The only limitation is that the type must extend <code>Throwable</code>.</p>
<h5 id="signals-does-not-guarantee-an-exception">Signals does not guarantee an exception</h5>
<p>A frequently occurring use-case is to guarantee that an exception is thrown, if a certain condition occurs. Furthermore, this is also how the semantics of the <code>signals</code> clause is sometimes misinterpreted. Applying this line of though to the previous example, one might expect the method <code>sum</code> to <em>always</em> throw if one of the arguments equals five. However, this is not the case. The implementation for <code>pickySum</code> below demonstrates this. The implementation for <code>pickySum</code> also satisfies the contract for <code>sum</code>, but clearly <code>pickySum</code> does not <em>always</em> throw an exception if one of the arguments equals 5:</p>
<!-- standalone-snip pickySum
class C {
-->

<!-- snip pickySum -->

<div class="sourceCode" id="cb35"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb35-1" title="1"><span class="co">//@ signals (Exception e) a == 5 || b == 5;</span></a>
<a class="sourceLine" id="cb35-2" title="2"><span class="co">//@ ensures \result == (a + b);</span></a>
<a class="sourceLine" id="cb35-3" title="3"><span class="dt">void</span> <span class="fu">pickySum</span>(<span class="dt">int</span> a, <span class="dt">int</span> b) {</a>
<a class="sourceLine" id="cb35-4" title="4">    <span class="kw">if</span> ((a == <span class="dv">5</span> || b == <span class="dv">5</span>) &amp;&amp; <span class="fu">dayOfTheWeek</span>() == <span class="st">&quot;tuesday&quot;</span>) {</a>
<a class="sourceLine" id="cb35-5" title="5">        <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">Exception</span>();</a>
<a class="sourceLine" id="cb35-6" title="6">    } <span class="kw">else</span> {</a>
<a class="sourceLine" id="cb35-7" title="7">        <span class="kw">return</span> a + b;</a>
<a class="sourceLine" id="cb35-8" title="8">    }</a>
<a class="sourceLine" id="cb35-9" title="9">}</a></code></pre></div>
<!-- standalone-snip pickySum
}
-->

<p>Instead, <code>pickySum</code> only throws an exception if one of the arguments equals five, <em>and</em> today is tuesday. Would <code>pickySum</code> be called on a monday with 5 and 10, an exception would not be thrown, and instead 15 would be returned.</p>
<p>This artificial example shows how a signals clause should be interpreted: when an exception of the appropriate type is thrown, the <code>signals</code> clause can be assumed to hold. We call this the "reactive" semantics.</p>
<p>It is <em>not</em> guaranteed that an exception is thrown if a <code>signals</code> condition occurs. We call this the "causal" semantics. VerCors does <em>not</em> implement this currently.</p>
<p>If needed, there is a way to model the causal semantics using an additional <code>ensures</code> clause. To do this, an <code>ensures</code> clause needs to be added that implies <code>false</code> when the <code>signals</code> condition occurs. For example, <code>pickySum</code> can be made consistent as follows:</p>
<!-- standalone-snip consistentSum
class C {
-->

<!-- snip consistentSum -->

<div class="sourceCode" id="cb36"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb36-1" title="1"><span class="co">//@ signals (Exception e) a == 5 || b == 5;</span></a>
<a class="sourceLine" id="cb36-2" title="2"><span class="co">//@ ensures (a == 5 || b == 5) ==&gt; false;</span></a>
<a class="sourceLine" id="cb36-3" title="3"><span class="co">//@ ensures \result == (a + b);</span></a>
<a class="sourceLine" id="cb36-4" title="4"><span class="dt">void</span> <span class="fu">consistentSum</span>(<span class="dt">int</span> a, <span class="dt">int</span> b) {</a>
<a class="sourceLine" id="cb36-5" title="5">    <span class="kw">if</span> (a == <span class="dv">5</span> || b == <span class="dv">5</span>) {</a>
<a class="sourceLine" id="cb36-6" title="6">        <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">Exception</span>();</a>
<a class="sourceLine" id="cb36-7" title="7">    } <span class="kw">else</span> {</a>
<a class="sourceLine" id="cb36-8" title="8">        <span class="kw">return</span> a + b;</a>
<a class="sourceLine" id="cb36-9" title="9">    }</a>
<a class="sourceLine" id="cb36-10" title="10">}</a></code></pre></div>
<!-- standalone-snip consistentSum
}
-->

<p>By ensuring that the method cannot terminate normally if one of the arguments equals 5, it is guaranteed that an exception is thrown when one of the arguments equals 5. This encodes the causal semantics using the reactive semantics supported by VerCors.</p>
<h5 id="exception-guarantees">Exception guarantees</h5>
<p>Java guarantees that methods only throw checked exceptions if they are explicitly mentioned in the <code>throws</code> attribute. Unchecked exceptions can always be thrown.</p>
<p>VerCors does not implement this exact semantics. Instead, it assumes that any exception that can be thrown is mentioned in either the <code>throws</code> attribute or in a <code>signals</code> clause. In other words, if a method has no <code>throws</code> clauses, nor <code>signals</code> clauses, it is 100% exception safe according to VerCors. A downside of this is that the VerCors exception semantics does not 100% reflect the Java semantics. The upside is that VerCors can now guarantee that all specified exceptions are caught, as all relevant exceptions are stated explicitly.</p>
<p>For example, if a method does not have a <code>signals</code> clause stating it throws a <code>RuntimeException</code>, VerCors assumes this exception will never be thrown by the method. Another example, if a <code>throw new RuntimeException()</code> statement occurs in method M, VerCors will give an error if M does not have a <code>signals</code> clause for RuntimeException.</p>
<p>In some situations it might be necessary to opt into the more realistic Java semantics of unchecked exceptions. VerCors does not support this directly, but it can be moddeled with an additional <code>signals</code> clause. To do this, an additional <code>signals</code> clause must be added with the condition <code>true</code>. For example, we can modify the contract of the earlier presented <code>sum</code> method to allow throwing a <code>RuntimeException</code> randomly:</p>
<!-- header-snip ExcGuarantees Error -->

<!-- wrap-class-snip ExcGuarantees -->

<div class="sourceCode" id="cb37"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb37-1" title="1"><span class="co">//@ signals (ArithmeticException e) a == 5 || b == 5;</span></a>
<a class="sourceLine" id="cb37-2" title="2"><span class="co">//@ signals (RuntimeException e) true;</span></a>
<a class="sourceLine" id="cb37-3" title="3"><span class="co">//@ ensures \result == (a + b);</span></a>
<a class="sourceLine" id="cb37-4" title="4"><span class="dt">void</span> <span class="fu">sum</span>(<span class="dt">int</span> a, <span class="dt">int</span> b) {</a>
<a class="sourceLine" id="cb37-5" title="5">    <span class="kw">if</span> (a == <span class="dv">5</span> || b == <span class="dv">5</span>) {</a>
<a class="sourceLine" id="cb37-6" title="6">        <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">ArithmeticException</span>();</a>
<a class="sourceLine" id="cb37-7" title="7">    } <span class="kw">else</span> {</a>
<a class="sourceLine" id="cb37-8" title="8">        <span class="kw">return</span> a + b;</a>
<a class="sourceLine" id="cb37-9" title="9">    }</a>
<a class="sourceLine" id="cb37-10" title="10">}</a>
<a class="sourceLine" id="cb37-11" title="11"></a>
<a class="sourceLine" id="cb37-12" title="12"><span class="dt">void</span> <span class="fu">useSum</span>() {</a>
<a class="sourceLine" id="cb37-13" title="13">    <span class="dt">int</span> result = <span class="fu">sum</span>(<span class="dv">5</span>, <span class="dv">10</span>);</a>
<a class="sourceLine" id="cb37-14" title="14">    <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;Result: &quot;</span> + result);</a>
<a class="sourceLine" id="cb37-15" title="15">}</a></code></pre></div>
<p>If this example is checked by VerCors, it will yield an error in the <code>useSum</code> method. The error will complain that <code>sum</code> might throw a <code>RuntimeException</code>, but that it is not specified in the contract nor handled in the <code>useSum</code> body.</p>
<p>A way to resolve this would be to catch the <code>RuntimeException</code> by wrapping the call to <code>sum</code> in a <code>try-catch</code> block. However, since catching a <code>RuntimeException</code> is bad practice, it is sometimes better to indicate in the contract of <code>useSum</code> that <code>useSum</code> might also throw a <code>RuntimeException</code>. This propagates the responsibility for handling the unchecked exception to the caller.</p>
<h3 id="the-signals_only-clause">The signals_only clause</h3>
<p>The <code>signals_only</code> clause from JML (documented <a href="http://www.eecs.ucf.edu/~leavens/JML/jmlrefman/jmlrefman_9.html#SEC110">here</a>) is not supported by VerCors. It guarantees that the only types that will be thrown by the method are the types listed in the <code>signals_only</code> clause.</p>
<p>To simulate the functionality of <code>signals_only T1, ..., Tn</code>, a signals clause with the condition <code>true</code> can be added for each <code>Ti</code>. For example, the clause <code>signals_only T1, T2;</code> can be simulated by adding two <code>signals</code> clauses to a method contract as follows:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb38-1" title="1"><span class="co">//@ signals (T1 e) true;</span></a>
<a class="sourceLine" id="cb38-2" title="2"><span class="co">//@ signals (T2 e) true;</span></a>
<a class="sourceLine" id="cb38-3" title="3"><span class="dt">void</span> <span class="fu">m</span>() {</a>
<a class="sourceLine" id="cb38-4" title="4">    </a>
<a class="sourceLine" id="cb38-5" title="5">}</a></code></pre></div>
<p>Alternatively, the abbreviation of <code>signals_only</code> documented in <a href="http://www.eecs.ucf.edu/~leavens/JML/jmlrefman/jmlrefman_9.html#SEC110">Section 9.9.5 of the JML reference manual</a> can also be used to approximate the semantics of <code>signals_only</code> in VerCors.</p>
<h2 id="goto-and-labels">Goto and labels</h2>
<p>PVL has support for <code>goto</code> and <code>label</code>. They are useful for modeling control flow primitives not yet supported in VerCors. The semantics are standard: when the <code>goto l</code> statement is encountered, control flow is immediately transferred to the location indicated by the label <code>l</code>. For example, the following program verifies:</p>
<!-- header-snip GotoEx1 -->

<!-- wrap-method-snip GotoEx1 -->

<div class="sourceCode" id="cb39"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb39-1" title="1"><span class="dt">int</span> x = <span class="dv">3</span>;</a>
<a class="sourceLine" id="cb39-2" title="2"><span class="kw">goto</span> l;</a>
<a class="sourceLine" id="cb39-3" title="3">x = <span class="dv">4</span>;</a>
<a class="sourceLine" id="cb39-4" title="4">label l;</a>
<a class="sourceLine" id="cb39-5" title="5">assert x == <span class="dv">3</span>;</a></code></pre></div>
<p>As PVL does not have a construct like <code>finally</code> in Java, there are no exceptions for the semantics of <code>goto</code> in PVL.</p>
<p>One example where use of <code>goto</code> might lead to confusing results is the following. In the below example, <code>goto</code> is used to exit the <code>while</code> loop. Because <code>goto</code> redirects control flow to the destination label immediately, checking the loop invariant is skipped.</p>
<!-- header-snip GotoEx2 -->

<!-- wrap-method-snip GotoEx2 -->

<div class="sourceCode" id="cb40"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb40-1" title="1"><span class="dt">int</span> r = <span class="dv">10</span>;</a>
<a class="sourceLine" id="cb40-2" title="2">loop_invariant r == <span class="dv">10</span>;</a>
<a class="sourceLine" id="cb40-3" title="3"><span class="kw">while</span> (<span class="kw">true</span>) {</a>
<a class="sourceLine" id="cb40-4" title="4">  r = <span class="dv">20</span>;</a>
<a class="sourceLine" id="cb40-5" title="5">  <span class="kw">goto</span> lbl2;</a>
<a class="sourceLine" id="cb40-6" title="6">}</a>
<a class="sourceLine" id="cb40-7" title="7">assert r == <span class="dv">10</span>; <span class="co">// Never executed</span></a>
<a class="sourceLine" id="cb40-8" title="8">label lbl2;</a>
<a class="sourceLine" id="cb40-9" title="9">assert r == <span class="dv">20</span>;</a></code></pre></div>
<p>If it is desired that the loop invariant is checked at <code>goto</code> as well, this can be modeled by adding asserts at the exit labels of the <code>while</code> loop.</p>
<h1 id="veymont">VeyMont</h1>
<p>VeyMont is a tool for verification of concurrent message passing programs. The tool has been build on top of VerCors. VeyMont decomposes the global program from the input files into several local programs that can be executed in parallel. The program from the input files has to adhere to the syntax of a 'global program'. Syntax violations result in VeyMont Fail messages. The decomposition preserves the behaviour of the global program. This implies that all functional properties proven (with VerCors) for the global program also hold for the local program. Also, both global programs and their decomposed local programs are deadlock-free by construction.</p>
<h2 id="user-documentation">User documentation.</h2>
<h3 id="installing-and-running-veymont">Installing and running VeyMont</h3>
<p>First build VerCors from source (as there has not been a release with VeyMont yet), following the instructions from the <a href="https://github.com/utwente-fmt/vercors">README on GitHub</a>. Then run VeyMont by executing the following command:</p>
<p><code>./bin/vct --veymont &lt;filepath-to-output-file-for-local-programs&gt; &lt;filepath-to-global-program&gt;</code></p>
<p>Here <code>&lt;filepath-to-global-program&gt;</code> is the input file you provide to VeyMont, and <code>&lt;filepath-to-output-file-for-local-programs&gt;</code> is the name of the file VeyMont should write to. The global program files need to be <code>.pvl</code> files; the output file can be either an PVL or Java file. Example global programs can be found in <code>examples/veymont-global-programs</code>.</p>
<h3 id="using-veymont-for-verifying-concurrent-message-passing-programs">Using VeyMont for verifying concurrent message-passing programs</h3>
<p>Steps for using VeyMont:</p>
<ol>
<li>Write a global program in PVL (an input language of VerCors).</li>
<li>Add annotations to the global program to prove functional correctness.</li>
<li>Provide the global program to VerCors for verification. If verification fails, go back to step 1 (incorrect global program) or step 2 (incorrect annotations).</li>
<li>Provide the verified global program to VeyMont for decomposition. If Vey- Mont rejects, go back to step 1; if it accepts, it generates local programs.</li>
</ol>
<p>Example global programs can be found in <code>examples/veymont-global-programs</code>.</p>
<h2 id="developer-documentation">Developer documentation</h2>
<p>VeyMont executes the following passes:</p>
<ul>
<li><strong>VeyMontStructCheck</strong> This pass checks whether the input file contains a global program of the required syntax, as described in section 4.1 "Global programs" of the paper, and adheres to syntactical conditions of 'well-formedness' and 'sufficiency', see section 4.3 "Checking well-formedness, well-behavedness, and sufficiency". In case of violation, VeyMont aborts with a VeyMont Fail message.</li>
<li><strong>VeyMontTerminationCheck</strong> This pass checks whether any recursive method calls are used in the Main class and in the other classes. If so, then deadlock-freedom might not hold. If the Main class contains recursion, VeyMont aborts with a VeyMont Fail message, because this is not allowed (for guaranteeing functional correctness). In case of recursion in other classes, VeyMont issues a warning that deadlock-freedom cannot be guaranteed.</li>
<li><strong>VeyMontDecompose</strong> This pass does most of the transformation of the actual decomposition of the global program into local programs, as given in section 4.2 "Local programs and decomposition", except for the addition of the barrier.await() calls that will be added by the pass VeyMontBarrier.</li>
<li><strong>removeEmptyBlocks</strong> This pass removes par-blocks that have no statements.</li>
<li><strong>VeyMontLocalProgConstr</strong> This pass adds the initialization of the channel objects, and the accompanying annotations to the pre-and post conditions of the local program class constructors.</li>
<li><strong>VeyMontAddChannelPerms</strong> This pass adds the necessary (permission and != null) annotations for the channel objects to the pre-and post conditions and the loop invariants of all non-constructor methods.</li>
<li><strong>VeyMontAddStartThreads</strong> This pass generates a class that initializes the barrier, channel and local program objects, and then forks and then joins the latter objects for executing the local programs in parallel.</li>
<li><strong>printVeyMontOutput</strong> This pass prints the decomposed programs to a file, either in the PVL or Java language.</li>
</ul>
<h1 id="term-rewriting-rules">Term Rewriting Rules</h1>
<p>VerCors allows you to define your own term rewriting rules via <code>jspec</code> files. This chapter shows you how.</p>
<h1 id="magic-wands">Magic Wands</h1>
<p>The handling of magic wands is non-trivial, so this chapter takes a closer look at that. For further reading, see e.g. <em>"Witnessing the elimination of magic wands". Blom, S.; and Huisman, M. STTT, 17(6): 757â781. 2015</em>.</p>
<p>Also take a look at the Viper tutorial for wands: <a href="http://viper.ethz.ch/tutorial/?page=1&amp;section=#magic-wands">http://viper.ethz.ch/tutorial/?page=1&amp;section=#magic-wands</a></p>
<h2 id="what-are-magic-wands">What are Magic Wands?</h2>
<p>The "Magic Wand" or <em>separating implication</em> is a connective in separation logic using the symbol <code>-*</code>. It represents a part of a resource (see <a href="https://github.com/utwente-fmt/vercors/wiki/Predicates">"Predicates"</a>) or "resource with a hole": <code>A -* B</code> means "if you give me an <code>A</code>, I can give you a <code>B</code> in return". Thus, it is similar to a logical implication <code>A ==&gt; B</code>; however, it consumes the <code>A</code> when it is exchanged for a <code>B</code>.</p>
<p>A common use case is if you have a predicate defining a recursive data structure like a linked list or a binary tree, and you take a part of that data structure to reason about explicitly, like a sub-tree. You can use the recursive predicate to reason about the sub-tree, but it is more difficult to reason about the <em>remainder</em> of the original tree: Since you took out the sub-tree and have explicit permission for it, the recursive predicate for the whole tree can no longer have the permission for that part, so it would have to stop recursing at a certain point. With a wand, you can resolve this: For a tree <code>T</code> with left sub-tree <code>L</code> and right sub-tree <code>R</code>, and a recursive predicate <code>Tree(x)</code>, you can split <code>Tree(T)</code> into <code>Tree(L) ** (Tree(L)-*Tree(T))</code>. So you have the explicit resource for the left sub-tree, and a wand such that if you join the sub-tree back into it, you get the predicate for the whole tree back. This joining is called <em>applying</em> the wand.</p>
<h2 id="syntax-in-vercors">Syntax in VerCors</h2>
<p>We will use the following binary tree as example:</p>
<!-- standaloneSnip magicWandAndTree
//:: cases magicWandAndTree
//:: verdict Pass
//:: tool silicon
-->

<!-- codeSnip magicWandAndTree -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">final class Tree {
  int value;
  int priority;
  Tree left;
  Tree right;

  /*@
  resource tree() = Perm(value, write) ** Perm(priority, write) ** Perm(left, write) ** Perm(right, write) 
    ** (left != null ==&gt; left.tree()) ** (right != null ==&gt; right.tree());

  requires t.tree();
  static pure boolean sorted(Tree t) 
  = t != null ==&gt; \unfolding t.tree() \in 
    (t.left != null ==&gt; sorted(t.left) &amp;&amp; \unfolding t.left.tree() \in t.priority &gt;= t.left.priority) 
    &amp;&amp; (t.right!= null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority);
  @*/
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases magicWandAndTree
//:: verdict Pass
//:: tool silicon
final class Tree {
  int value;
  int priority;
  Tree left;
  Tree right;

  /*@
  resource tree() = Perm(value, write) ** Perm(priority, write) ** Perm(left, write) ** Perm(right, write) 
    ** (left != null ==&gt; left.tree()) ** (right != null ==&gt; right.tree());

  requires t.tree();
  static pure boolean sorted(Tree t) 
  = t != null ==&gt; \unfolding t.tree() \in 
    (t.left != null ==&gt; sorted(t.left) &amp;&amp; \unfolding t.left.tree() \in t.priority &gt;= t.left.priority) 
    &amp;&amp; (t.right!= null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority);
  @*/
/*@
requires t != null;
requires t.tree();
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures \result.tree() -* t.tree();
@*/
static Tree get_left(Tree t) {
  //@ unfold t.tree();
  Tree res = t.left;
  /*@
  create {
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    fold t.tree();
    qed res.tree() -* t.tree();
  }
  @*/
  return res;
}
/*@
context t != null;
context t.tree();
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority(Tree t, int max_priority) {
  Tree left = get_left(t);
  // now we have tree(left) and a wand tree(left) -* tree(t)
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply left.tree() -* t.tree();
  // now left.tree() is no longer directly available, but t.tree() is back
  return res;
}
/*@
requires t != null ** t.tree();
static boolean wand_helper(Tree t, int max_prio)
  = \unfolding t.tree() \in t.priority &lt;= max_prio;
@*/

/*@
yields int root_prio;
requires t != null;
requires t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures sorted(\result) &amp;&amp; wand_helper(\result, root_prio);
ensures \result.tree() ** sorted(\result) ** wand_helper(\result, root_prio) 
        -* 
        t.tree() ** sorted(t);
@*/
static Tree get_left_sorted(Tree t) {
  //@ unfold t.tree();
  //@ ghost root_prio = t.priority;
  Tree res = t.left;
  /*@
  create {
    // necessary parts for t.tree()
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    // necessary parts for t.sorted()
    use res != null;
    use t.priority == root_prio;
    use t.right != null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority;
    // assemble parts
    fold t.tree();
    qed res.tree() ** sorted(res) ** wand_helper(res, root_prio) 
        -* 
        t.tree() ** sorted(t);
  }
  @*/
  return res;
}

/*@
context t != null;
context t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority_sorted(Tree t, int max_priority) {
  //@ ghost int root_prio;
  Tree left = get_left_sorted(t) /*@ then { root_prio = root_prio; } @*/;
  // now we have left.tree(), sorted(left) and wand_helper(left, root_prio), as well as the wand
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply (left.tree() ** sorted(left) ** wand_helper(left, root_prio)) -* (t.tree() ** sorted(t));
  // now left.tree() is no longer directly available, but t.tree() is back and sorted
  return res;
}
} // Closing brace for class Tree, which started at the beginning of this chapter
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>So a <code>Tree</code> contains a data item <code>value</code>, a priority and two references to the sub-trees; the <code>tree</code> resource contains write permissions for all those fields, as well as recursive permissions for the sub-trees; and the <code>sorted</code> function ensures that the priority in the root node is the largest in the <code>Tree</code> (like in a priority queue).</p>
<h3 id="creating-a-wand">Creating a Wand</h3>
<p>To create a wand, use the keyword <code>create {...}</code>. Inside the curly braces, you have to provide the necessary information to create the wand:</p>
<p>You need to explicitly specify which resources from the current context should be folded into the wand. The keyword for this is <code>use</code>. Note that, like with folding a normal predicated, any permissions folded into the wand are no longer available in the environment. You can also <code>use</code> boolean facts from the current context, e.g. <code>use a==b;</code>.</p>
<p>When creating a wand <code>A-*B</code>, you need to describe how exactly to merge <code>A</code> with the content of the wand to obtain <code>B</code>. For example, <code>A</code> may contain permissions for the left sub-tree and the wand those for the right sub-tree, and to get the full tree, you need to perform a <code>fold</code>. All necessary permissions and boolean facts for such a merger must be provided via <code>use</code>.</p>
<p>The final statement within the curly braces of <code>create</code> has to be <code>qed A-*B;</code>, with <code>A-*B</code> being replaced by the wand you created.</p>
<p><strong>Note</strong> that the wand operator <code>-*</code> has the precedence like an implication, thus it is less binding than the separating conjunct <code>**</code> and boolean connectives like <code>&amp;&amp;</code>.</p>
<!-- codeSnip magicWandAndTree -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
requires t != null;
requires t.tree();
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures \result.tree() -* t.tree();
@*/
static Tree get_left(Tree t) {
  //@ unfold t.tree();
  Tree res = t.left;
  /*@
  create {
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    fold t.tree();
    qed res.tree() -* t.tree();
  }
  @*/
  return res;
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases magicWandAndTree
//:: verdict Pass
//:: tool silicon
final class Tree {
  int value;
  int priority;
  Tree left;
  Tree right;

  /*@
  resource tree() = Perm(value, write) ** Perm(priority, write) ** Perm(left, write) ** Perm(right, write) 
    ** (left != null ==&gt; left.tree()) ** (right != null ==&gt; right.tree());

  requires t.tree();
  static pure boolean sorted(Tree t) 
  = t != null ==&gt; \unfolding t.tree() \in 
    (t.left != null ==&gt; sorted(t.left) &amp;&amp; \unfolding t.left.tree() \in t.priority &gt;= t.left.priority) 
    &amp;&amp; (t.right!= null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority);
  @*/
/*@
requires t != null;
requires t.tree();
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures \result.tree() -* t.tree();
@*/
static Tree get_left(Tree t) {
  //@ unfold t.tree();
  Tree res = t.left;
  /*@
  create {
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    fold t.tree();
    qed res.tree() -* t.tree();
  }
  @*/
  return res;
}
/*@
context t != null;
context t.tree();
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority(Tree t, int max_priority) {
  Tree left = get_left(t);
  // now we have tree(left) and a wand tree(left) -* tree(t)
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply left.tree() -* t.tree();
  // now left.tree() is no longer directly available, but t.tree() is back
  return res;
}
/*@
requires t != null ** t.tree();
static boolean wand_helper(Tree t, int max_prio)
  = \unfolding t.tree() \in t.priority &lt;= max_prio;
@*/

/*@
yields int root_prio;
requires t != null;
requires t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures sorted(\result) &amp;&amp; wand_helper(\result, root_prio);
ensures \result.tree() ** sorted(\result) ** wand_helper(\result, root_prio) 
        -* 
        t.tree() ** sorted(t);
@*/
static Tree get_left_sorted(Tree t) {
  //@ unfold t.tree();
  //@ ghost root_prio = t.priority;
  Tree res = t.left;
  /*@
  create {
    // necessary parts for t.tree()
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    // necessary parts for t.sorted()
    use res != null;
    use t.priority == root_prio;
    use t.right != null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority;
    // assemble parts
    fold t.tree();
    qed res.tree() ** sorted(res) ** wand_helper(res, root_prio) 
        -* 
        t.tree() ** sorted(t);
  }
  @*/
  return res;
}

/*@
context t != null;
context t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority_sorted(Tree t, int max_priority) {
  //@ ghost int root_prio;
  Tree left = get_left_sorted(t) /*@ then { root_prio = root_prio; } @*/;
  // now we have left.tree(), sorted(left) and wand_helper(left, root_prio), as well as the wand
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply (left.tree() ** sorted(left) ** wand_helper(left, root_prio)) -* (t.tree() ** sorted(t));
  // now left.tree() is no longer directly available, but t.tree() is back and sorted
  return res;
}
} // Closing brace for class Tree, which started at the beginning of this chapter
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Notice how in the example, all the permissions necessary for folding <code>tree(t)</code> are provided with <code>use</code>, <strong>except</strong> the part that is in the premise of the wand, <code>tree(t.left)</code>. If we had provided that as well, it would have become part of the wand, rather than being the "missing piece", and the first post-condition <code>ensures tree(\result)</code> would have failed for lack of permission (since this permission is bundled into the wand, and no longer directly available). Additionally, we had to provide the fact that <code>res</code> is the left sub-tree of <code>t</code>, so that <code>fold tree(t)</code> knows that the premise of the wand fits into the missing part of the predicate.</p>
<h3 id="applying-a-wand">Applying a Wand</h3>
<p>To combine the "missing piece" with the wand and obtain the full resource, use the keyword <code>apply</code>. Since we already specified how the merging works when we created the wand, no further logic is needed now:</p>
<!-- codeSnip magicWandAndTree -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
context t != null;
context t.tree();
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority(Tree t, int max_priority) {
  Tree left = get_left(t);
  // now we have tree(left) and a wand tree(left) -* tree(t)
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply left.tree() -* t.tree();
  // now left.tree() is no longer directly available, but t.tree() is back
  return res;
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases magicWandAndTree
//:: verdict Pass
//:: tool silicon
final class Tree {
  int value;
  int priority;
  Tree left;
  Tree right;

  /*@
  resource tree() = Perm(value, write) ** Perm(priority, write) ** Perm(left, write) ** Perm(right, write) 
    ** (left != null ==&gt; left.tree()) ** (right != null ==&gt; right.tree());

  requires t.tree();
  static pure boolean sorted(Tree t) 
  = t != null ==&gt; \unfolding t.tree() \in 
    (t.left != null ==&gt; sorted(t.left) &amp;&amp; \unfolding t.left.tree() \in t.priority &gt;= t.left.priority) 
    &amp;&amp; (t.right!= null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority);
  @*/
/*@
requires t != null;
requires t.tree();
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures \result.tree() -* t.tree();
@*/
static Tree get_left(Tree t) {
  //@ unfold t.tree();
  Tree res = t.left;
  /*@
  create {
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    fold t.tree();
    qed res.tree() -* t.tree();
  }
  @*/
  return res;
}
/*@
context t != null;
context t.tree();
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority(Tree t, int max_priority) {
  Tree left = get_left(t);
  // now we have tree(left) and a wand tree(left) -* tree(t)
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply left.tree() -* t.tree();
  // now left.tree() is no longer directly available, but t.tree() is back
  return res;
}
/*@
requires t != null ** t.tree();
static boolean wand_helper(Tree t, int max_prio)
  = \unfolding t.tree() \in t.priority &lt;= max_prio;
@*/

/*@
yields int root_prio;
requires t != null;
requires t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures sorted(\result) &amp;&amp; wand_helper(\result, root_prio);
ensures \result.tree() ** sorted(\result) ** wand_helper(\result, root_prio) 
        -* 
        t.tree() ** sorted(t);
@*/
static Tree get_left_sorted(Tree t) {
  //@ unfold t.tree();
  //@ ghost root_prio = t.priority;
  Tree res = t.left;
  /*@
  create {
    // necessary parts for t.tree()
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    // necessary parts for t.sorted()
    use res != null;
    use t.priority == root_prio;
    use t.right != null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority;
    // assemble parts
    fold t.tree();
    qed res.tree() ** sorted(res) ** wand_helper(res, root_prio) 
        -* 
        t.tree() ** sorted(t);
  }
  @*/
  return res;
}

/*@
context t != null;
context t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority_sorted(Tree t, int max_priority) {
  //@ ghost int root_prio;
  Tree left = get_left_sorted(t) /*@ then { root_prio = root_prio; } @*/;
  // now we have left.tree(), sorted(left) and wand_helper(left, root_prio), as well as the wand
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply (left.tree() ** sorted(left) ** wand_helper(left, root_prio)) -* (t.tree() ** sorted(t));
  // now left.tree() is no longer directly available, but t.tree() is back and sorted
  return res;
}
} // Closing brace for class Tree, which started at the beginning of this chapter
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="more-complex-expressions">More Complex Expressions</h3>
<p>Sometimes, we may want to reason about the things contained in a wand; for example we decompose a sorted tree, and want to say it will be sorted again after the merger. However, as long as <code>tree(t)</code> is split into the sub-tree and the wand, we cannot call <code>sorted(t)</code> as it needs the full predicate <code>tree(t)</code>. But simply ignoring the sortedness when splitting and later merging again would mean that we can no longer make any assertions about sortedness afterwards. As a solution, we encode the property into the wand, by adding conjuncts to the premise and antecedence of the wand: <code>A**B -* C**D</code>. We can only apply such a wand if we hold the permissions of <code>A</code> <em>and</em> the properties in <code>B</code> hold. This stricter requirement is rewarded with the fact that we will get both the permissions in <code>C</code> and the properties of <code>D</code> after applying the wand.</p>
<p><strong>Note</strong> that VerCors currently only allows method calls as conjuncts in wands, so properties like an equality <code>a==b</code> must be wrapped in a function in order to be used.</p>
<!-- codeSnip magicWandAndTree -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
requires t != null ** t.tree();
static boolean wand_helper(Tree t, int max_prio)
  = \unfolding t.tree() \in t.priority &lt;= max_prio;
@*/

/*@
yields int root_prio;
requires t != null;
requires t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures sorted(\result) &amp;&amp; wand_helper(\result, root_prio);
ensures \result.tree() ** sorted(\result) ** wand_helper(\result, root_prio) 
        -* 
        t.tree() ** sorted(t);
@*/
static Tree get_left_sorted(Tree t) {
  //@ unfold t.tree();
  //@ ghost root_prio = t.priority;
  Tree res = t.left;
  /*@
  create {
    // necessary parts for t.tree()
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    // necessary parts for t.sorted()
    use res != null;
    use t.priority == root_prio;
    use t.right != null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority;
    // assemble parts
    fold t.tree();
    qed res.tree() ** sorted(res) ** wand_helper(res, root_prio) 
        -* 
        t.tree() ** sorted(t);
  }
  @*/
  return res;
}

/*@
context t != null;
context t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority_sorted(Tree t, int max_priority) {
  //@ ghost int root_prio;
  Tree left = get_left_sorted(t) /*@ then { root_prio = root_prio; } @*/;
  // now we have left.tree(), sorted(left) and wand_helper(left, root_prio), as well as the wand
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply (left.tree() ** sorted(left) ** wand_helper(left, root_prio)) -* (t.tree() ** sorted(t));
  // now left.tree() is no longer directly available, but t.tree() is back and sorted
  return res;
}
<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases magicWandAndTree
//:: verdict Pass
//:: tool silicon
final class Tree {
  int value;
  int priority;
  Tree left;
  Tree right;

  /*@
  resource tree() = Perm(value, write) ** Perm(priority, write) ** Perm(left, write) ** Perm(right, write) 
    ** (left != null ==&gt; left.tree()) ** (right != null ==&gt; right.tree());

  requires t.tree();
  static pure boolean sorted(Tree t) 
  = t != null ==&gt; \unfolding t.tree() \in 
    (t.left != null ==&gt; sorted(t.left) &amp;&amp; \unfolding t.left.tree() \in t.priority &gt;= t.left.priority) 
    &amp;&amp; (t.right!= null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority);
  @*/
/*@
requires t != null;
requires t.tree();
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures \result.tree() -* t.tree();
@*/
static Tree get_left(Tree t) {
  //@ unfold t.tree();
  Tree res = t.left;
  /*@
  create {
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    fold t.tree();
    qed res.tree() -* t.tree();
  }
  @*/
  return res;
}
/*@
context t != null;
context t.tree();
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority(Tree t, int max_priority) {
  Tree left = get_left(t);
  // now we have tree(left) and a wand tree(left) -* tree(t)
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply left.tree() -* t.tree();
  // now left.tree() is no longer directly available, but t.tree() is back
  return res;
}
/*@
requires t != null ** t.tree();
static boolean wand_helper(Tree t, int max_prio)
  = \unfolding t.tree() \in t.priority &lt;= max_prio;
@*/

/*@
yields int root_prio;
requires t != null;
requires t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures sorted(\result) &amp;&amp; wand_helper(\result, root_prio);
ensures \result.tree() ** sorted(\result) ** wand_helper(\result, root_prio) 
        -* 
        t.tree() ** sorted(t);
@*/
static Tree get_left_sorted(Tree t) {
  //@ unfold t.tree();
  //@ ghost root_prio = t.priority;
  Tree res = t.left;
  /*@
  create {
    // necessary parts for t.tree()
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    // necessary parts for t.sorted()
    use res != null;
    use t.priority == root_prio;
    use t.right != null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority;
    // assemble parts
    fold t.tree();
    qed res.tree() ** sorted(res) ** wand_helper(res, root_prio) 
        -* 
        t.tree() ** sorted(t);
  }
  @*/
  return res;
}

/*@
context t != null;
context t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority_sorted(Tree t, int max_priority) {
  //@ ghost int root_prio;
  Tree left = get_left_sorted(t) /*@ then { root_prio = root_prio; } @*/;
  // now we have left.tree(), sorted(left) and wand_helper(left, root_prio), as well as the wand
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply (left.tree() ** sorted(left) ** wand_helper(left, root_prio)) -* (t.tree() ** sorted(t));
  // now left.tree() is no longer directly available, but t.tree() is back and sorted
  return res;
}
} // Closing brace for class Tree, which started at the beginning of this chapter
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<!-- standaloneSnip magicWandAndTree
} // Closing brace for class Tree, which started at the beginning of this chapter
-->

<p>Now, when creating the wand, we need to <code>use</code> additional information in order to be able to ensure sortedness after the merger: The condition for the right side can simply be provided. The condition for the left side is part of the premise of the wand (in particular <code>sorted</code>). The comparison between the priority of the root and the priority of the left node is wrapped into a helper function, <code>wand_helper</code>. Since the premise of the wand contains no permissions for <code>t.priority</code>, we use a ghost variable <code>root_prio</code> to communicate that value.</p>
<p>Applying the wand is nearly as simple as before. However, we again need to use the ghost variable <code>root_prio</code> as an intermediate storage for the priority of <code>t</code>.</p>
<p>You see that adding such additional constraints about the wand's resources is possible, but can carry significant overhead of helper functions, <code>use</code> statements, etc.</p>
<h1 id="inhale-and-exhale">Inhale and exhale</h1>
<p>// TODO: Explain inhale and exhale statements (add warning!)</p>
<h1 id="what-does-this-vercors-error-message-mean">What does this VerCors error message mean?</h1>
<p>This page is to explain what the different error messages in VerCors mean. We try to keep this page alphabetically ordered by error message (case insensitive sorting. For sentences: spaces come before letters in the alphabet). If you have a question about error messages, please add a question to this wiki page. If you know the answer to a question asked here, please replace the question with the answer (or with a link to the answer elsewhere on the wiki).</p>
<h4 id="assignmentfailed-insufficient-permission">AssignmentFailed: insufficient permission</h4>
<p>This means you are trying to write to a variable (at the left hand side of an assignment) to which VerCors cannot establish a write-permission. The statement <code>assert(Perm(lhs,1));</code> in which <code>lhs</code> is the left hand side of this assignment will fail at this point in your code, but should be provable.</p>
<h4 id="illegal-argument-count">Illegal argument count</h4>
<p>This is a internal VerCors error, that might be due to a parse-error in your script. We have opened a issue for this <a href="https://github.com/utwente-fmt/vercors/issues/125">here</a>.</p>
<h4 id="illegal-iteration-invariant">Illegal iteration invariant</h4>
<p>This seems to happen when you try to specify a <code>loop_invariant</code> in a <code>for</code>-loop, where you're using a resource as invariant. Try using <code>context</code> (short for <code>ensures</code> and <code>requires</code> combined) instead. Are you getting this message in a different situation? Do let us know!</p>
<h4 id="javalang">java.lang.*</h4>
<p>This is never supposed to happen, but unfortunately, it did. Thank you for finding this bug in VerCors. Try searching our issue tracker to see if you believe this bug is already being addressed. If not, please let us know about it by adding it!</p>
<h4 id="no-viable-alternative-at-">No viable alternative at ...</h4>
<p>This is a parsing error, you may have made a typo, or inadvertently used a reserved keyword as a variable. Check your code at the position indicated. If this is the start of a line, make sure there is a semicolon <code>;</code> at the previous line.</p>
<h4 id="notwellformedinsufficientpermission">NotWellFormed:InsufficientPermission</h4>
<p>This error is shown at a specification. We require rules to be 'self framing', this means that you need read-permission in order to access variables, even inside specifications. Furthermore, checks like array accesses being within bounds need to hold. The order of the specifications makes a difference here: the lines of your specifications are checked from top to bottom, and from left to right. In order to establish permissions and bounds, add a line of specification before the line that gives you trouble, asserting that you have read permission, or that the access is within bounds.</p>
<p>If you see this error in the <code>\old(..)</code> part of an ensures expression, you need permission to that variable before executing the function. For constructors (e.g. <code>foo</code> method of class <code>foo</code>), there is no <code>\old(this.x)</code>, as the variable <code>this.x</code> is only created when the constructor is called.</p>
<h4 id="pre-condition-of-constructor-may-not-refer-to-this">Pre-condition of constructor may not refer to this</h4>
<p>When calling the constructor method of a class, the class variables are not yet initialised. Therefore, you should not refer to them. Do you need write-permission? Don't worry, the class constructor already has it by definition (as it implicitly creates the variables)!</p>
<h4 id="type-of-leftright-argument-is-resource-rather-than-boolean">Type of left/right argument is Resource rather than Boolean:</h4>
<p>This is a type error. You are using a symbol like <code>&amp;&amp;</code> that requires boolean values on both sides. Changing <code>&amp;&amp;</code> to <code>**</code>, or breaking up your specification into multiple lines might solve the problem for you.</p>
<h4 id="verification-aborted-exceptionally-javautilconcurrentexecutionexception-javautilconcurrentexecutionexception-javautilnosuchelementexception-noneget">Verification aborted exceptionally: java.util.concurrent.ExecutionException: java.util.concurrent.ExecutionException: java.util.NoSuchElementException: None.get</h4>
<p>See <a href="https://github.com/utwente-fmt/vercors/wiki/Predicates#vercors-crashes-when-predicates-are-unfolded">VerCors crashes when predicates are unfolded</a>.</p>
<h1 id="pvl-syntax-reference">PVL Syntax Reference</h1>
<p>On this page you can find a description of the syntax of PVL, Prototypal Verification Language; one of the languages for which VerCors supports verification.</p>
<h2 id="general">General</h2>
<ul>
<li><strong>Identifiers</strong> can consist of the characters a-z, A-Z, 0-9 and _. However, they must <strong>start</strong> with a letter (a-z, A-Z). Note that the following words are reserved and can therefore <strong>not</strong> be used as identifiers: create, action, destroy, send, recv, use, open, close, atomic, from, merge, split, process, apply, label, \result, write, read, none, empty and current_thread.</li>
<li>The keyword <code>this</code> is used to refer to the current object.</li>
<li>A program is typically defined within a <code>class</code>:</li>
</ul>
<!-- end list -->

<pre><code>class ClassName {
    // Here you can add any constructors, class variables and method declarations
}
</code></pre>
<ul>
<li>You can write single-line or multi-line comments as follows:</li>
</ul>
<!-- end list -->

<pre><code>// This is a single-line comment
/* 
    This is a 
    multi-line comment 
*/
</code></pre>
<ul>
<li>Lines in PVL should end with a semi-colon <code>;</code>.</li>
<li>Unlike JML, PVL specifications are <strong>not</strong> written in comments!</li>
</ul>
<h2 id="types-and-data-structures">Types and Data Structures</h2>
<table>
<thead>
<tr class="header">
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>int</code></td>
<td>Integer</td>
</tr>
<tr class="even">
<td><code>boolean</code></td>
<td><code>true</code> or <code>false</code></td>
</tr>
<tr class="odd">
<td><code>void</code></td>
<td>Used when a method does not return anything</td>
</tr>
<tr class="even">
<td><code>resource</code></td>
<td>Boolean-like type that also allows reasoning about permissions</td>
</tr>
<tr class="odd">
<td><code>frac</code></td>
<td>Fraction</td>
</tr>
<tr class="even">
<td><code>zfrac</code></td>
<td>Fraction that can also be zero.</td>
</tr>
<tr class="odd">
<td><code>process</code></td>
<td>Type of actions and defined processes in histories. For more information on histories &amp; futures, have a look at the section on <a href="#historiesAndFutures">Histories &amp; Futures</a>.</td>
</tr>
<tr class="even">
<td><code>T[]</code></td>
<td>Array which contains elements of type <code>T</code>. <code>T</code> should be replaced by a type. Note that when you initialize a new array, you should always define the length of the array, e.g. <code>new int[3]</code> instead of <code>new int[]</code>.</td>
</tr>
<tr class="odd">
<td><code>seq&lt;T&gt; var</code></td>
<td>Defines an immutable ordered list (sequence) named <code>var</code>. <code>T</code> should be replaced by a type.</td>
</tr>
<tr class="even">
<td><code>set&lt;T&gt; var</code></td>
<td>Defines an immutable orderless collection (set) that does not allow duplicates. <code>T</code> should be replaced by a type.</td>
</tr>
<tr class="odd">
<td><code>bag&lt;T&gt; var</code></td>
<td>Defines an immutable orderless collection (bag) that does allow duplicates. <code>T</code> should be replaced by a type.</td>
</tr>
<tr class="even">
<td><code>option&lt;T&gt;</code></td>
<td>Extends type <code>T</code> with an extra element <code>None</code>. Each element is then either of the type <code>None</code> or of the type <code>Some(e)</code> where <code>e</code> is of type <code>T</code>. <code>T</code> should be replaced by a type. Options cannot be unpacked at the moment.</td>
</tr>
</tbody>
</table>
<p>For more information on sequences, sets, bags and options, have a look at the wiki page on <a href="https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types">Axiomatic Data Types</a>.</p>
<h2 id="expressions-1">Expressions</h2>
<h3 id="infix-operators">Infix Operators</h3>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>==</code>, <code>!=</code></td>
<td>Equals and not equals for reasoning about the equality of expressions</td>
</tr>
<tr class="even">
<td><code>&amp;&amp;</code>, <code>||</code>, <code>!</code></td>
<td>And, or, and negation respectively for reasoning with boolean variables.</td>
</tr>
<tr class="odd">
<td><code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&gt;=</code></td>
<td>Smaller than, smaller than equals, greater than and greater than equals respectively. They are used to compare integers.</td>
</tr>
<tr class="even">
<td><code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>\</code></td>
<td>Addition, subtraction, multiplication, integer division and fractional division respectively.</td>
</tr>
<tr class="odd">
<td><code>++</code>, <code>--</code></td>
<td>Increase by 1 and decrease by 1 respectively. Unlike the other operators, this only requires an variable on the left-hand side.</td>
</tr>
<tr class="even">
<td><code>==&gt;</code></td>
<td>Implication. This statement evaluates to true unless the statement before the arrow evaluates to true and the statement after the arrow evaluates to false.</td>
</tr>
<tr class="odd">
<td><code>**</code></td>
<td>Separating conjunction. <code>a ** b</code> denotes that <code>a</code> and <code>b</code>point to different variables on the heap and that both expressions mus tevaluate to true. This is used to reason about multiple resources.</td>
</tr>
<tr class="even">
<td><code>-*</code></td>
<td>Magic wand or separating implication. This is used to reason about resources. //TODO: investigate what is supported.</td>
</tr>
<tr class="odd">
<td><code>new T()</code></td>
<td>Creates a new object of type <code>T</code>.</td>
</tr>
<tr class="even">
<td><code>new T[length]</code></td>
<td>Creates a new array which contains objects of type <code>T</code> with <code>length</code> number of items.</td>
</tr>
<tr class="odd">
<td><code>boolExpr ? exprA : exprB;</code></td>
<td>Evaluates <code>boolExpr</code>, if this is true it will return <code>exprA</code> and otherwise <code>exprB</code>.</td>
</tr>
<tr class="even">
<td><code>(\let T t = exprA; exprB)</code></td>
<td>Evaluates <code>exprB</code>, replacing every occurence of <code>t</code> with the result of evaluating<code>exprA</code>. The surrounding parens <code>(</code> <code>)</code> are required.</td>
</tr>
</tbody>
</table>
<h3 id="quantified-expressions">Quantified Expressions</h3>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>(\forall vars; range; boolExpr)</code></td>
<td>Construct that allows you to repeat a certain expression for several variables. For example, <code>(\forall int j; j &gt;= 0 &amp;&amp; j &lt; n; array[j] &gt;= 0)</code> denotes that all elements in <code>array</code> nonnegative. It is equal to the following statement: <code>array[0] &gt;= 0 &amp;&amp; array[1] &gt;= 0 &amp;&amp; ... &amp;&amp; array[n-1] &gt;= 0</code>. <code>vars</code> should declare the variables over which we will reason. <code>range</code> can be any boolean expression, often used to describe the range of <code>vars</code>. <code>boolExpr</code> is some expression that should evaluate to a boolean for all variables in the given range.</td>
</tr>
<tr class="even">
<td><code>(\forall* vars; range; expr)</code></td>
<td>Similar construct to the <code>\forall</code> except that the expressions are separated by <code>**</code> instead of <code>&amp;&amp;</code>. One can for example write <code>(\forall* int j; j &gt;= 0 &amp;&amp; j &lt; array.length; Perm(array[j], write)</code> which denotes that the thread has writing access to all elements in <code>array</code>.</td>
</tr>
<tr class="odd">
<td><code>(\exists Type id; range; expr)</code></td>
<td>Evaluates to true if there exists an element, called <code>id</code>, such that the final expression evaluates to true.</td>
</tr>
<tr class="even">
<td><code>array[*]</code></td>
<td>This is a simplified <code>\forall*</code> expression that ranges over all elements in the array <code>array</code>. Instead of the example mentioned above for <code>\forall*</code>, you can then write <code>Perm(array[*], write)</code>. This <strong>cannot</strong> be used within nested <code>\forall*</code> expressions.</td>
</tr>
</tbody>
</table>
<h3 id="specification-only-expressions">Specification-only Expressions</h3>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>\result</code></td>
<td>Keyword that refers to the object that the method returns</td>
</tr>
<tr class="even">
<td><code>\old(expr)</code></td>
<td>Refers to the value of the specified expression in the pre-state. This can be used in a postcondition (ensures) or loop invariant in which case the pre-state is when the method was called.</td>
</tr>
<tr class="odd">
<td><code>held(x)</code></td>
<td>Check whether you are holding a non-reentrant lock. <code>x</code> should refer to the lock invariant. See also: <a href="https://github.com/utwente-fmt/vercors/blob/dev/examples/waitnotify/Queue.pvl">Queue.pvl</a>.</td>
</tr>
<tr class="even">
<td><code>idle(t)</code></td>
<td>Returns true if thread <code>t</code> is idle (before calling <code>t.fork()</code> or after calling <code>t.join()</code>). Overall a thread starts as idle, if the thread is forked, it goes to a 'runnning' state. If join is called on a running thread, then it goes back to an 'idle' state.</td>
</tr>
<tr class="odd">
<td><code>running(t)</code></td>
<td>Returns true if thread <code>t</code> is running. Overall a thread can go through the following states: idle --[t.fork()]--&gt; running --[t.join()]--&gt; idle</td>
</tr>
</tbody>
</table>
<h3 id="resources">Resources</h3>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>Perm(var, p)</code></td>
<td>Defines permissions for variable <code>var</code>. If <code>p</code> is <code>1</code> or <code>write</code> then it denotes write permission, anything between 0 and 1 or <code>read</code> denotes read permission. Be aware that you cannot use arithmetic when using <code>read</code> such as <code>read/2</code> or dividing <code>read</code> among multiple threads! <code>Perm()</code> is of the type Resource.</td>
</tr>
<tr class="even">
<td><code>PointsTo(var, p, val)</code></td>
<td>Denotes permissions <code>p</code> for variable <code>var</code> similar to <code>Perm()</code>. Moreover, variable <code>var</code> points to the value <code>val</code>. <code>PointsTo()</code> is of the type Resource.</td>
</tr>
<tr class="odd">
<td><code>Value(var)</code></td>
<td>Defines a read-only permission on the given variable. This read-only permission cannot become a write permission and it can duplicate as often as necessary.</td>
</tr>
</tbody>
</table>
<h2 id="control-flow-constructs">Control flow constructs</h2>
<table>
<thead>
<tr class="header">
<th>Control flow construct</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Function</td>
<td><code>contract returnType functionName(paramType paramName, ...) { ... }</code>. <code>contract</code> should describe the specification of the method. <code>returnType</code> should be replaced by a specific type or <code>void</code> depending on what (if anything) the method returns. <code>functionName</code> should be replaced by the name of the function. <code>paramType paramName, ...</code> is a comma-separated list of parameters, for every parameter you should define its type and its name. It is also possible to have no parameters. For example: <code>ensures \result == a + b; int sum(int a, int b) { return a + b; }</code> is a function which returns an integer that is the sum of the parameters given.<br> <strong>Pure and Abstract Functions:</strong> Pure functions are declared by prepending modifiers <code>static</code> and <code>pure</code> in that order. They should be side-effect free and their postconditions must not contain resource assertions such as accessibility predicates. All accessibility constraints for the body of the function and for the postcondition should be ensured by the preconditions. In fact, since pure functions applications are side-effect-free, pre- and post-states of a function application are the same. <em>Example:</em><br><code>requires a != null;</code><br><code>requires 0 &lt;= n &amp;&amp; n &lt;= a.length;</code><br><code>requires (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; a.length; Perm(a[j],1\2));</code><br><code>ensures (n==a.length)? \result == 0 : \result == a[n] + sumAll(a,n+1);</code><br><code>static pure int sumAll(int []a, int n);</code><br>Notice that in the example the function has no body. By doing so we declare an <em>abstract function</em>. When calling this function, its pre-conditions will be checked and its postconditions assumed. No correspondence should be assumed between pure and abstract functions.</td>
</tr>
<tr class="even">
<td>Return</td>
<td><code>return</code> can be used to exit the current method. <code>return expr</code> can be used within a method to return a specific object as a result.</td>
</tr>
<tr class="odd">
<td>If-statement</td>
<td><ul><li>Single-line option: <code>if (boolExpr) ...;</code></li><li>Multi-line option: <code>if (boolExpr) { ... }</code></li></ul></td>
</tr>
<tr class="even">
<td>If-then-else</td>
<td><code>if (boolExpr) { ... } else { ... }</code></td>
</tr>
<tr class="odd">
<td>For-loop</td>
<td><code>loop_invariant p; for (...) { ... }</code></td>
</tr>
<tr class="even">
<td>While-loop</td>
<td><code>loop_invariant p; while (boolExpr) { ... }</code></td>
</tr>
<tr class="odd">
<td>Parallel block</td>
<td><code>par contract { ... }</code> OR <code>par identifier(iters) contract { ... }</code>. The <code>identifier</code> is optional and <code>iters</code> can be empty. <code>iters</code> specifies what variables are iterated over. Note that you can also extend a parallel block with another parallel block as follows: <code>par contract { ... } and contract { ... }</code> OR <code>par identifier(iters) contract { ... } and identifier(iters) contract { ... }</code>.</td>
</tr>
<tr class="even">
<td>Vector block</td>
<td><code>vec (iters) { ... }</code> is a variant of the parallel block where every step is executed in lock step. You do not need to specify a pre- and postcondition. <code>iters</code> should define what variables are iterated over, e.g., <code>int i = 0..10</code>.</td>
</tr>
<tr class="odd">
<td>Atomic block</td>
<td><code>atomic(inv) { ... }</code> performs the actions within the block atomically. As a result, other threads will not be able to see any intermediate results, only the result before or after executing the atomic block. <code>inv</code> refers to an invariant which stores permissions that are necessary when executing the atomic block.</td>
</tr>
<tr class="even">
<td>Barrier</td>
<td><code>barrier(identifier) contract {  }</code> waits for all threads to reach this point in the program, then permissions can be redistributed amongst all threads, as specified in the contract, after which the threads are allowed to continue. The barrier needs to know how many threads should reach it before everyone is allowed to continue, this is done by specifying <code>identifier</code> which refers to a parallel block before the barrier.</td>
</tr>
<tr class="odd">
<td>Fork a thread</td>
<td><code>fork expr</code> starts a new thread.</td>
</tr>
<tr class="even">
<td>Join a thread</td>
<td><code>join expr</code> waits for the specified thread to complete.</td>
</tr>
<tr class="odd">
<td>Wait</td>
<td><code>wait expr</code> will pause the thread until it is notified to continue.</td>
</tr>
<tr class="even">
<td>Notify</td>
<td><code>notify expr</code> will notify another thread that it may continue if it is waiting.</td>
</tr>
<tr class="odd">
<td>Acquire a lock</td>
<td><code> lock expr</code></td>
</tr>
<tr class="even">
<td>Release a lock</td>
<td><code>unlock expr</code></td>
</tr>
<tr class="odd">
<td>Label</td>
<td><code>label l</code> indicates a location in the program that can be jumped to with <code>goto l</code>.</td>
</tr>
<tr class="even">
<td>Goto</td>
<td><code>goto l</code> indicates control flow must be transferred to the location of the label <code>l</code>.</td>
</tr>
</tbody>
</table>
<p>Note that <strong>for-loops</strong> and <strong>while-loops</strong> should be <strong>preceded with a contract</strong> consisting of one or more loop invariants. Parallel blocks require a contract in the form of requires/ensures clauses.</p>
<h2 id="verification-flow-constructs">Verification flow constructs</h2>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>assert expr</code></td>
<td>Defines an assert statement <code>expr</code> which describes a condition that should hold at the program point where this statement is defined.</td>
</tr>
<tr class="even">
<td><code>assume expr</code></td>
<td>Defines a statement that assumes that <code>expr</code> holds. It can be put anywhere within the code.</td>
</tr>
<tr class="odd">
<td><code>requires expr</code></td>
<td>Defines the precondition as <code>expr</code>, i.e., <code>expr</code> must hold when calling this method. The precondition should be specified <strong>before</strong> the method declaration.</td>
</tr>
<tr class="even">
<td><code>ensures expr</code></td>
<td>Defines the postcondition as <code>expr</code>, i.e., <code>expr</code> must hold when completing this method. The postcondition should be specified <strong>before</strong> the method declaration.</td>
</tr>
<tr class="odd">
<td><code>context expr</code></td>
<td>This is an abbreviation that combines the statements <code>requires expr</code> and <code>ensures expr</code>. This statement should be specified <strong>before</strong> the method declaration.</td>
</tr>
<tr class="even">
<td><code>loop_invariant expr</code></td>
<td>Defines a loop invariant <code>expr</code> which is a condition that must hold when entering the loop and after each loop iteration. A loop invariant should be specified <strong>before</strong> the corresponding loop.</td>
</tr>
<tr class="odd">
<td><code>context_everywhere expr</code></td>
<td>This is an abbreviation that combines the statement <code>requires expr</code> and <code>ensures expr</code>. Moreover, it also adds <code>loop_invariant expr</code> to all loops within the method. This statement should be specified <strong>before</strong> the method declaration.</td>
</tr>
<tr class="even">
<td><code>given T p</code></td>
<td>Defines that a ghost input parameter (specification-only parameter) of type <code>T</code> with the name <code>p</code> is passed when this method is called. This statement should be specified <strong>before</strong> the method declaration.</td>
</tr>
<tr class="odd">
<td><code>yields x</code></td>
<td>Returns a ghost output parameter (specification-only parameter) to the callee of this method. This statement should be specified <strong>before</strong> the method declaration.</td>
</tr>
<tr class="even">
<td><code>with ... then ...</code></td>
<td><code>with</code> is used to pass a parameter to a method (which has a given statement) and <code>then</code> can be used to store a returned value from a <code>yields</code> statement. This statement is specified after the corresponding method call (on the same line) where you want to pass the parameter. All the <code>...</code> should be replaced by an assignment.</td>
</tr>
<tr class="odd">
<td><code>unfolding ... in expr</code></td>
<td>Temporarily unfold definitions in (pure) expressions. The <code>...</code> should be replaced by a predicate.</td>
</tr>
<tr class="even">
<td><code>refute expr</code></td>
<td>Disproves <code>expr</code> at the given program point. This statement can be put anywhere in the code. Internally it is translated to <code>assert !(expr)</code>.</td>
</tr>
<tr class="odd">
<td><code>inhale p</code></td>
<td>Take in the specified permissions and properties.</td>
</tr>
<tr class="even">
<td><code>exhale p</code></td>
<td>Discard the specified permissions</td>
</tr>
<tr class="odd">
<td><code>fold x</code></td>
<td>Wrap permissions inside the definition</td>
</tr>
<tr class="even">
<td><code>unfold x</code></td>
<td>Unwrap a bundle of permissions</td>
</tr>
<tr class="odd">
<td><code>witness x</code></td>
<td>Declares witness names. <em>This feature is deprecated and should no longer be used</em>.</td>
</tr>
</tbody>
</table>
<h3 id="histories--futures-">Histories &amp; Futures <a name="historiesAndFutures"></a></h3>
<h4 id="defining-processes">Defining processes</h4>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>process</code></td>
<td>Type of actions and defined processes in histories.</td>
</tr>
<tr class="even">
<td><code>process1 + process 2</code></td>
<td>Do either <code>process1</code> or <code>process2</code></td>
</tr>
<tr class="odd">
<td><code>process1 * process 2</code></td>
<td>Sequential composition, do <code>process1</code> followed by <code>process2</code></td>
</tr>
<tr class="even">
<td><code>process1 || process 2</code></td>
<td>Parallel composition, do <code>process1</code> and <code>process2</code> at the same time (interleaved)</td>
</tr>
</tbody>
</table>
<h4 id="history-related-constructs">History-related constructs</h4>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>History hist</code></td>
<td>Declare a History object called <code>hist</code></td>
</tr>
<tr class="even">
<td><code>HPerm(var, p)</code></td>
<td>History-specific permissions where <code>var</code> refers to a variable in the history and <code>p</code> is the amount of permissions (a value between 0 and 1)</td>
</tr>
<tr class="odd">
<td><code>Hist(var, p, val)</code></td>
<td>Similar to <code>PointsTo</code>, it denotes permissions <code>p</code> for variable <code>var</code> (which is in a history). Moreover, variable <code>var</code> points to the value <code>val</code>.</td>
</tr>
<tr class="even">
<td><code>AbstractState(h, boolExpr)</code></td>
<td>This can be used to check that the given boolean expression holds in the history (or future) <code>h</code></td>
</tr>
<tr class="odd">
<td><code>action(h, perm, preState, postState) { ... }</code></td>
<td>The action describes how the state of the history (or future) is changed by the code within <code>{ ... }</code>. The pre- and post-state describe the state of the history (or future) in terms of processes. <code>perm</code> describes the permissions we have on the history (or future) and <code>h</code> is the name of the history (or future)</td>
</tr>
<tr class="even">
<td><code>create h</code></td>
<td>Create a history. Note that the History class should be instantiated beforehand.</td>
</tr>
<tr class="odd">
<td><code>destroy h, val</code></td>
<td>Destroy a history <code>h</code> which has the value <code>val</code></td>
</tr>
<tr class="even">
<td><code>split h, p1, val1, p2, val2</code></td>
<td>Split a history (or future) into two such that the first part has permissions <code>p1</code> and value <code>val1</code> and the second part has permissions <code>p2</code> and value <code>val2</code></td>
</tr>
<tr class="odd">
<td><code>merge h, p1, val1, p2, val2</code></td>
<td>Merge two histories (or futures) such that resulting history <code>h</code> has permissions <code>p1+p2</code> and consists of combination of the actions described in <code>val1</code> and <code>val2</code></td>
</tr>
<tr class="even">
<td><code>modifies vars</code></td>
<td>List of locations that might be modified</td>
</tr>
<tr class="odd">
<td><code>accessible vars</code></td>
<td>List of locations that might be accessed</td>
</tr>
</tbody>
</table>
<h4 id="future-related-constructs">Future-related constructs</h4>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>Future f</code></td>
<td>Declare a Future object called <code>f</code></td>
</tr>
<tr class="even">
<td><code>Future(f, p, val)</code></td>
<td>It denotes that we have permissions <code>p</code> on future <code>f</code> of which the state is <code>val</code></td>
</tr>
<tr class="odd">
<td><code>choose f, p1, pre, post</code></td>
<td>//TODO check this support and definition</td>
</tr>
<tr class="even">
<td><code>create f, val</code></td>
<td>Create a future <code>f</code> with the initial state <code>val</code></td>
</tr>
<tr class="odd">
<td><code>destroy f</code></td>
<td>Destroy the future <code>f</code></td>
</tr>
</tbody>
</table>
<h4 id="other">Other</h4>
<ul>
<li>APerm ??</li>
<li><code>Ls: send p to Lr, d</code> | Release permissions <code>p</code> to the statement labelled <code>Lr</code> with <code>d</code> being the distance of dependence. This statement is labelled <code>Ls</code>.</li>
<li><code>Lr: recv p from Ls, d</code> | Acquire permission <code>p</code> from the statement labelled <code>Ls</code> with the distance of dependence <code>d</code>. This statement is labelled <code>Lr</code>.</li>
<li>Iteration contract | An iteration contract specifies the iteration's resources. The precondition of an iteration contract specifies the resources that a particular iteration needs, and the postcondition specifies the resources that become available after the execution of the iteration.</li>
<li>\pointer(var, length, perm), \pointer_index(...)?</li>
</ul>
<h1 id="vercors-usage--debugging-cheat-sheet">VerCors usage &amp; debugging cheat sheet</h1>
<h2 id="information--questions">Information &amp; questions</h2>
<p><a href="https://github.com/utwente-fmt/vercors/wiki">https://github.com/utwente-fmt/vercors/wiki</a></p>
<p>If you're doing a project with VerCors, ask us about the VerCors community chat.</p>
<h2 id="getting-vercors-up-and-running">Getting VerCors up and running</h2>
<p>Required: at least java 11</p>
<h3 id="pre-build">Pre-build</h3>
<ul>
<li>Download latest release (1.3.0 at the time of writing, doesn't work on windows)</li>
<li>Download the build from the dev branch. Download the .tgz file, it contains a bat script for windows as well. Very likely works, but no guarantee</li>
</ul>
<p>Should be just unzip and go.</p>
<h3 id="compile-from-source">Compile from source</h3>
<p>Requires java 11 &amp; sbt. Benefits: allows setting breakpoints in intellij. See VerCors README/Wiki for details.</p>
<h2 id="general-usage">General usage</h2>
<p><code>vercors inputFile.java --backend</code></p>
<p>Where <code>backend</code> can be either <code>silicon</code> or <code>carbon</code>.</p>
<h2 id="general-flags">General flags</h2>
<p>Of course, <code>--help</code></p>
<p>Backends: <code>--carbon</code> (slower, but based on boogie, so sometimes more powerful), <code>--silicon</code> (faster, built by ETH Zurich, sometimes not as smart as Carbon)</p>
<p>Progress printing of individual passes: <code>--progress</code></p>
<p>Slows down execution but prints more debug info upon crashes: <code>--debug vct.main.Main</code></p>
<p>Triggers a system notification upon completion: <code>--notify</code></p>
<h2 id="advanced-verification-flags">Advanced verification flags</h2>
<h3 id="detection-of-unsound-preconditions">Detection of unsound preconditions</h3>
<p>Flag: <code>--disable-sat</code></p>
<p>Turns off detection of unsound preconditions. Not needed in general use of VerCors. Might be necessary if you have a lot of foralls in preconditions, and verification is slow.</p>
<p>Java example:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb43-1" title="1"><span class="kw">class</span> C {</a>
<a class="sourceLine" id="cb43-2" title="2">    <span class="co">//@ requires 1 == 2; // &lt;-- Normally this causes an error, --disable-sat turns this off    </span></a>
<a class="sourceLine" id="cb43-3" title="3">    <span class="dt">void</span> <span class="fu">m</span>() {</a>
<a class="sourceLine" id="cb43-4" title="4"></a>
<a class="sourceLine" id="cb43-5" title="5">    }</a>
<a class="sourceLine" id="cb43-6" title="6">}</a></code></pre></div>
<h2 id="debugging-flags">Debugging flags</h2>
<p>Flags: <code>--show-before passName</code>, <code>--show-after passName</code></p>
<p>Show textual representation of internal AST before and after a pass. Pass names can be seen by running VerCors with <code>--progress</code>.</p>
<h3 id="vscode-plugin--flags-needed">VSCode plugin + flags needed</h3>
<p>Dump AST given to silicon/carbon into a text file: <code>--encoded temp.sil</code></p>
<p>This can be opened in VScode with the ETH Zurich Viper plugin/extension installed (see the vscode store for this).</p>
<p>Note:</p>
<ul>
<li>The viper version between VerCors and vscode might be out of sync</li>
<li>The vscode plugin has a 100 second timeout (though it can be turned off)</li>
<li>The vscode plugin caches results in a wrong way sometimes (this can also be turned off)</li>
</ul>
<h2 id="some-starter-example-files">Some starter example files</h2>
<ul>
<li>In the <code>example</code> folder in the repository:
<ul>
<li><code>basic/BasicAssert-e1.java</code></li>
<li><code>parallel/block-par.pvl</code></li>
<li><code>demo/demo1.pvl</code>, <code>demo/demo2.pvl</code></li>
</ul></li>
<li>All examples in the wiki/tutorial</li>
</ul>
<h1 id="case-studies">Case Studies</h1>
<p>This page lists all the case studies that have been done with VerCors.</p>
<h2 id="published-case-studies">Published case studies</h2>
<ul>
<li><strong>Automated Verification of the Parallel Bellman-Ford Algorithm</strong>. M. Safari, W. Oortwijn and M. Huisman (SAS 2021).
<ul>
<li>Paper: <a href="https://doi.org/10.1007/978-3-030-88806-0_17">https://doi.org/10.1007/978-3-030-88806-0_17</a></li>
<li>Code: <a href="https://github.com/Safari1991/SSSP-Verification">https://github.com/Safari1991/SSSP-Verification</a></li>
<li>Builds on the student project by J. Smits</li>
</ul></li>
<li><strong>Permission-Based Verification of Red-Black Trees and Their Merging</strong>. L. Armborst and M. Huisman (FormaliSE 2021).
<ul>
<li>Paper: <a href="https://research.utwente.nl/en/publications/permission-based-verification-of-red-black-trees-and-their-mergin">https://research.utwente.nl/en/publications/permission-based-verification-of-red-black-trees-and-their-mergin</a></li>
<li>Code: <a href="https://data.4tu.nl/articles/software/_/13611578">https://data.4tu.nl/articles/software/_/13611578</a></li>
<li><em>This is a continuation of the master project by H.M. Nguyen</em></li>
</ul></li>
<li><strong>Formal Verification of Parallel Stream Compaction and Summed-Area Table Algorithms</strong>. M. Safari and M. Huisman (ICTAC 2020).
<ul>
<li>Paper: <a href="https://doi.org/10.1007/978-3-030-64276-1_10">https://doi.org/10.1007/978-3-030-64276-1_10</a></li>
<li>Code: <a href="https://github.com/Safari1991/Prefixsum-Applications">https://github.com/Safari1991/Prefixsum-Applications</a></li>
</ul></li>
<li><strong>A Generic Approach to the Verification of the Permutation Property of Sequential and Parallel Swap-Based Sorting Algorithms</strong>. M. Safari and M. Huisman (IFM 2020).
<ul>
<li>Paper: <a href="https://doi.org/10.1007/978-3-030-63461-2_14">https://doi.org/10.1007/978-3-030-63461-2_14</a></li>
<li>Code: <a href="https://github.com/Safari1991/Permutation">https://github.com/Safari1991/Permutation</a></li>
</ul></li>
<li><strong>On the Industrial Application of Critical Software Verification with VerCors</strong>. M. Huisman and R.E. Monti (ISoLA 2020).
<ul>
<li>Paper: <a href="https://doi.org/10.1007/978-3-030-61467-6_18">https://doi.org/10.1007/978-3-030-61467-6_18</a></li>
<li>Code: <em>Not publicly available</em></li>
<li>This was in collaboration with the companies <em>Technolution</em> and <em>Thales</em>.</li>
<li>This case study uses a combination of mCRL2 (model checker) and VerCors to prove correctness of the software.</li>
</ul></li>
<li><strong>Formal Verification of Parallel Prefix Sum</strong>. M Safari, W. Oortwijn, S. Joosten and M. Huisman (NFM 2020).
<ul>
<li>Paper: <a href="https://doi.org/10.1007/978-3-030-55754-6_10">https://doi.org/10.1007/978-3-030-55754-6_10</a></li>
<li>Code: <a href="https://github.com/Safari1991/Prefixsum">https://github.com/Safari1991/Prefixsum</a></li>
<li>Builds on the student project by T. Wiefferink</li>
</ul></li>
<li><strong>Automated Verification of Parallel Nested DFS</strong>. W. Oortwijn, M. Huisman, S.J.C. Joosten and J. van de Pol (TACAS 2020).
<ul>
<li>Paper: <a href="https://doi.org/10.1007/978-3-030-45190-5_14">https://doi.org/10.1007/978-3-030-45190-5_14</a></li>
<li>Code: <a href="https://doi.org/10.4121/uuid:36c00955-5574-44d9-9b26-340f7a1ea03b">https://doi.org/10.4121/uuid:36c00955-5574-44d9-9b26-340f7a1ea03b</a></li>
</ul></li>
<li><strong>Formal Verification of an Industrial Safety-Critical Traffic Tunnel Control System</strong>. W. Oortwijn and M. Huisman (IFM 2019).
<ul>
<li>Paper: <a href="https://doi.org/10.1007/978-3-030-34968-4_23">https://doi.org/10.1007/978-3-030-34968-4_23</a></li>
<li>Code: <em>Not publicly available</em></li>
<li>This was in collaboration with the company <em>Technolution</em>.</li>
<li>This case study uses a combination of mCRL2 (model checker) and VerCors to prove correctness of the software.</li>
</ul></li>
</ul>
<h2 id="student-projects">Student projects</h2>
<p>Be aware that not all student projects verify complete functional correctness!</p>
<h3 id="master-projects">Master projects</h3>
<ul>
<li><strong>Verification of a model checking algorithm in VerCors</strong>. H. Hollander (2021).
<ul>
<li>Master thesis: <a href="http://purl.utwente.nl/essays/88268">http://purl.utwente.nl/essays/88268</a></li>
<li>Code: <a href="https://github.com/HanHollander/SetBasedSCC">https://github.com/HanHollander/SetBasedSCC</a></li>
</ul></li>
<li><strong>Formal verification of a red-black tree data structure</strong>. H.M. Nguyen (2019).
<ul>
<li>Master thesis: <a href="http://purl.utwente.nl/essays/77569">http://purl.utwente.nl/essays/77569</a></li>
<li>Code: <a href="https://fmt.ewi.utwente.nl/media/rbt.zip">https://fmt.ewi.utwente.nl/media/rbt.zip</a></li>
<li>This has been continued in <a href="https://research.utwente.nl/en/publications/permission-based-verification-of-red-black-trees-and-their-mergin"><strong>Permission-Based Verification of Red-Black Trees and Their Merging</strong></a> (more info in the published case studies list above)</li>
</ul></li>
</ul>
<h3 id="bachelor-projects">Bachelor projects</h3>
<ul>
<li><strong>Let's sort this out: GPGPU Verification of Radix Sort</strong>. D.H.M.A. van Oorschot (2020).
<ul>
<li>Bachelor thesis: <a href="http://purl.utwente.nl/essays/80589">http://purl.utwente.nl/essays/80589</a></li>
<li>Code: <a href="https://gist.github.com/Drevanoorschot/4ffaef5cbc430e41a29a30a86dc1de64">Parallel count algorithm</a>, <a href="https://gist.github.com/Drevanoorschot/f527b0ac54212117ce75b66d5799ee63">Parallel reorder algorithm</a>, and <a href="https://gist.github.com/Drevanoorschot/9d0efb3dd78fa147c720b62ce0d491d7">Parallel radix sort algorithm</a>.</li>
</ul></li>
<li><strong>GPGPU Verification: Correctness of Odd-Even Transposition Sort Algorithm</strong>. Y. Kumashev (2020).
<ul>
<li>Bachelor thesis: <a href="http://purl.utwente.nl/essays/80585">http://purl.utwente.nl/essays/80585</a></li>
<li>Code: <a href="https://doi.org/10.6084/m9.figshare.11725848.v1">https://doi.org/10.6084/m9.figshare.11725848.v1</a></li>
</ul></li>
<li><strong>Formal Automated Verification of a Work-Stealing Deque</strong>. C.M. van Kampen (2020).
<ul>
<li>Bachelor thesis: <a href="http://purl.utwente.nl/essays/80687">http://purl.utwente.nl/essays/80687</a></li>
<li>Code: <a href="https://github.com/coenvk/lace-vercors">https://github.com/coenvk/lace-vercors</a></li>
</ul></li>
<li><strong>Verifying GPGPU Implementation of Breadth-First Search Algorithm</strong>. J. Smits (2019).
<ul>
<li>Bachelor thesis: <a href="https://fmt.ewi.utwente.nl/media/Bachelor_Thesis_Jan_Smits_BFS_Verification_1.2.pdf">https://fmt.ewi.utwente.nl/media/Bachelor_Thesis_Jan_Smits_BFS_Verification_1.2.pdf</a></li>
<li>Code: <em>In bachelor thesis</em></li>
</ul></li>
<li><strong>Optimization, Specification and Verification of the Prefix Sum Program in an OpenCL Environment</strong>. T. Wiefferink (2015).
<ul>
<li>Bachelor thesis: <a href="https://fmt.ewi.utwente.nl/media/147.pdf">https://fmt.ewi.utwente.nl/media/147.pdf</a></li>
<li>Code: <a href="https://fmt.ewi.utwente.nl/media/147_attachment_1.zip">https://fmt.ewi.utwente.nl/media/147_attachment_1.zip</a>, also available at: <a href="https://github.com/NLthijs48/PrefixSumVerification">https://github.com/NLthijs48/PrefixSumVerification</a></li>
</ul></li>
</ul>
<h1 id="meta">Meta</h1>
<p>This page lists the software, deployments, credentials and documentation in the orbit of the VerCors project.</p>
<p>Primary projects:</p>
<ul>
<li><a href="#vercors-the-tool">VerCors, the tool</a></li>
<li><a href="#vercors-website">VerCors Website</a></li>
<li><a href="#vercors-server-online-tool-runner">VerCors Server</a></li>
<li><a href="#the-wiki">The Wiki</a></li>
<li><a href="#gitlab-mirror">GitLab Mirror</a></li>
</ul>
<p>Secondary maintained tooling:</p>
<ul>
<li><a href="#tool-server">tool-server</a></li>
<li><a href="#antlr4-fork">ANTLR4 fork</a></li>
<li><a href="#docker-hub">Docker Hub</a></li>
<li><a href="#phabricator">Phabricator</a></li>
</ul>
<h2 id="vercors-the-tool">VerCors (the tool)</h2>
<ul>
<li>Code at <a href="https://github.com/utwente-fmt/vercors">https://github.com/utwente-fmt/vercors</a></li>
</ul>
<h2 id="vercors-website">VerCors Website</h2>
<ul>
<li>Code at <a href="https://github.com/utwente-fmt/vercors-web">https://github.com/utwente-fmt/vercors-web</a></li>
<li>Viewable at <a href="https://vercors.ewi.utwente.nl/">https://vercors.ewi.utwente.nl/</a></li>
<li>Redirect at <a href="https://utwente.nl/vercors">https://utwente.nl/vercors</a> (Maintained by M&amp;C UTwente)</li>
<li>Backoffice at <a href="https://vercors.ewi.utwente.nl/backoffice">https://vercors.ewi.utwente.nl/backoffice</a> (Ask Raul Monti for credentials)</li>
<li>Deployed at <a href="https://webservice.utwente.nl:8443">https://webservice.utwente.nl:8443</a> (Ask Pieter Bos for credentials)
<ul>
<li>Separate credentials for FTPS access (Ask Pieter Bos)</li>
<li>Also deploys database (Ask Pieter Bos for credentials)</li>
</ul></li>
</ul>
<h2 id="vercors-server-online-tool-runner">VerCors Server (online tool runner)</h2>
<p>This simply makes the tool available to run on the internet.</p>
<ul>
<li>Code at <a href="https://github.com/utwente-fmt/vercors-server">https://github.com/utwente-fmt/vercors-server</a></li>
<li>WebSocket access at <a href="wss://vercors-server.apps.utwente.nl/">wss://vercors-server.apps.utwente.nl/</a></li>
<li>Deployed at <a href="https://rancher.utsp.utwente.nl/">https://rancher.utsp.utwente.nl/</a> (Ask Tom van Dijk)</li>
</ul>
<h2 id="gitlab-mirror">GitLab Mirror</h2>
<ul>
<li>Data at <a href="https://gitlab.utwente.nl/fmt/vercors/vercors-back-up">https://gitlab.utwente.nl/fmt/vercors/vercors-back-up</a></li>
<li>Note the page will return a 404 without correct permissions</li>
<li>Contact Ãmer Èakar for credentials</li>
</ul>
<h2 id="tool-server">tool-server</h2>
<p>Minimal piece of software that makes a command line tool available to stream over a websocket. Not meant to be deployed directly.</p>
<ul>
<li>Code at <a href="https://github.com/utwente-fmt/tool-server">https://github.com/utwente-fmt/tool-server</a></li>
<li>In use by <a href="https://github.com/utwente-fmt/vercors-server">https://github.com/utwente-fmt/vercors-server</a></li>
</ul>
<h2 id="antlr4-fork">ANTLR4 Fork</h2>
<ul>
<li>Code at <a href="https://github.com/niomaster/antlr4/">https://github.com/niomaster/antlr4/</a></li>
</ul>
<h2 id="the-wiki">The Wiki</h2>
<ul>
<li>Viewable and code at <a href="https://github.com/utwente-fmt/vercors/wiki">https://github.com/utwente-fmt/vercors/wiki</a></li>
<li>Mirrored to <a href="https://vercors.ewi.utwente.nl/wiki">https://vercors.ewi.utwente.nl/wiki</a></li>
</ul>
<h2 id="docker-hub">Docker Hub</h2>
<ul>
<li>Viewable at <a href="https://hub.docker.com/u/utwentefmt">https://hub.docker.com/u/utwentefmt</a></li>
<li>Contact Tom van Dijk for credentials</li>
</ul>
<h2 id="phabricator">Phabricator</h2>
<p>Maintained by UTwente, used for various projects</p>
<ul>
<li>Projects viewable at <a href="https://vcs.utwente.nl/diffusion/query/JmuTk5VR3rfI/">https://vcs.utwente.nl/diffusion/query/JmuTk5VR3rfI/</a></li>
<li>Contact Marieke Huisman for access</li>
</ul>
<h1 id="developing-for-vercors">Developing for VerCors</h1>
<h2 id="workflow">Workflow</h2>
<p><em>Below you can find a description of what a typical workflow looks like.</em></p>
<ol>
<li>Determine what you want to fix.</li>
<li>If there is an issue for what you want to fix, assign yourself to the issue. This can be done by navigating to the specific page of the issue. Then on the right-hand side there is an "Assignees" header. Beneath this header click on "assign yourself".</li>
<li>Create a fork of VerCors if you have not done this yet. The installation instructions can be found on the main Github page (<a href="https://github.com/utwente-fmt/vercors">https://github.com/utwente-fmt/vercors</a>).</li>
<li>Navigate to the VerCors project on your computer in your terminal.</li>
<li>When you're inside the <code>vercors</code> directory, create a new branch by executing the following command: <code>git branch branch_name</code>. Replace <code>branch_name</code> by the name for your branch. This name can reflect what you will fix. For example if you are going to fix issue 1, then you can name the branch "issue1". Or if you add support for automatic generation of invariants, then you can name the branch "automaticInvariants".</li>
<li>Then switch to the new branch using the command <code>git checkout branch_name</code>.</li>
<li>You can now start working on your problem!</li>
<li>When you are done with your fix, <strong>commit and push</strong> your changed files to the branch. To push to your new branch you can use the following command:<code>git push origin branch_name</code>.</li>
<li>Navigate to the main GitHub page of VerCors (<a href="https://github.com/utwente-fmt/vercors/">https://github.com/utwente-fmt/vercors/</a>).</li>
<li>Create a new pull request (see also: <a href="https://help.github.com/articles/creating-a-pull-request-from-a-fork/">https://help.github.com/articles/creating-a-pull-request-from-a-fork/</a>).</li>
<li>As soon as this pull request has been reviewed by at least one person, and is accepted, then your fix can be merged into the master branch. <em>Congratulations you're done with this PR (Pull Request)!</em></li>
</ol>
<h1 id="project-structure">Project Structure</h1>
<h2 id="functional-overview">Functional Overview</h2>
<p>VerCors verifies programs by going through three stages:</p>
<ul>
<li><strong>The frontend, or parsing</strong>: in this step a collection of files is read and parsed into COL, the common object language. This is the internal intermediate representation of programs in VerCors.</li>
<li><strong>The rewrite stage</strong>: The COL AST (usually referred to as just the AST) is transformed into a different AST, or it is checked for some property, together called a "pass". Depending on user-supplied options many passes are applied to the AST. They can be divided in several categories:
<ul>
<li><em>Reducing a feature</em>: The subset of COL used is reduced, by encoding the proof obligations of a language construct in some other way. An example is that we reduce <code>for</code> loops to <code>while</code> loops, by placing the initialization before a new while loop, retaining the condition, and appending the update to the end of the loop body.</li>
<li><em>Checking for consistency</em>: in some places it is useful that the type structure of the AST is not as strict as the set of ASTs we want to allow. Almost all checks are done in the type check, a single pass executed many times.</li>
<li><em>Standardization</em>: many passes expect certain properties to be true about the AST (e.g. "expresions have no side effects"), but on the other hand it is useful not to constrain passes too much in what they can generate. Therefor we standardize the AST between passes, to reduce simple language features.</li>
<li><em>Importing builtins</em>: some features are supported by importing a header of sorts into the AST.</li>
<li><em>Optimization</em>: optimizing passes transform the AST (in particular expressions) such that they are faster to prove, or rely less on heuristics of the backend.</li>
</ul></li>
<li><strong>The backend, or verification</strong>: the very much reduced AST is transformed once more, into the language of the selected backend. The backend makes a judgement on the program. This judgement is translated back into useful information about the program.</li>
</ul>
<p>There are also a few cross-cutting concerns:</p>
<ul>
<li><strong>The origin system</strong> tracks how the frontend parse tree is transformed via COL into a backend language. This means that if a message from the backend mentions a part of the AST in the backend language, it can be translated all the way back to its origin in the frontend input.</li>
<li><strong>Logging</strong>: we have a bespoke logging system and outputting via stdout or stderr is forbidden programatically. This makes it possible to set verbosity with the granularity we want (e.g. only verdict, progress information, filter debug information by class)</li>
</ul>
<h2 id="technical-setup">Technical Setup</h2>
<p>The VerCors project sources are managed on GitHub, at <a href="https://github.com/utwente-fmt/vercors">https://github.com/utwente-fmt/vercors</a>. The unstable development branch is <code>dev</code>, from where we branch to develop new features and bugfixes. Those with access may push feature branches to the main repository, or create a fork if they prefer. A pull request is then made and reviewed by someone appropriate.</p>
<p>Pushed commits as well as pull requests are checked via continuous integration, currently Travis + Sonarcloud. Travis builds Vercors and runs the test suite. The (committed) code is linted by Sonarcloud. Once the checks pas and a code review is completed, the PR is merged in dev. In dev is also where we hope to notice bad interactions between new features.</p>
<p>We aim to make a new VerCors release once per month, which is done via a tagged merge commit to the <code>master</code> branch, followed by a GitHub release.</p>
<p>VerCors is written in java and scala. Code is accepted in either language, but all things being equal scala is preferred. The build structure is defined in the scala build tool. We use the sbt-native-packager plugin to package the tool as a .deb and a .tar.gz (compiled). The sbt-buildinfo plugin supplies the tool with run-time access to versioning and build time information.</p>
<h2 id="project-structure-1">Project Structure</h2>
<p><em>NB: this information quickly becomes out of date as vercors is refactored.</em></p>
<h3 id="section"><code>/</code></h3>
<ul>
<li><code>build.sbt</code> is the root build definition. It configures global plugin options, wires sub-project dependencies, configures run-time build information, denotes external dependencies, configures metadata about the project and configures compiler options.</li>
<li><code>.travis.yml</code> sets up caching and parallelizes the build. The actual build steps are in <code>.travis/build.sh</code>.</li>
</ul>
<h3 id="travis"><code>/.travis</code></h3>
<ul>
<li><code>travis_fold.sh</code>: Wrapper script that causes travis to make a foldable section of text.</li>
<li><code>travis_tar.sh</code>: Replacement for the system <code>tar</code> that packs our cache in a format that SBT ends up being happy with. Should be default by now <a href="https://travis-ci.community/t/change-tar-format-to-posix/5467">https://travis-ci.community/t/change-tar-format-to-posix/5467</a></li>
</ul>
<h3 id="bin"><code>/bin</code></h3>
<p>Convenience run scripts that targets the last-compiled classes in the vercors directory. This is the least stable method of running Vercors. If bleeding edge features are not needed, use the release version. If possible, run Vercors imported in an IDE instead. Failing that, the run scripts can be useful.</p>
<ul>
<li><code>run-class.sh</code> and <code>.classpath</code>: run-class obtains the run-time class path from SBT and caches it in .classpath. A supplied main class + arguments is run from this class path. Other scripts in the directory only select a main class and refer to run-class.</li>
</ul>
<h3 id="examples-5"><code>/examples</code></h3>
<p>This directory serves the dual purpose of being an archive of past case studies and competition results, as well as the test suite of VerCors. Files in this directory have a header denoting how they are used in the test suite. Names denoted by "case" or "cases" are collected, where overlapping names are joined together as one test case. Files may occur in more than one "case." "tools" denotes the backend used (silicon by default), "verdict" the expected final result (Pass by default).</p>
<ul>
<li><code>private</code>: this can be created as a subdirectory and is ignored by git. Contributing examples (however small) that reproduce issues are however appreciated.</li>
</ul>
<h3 id="parsers"><code>/parsers</code></h3>
<p>A sub-project of Vercors that implements the parsing infrastructure of Vercors.</p>
<ul>
<li><code>build.sbt</code>: runs ANTLR 4, the parser generator, prior to compilation if necessary. Grammar source sets are encoded explicitly in the build file.</li>
<li><code>src/main/antlr/*.g4</code>: root grammars from which parsers are generated. These only glue a language grammar to the specification grammar, though the language grammar itself is also modified somewhat.</li>
<li><code>lib/antlr4/*.g4</code>: non-root grammars, defining languages (such as C and Java), embedded languages (such as OpenMP) and specifications.</li>
</ul>
<h3 id="project"><code>/project</code></h3>
<p>An artifact of how SBT works. SBT projects are layered, not in the sense that we have sub-project dependencies, but that you can define meta-projects. This directory defines a meta-project, which means it is available in compiled form in the upper build definition. We just use it to add some plugins to the compiler.</p>
<h3 id="splitverify"><code>/SplitVerify</code></h3>
<p>This tool is not part of VerCors itself, but interacts with VerCors to cache the verification result of <em>parts</em> of a test case. That means that changing part of a test case only requires re-verifying the changed part. Refer to the readme there for further information.</p>
<h3 id="util"><code>/util</code></h3>
<ul>
<li><code>VercorsPVL.tmbundle</code>: textmate bundle, defining PVL as a grammar, enabling syntax highlighting for PVL in some editors.</li>
</ul>
<h3 id="src"><code>/src</code></h3>
<p>The sources associated with the top-level SBT project, i.e. the main part of VerCors.</p>
<h3 id="srcuniversalres"><code>/src/universal/res</code></h3>
<p>Here live the resources of VerCors. Normally they would be in a directory <code>res</code> or so in the root, but we have a custom solution to ensure that they remain regular files, even when packed into a jar by the build tool. Universal refers to the native-packager also being called the "Universal" plugin. "res" is the name of the directory in which the resources end up in .tar.gz deployment.</p>
<ul>
<li><code>config</code>: Include files ("headers") that are put in the AST at some intermediate stage.
<ul>
<li><code>config/prelude(_C)?.sil</code>: here the standard axiomatic data types that we need are defined</li>
<li>*.jspec: simplification rules that we assume to be true, applied at various stages.</li>
</ul></li>
<li><code>deps</code>: Software dependencies that we do not refer to in the project structure, but rather by including the binary.</li>
<li><code>include</code>: Include files ("headers") that are available to front-end files, though currently only C.</li>
<li><code>selftest</code>: Ancient test files that are still accessible via the test suite. Unclear if they still work.</li>
</ul>
<h3 id="srcmainscala"><code>/src/main/scala</code></h3>
<p>Please don't use this directory anymore. Scala sources also compile fine when included in the java directory, so this "mirror" of the package structure only serves to confuse where classes are defined. Only a few rewrite passes are defined here.</p>
<h3 id="srcmainjava"><code>/src/main/java</code></h3>
<ul>
<li><code>col/lang</code>: I believe this is an implementation of some verification constructs, to facilitate compiling PVL to Java.</li>
<li><code>puptol</code>, <code>rise4fun</code>: external tool support, now obsolete.</li>
</ul>
<h3 id="srcmainjavavct"><code>/src/main/java/vct</code></h3>
<ul>
<li><code>antlr/parser</code>: Takes ANTLR parse trees and converts them to COL. The classes ending in <code>Parser</code> guide the conversion process. Classes ending in <code>ToCOL</code> do the actual immediate translation. Finally there are a few rewrite passes that solve language-specific problems.</li>
<li><code>boogie</code>: Old (?) prototypes for supporting boogie, dafny and chalice.</li>
<li><code>col/annotate</code>: A single feature rewrite pass, unclear why it's in a different package.</li>
<li><code>col/ast</code>: the AST of COL, divided into expressions (<code>expr</code>), declarations (<code>stmt/decl</code>), statements (<code>stmt/{composite,terminal}</code>) and types (<code>type</code>). Also defines some abstract intermediate node types (<code>generic</code>) and utility classes for traversing the tree in various ways (<code>util</code>).</li>
<li><code>col/print</code>: logic to translate COL into text again for different frontends. Only Java is well-supported, as it's the default diagnostic output.</li>
<li><code>col/rewrite</code>: this is where all rewrite passes are defined. They are under-documented, but the <code>Main</code> class offers a brief explanation for each of them.</li>
<li><code>col/syntax</code>: abstract representation of the syntax of various frontends.</li>
<li><code>demo</code>: unclear why this is in the source tree.</li>
<li><code>error</code>: probably an attempt at better abstracting errors from the backend</li>
<li><code>learn</code>: experiment that counts the different types of nodes in the AST, to attempt to correlate verification time with the presence of particular nodes.</li>
<li><code>logging</code>: barely used; abstracts messages and errors for a particular pass</li>
<li><code>main</code>: entry points for VerCors, as well as some poorly-sorted classes.
<ul>
<li><code>ApiGen</code>: echoes back a java program immediately after parsing something; purpose unclear.</li>
<li><code>BoogieFOL</code>: another prototype to interface with boogie, a deprecated backend (?)</li>
<li><code>Brain</code>, <code>SMTinter</code>, <code>SMTresult</code>, <code>Translator</code>: attempt by student (?) to interface with z3</li>
<li><code>Main</code>: the true entry point of Vercors.</li>
</ul></li>
<li><code>silver</code>: maps COL to Silver, the language used by the viper project.</li>
<li><code>test</code>: the testing framework of Vercors. Collects cases from the examples directory and tests each in an isolated process.</li>
<li><code>util/Configuration.java</code>: contains most command-line options, as well as the logic to determine the location of external tools (z3, silicon, etc.)</li>
</ul>
<h3 id="viper"><code>/viper</code></h3>
<p>More logic to interface with the viper backend(s), unclear where exactly the cut is with regards to <code>/src/main/java/vct/silver</code>.</p>
<h3 id="viperhre"><code>/viper/hre</code></h3>
<p>The general utilities project ("Hybrid Runtime Environment"), located here so <code>/viper</code> may depend on it. From here under <code>src/main/java</code>:</p>
<ul>
<li><code>hre/ast</code>: definitions for the different types of <code>Origin</code>.</li>
<li><code>hre/config</code>: defines different types of command line options (integer, choice, collect...)</li>
<li><code>hre/debug/HeapDump</code>: dumps a class and its fields recursively using reflection. Largely replaced by <code>DebugNode</code></li>
<li><code>hre/io</code>: inter-process communication.</li>
<li><code>hre/lang/System</code>: defines the logging system. Currently output to stdout and stderr directly is forbidden programatically, so that you're forced to use the logging framework.</li>
</ul>
<h1 id="ide-import">IDE Import</h1>
<p>This document gives instructions on how to configure a development environment for VerCors, using either Eclipse or Intellij IDEA. Below the instructions there is a list of encountered errors, you might want to check there if you encounter one. The setup for IntelliJ IDEA is considerably easier, so we recommend using that.</p>
<h2 id="configuring-vercors-for-eclipse">Configuring VerCors for Eclipse</h2>
<p>First make sure that Eclipse is installed. The installation instructions described below have been tested with Ubuntu 18.04 and Eclipse version 4.11.0 (March 2019) from snap, not apt. The version from the eclipse website should be equivalent. Also make sure that VerCors has been installed according to the instructions given on the <a href="https://github.com/utwente-fmt/vercors">main Git page</a>.</p>
<p>Install the Scala IDE plugin for Eclipse. Download- and installation instructions can be found <a href="http://scala-ide.org/download/current.html">here</a>. After providing the installation/update site in Eclipse, make sure that <em>all</em> the suggested options are selected for installation. After installation has completed, navigate to Help &gt; Install new software &gt; Manage, and go to Scala &gt; Compiler. We have to give scalac more memory to compile VerCors than is available by default, so enter "-J-Xmx2048m" under "Additional command line options" to increase the limit to 2048MB.</p>
<p>Install the eclipse plugin for sbt, instructions for which can be found <a href="https://github.com/sbt/sbteclipse">here</a>. It is recommended that you install it in the global file, and not in the vercors file, as we do not want to add eclipse-specific configuration in the repository. Create a global settings file for SBT (e.g. in ~/.sbt/1.0/global.sbt) and add the setting <code>EclipseKeys.skipParents in ThisBuild := false</code></p>
<h3 id="configuring-the-vercors-modules">Configuring the VerCors modules</h3>
<ol>
<li>Navigate to the vercors subdirectory using a terminal, and run <code>sbt eclipse</code>. This will generate all the eclipse projects necessary to build vercors within eclipse.</li>
<li>In eclipse, go to File &gt; Import and select General &gt; Existing Projects into Workspace. Select the vercors subdirectory, and tick Search for nested projects. If all went well, it should list all the vercors subprojects (vercors, hre, parsers, viper, silicon, etc.). Click finish.</li>
<li>Eclipse will automatically build vercors; wait for it to finish. If eclipse fails to build the projects in this stage, unfortunately the projects are left in a broken state. You should remove all the projects or clear the workspace, and try again.</li>
</ol>
<h3 id="running-vercors-from-eclipse">Running VerCors from Eclipse</h3>
<p>To run VerCors from Eclipse, and thereby allow debugging within Eclipse, a <em>Run Configuration</em> needs to be created and used. To create a run configuration, do the following. In the menu, navigate to "<em>Run &gt; Run Configurations...</em>". Select "<em>Java Application</em>" in the left menu and press the "New" button/icon in the toolbar. From here you can assign a name to the new configuration, for example "VerCors". Under "<em>Project</em>" select the "Vercors" project. Under "<em>Main class</em>" select or type <code>vct.main.Main</code>. Under the "<em>Arguments</em>" tab, type <code>${string_prompt}</code> in the "<em>Program arguments</em>" field, so that every time VerCors is run with this new configuration, a pop-up window will be given in which arguments to VerCors can be specified. Moreover, in the "<em>VM arguments</em>" field, type <code>-Xss16m</code>, which increases the stack size to 16MB for VerCors runs (the default stack size may not be enough). Set the working directory to the root directory of the git repository.</p>
<p>After performing these steps, you should be able to run VerCors from Eclipse via the "<em>Run</em>" option (do not forget selecting the new run configuration). The output of VerCors is then printed in Eclipse console view. To validate the configuration, try for example "--silicon examples/manual/fibonacci.pvl". If you get an error like <code>NoClassDefFoundError: scala/Product</code>, perform the workaround listed under "I got an error!" below.</p>
<h2 id="configuring-vercors-for-intellij-idea">Configuring VerCors for IntelliJ IDEA</h2>
<p>The steps below were testing with Ubuntu 18.04 and Intellij IDEA community edition, version 2019.1.1 retrieved via snap. Also make sure that VerCors has been installed according to the instructions given on the <a href="https://github.com/utwente-fmt/vercors">main Git page</a>.</p>
<p>When first installed, go to Configure &gt; Plugins, or when already installed go to File &gt; Settings &gt; Plugins. Install the Scala plugin, and restart the IDE as suggested.</p>
<h3 id="configuring-the-project">Configuring the project</h3>
<ol>
<li>Go to Open when first installed, File &gt; Open otherwise, and open vercors/build.sbt. Open it as a project as suggested. (<em>For older IDEA versions: in the dialog "Import Project from sbt", you should tick "Use sbt shell: for imports" and "for builds"</em>)</li>
<li>Wait for the running process to complete, which configures the whole project.</li>
<li>Open File &gt; Settings, go to Build, Execution, Deployment &gt; Build Tools &gt; sbt, select the "vercors" sbt project (likely the only one) and tick use for [x] project reload and [x] builds. (<em>Not needed in old versions of IDEA</em>)</li>
</ol>
<h3 id="running-vercors-from-intellij-idea">Running VerCors from IntelliJ IDEA</h3>
<p>Go to Run &gt; Edit configurations, and add a Java application with the following settings:</p>
<ul>
<li>Main class: <code>vct.main.Main</code></li>
<li>VM options: <code>-Xss16m</code> (increases the stack size to 16MB; as of IDEA 2020.3 you need to click Modify options &gt; Add VM options first)</li>
<li>Program arguments: <code>$Prompt$</code> (asks for parameters every time)</li>
<li>Working directory: the root of the git repository</li>
<li>Use classpath of module: <code>Vercors</code> (as of IDEA 2020.3: <code>-cp vercors</code>)</li>
</ul>
<p>You should now be able to run and debug VerCors from within IntellJ IDEA! The first time the run configuration is used the project will be built in full, so that will take some time.</p>
<h3 id="configure-sonarlint-for-vercors-in-intellij">Configure SonarLint for VerCors in IntelliJ</h3>
<p>SonarCloud runs code quality checks e.g. when you merge a branch. <a href="https://www.sonarlint.org/">SonarLint</a> gives you the same warnings as SonarCloud but now inside IntelliJ, while you work on the code. SonarLint also supports Eclipse, Visual Studio and VS code. While this instruction focusses on IntelliJ, the installation steps for other IDEs will likely be similar.</p>
<ol>
<li>Install the <a href="https://plugins.jetbrains.com/plugin/7973-sonarlint">SonarLint Plugin</a> by following the installation instructions.
<ul>
<li>E.g. in IntelliJ via File &gt; Settings &gt; Plugins.</li>
</ul></li>
<li>Add a connection which synchronises the rules of SonarLint with those of SonarCloud.
<ul>
<li>Go to Settings &gt; Tools &gt; SonarLint &gt; Settings. Add a SonarQube / SonarCloud connection.</li>
<li>Pick a name. Select SonarCloud. Click Next.</li>
<li>Create a token. This requires you to be logged in to SonarCloud. Click Next.
<ul>
<li>Clicking "Generate Token" will direct you to the SonarCloud website. Log in with your GitHub account to connect to the VerCors project.</li>
<li>When generating a token on the SonarCloud web interface, the token will only be displayed once. Make sure to copy it, and paste it into the respective field in IntelliJ.</li>
</ul></li>
<li>Select "University of Twente". Click Next.</li>
<li>Deselect "Receive notifications" (except if you would like to have notifications). Click Next.</li>
<li>Click Finish</li>
</ul></li>
<li>Select a Sonarcloud project for SonarLint.
<ul>
<li>Go to Settings &gt; Tools &gt; SonarLint &gt; Project Settings &gt; Bind to SonarQube / SonarCloud.</li>
<li>In the dropdown menu of Project binding &gt; Connections:, select the connection you set up in Step 2.</li>
<li>In the dropdown menu of Project binding &gt; Project:, select the VerCors project.</li>
<li>Click Apply (to save the settings but keep the window open) or OK (to save the settings and close the dialogue).</li>
</ul></li>
</ol>
<h2 id="i-encountered-an-error">I encountered an error!</h2>
<p>Here is a collection of errors we encountered, with a solution. Is your problem not here? Please file an issue!</p>
<ul>
<li><em>While eclipse is building the workspace, I get a StackOverflowException.</em> The scala compiler has insufficient memory to compile the project, try increasing the limit at Help &gt; Install New Software &gt; Manage, then Scala &gt; Compiler. Try adding -J-X____m at "Additional command line parameters", substituting ___ with the amount of memory (in MB) you want to try.</li>
<li><em>Silicon is not detected as a project when running <code>sbt eclipse</code>.</em> By default, parent projects (SBT projects that aggregate other projects) are not included by this tool. Remember to add <code>EclipseKeys.skipParents in ThisBuild := false</code> to the global SBT settings file.</li>
<li><em>Only VerCors is detected as a project by eclipse.</em> Remember to tick "Search for nested projects".</li>
<li><em>The run configuration only outputs NoClassDefFoundError: scala/Product.</em> For whatever reason, the scala runtime environment is not included in the run configuration. You should add manual dependencies in the run configuration, at Dependencies &gt; Classpath Entries &gt; Add External JARs. Add <code>scala-library.jar</code> and <code>scala-reflect.jar</code>, which should be present in the sbt configuration directory, <code>~/.sbt/boot/scala-x.x.x/</code> or similar. It seems to me that these libraries should be included from the project classpath, so please let me know if I'm misunderstanding!</li>
<li><em>While IntelliJ is building, it encounters import errors in package <code>vct.antlr4.generated</code></em>. When creating the project from <code>vercors/build.sbt</code>, do not forget to tick "Use sbt shell: for builds", do not tick imports, and untick "allow overriding sbt version". I only encountered this on initial setup of the project and sometimes "accidentally" fixed it, so please let me know if you did set these options, but got this result anyway.</li>
<li><em>The run configuration says: "Warning: Main method not found in class vct.main.Main"</em>. You might not have compiled vercors for the first time yet, or forgot to tick "use sbt shell for project reload, builds".</li>
</ul>
<h1 id="scalatest">ScalaTest</h1>
<h2 id="running-scalatest">Running ScalaTest</h2>
<p>ScalaTest can be run by the commandline or via the Intellij. For running with Intellij you need the Scala plugin of JetBrains. VerCors uses a lot of memory that is why you have to add an VM option to the ScalaTest template. Go to Run/Debug Configuration. Click on the blue text "Edit configuration templates..." in the left corner. Select ScalaTest. Select Configuration. Set VM options to "-Xss128M". You can run the test by right clicking a test file and selecting the option "Run '{filename}'". To run a single test you can open the file and clicking on the run arrow between the line number and the text of the file. The test files are in "src/test/scala/". Intellij also supports running the test in debug mode by selecting debug mode. Running from the commandline can be done using sbt. The following command runs all the tests. <code>sbt test</code> The following command runs all the test in the file integration.Generated1Tests. <code>sbt "testOnly integration.Generated1Tests"</code></p>
<p>More settings can be found in <a href="https://www.scalatest.org/user_guide/using_scalatest_with_sbt">https://www.scalatest.org/user_guide/using_scalatest_with_sbt</a> Note that the run settings like classpath and available memory can be different from Intellij and sbt.</p>
<h1 id="wiki-code-snippet-testing-harness">Wiki Code Snippet Testing Harness</h1>
<p>VerCors supports extracting tests from the tutorial and automatically running the extracted tests. The following syntax is recognized in the tutorial. For example usages of this syntax, see the raw version of the chapter of <a href="https://raw.githubusercontent.com/wiki/utwente-fmt/vercors/Axiomatic-Data-Types.md">Axiomatic Data Types</a>. As the annotations will be hidden when viewing the rendered markdown, click on "edit page"</p>
<h2 id="self-contained-code-blocks">Self-contained code blocks</h2>
<p>Testcases defined by template, e.g.:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode markdown"><code class="sourceCode markdown"><a class="sourceLine" id="cb44-1" title="1">&lt;!--<span class="co"> testBlock Fail --&gt;</span></a>
<a class="sourceLine" id="cb44-2" title="2"><span class="bn">```java</span></a>
<a class="sourceLine" id="cb44-3" title="3"><span class="bn">assert false;</span></a>
<a class="sourceLine" id="cb44-4" title="4"><span class="bn">```</span></a></code></pre></div>
<p>There are three possible code block annotations:</p>
<ul>
<li><code>testBlock</code> wraps the code in a method and class</li>
<li><code>testMethod</code> wraps the code in a class</li>
<li><code>test</code> returns the code as is</li>
</ul>
<p><code>testBlock</code> and <code>testMethod</code> are compatible with Java and PVL.</p>
<p>The case name of the generated test is derived from the heading structure.</p>
<h2 id="snippets">Snippets</h2>
<p>To combine multiple code blocks into one test case (potentially with hidden glue code), you can use Snippets. The markdown for that might look like this:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode markdown"><code class="sourceCode markdown"><a class="sourceLine" id="cb45-1" title="1">&lt;!--<span class="co"> standaloneSnip smallCase</span></a>
<a class="sourceLine" id="cb45-2" title="2"><span class="co">//:: cases smallCase</span></a>
<a class="sourceLine" id="cb45-3" title="3"><span class="co">//:: verdict Fail</span></a>
<a class="sourceLine" id="cb45-4" title="4"><span class="co">class Test {</span></a>
<a class="sourceLine" id="cb45-5" title="5"><span class="co">--&gt;</span></a>
<a class="sourceLine" id="cb45-6" title="6"></a>
<a class="sourceLine" id="cb45-7" title="7">&lt;!--<span class="co"> codeSnip smallCase --&gt;</span></a>
<a class="sourceLine" id="cb45-8" title="8"><span class="bn">```java</span></a>
<a class="sourceLine" id="cb45-9" title="9"><span class="bn">boolean never() {</span></a>
<a class="sourceLine" id="cb45-10" title="10"><span class="bn">  return false;</span></a>
<a class="sourceLine" id="cb45-11" title="11"><span class="bn">}</span></a>
<a class="sourceLine" id="cb45-12" title="12"><span class="bn">```</span></a>
<a class="sourceLine" id="cb45-13" title="13">*Here could be some more explanation about &quot;never&quot;.*</a>
<a class="sourceLine" id="cb45-14" title="14"></a>
<a class="sourceLine" id="cb45-15" title="15">&lt;!--<span class="co"> standaloneSnip smallCase</span></a>
<a class="sourceLine" id="cb45-16" title="16"><span class="co">void test() {</span></a>
<a class="sourceLine" id="cb45-17" title="17"><span class="co">--&gt;</span></a>
<a class="sourceLine" id="cb45-18" title="18"></a>
<a class="sourceLine" id="cb45-19" title="19">Then the following example will **fail**:</a>
<a class="sourceLine" id="cb45-20" title="20"></a>
<a class="sourceLine" id="cb45-21" title="21">&lt;!--<span class="co"> codeSnip smallCase --&gt;</span></a>
<a class="sourceLine" id="cb45-22" title="22"><span class="bn">```java</span></a>
<a class="sourceLine" id="cb45-23" title="23"><span class="bn">assert never();</span></a>
<a class="sourceLine" id="cb45-24" title="24"><span class="bn">```</span></a>
<a class="sourceLine" id="cb45-25" title="25"></a>
<a class="sourceLine" id="cb45-26" title="26">&lt;!--<span class="co"> standaloneSnip smallCase</span></a>
<a class="sourceLine" id="cb45-27" title="27"><span class="co">}</span></a>
<a class="sourceLine" id="cb45-28" title="28"><span class="co">}</span></a>
<a class="sourceLine" id="cb45-29" title="29"><span class="co">--&gt;</span></a></code></pre></div>
<p>Note that the hidden glue code uses <code>standaloneSnip</code>, and includes the code inside the HTML comment tags <code>&lt;!--</code> and <code>--&gt;</code>. The visible code snippets use <code>codeSnip</code>, and the code is outside the comment tags, enclosed in triple back-ticks like any displayed code block.</p>
<h1 id="feature-rainbow">Feature Rainbow</h1>
<p>If you are reading this you are probably frustrated with the feature system, so first allow me to explain <em>why</em> we have a feature system :)</p>
<h3 id="why-have-a-feature-system">Why have a feature system?</h3>
<p>VerCors is a transformation pipeline, consisting of a large number of passes. Currently, many passes make assumptions about the structure of the AST (justly or unjustly). Often this means that passes assume a particular pass has run before it.</p>
<p>In the absence of a way to make these assumptions explicit, bugs that violate them may survive for dozens of passes before crashing VerCors. Especially for developers that are not well-versed in all of the passes (i.e. everyone), it can then be very hard to diagnose the cause of a bug: the true cause may be a bug in pass #5, violating an implicit assumption in pass #17, crashing VerCors in pass #25!</p>
<p>We have thus chosen to make assumptions about the AST explicit, by way of binary predicates about the AST: features. This introduces a burden on developers writing new passes, because it takes some work to integrate a new pass with the feature system. In particular, usually a feature is needed to convince VerCors that a pass actually does something. Furthermore, the developer must think about the assumptions that their own pass makes, and specify which feature are allowed and introduced. We believe the tradeoff is worth it.</p>
<h3 id="how-does-it-work">How does it work?</h3>
<ul>
<li><strong>FeatureRainbow</strong> is a collection of binary predicates about the AST. An example is the presence of sections labeled with <code>spec_ignore</code>: these sections should be wholly ignored by VerCors, and are removed by the <code>FilterSpecIgnore</code> pass. <code>FeatureRainbow</code> thus scans the AST for the presence of the <code>ASTNode</code> for <code>spec_ignore</code>, and returns (along with a lot of other binary predicates) whether it's there.</li>
<li><strong>Passes</strong> is the master collection of all rewrite passes that VerCors can do. A pass specifies which features it <em>permits</em>, <em>removes</em> and <em>introduces</em>:
<ul>
<li><strong>permits</strong> lists all the features that the pass can stomach. For example, many passes cannot deal with <code>spec_ignore</code>, since it requires special consideration to ignore those sections. <code>Feature.DEFAULT_PERMIT</code> is a list of features that are not especially counter-intuitive or unexpected, and most new passes should permit at least those features.</li>
<li><strong>removes</strong> indicates the effect of a pass. A pass that removes no feature may as well not be executed at all. The final goal of VerCors is to reach its backend, for example <code>applySilicon</code>. All VerCors then cares about is to remove enough features such that the remaining features are a subset of <code>applySilicon.permits</code>.</li>
<li><strong>introduces</strong> lists the features that are (re)introduced by a pass. Ideally no pass should introduce any feature, and everything is implemented in the smallest set of the AST possible. In practice, it is nice to be able to compose features: maybe a feature would like to use polymorphism to implement something.</li>
</ul></li>
<li><strong>Main.silverPassOrder</strong> is the default sequence of passes. <code>Main</code> statically verifies that the order is correct: passes do not introduce features that are not permitted by later passes (or: they are removed in time). <code>Main</code> also performs the crucial ability enabled by the feature system: run-time checks between every pass. After every rewrite pass, the set of features it has is computed. Given that we have the features before a pass and after a pass, <code>Main</code> checks that:
<ul>
<li><code>after â© pass.removes = â</code></li>
<li><code>(after \ before) â pass.introduces</code></li>
</ul></li>
</ul>
<h3 id="tldr">TL;DR</h3>
<ul>
<li>Make a feature for whatever your new pass simplifies away</li>
<li>Give it an entry in <code>Passes</code>, and try if it works with <code>permits=Feature.DEFAULT_PERMIT, removes=Seq(your_feature_here), introduces=Feature.DEFAULT_INTRODUCE</code>. Also consider using Feature.NO_POLY_INTRODUCE or Feature.EXPR_ONLY_INTRODUCE.</li>
<li>Place your pass in the chain in <code>Main.silverPassOrder</code>. Give VerCors the flag <code>--debug vct.main.Main</code>, it will explain to you what went wrong with the features if it does not work. Note that most paths through Choices will not work: the errors are okay, <strong>iff it goes on to execute the passes</strong>. If not, there's something wrong!</li>
<li>Enable <code>--strict-internal</code>! This actually does the run-time checking, it is not enabled by default.</li>
<li>Apply any of these changes until stuff works:
<ul>
<li>Move your pass around in <code>Main.silverPassOrder</code>. It helps to be near a pass that is approximately DEFAULT_PERMIT and DEFAULT_INTRODUCE</li>
<li>Increase the number of features that you permit (make sure you can deal with them)</li>
<li>Decrease the number of features that you introduce (make sure you don't introduce that feature)</li>
</ul></li>
</ul>
<h1 id="clearer-separation-of-real-and-ghost-state">Clearer separation of real and ghost state</h1>
<p>VerCors does not discern between ghost state and real state. This means real state can be changed from ghost code, and vice versa. This is not an issue, as in practice it is feasible to maintain this separation manually. But, for future reference, below two solutions are documented which can prevent the two types of state from being mixed.</p>
<h3 id="frama-c-solution">Frama-C solution</h3>
<p>Frama-C prevents mixing ghost and real state by tracking the type of state in the type of variables. An <code>int</code> declared in a ghost block is actually of type <code>int \ghost</code> (with the <code>\ghost</code> qualifier listed after the type, similar to how the <code>const</code> qualifier can be listed after the type). If a pointer is taken from such a ghost int, this yields a value of type <code>int \ghost *</code>. By keeping track of the kind of state in the type, mixing of the two kinds of state is prevented. The code snippet below shows an example of referring to both normal pointers and ghost pointers in Frama-C ghost code.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb46-1" title="1"><span class="co">/*@ requires \valid(a);</span></a>
<a class="sourceLine" id="cb46-2" title="2"><span class="co">  @*/</span></a>
<a class="sourceLine" id="cb46-3" title="3"><span class="dt">void</span> testGhost(<span class="dt">int</span> *a)</a>
<a class="sourceLine" id="cb46-4" title="4">{</a>
<a class="sourceLine" id="cb46-5" title="5">  <span class="co">/*@ ghost </span></a>
<a class="sourceLine" id="cb46-6" title="6"><span class="co">    int x;</span></a>
<a class="sourceLine" id="cb46-7" title="7"><span class="co">    int \ghost *ghostPtr;</span></a>
<a class="sourceLine" id="cb46-8" title="8"><span class="co">    int *realPtr;</span></a>
<a class="sourceLine" id="cb46-9" title="9"></a>
<a class="sourceLine" id="cb46-10" title="10"><span class="co">    ghostPtr = &amp;x;</span></a>
<a class="sourceLine" id="cb46-11" title="11"><span class="co">    ghostPtr = a; // Not ok! Error</span></a>
<a class="sourceLine" id="cb46-12" title="12"></a>
<a class="sourceLine" id="cb46-13" title="13"><span class="co">    realPtr = &amp;x; // Not ok! Error</span></a>
<a class="sourceLine" id="cb46-14" title="14"><span class="co">    realPtr = a;</span></a>
<a class="sourceLine" id="cb46-15" title="15"><span class="co">     </span></a>
<a class="sourceLine" id="cb46-16" title="16"><span class="co">    @*/</span></a>
<a class="sourceLine" id="cb46-17" title="17">}  </a></code></pre></div>
<p>This solution could also be used by VerCors, and seems the most straightforward to implement and explain. A possible drawback of this approach is that ghost methods defined to work over ghost pointers cannot be used on regular pointers, so this might require users to define ghost functions twice in some cases.</p>
<p>Another drawback is that the type system of the language to be checked needs to be changed/extended. For languages that do not have const-like modifiers like Java, it's not immediately clear how the type system has to be extended. But, for a language like Java, maybe generics can be used.</p>
<h3 id="permission-based-solution">Permission based solution</h3>
<p>Since VerCors supports permissions, they could also possibly be used to discern between real and ghost state. For example, VerCors could support a ghost permission and a real permission. A benefit of this is that the type system of the language to be checked does not have to be modified.</p>
<p>A drawback is that still duplicate function definitions are needed for ghost functions that want to operate over both ghost and regular state. Maybe this can be resolved by having some kind of permission that can be both a ghost or regular permission, which disallows writing, and is therefore safe to use in both regular method and ghost method contracts. But this seems like a non-trivial extension of separation logic, and also difficult to encode in Silver.</p>
<h1 id="distributing-read-permissions-between-threads">Distributing read permissions between threads</h1>
<p>A possible use case of read permissions is to distribute read permission between threads:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb47-1" title="1">par (<span class="dt">int</span> tid = <span class="dv">0</span> .. N)</a>
<a class="sourceLine" id="cb47-2" title="2"><span class="kw">requires</span> x != null ** Perm(x.f, read);</a>
<a class="sourceLine" id="cb47-3" title="3">{</a>
<a class="sourceLine" id="cb47-4" title="4">  m1(x.f)</a>
<a class="sourceLine" id="cb47-5" title="5">} <span class="kw">and</span> </a>
<a class="sourceLine" id="cb47-6" title="6"><span class="kw">requires</span> x != null ** Perm(x.f, read);</a>
<a class="sourceLine" id="cb47-7" title="7">{</a>
<a class="sourceLine" id="cb47-8" title="8">  m2(x.f);</a>
<a class="sourceLine" id="cb47-9" title="9">}</a></code></pre></div>
<p>This results in the following quantifier for the parallel region:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb48-1" title="1">(\forall <span class="dt">int</span> tid = <span class="dv">0</span> .. N; Perm(x.f, read))</a></code></pre></div>
<p>However, because of <a href="http://viper.ethz.ch/tutorial/?page=1&amp;section=#receiver-expressions-and-injectivity">viper's injectivity requirement</a>, this expression is not well-formed.</p>
<p>The following rewrite rules can be used to resolve this:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb49-1" title="1">axiom read_spreads_l {</a>
<a class="sourceLine" id="cb49-2" title="2">  Perm(g1, read * i)</a>
<a class="sourceLine" id="cb49-3" title="3">  ==</a>
<a class="sourceLine" id="cb49-4" title="4">  i &gt; <span class="dv">0</span> ==&gt; Perm(g1, read)</a>
<a class="sourceLine" id="cb49-5" title="5">}</a>
<a class="sourceLine" id="cb49-6" title="6"></a>
<a class="sourceLine" id="cb49-7" title="7">axiom read_spreads_r {</a>
<a class="sourceLine" id="cb49-8" title="8">  Perm(g1, i * read)</a>
<a class="sourceLine" id="cb49-9" title="9">  ==</a>
<a class="sourceLine" id="cb49-10" title="10">  i &gt; <span class="dv">0</span> ==&gt; Perm(g1, read)</a>
<a class="sourceLine" id="cb49-11" title="11">}</a>
<a class="sourceLine" id="cb49-12" title="12"></a>
<a class="sourceLine" id="cb49-13" title="13">axiom resource_independent_read_quant {</a>
<a class="sourceLine" id="cb49-14" title="14">  (\forall* <span class="dt">int</span> tid; (tid \memberof {(e1!tid)..(e2!tid)}); (Perm(g1, read)!tid))</a>
<a class="sourceLine" id="cb49-15" title="15">  ==</a>
<a class="sourceLine" id="cb49-16" title="16">  (e1&lt;e2) ==&gt; Perm(g1, read)</a>
<a class="sourceLine" id="cb49-17" title="17">}</a>
<a class="sourceLine" id="cb49-18" title="18"></a></code></pre></div>
<p>Unfortunately, these rules cause some problems. Besides sidestepping this injectivity requirement, using these rewrite rules does not accurately reflect Viper's intended semantics of <code>read</code> (see: <a href="https://github.com/viperproject/silicon/issues/539">https://github.com/viperproject/silicon/issues/539</a>). Furthermore, at the time of writing this it is also not allowed to have complex expressions composed of `read (see: <a href="https://github.com/viperproject/silicon/issues/569">https://github.com/viperproject/silicon/issues/569</a>), which would be needed to use more complicated alternative rewrite rules (see below).</p>
<p>Currently, the only way of working around this is by using the fact that the number of threads is usually known (in the above example, the number of threads is <code>N</code>). This allows permissions to be distributed in portions of <code>1\N</code>. A downside of this is that when the expressions become more complicated (say, when you have N producers, and one consumer, portions are of size <code>1\(N+1)</code>), Viper/Z3 can sometimes not deal with the resulting non-linear arithmetic, which can cause long verification times and non-determinism.</p>
<h2 id="alternative-formulations-of-the-rewrite-rules">Alternative formulations of the rewrite rules</h2>
<p>Briefly the following alternative formulation was used in vercors:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb50-1" title="1">axiom read_spreads_l {</a>
<a class="sourceLine" id="cb50-2" title="2">  read * i</a>
<a class="sourceLine" id="cb50-3" title="3">  ==</a>
<a class="sourceLine" id="cb50-4" title="4">  (\let <span class="dt">int</span> canary = i; i == <span class="dv">0</span> ? read : read)</a>
<a class="sourceLine" id="cb50-5" title="5">}</a>
<a class="sourceLine" id="cb50-6" title="6"></a>
<a class="sourceLine" id="cb50-7" title="7">axiom read_spreads_r {</a>
<a class="sourceLine" id="cb50-8" title="8">  i * read</a>
<a class="sourceLine" id="cb50-9" title="9">  ==</a>
<a class="sourceLine" id="cb50-10" title="10">  (\let <span class="dt">int</span> canary = i; i == <span class="dv">0</span> ? read : read)</a>
<a class="sourceLine" id="cb50-11" title="11">}</a></code></pre></div>
<p>These leave the value <code>i</code> outside of the multiplication, but do keep <code>i</code> around because it needs to be well-formed. For example, if <code>i</code> were <code>1/0</code>, removing it would be unsound. However, these rules are currently not allowed because of <a href="https://github.com/viperproject/silicon/issues/569">https://github.com/viperproject/silicon/issues/569</a>.</p>
    </span>
    <span class="wiki-side-menu">
        <ul>
<li>
<a href="#introduction">Introduction</a>
<ul>
<li><a href="#vercors">VerCors</a></li>
</ul>
</li>
<li>
<a href="#background">Background</a>
<ul>
<li><a href="#software-verification">Software Verification</a></li>
<li><a href="#separation-logic">Separation Logic</a></li>
</ul>
</li>
<li>
<a href="#installing-and-running-vercors">Installing and Running VerCors</a>
<ul>
<li><a href="#syntax-highlighting">Syntax highlighting</a></li>
</ul>
</li>
<li>
<a href="#prototypical-verification-language">Prototypical Verification Language</a>
</li>
<li>
<a href="#specification-syntax">Specification Syntax</a>
<ul>
<li><a href="#method-contracts">Method Contracts</a></li>
<li><a href="#auxiliary-annotations">Auxiliary Annotations</a></li>
</ul>
</li>
<li>
<a href="#permissions">Permissions</a>
<ul>
<li><a href="#self-framing">Self-framing</a></li>
<li><a href="#permission-leaks">Permission leaks</a></li>
<li><a href="#some-extra-notation">Some extra notation</a></li>
</ul>
</li>
<li>
<a href="#gpgpu-verification">GPGPU Verification</a>
</li>
<li>
<a href="#axiomatic-data-types">Axiomatic Data Types</a>
<ul>
<li><a href="#sequence">Sequence</a></li>
<li><a href="#set">Set</a></li>
<li><a href="#bag">Bag</a></li>
<li><a href="#map">Map</a></li>
<li><a href="#tuple">Tuple</a></li>
<li><a href="#option">Option</a></li>
<li><a href="#adt-reference">ADT Reference</a></li>
</ul>
</li>
<li>
<a href="#arrays-and-pointers">Arrays and Pointers</a>
<ul>
<li><a href="#array-permissions">Array permissions</a></li>
<li><a href="#syntactic-sugar">Syntactic sugar</a></li>
<li><a href="#pointers">Pointers</a></li>
<li><a href="#injectivity-object-arrays-and-efficient-verification">Injectivity, object arrays and efficient verification</a></li>
</ul>
</li>
<li>
<a href="#parallel-blocks">Parallel Blocks</a>
</li>
<li>
<a href="#atomics-and-locks">Atomics and Locks</a>
<ul>
<li><a href="#pvl-intrinsic-locks">PVL: Intrinsic locks</a></li>
<li><a href="#pvl-atomics">PVL: Atomics</a></li>
<li><a href="#java-synchronized">Java: Synchronized</a></li>
</ul>
</li>
<li>
<a href="#process-algebra-models">Process Algebra Models</a>
</li>
<li>
<a href="#predicates">Predicates</a>
<ul>
<li><a href="#why-predicates">Why predicates?</a></li>
<li><a href="#predicate-syntax-and-usage">Predicate syntax and usage</a></li>
<li><a href="#the-counter-example-now-with-predicates">The <code>Counter</code> example, now with predicates</a></li>
<li><a href="#reservedinternal-predicates">Reserved/internal predicates</a></li>
<li><a href="#advanced-usage-of-predicates">Advanced usage of predicates</a></li>
<li><a href="#known-problems">Known problems</a></li>
</ul>
</li>
<li>
<a href="#inheritance-1">Inheritance</a>
</li>
<li>
<a href="#exceptions--goto">Exceptions & Goto</a>
<ul>
<li><a href="#exceptions">Exceptions</a></li>
<li><a href="#goto-and-labels">Goto and labels</a></li>
</ul>
</li>
<li>
<a href="#veymont">VeyMont</a>
<ul>
<li><a href="#user-documentation">User documentation.</a></li>
<li><a href="#developer-documentation">Developer documentation</a></li>
</ul>
</li>
<li>
<a href="#term-rewriting-rules">Term Rewriting Rules</a>
</li>
<li>
<a href="#magic-wands">Magic Wands</a>
<ul>
<li><a href="#what-are-magic-wands">What are Magic Wands?</a></li>
<li><a href="#syntax-in-vercors">Syntax in VerCors</a></li>
</ul>
</li>
<li>
<a href="#inhale-and-exhale">Inhale and exhale</a>
</li>
<li>
<a href="#what-does-this-vercors-error-message-mean">What does this VerCors error message mean?</a>
</li>
<li>
<a href="#pvl-syntax-reference">PVL Syntax Reference</a>
<ul>
<li><a href="#general">General</a></li>
<li><a href="#types-and-data-structures">Types and Data Structures</a></li>
<li><a href="#expressions-1">Expressions</a></li>
<li><a href="#control-flow-constructs">Control flow constructs</a></li>
<li><a href="#verification-flow-constructs">Verification flow constructs</a></li>
</ul>
</li>
<li>
<a href="#vercors-usage--debugging-cheat-sheet">VerCors usage & debugging cheat sheet</a>
<ul>
<li><a href="#information--questions">Information & questions</a></li>
<li><a href="#getting-vercors-up-and-running">Getting VerCors up and running</a></li>
<li><a href="#general-usage">General usage</a></li>
<li><a href="#general-flags">General flags</a></li>
<li><a href="#advanced-verification-flags">Advanced verification flags</a></li>
<li><a href="#debugging-flags">Debugging flags</a></li>
<li><a href="#some-starter-example-files">Some starter example files</a></li>
</ul>
</li>
<li>
<a href="#case-studies">Case Studies</a>
<ul>
<li><a href="#published-case-studies">Published case studies</a></li>
<li><a href="#student-projects">Student projects</a></li>
</ul>
</li>
<li>
<a href="#meta">Meta</a>
<ul>
<li><a href="#vercors-the-tool">VerCors (the tool)</a></li>
<li><a href="#vercors-website">VerCors Website</a></li>
<li><a href="#vercors-server-online-tool-runner">VerCors Server (online tool runner)</a></li>
<li><a href="#gitlab-mirror">GitLab Mirror</a></li>
<li><a href="#tool-server">tool-server</a></li>
<li><a href="#antlr4-fork">ANTLR4 Fork</a></li>
<li><a href="#the-wiki">The Wiki</a></li>
<li><a href="#docker-hub">Docker Hub</a></li>
<li><a href="#phabricator">Phabricator</a></li>
</ul>
</li>
<li>
<a href="#developing-for-vercors">Developing for VerCors</a>
<ul>
<li><a href="#workflow">Workflow</a></li>
</ul>
</li>
<li>
<a href="#project-structure">Project Structure</a>
<ul>
<li><a href="#functional-overview">Functional Overview</a></li>
<li><a href="#technical-setup">Technical Setup</a></li>
<li><a href="#project-structure-1">Project Structure</a></li>
</ul>
</li>
<li>
<a href="#ide-import">IDE Import</a>
<ul>
<li><a href="#configuring-vercors-for-eclipse">Configuring VerCors for Eclipse</a></li>
<li><a href="#configuring-vercors-for-intellij-idea">Configuring VerCors for IntelliJ IDEA</a></li>
<li><a href="#i-encountered-an-error">I encountered an error!</a></li>
</ul>
</li>
<li>
<a href="#scalatest">ScalaTest</a>
<ul>
<li><a href="#running-scalatest">Running ScalaTest</a></li>
</ul>
</li>
<li>
<a href="#wiki-code-snippet-testing-harness">Wiki Code Snippet Testing Harness</a>
<ul>
<li><a href="#self-contained-code-blocks">Self-contained code blocks</a></li>
<li><a href="#snippets">Snippets</a></li>
</ul>
</li>
<li>
<a href="#feature-rainbow">Feature Rainbow</a>
</li>
<li>
<a href="#clearer-separation-of-real-and-ghost-state">Clearer separation of real and ghost state</a>
</li>
<li>
<a href="#distributing-read-permissions-between-threads">Distributing read permissions between threads</a>
<ul>
<li><a href="#alternative-formulations-of-the-rewrite-rules">Alternative formulations of the rewrite rules</a></li>
</ul>
</li>
</ul>
    </span>
</div>

    </div>
</div>


        <div id="footer">
            <div class="row">
                <a href="//fmt.ewi.utwente.nl" target="_blank"><img src="/images/FMT logo.png" alt=""></a>
                <div class="copyright">
                    <a href="//fmt.ewi.utwente.nl/research/projects/view/vercors/" target="_blank">Copyright <code>&copy</code> The VerCors Project 2007-2022</a>
                    | <a href="//fmt.ewi.utwente.nl" target="_blank">FMT - University of Twente</a>
                    | <a href="/about/">About Us</a>
                </div>
            </div>
        </div>
    </body>
</html>