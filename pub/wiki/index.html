
<!DOCTYPE HTML>
<!--
VerCors Tool --- Formal Methods and Tools Group (EWI)
University of Twente, Enschede, The Netherlands
-->
<html lang="en">
    <head>
        <title>Tutorial Â· VerCors Tool FMT | UTwente </title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">

        <meta name="title" property="og:title" content="VerCors Verifier for Parallel Software">
        <meta property="og:type" content="website">
        <meta property="og:image" content="https://vercors.ewi.utwente.nl/images/opengraph-logo.png">
        <meta property="og:image:type" content="image/png">
        <meta property="og:image:alt" content="The text 'VerCors' with a red mountain ridge on the top right">
        <meta property="og:url" content="https://utwente.nl/vercors">
        <meta name="description" property="og:description" content="The VerCors verifier is a tool for deductive verification of concurrent and parallel software. VerCors can reason about programs written in different programming languages, such as Java, C and OpenCL, where the specifications are written in terms of pre-post-condition contracts using permission-based separation logic. VerCors is able to reason about data-race freedom, memory safety, and functional correctness, and it has been applied on several realistic case studies. Several tools are being developed directly on top of VerCors by encoding their input languages to VerCors' internal representation, allowing reuse of the existing infrastructure for verification. These tools are Alpinist, Vesuv, and VeyMont.">
        <meta name="keywords" content="software, formal verification, deductive verification, java, c, opencl, openmp, cuda, separation logic">
        <meta name="theme-color" content="#d12010">

        <link rel="icon" href="/images/icon.svg">

        <link rel="stylesheet" href="/css/external/codemirror.css">
        <link rel="stylesheet" href="/css/external/codemirror-monokai.css">
        <link rel="stylesheet" href="/css/highlight/default.css">
        <link rel="stylesheet" href="/css/external/datatables.min.css">
        <link rel="stylesheet" href="/css/global.css">
        <link rel="stylesheet" href="/css/elements.css">
        <link rel="stylesheet" href="/css/colors.css">
        <link rel="stylesheet" href="/css/shared.css">
        <link rel="stylesheet" href="/css/datatables.css">
        <link rel="stylesheet" href="/css/home.css">
        <link rel="stylesheet" href="/css/online.css">
        <link rel="stylesheet" href="/css/credits.css">
        <link rel="stylesheet" href="/css/wiki.css">
        <link rel="stylesheet" href="/css/responsive.css">

        <script src="/js/jquery.min.js"></script>
        <script src="/js/highlight.pack.js"></script>
        <script src="/js/codemirror.js"></script>
        <script src="/js/datatables.min.js"></script>
        <script src="/js/vercorsonline.js"></script>
        <script src="/js/init.js"></script>

        <!--<script type="text/javascript">
            hljs.initHighlightingOnLoad();
        </script>-->
    </head>
    <body class="no-sidebar">
        <div id="header" class="">
            <nav>
                <div class="container">
                    <div id="logo">
                        <span id="hamburger" onclick="document.querySelector('nav').classList.toggle('open')"><span class="fa fa-bars"></span></span><!--
                        --><a href="/"><img id="logo-light" src="/images/logo.svg" title="The VerCors Verifier" alt="Logo of the VerCors Verifier"><img id="logo-dark" src="/images/logo-white.svg" title="The VerCors Verifier" alt="Logo of the VerCors Verifier"></a>
                    </div>
                    <ul>
                        <li>
                            <a href="/wiki/">Getting Started</a>
                            <ul>
                                <li><a href="/wiki/#installing-and-running-vercors">Installation Guide</a></li>
                                <li><a href="/wiki/#prototypical-verification-language">Tutorial</a></li>
                                <li>
                                    <a href="//github.com/utwente-fmt/vercors/issues" target="_blank">
                                        Issue Tracker
                                        <span class="fa fa-external-link" style="font-size: 10pt"></span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <a href="/">Tools</a>
                            <ul>
                                <li><a href="/">Verifier</a></li>
                                <li><a href="/alpinist/">Alpinist</a></li>
                                <li><a href="/vesuv/">VeSUV</a></li>
                                <li><a href="/veymont/">VeyMont</a></li>
                            </ul>
                        </li>
                        <li><a href="/publications/">Publications</a></li>
                        <li>
                            <a href="/about/">About</a>
                            <ul>
                                <li><a href="/about/#team">VerCors Team</a></li>
                                <li><a href="/news/">News</a></li>
                                <li><a href="/about/#contact">Contact</a></li>
                                <li><a href="/about/#credits">Credits</a></li>
                                <li><a href="/license/">License</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>
            
<div id="banner" class="container">
    <section>
        <p class="button-row">
    <a href="//github.com/utwente-fmt/vercors" class="button" target="_blank">
        View on Github
    </a>
    <a href="/try_online/" class="button">Try VerCors Online</a>
</p>
    </section>
</div>

        </div>

        
<div class="alt">
    <section class="container">
        
<div class="row" style="width: 100%; vertical-align: top">
    <span style="width: 75%; display: inline-block" id="wiki-content">
        
<h1 id="introduction">Introduction</h1>
<p><strong>Welcome</strong> to the VerCors tutorial! In this tutorial,
we will look at what VerCors is, what it can do, and how <em>you</em>
can use it.</p>
<p>VerCors is a toolset for software verification. It can be used to
reason about programs written in Java, C, OpenCL and PVL, which is a
<em>Prototypal Verification Language</em> that is developed alongside
VerCors and often used to demonstrate and test the capabilities of
VerCors.</p>
<p>In this tutorial, we will first take a brief look at where VerCors
fits into the bigger picture of software verification. As this is only a
brief look, we recommend users that are unfamiliar with software
verification to take a look at the chapter <a
href="../Background">"Background"</a> that gives more information on
software verification and some of the terms used below. Then, we will
discuss the syntax of <a
href="https://github.com/utwente-fmt/vercors/wiki/Prototypal-Verification-Language">PVL</a>
and <a
href="https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax">Specifications
in VerCors</a>. Once we have a basic idea of how things work, we look at
several more advanced concepts, either of VerCors (e.g. <a
href="https://github.com/utwente-fmt/vercors/wiki/Resources-and-Predicates">resources</a>)
or of the input languages (e.g. <a
href="https://github.com/utwente-fmt/vercors/wiki/Inheritance">inheritance</a>).
You can find an overview of the chapters on the right.</p>
<h2 id="vercors">VerCors</h2>
<p>VerCors is a verification tool that uses <em>static analysis</em> to
prove <em>partial correctness</em> of a given piece of code. It requires
users (e.g. software developers) to add <em>annotations in the
code</em>, which specify the expected behaviour. The chapter <a
href="https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax">"Specification
Syntax"</a> of this tutorial describes the syntax for these annotations.
VerCors particularly targets parallel and concurrent programs, using the
permission-based <em>Concurrent Separation Logic (CSL)</em> as its
logical foundation. CSL is a program logic that has a very strong notion
of <em>ownership</em> in the form of <em>(fractional) permissions</em>:
A thread can only read from, or write to, shared memory if it owns
enough permission to do so. An advantage of concurrent separation logic
is that, due to the explicit handling of ownership, we get properties
like data-race freedom and memory safety for free; these properties are
consequences of the soundness argument of the logic. A disadvange is
that it causes significant overhead to always deal with permissions
explicitly. Therefore, if you only wish to verify sequential algorithms,
it may be worthwhile to look at alternative tools such as <a
href="http://www.openjml.org/">OpenJML</a> and <a
href="https://www.key-project.org/">KeY</a>, which do not use CSL as
their logical foundation. For more info on CSL, ownership and
permissions, see the chapter <a
href="https://github.com/utwente-fmt/vercors/wiki/Permissions">"Permissions"</a>.</p>
<p>VerCors' analysis is <em>modular</em>, proving each method in
isolation: Each method has a contract specifying the pre-conditions that
must be met before calling the method, and the post-conditions that are
certain when the method call finishes. Analysis of a method body happens
solely based on the contract, not considering any actual calling
environments.</p>
<p>While VerCors currently supports Java, C (incl. OpenMP), OpenCL and
PVL, it is designed to be extensible, in the sense that support for
other input languages with parallel and concurrent language constructs
(for example C#) can be added without much difficulty. For that, the aim
for VerCors is to allow reasoning over many different general
concurrency structures, like statically-scoped concurrency (e.g. GPU
kernels), dynamically-scoped concurrency (e.g. fork/join parallelism),
and automated parallelism (e.g. programs that are automatically
parallelised using OpenMP).</p>
<p>Note that VerCors checks for <em>partial correctness</em>, meaning
that if the program terminates, then it satisfies its post-conditions.
No proof is attempted to check whether the program actually
terminates.</p>
<p>It is worth noting that VerCors is not the only tool that can perform
static verification on annotated programs; there are actually many tools
that can do a very similar job. Examples of such tools are: <a
href="http://research.microsoft.com/dafny">Dafny</a>, <a
href="http://www.openjml.org/">OpenJML</a>, <a
href="https://www.key-project.org/">KeY</a>, <a
href="https://github.com/verifast/verifast">VeriFast</a>, and <a
href="https://research.microsoft.com/vcc">VCC</a>. However, VerCors
distinguishes itself by focussing on <em>different parallel and
concurrent language constructs</em> (e.g. Dafny, OpenJML, and KeY only
allow verifying sequential programs) of <em>various high-level
programming languages</em> (e.g. VCC only allows to verify C programs).
Moreover, VerCors is not designed to be language-dependent, and instead
focusses on verification techniques for <em>general</em> concurrency
patterns.</p>
<p>Internally, VerCors uses the <a
href="https://www.pm.inf.ethz.ch/research/viper.html">Viper backend</a>,
which in turn uses the SMT solver <a
href="https://github.com/Z3Prover/z3">Z3</a>. <img
src="https://vercors.ewi.utwente.nl/images/vct-arch-narrow_edit.png"
alt="VerCors architecture" /></p>
<h1 id="background">Background</h1>
<p>In this chapter, we explain some of the terms related to VerCors, for
example <em>static analysis</em>. If you are already an experienced user
of software verification tools, feel free to skip it. If you are new to
the topic, we recommend reading this chapter to better understand the
other chapters.</p>
<h2 id="software-verification">Software Verification</h2>
<p>Nowadays, we as a society rely heavily on software, and software
errors can have a major impact, even causing deaths. Thus, software
developers strive to reduce the number of software errors as much as
possible. <em>Software verification</em> is the task of reasoning about
the behaviour of the software, in order to ensure that it behaves
correctly. The most basic case could be considered to be the compiler,
which checks that the program e.g. does not misspell a name. Only if the
compiler does not find any errors, then the program can be executed.
However, many errors that are more intricate can slip past the compiler.
To catch these, there are two possibilities: <em>Static analysis</em>
and <em>dynamic analysis</em>. Dynamic analysis runs the program and
watches its behaviour. One example is testing, where you provide the
software with a concrete input, let it compute an output and check that
it is the expected one. While this can show errors, it cannot guarantee
the absence of errors: Maybe it only works for this specific input, and
even that only in non-leap years. <em>Static analysis</em> looks at the
source code itself, and can thus reason in more general terms. The
compiler is part of this category, and so is VerCors.</p>
<p>Different tools provide different levels of analysis. As an example,
let's take a division by zero, which is not allowed in mathematics and
would cause the software to misbehave. In the most simple case, we could
search for expressions like <code>1/0</code>, which we recognise as bad
immediately. But what about <code>1/x</code>? Maybe <code>x</code> is
zero, maybe not. Some tools will check the program to find all possible
values that <code>x</code> can take. But this is often difficult to
decide, and the tools often approximate (e.g. instead of saying "-1, 1
or 2", they say "the interval [-1,2]", thereby also including the value
0 even though it cannot occur in reality). This can lead to false
results, e.g. complaining about programs that are actually correct.
Other tools require the user (meaning the software developer) to specify
which values <code>x</code> can take. This requires much more effort by
the user, who has to <em>annotate</em> the code, i.e. provide additional
information inside the program that is not needed to run the program,
but only for analysing it. As a reward for the additional effort, the
user can get more accurate results. VerCors follows this approach,
requiring the user to provide specifications as annotations. The chapter
<a
href="https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax">"Specification
Syntax"</a> of this tutorial describes the syntax for these
annotations.</p>
<p>Annotations can have different purposes, and two are particularly
relevant: <em>Assertions</em> or <em>proof obligations</em> are
properties the user wants to be proven, for instance that a function
computes the correct value. <em>Assumptions</em> provide the tool with
additional knowledge to help its proof; the tool takes them as given
facts and does <em>not</em> prove them. A common example are method
pre-conditions, where the user specifies the context in which the method
is called. That way, when analysing the method itself, the tool can
reason more accurately e.g. about the values of input parameters.
However, that means that the analysis results is only applicable if the
respective assumptions are met. So users (particularly new users) should
pay attention what facts were actually proven, and what was assumed, and
be aware under which conditions the analysis result holds.</p>
<p>As an example, consider the following code:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> <span class="fu">foo</span><span class="op">(</span><span class="dt">int</span> arg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">10</span><span class="op">/</span>arg<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If we <em>assume</em> that the method is only invoked with arguments
<code>arg&gt;0</code>, then we can <em>assert</em> (or <em>prove</em>)
that no division by zero occurs, and even that the result is between 0
and 10. Note that if the assumption is unsatisfiable (e.g. two
contradictory conditions, or a simple <code>false</code>), then we can
derive any boolean statement, because the implication "if assumption
then statement" is trivially true. Thus, users must be careful in their
choice of assumptions.</p>
<h2 id="separation-logic">Separation Logic</h2>
<p>VerCors particularly targets parallel and concurrent programs, as
they are more difficult to understand intuitively and thus are more
error-prone than sequential programs. One typical example is two parts
of the program accessing the same memory location at the same time. This
can lead to the unintuitive fact that, right after one thread wrote a
value to a variable, that variable might already have an entirely
different value due to the other thread jumping in between and changing
it. To avoid one thread invalidating the properties and invariants
maintained and observed by the other threads, VerCors uses
<em>Permission-Based Separation Logic (PBSL)</em> as its logical
foundation. PBSL is a program logic that has a very strong notion of
<em>ownership</em> in the form of <em>(fractional) permissions</em>: A
thread can only read from, or write to, shared memory if it owns enough
permission to do so. So just because a variable is on the heap, shared
and technically accessible by everyone, that does not mean that just
anyone can go ahead and use it; they need to coordinate with the others
by getting permission first. The specification language of VerCors has
constructs to deal with ownership and permissions (see the chapter <a
href="https://github.com/utwente-fmt/vercors/wiki/Permissions">"Permissions"</a>).
An advantage of this approach is that, due to the explicit handling of
ownership, we get properties like data-race freedom and memory safety
for free; these properties are consequences of the soundness argument of
the logic. You will notice that the handling of permissions makes up a
significant part of the verification effort, and <em>"Insufficient
Permissions"</em> is a frequent complaint by VerCors in the beginning.
And while VerCors can be used to analyse sequential programs, it always
requires this overhead of managing permissions. Therefore, if you only
wish to verify sequential algorithms, it may be worthwhile to look at
alternative tools such as <a href="http://www.openjml.org/">OpenJML</a>
and <a href="https://www.key-project.org/">KeY</a>, which do not use
PBSL as their logical foundation.</p>
<h1 id="installing-and-running-vercors">Installing and Running
VerCors</h1>
<p>The installation and running instructions can be found on the <a
href="https://github.com/utwente-fmt/vercors">Github homepage</a> of
this project.</p>
<h2 id="syntax-highlighting">Syntax highlighting</h2>
<p>When writing a program in PVL, the Prototypal Verification Language
of VerCors, syntax highlighting can be obtained in the following
way:</p>
<p>VerCors provides syntax highlighting support for PVL in <a
href="https://macromates.com/download">TextMate 2</a> (MacOS X) and <a
href="https://www.sublimetext.com">Sublime Text</a> (Linux and Windows)
as a TextMate Bundle. The bundle is located at
<code>./util/VercorsPVL.tmbundle</code>. On MacOS X for TextMate 2 you
can simply double click the <code>.tmbundle</code> file to install it.
Sublime Text requires you to copy the bundle content to some
directory:</p>
<ol type="1">
<li>In Sublime Text, click on the
<code>Preferences &gt; Browse Packagesâ¦</code> menu.</li>
<li>Create a new directory and name it <code>VercorsPVL</code>.</li>
<li>Move the contents of <code>VercorsPVL.tmbundle</code> (that is, the
<code>./Syntaxes</code> directory) into the directory you just
created.</li>
<li>Restart Sublime Text.</li>
</ol>
<p><a href="https://code.visualstudio.com">Visual Studio Code</a> (VS
Code) also has support for TextMate bundles to do syntax highlighting
(VS Code runs on Windows, Linux and OSX). Click <a
href="https://code.visualstudio.com/docs/extensions/themes-snippets-colorizers">here</a>
for instructions on how to install this (this has not been tested
however).</p>
<h1 id="prototypal-verification-language">Prototypal Verification
Language</h1>
<p>This page discusses the language features of PVL, the Prototypal
Verification Language of VerCors. The language is similar to Java, so it
has classes, methods, etc. It doesn't have modifiers like public and
private. This language is used for research too, so some special
constructs like the <a
href="https://github.com/utwente-fmt/vercors/wiki/Tutorial-Parallel-Blocks">par-block</a>
have been added to it. This section elaborates on the basic language
features of PVL. The more advanced features are described in later
sections. A complete reference overview of the PVL language and
specification syntax can be found <a
href="https://github.com/utwente-fmt/vercors/wiki/PVL-Syntax-Reference">here</a>.</p>
<h3 id="basic-types-and-expressions">Basic types and expressions</h3>
<p>Currently, VerCors supports the types <code>int</code>,
<code>boolean</code>, and <code>void</code> (for return types of
methods). Identifiers, e.g. variables and method names, can consist of
the characters a-z, A-Z, 0-9 and _. However, they must start with a
letter (a-z, A-Z). The following words are reserved and can therefore
not be used as identifiers:</p>
<p><code>inline</code>, <code>assert</code>, <code>package</code>,
<code>class</code>, <code>kernel</code>, <code>barrier</code>,
<code>invariant</code>, <code>constructor</code>, <code>run</code>,
<code>if</code>, <code>else</code>, <code>while</code>,
<code>for</code>, <code>goto</code>, <code>return</code>,
<code>vec</code>, <code>par</code>, <code>and</code>,
<code>parallel</code>, <code>sequential</code>, <code>block</code>,
<code>lock</code>, <code>unlock</code>, <code>wait</code>,
<code>notify</code>, <code>fork</code>, <code>join</code>,
<code>this</code>, <code>null</code>, <code>true</code>,
<code>false</code>, <code>current_thread</code>, <code>global</code>,
<code>local</code>, <code>static</code>, <code>unfolding</code>,
<code>in</code>, <code>new</code>, <code>id</code>,
<code>boolean</code>, <code>void</code>, <code>int</code>,
<code>string</code>, <code>resource</code>, <code>process</code>,
<code>frac</code>, <code>zfrac</code>, <code>bool</code>,
<code>ref</code>, <code>rational</code>, <code>seq</code>,
<code>set</code>, <code>bag</code>, <code>pointer</code>,
<code>map</code>, <code>option</code>, <code>either</code>,
<code>tuple</code>, <code>type</code>, <code>any</code>,
<code>nothing</code>, <code>pure</code>, <code>thread_local</code>,
<code>with</code>, <code>then</code>, <code>given</code>,
<code>yields</code>, <code>axiom</code>, <code>model</code>,
<code>adt</code>, <code>modifies</code>, <code>accessible</code>,
<code>requires</code>, <code>ensures</code>,
<code>context_everywhere</code>, <code>context</code>,
<code>loop_invariant</code>, <code>kernel_invariant</code>,
<code>lock_invariant</code>, <code>signals</code>,
<code>decreases</code>, <code>apply</code>, <code>fold</code>,
<code>unfold</code>, <code>open</code>, <code>close</code>,
<code>assume</code>, <code>inhale</code>, <code>exhale</code>,
<code>label</code>, <code>refute</code>, <code>witness</code>,
<code>ghost</code>, <code>send</code>, <code>to</code>,
<code>recv</code>, <code>from</code>, <code>transfer</code>,
<code>csl_subject</code>, <code>spec_ignore</code>, <code>action</code>,
<code>atomic</code>, <code>Reducible</code>, <code>AddsTo</code>,
<code>APerm</code>, <code>ArrayPerm</code>, <code>Contribution</code>,
<code>held</code>, <code>HPerm</code>, <code>idle</code>,
<code>perm</code>, <code>Perm</code>, <code>PointsTo</code>,
<code>running</code>, <code>Some</code>, <code>Left</code>,
<code>Right</code>, <code>Value</code>, <code>none</code>,
<code>None</code>, <code>write</code>, <code>read</code>,
<code>empty</code>.</p>
<p>Standard operators can be used to form expressions from values and
variables of type <code>int</code> or <code>boolean</code>:</p>
<ul>
<li>boolean operators:
<code>&amp;&amp;, ||, !, ==&gt;, ==, !=, &lt;, &lt;=, &gt;, &gt;=</code></li>
<li>arithmetic operators: <code>+, -, *, /, ++, --</code></li>
<li>if-then-else expression: <code>b ? e1 : e2</code> where
<code>b</code> is a boolean expressions, and <code>e1</code> and
<code>e2</code> are expressions of the same type</li>
</ul>
<p>Other expressions:</p>
<ul>
<li>Create new object: <code>new T(...)</code> where <code>T(...)</code>
is defined by the constructor of class <code>T</code></li>
<li>Create an array: <code>new T[i]</code> where <code>T</code> is a
type (so <code>int</code>, <code>boolean</code>, or a class
<code>T</code>) and <code>i</code> a non-negative integer.</li>
</ul>
<h3 id="classes-fields-methods">Classes, fields, methods</h3>
<p>A program consists of one of more classes. Classes have a name, zero
or more fields, zero or more constructors, and zero or more methods.
Below we show a small example class:</p>
<pre><code>class MyForest {
    int nrTrees;
    
    MyForest(int nr) {
        nrTrees = nr;
    }

    void plantTrees(int nr) {
        nrTrees = nrTrees + nr;
    }
}</code></pre>
<p>The keyword <code>this</code> can be used to refer to the current
object. Methods and functions may also be declared outside any class,
mimicking the behavior of static methods in Java.</p>
<h3 id="control-flow-return-if-while-for">Control flow: return, if,
while, for</h3>
<p>A method body consists of statements. The basic statements of PVL
are:</p>
<ul>
<li>assignment: <code>x = e;</code> where <code>x</code> is a variable
and <code>e</code> an expression.</li>
<li>return: <code>return e;</code>, where e is an expression of the type
of the method</li>
<li>if-statement: <code>if (b) then { s1 }</code> or
<code>if (b) then { s1 } else { s2 }</code>, where <code>b</code> is a
boolean expression and <code>s1</code> and <code>s2</code> are
(sequences of) statements.</li>
<li>while-loop: <code>while (b) { s1 }</code>, where <code>b</code> is a
boolean expression and <code>s1</code> a (sequence of) statement.</li>
<li>for-loop: <code>for(int i = e1; b; e2)</code>, where <code>i</code>
is an identifier <code>e1</code> is an integer expression,
<code>b</code> a boolean about <code>i</code> and <code>e2</code> an
update of <code>i</code>.</li>
<li>comments: single line comments <code>// put a comment here</code>,
or multiline comments <code>/*  put a comment here */</code>.</li>
</ul>
<p>Below we show a method using these constructs:</p>
<pre><code>int myExampleMethod(int nr) {
    nr = nr + 3;
    if(nr &gt; 10) { /* here is a multi-line comment
                     in the if-branch */
        nr = nr-3;
        for(int i = 0; i &lt; 2 &amp;&amp; nr &gt; 5; i++) {
            nr = nr/2;
        }
    } else { //we subtract a bit
        while (nr &gt; 2) {
            nr--;
        }
    }
    return nr + 5;
}</code></pre>
<h3 id="proof-helpers-frame-if">Proof helpers: frame, if(*)</h3>
<p>Proof helpers do not have an equivalent in regular programming
languages, but can be used to instruct the solver to take a certain
path.</p>
<p>You can use <code>if(*)</code> to encode a non-deterministic branch.
Exactly one branch of the <code>if</code> is chosen, but it is not known
to the solver which one. The syntax is as a normal if, but with the
condition <code>*</code>:</p>
<pre><code>void test() {
    if(*) {
        x[0] = 3;
    } else if(*) {
        x[1] = 8;
    } else {
        return;
    }
}</code></pre>
<h1 id="specification-syntax">Specification Syntax</h1>
<p><em>This section describes the syntax of the specification language,
which is independent of the target language. Thus, unless otherwise
stated, all features are supported for all input languages.</em></p>
<p>In this part of the tutorial, we will take a look at how
specifications are expressed in VerCors. While this tutorial provides
more detailed explanations of the various constructs, a concise list can
be found in the <a
href="https://github.com/utwente-fmt/vercors/wiki/PVL-Syntax-Reference">PVL
Syntax Reference</a> in the annex. The specification language is similar
to <a
href="http://www.eecs.ucf.edu/~leavens/JML/index.shtml">JML</a>.</p>
<p>Depending on the input language, specification are embedded into the
target code in two different ways: In most languages, such as Java and
C, the specifications are provided in special comments. These special
comments are either line comments starting with <code>//@</code>, or
block comments wrapped in <code>/*@</code> and <code>@*/</code>. Since
these are simply a kind of comment, regular compilers ignore them and
can still compile the program. However, the <code>@</code> signals
VerCors to interpret them as annotations. Note that this style of
comment comes from JML, so VerCors is not the only tool using them.
However, the exact interpretation of the comments may vary between
tools, so a valid specification in VerCors may not be recognised by
another tool and vice versa.</p>
<p>As an example, a method pre-condition (see following section) can
look like this:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ requires x&gt;0;
public int increment(int x) { /* ... */ }

/*@
requires x&gt;0;
requires y&gt;0;
@*/
public int add(int x, int y) { /* ... */ }<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-1
//:: verdict Pass
//:: tools silicon
final class Test {
    //@ requires x&gt;0;
    public int increment(int x) { /* ... */ }
    
    /*@
    requires x&gt;0;
    requires y&gt;0;
    @*/
    public int add(int x, int y) { /* ... */ }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p><strong>Tip</strong> Always remember to place the <code>@</code>! It
can be aggravating to spend significant time debugging, just to realise
that parts of the specification were put in regular comments and ignored
by the tool.</p>
<p>For PVL, the specifications are inserted directly into the code,
<em>without</em> the special comments around them:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">requires x&gt;0;
int increment(int x) { /* ... */ }

requires x&gt;0;
requires y&gt;0;
int add(int x, int y) { /* ... */ }<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-2
//:: verdict Pass
//:: tools silicon
class Test {
    requires x&gt;0;
    int increment(int x) { /* ... */ }
    
    requires x&gt;0;
    requires y&gt;0;
    int add(int x, int y) { /* ... */ }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Given that the syntax is otherwise identical, we will use the
commented version in the rest of the tutorial, to make the separation
between specifications and target code more obvious. The examples in
this chapter are in Java, but you can find the respective examples in
other languages on the <a
href="https://vercors.ewi.utwente.nl/try_online/examples?ExampleSearch%5Bid%5D=&amp;ExampleSearch%5Btitle%5D=&amp;ExampleSearch%5Bfeature%5D=&amp;ExampleSearch%5Bsource%5D=1&amp;ExampleSearch%5Blanguagename%5D=">website</a>
(as well as a Java file of all the examples below).</p>
<p>Most annotation constructs have to end with a semicolon.</p>
<p>In principle, we can distinguish two kinds of annotations:
Specifications in the form of <em>method contracts</em> that specify the
observable behaviour of the respective method; and <em>auxiliary
annotations</em> that guide the prover towards its goal and are for
example used inside a method's body, or to define helper functions. We
will first look at the former, then at the latter, and conclude with a
description of the kind of expressions that VerCors supports (e.g.
boolean connectives). For the earlier parts, it suffices to know that
expressions in VerCors specifications are an extension of whatever
expressions the target language supports.</p>
<h2 id="method-contracts">Method Contracts</h2>
<p>Method contracts specify the behaviour of the method that is visible
to the calling environment, by means of pre-conditions and
post-conditions. <em>Pre-conditions</em> use the keyword
<code>requires</code> and restrict the situations in which the method
can be invoked, e.g. restricting parameters to be non-null.
<em>Post-conditions</em> use the keyword <code>ensures</code> and
describe the behaviour of the method by defining the program state after
the call finishes. The method contract is placed above the method
header, and these keywords can only be used in combination with a method
header.</p>
<p>Two useful keywords to define the post-state (i.e. the state after
the method finishes) are <code>\result</code> to refer to the return
value of the (non-void) method, and <code>\old(expr)</code> to refer to
the value of <code>expr</code> <em>before</em> the method's
execution.</p>
<!-- test -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Test {
  /*@
  requires x &gt;= 0;
  requires y &gt;= 0;
  ensures \result == x+y;
  ensures \result &gt;= 0;
  @*/
  public int add(int x, int y) {
    return x+y;
  }

  /*@
  requires xs != null;
  ensures \result != null;
  ensures \result.length == \old(xs.length)+1;
  ensures \result.length &gt; 0;
  @*/
  public int[] append(int[] xs, int y) {
    int[] xsCopy = new int[xs.length + 1];
    /* ... */
    return xsCopy;
  }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-method-contracts-1
//:: verdict Pass
//:: tools silicon
class Test {
  /*@
  requires x &gt;= 0;
  requires y &gt;= 0;
  ensures \result == x+y;
  ensures \result &gt;= 0;
  @*/
  public int add(int x, int y) {
    return x+y;
  }

  /*@
  requires xs != null;
  ensures \result != null;
  ensures \result.length == \old(xs.length)+1;
  ensures \result.length &gt; 0;
  @*/
  public int[] append(int[] xs, int y) {
    int[] xsCopy = new int[xs.length + 1];
    /* ... */
    return xsCopy;
  }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Recall that VerCors analyses methods in isolation, purely based on
their contract and independent from any actual calling contexts. It
tries to prove that if the pre-condition is satisfied before the method
body is executed, then the post-condition holds afterwards. In the
example of the <code>add</code> method above, <em>if</em> the input
parameters are non-negative, <em>then</em> the result is, too. Note that
the pre-condition <code>x&gt;=0</code> is not actually required for
executing the method body, but it is necessary to prove the
post-condition. In contrast, in the example of <code>append</code>, the
pre-condition <code>xs!=null</code> is actually needed for
<code>\old(xs.length)</code> to be well-defined, and potentially to
prove absence of null-pointer dereferences in the method body. Note
that, to fully specify the correct behaviour of <code>append</code>, one
would have to compare the values inside of <code>xs</code> and
<code>\result</code>. Since these values are stored on the heap (and not
on the stack like the reference <code>xs</code> itself), this would
require access permissions, which will be introduced in the next chapter
<a
href="https://github.com/utwente-fmt/vercors/wiki/Permissions">"Permissions"</a>.</p>
<p><strong>Note</strong> Method contracts must not have side effects, so
for example calls to (non-pure) methods are forbidden inside contracts.
Pre- and post-conditions are processed in-order, so for example swapping
the order of two pre-conditions could result in a failed verification
(e.g. you need to specify that an integer variable is within range
before you can use it as an array index in another pre-condition). Note
that unsatisfiable pre-conditions (e.g. contradictory conditions, or
simply <code>false</code>) can lead to unexpected results, because the
implication "if pre-condition before, then post-condition after" becomes
trivially true for any post-condition, and VerCors is able to prove any
arbitrary statement.</p>
<p>Sometimes, the same expression is needed as a pre- and as a
post-condition, for example the fact that a global variable is not null.
In that case, the keyword <code>context</code> can be used as a
short-hand notation: <code>context xs != null;</code> stands for
<code>requires xs!=null; ensures xs!=null;</code>. An even further
reaching short-hand is <code>context_everywhere expr;</code>, which adds
<code>expr</code> as a pre- and as a post-condition, as well as a loop
invariant for all loops inside the method body (see below).</p>
<h2 id="auxiliary-annotations">Auxiliary Annotations</h2>
<p>When method bodies become more complicated than the toy examples
above, it becomes more difficult for VerCors to prove by itself that the
post-conditions hold after executing the method, and additional
annotations are needed inside the method body to guide the verification.
These can take the form of loop invariants, assumptions and assertions,
or ghost code. Ghost code can also occur outside of methods, for
instance to define helper functions.</p>
<h3 id="loop-invariants">Loop Invariants</h3>
<p>Loop invariants are similar to the <code>context</code> in a method
contracts, but for loops: They specify expressions that must hold before
entering the loop (like a pre-condition), as well as after each loop
iteration, incl. the last iteration (like a post-condition). Loop
invariants use the keyword <code>loop_invariant</code> and are placed
above the loop header:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ requires a&gt;0 &amp;&amp; b&gt;0;
//@ ensures \result == a*b;
public int mult(int a, int b) {
  int res = 0;
  //@ loop_invariant res == i*a;
  //@ loop_invariant i &lt;= b;
  for (int i=0; i&lt;b; i++) {
    res = res + a;
  }
  return res;
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-loop-invariants-1
//:: verdict Pass
//:: tools silicon
final class Test {
    //@ requires a&gt;0 &amp;&amp; b&gt;0;
    //@ ensures \result == a*b;
    public int mult(int a, int b) {
      int res = 0;
      //@ loop_invariant res == i*a;
      //@ loop_invariant i &lt;= b;
      for (int i=0; i&lt;b; i++) {
        res = res + a;
      }
      return res;
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Let us examine why this program verifies (you can skip this paragraph
if you are familiar with software verification and loop invariants): The
first loop invariant holds before we start the loop, because we
initialise both <code>i</code> and <code>res</code> to zero, and
<code>0 == 0*a</code> is true. Then in each iteration, we increase
<code>i</code> by one and <code>res</code> by <code>a</code>, so if
<code>res == i*a</code> held before the iteration, then it will also
hold afterwards. Looking at the second invariant, we see that it holds
before the loop execution because <code>i</code> is initialised to zero
and <code>b</code> is required to be greater than zero. To understand
why the invariant holds after each iteration, we also have to consider
the loop condition, <code>i&lt;b</code>. This condition has to be true
at the beginning of the iteration, otherwise the loop would have stopped
iterating. Since <code>i</code> and <code>b</code> are integers and
<code>i&lt;b</code> at the beginning of the iteration, an increment of
<code>i</code> by one during the iteration will ensure that at the end
of the iteration, <code>i&lt;=b</code> still holds. Note that if
<code>i</code> or <code>b</code> were floating point numbers,
<code>i</code> might have gone from <code>b-0.5</code> to
<code>b+0.5</code>, and we would not have been able to assert the loop
invariant. Likewise, any increment by more than one could step over
<code>b</code>. Only the combination of all these factors lets us assert
the invariant at the end of the loop iteration. When the loop stops
iterating, we know three things: Each of the two loop invariants holds,
and the loop condition does no longer hold (otherwise we would still be
iterating). Note that the combination of the second loop invariant and
the negated loop condition, <code>i&lt;=b &amp;&amp; !(i&lt;b)</code>,
ensures that <code>i==b</code>. Combining that with the first invariant
ensures the post-condition of the method.</p>
<p>Remember that VerCors checks for partial correctness, so there is no
check whether the loop actually stops iterating at some point. It just
asserts that <em>if</em> the loop stops, then the post-condition
holds.</p>
<p>As mentioned above, <code>context_everywhere expr;</code> in the
method contract will implicitly add <code>expr</code> as a loop
invariant to <em>all</em> loops in the method body. This can be useful
for expressions that hold for the entirety of the method, e.g. in the
case of <code>xs!=null</code>; but it can also be a subtle cause for
errors if it adds invariants to a loop that were not intended there
(especially in the case of multiple loops). For example, a method to
insert an element into a sorted array may add the new value at the end,
and then step by step restore the ordering of the array; in that case,
adding a sortedness property as <code>context_everywhere</code> would
not verify.</p>
<h3 id="assumptions-and-assertions">Assumptions and Assertions</h3>
<p>Sometimes, VerCors has trouble deriving a post-condition from the
given code and established facts (like pre-conditions), and it requires
explicitly specifying an intermediate step to guide the verification.
VerCors first proves these intermediate steps, and then can use them to
derive the desired facts. This can be done with the keyword
<code>assert</code>:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ ensures a==0 ? \result == 0 : \result &gt;= 10;
public int mult10(int a) {
  int res = a;
  if (res &lt; 0) {
    res = 0-res;
  }
  //@ assert res &gt;= 0;
  return 10*res;
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-assumptions-and-assertions-1
//:: verdict Pass
//:: tools silicon
final class Test {
    //@ ensures a==0 ? \result == 0 : \result &gt;= 10;
    public int mult10(int a) {
      int res = a;
      if (res &lt; 0) {
        res = 0-res;
      }
      //@ assert res &gt;= 0;
      return 10*res;
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>(Note that VerCors would be able to verify this example even without
the assertion, but this demonstrates how to use
<code>assert</code>.)</p>
<p><strong>Tip</strong> Assertions can also be useful for debugging: If
VerCors fails to prove the post-condition, adding <code>assert</code>
statements throughout the method body can help to pinpoint where the
verification fails, either because of a shortcoming of VerCors or
because of an actual error in the code. Additionally,
<code>assert false;</code> should always fail, so if the verification
does not seem to terminate, adding such statements throughout the method
can show where VerCors gets stuck. Finally, remember that a
contradiction e.g. in the pre-conditions can imply anything; even
<code>false</code>. So <code>assert false;</code> can be used to check
that no such contradiction occurred: If it verifies, something went
seriously wrong.</p>
<p>While assertions add additional proof obligations,
<em>assumptions</em> introduce additional facts that VerCors just takes
for granted afterwards, similar to pre-conditions. This is done via the
keyword <code>assume</code>. This can be dangerous if the assumptions
contradict the actual state of the program:</p>
<!-- testBlock -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">int x = 2;
//@ assume x == 1;
int y = x + 3;
//@ assert y == 4;<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-assumptions-and-assertions-2
//:: verdict Pass
//:: tools silicon
final class Test {
    void test() {
        int x = 2;
        //@ assume x == 1;
        int y = x + 3;
        //@ assert y == 4;
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>This snippet verifies, even though the actual value of <code>y</code>
at the end is 5. However, based on the (wrong) assumptions that
<code>x==1</code> on Line 2, the assertion holds. Therefore,
<strong>assumptions should be used with caution!</strong></p>
<p>Nevertheless, assumptions can be useful, e.g. for debugging purposes.
Also, while still being in the process of verifying the code, it can be
useful to assume certain basic facts to prove the bigger picture, and
then drill deeper and prove that the assumed facts actually hold.</p>
<p>VerCors also supports a <code>refute</code> statement, which is the
opposite of <code>assert</code>. Internally, <code>refute expr;</code>
is transformed into <code>assert !(expr);</code>, i.e. asserting the
negation. Note that a failing <code>assert expr;</code> is not
equivalent to a successful <code>refute expr;</code>. For example, if we
know nothing about the value of a variable <code>a</code>, then both
<code>assert a&gt;0;</code> and <code>refute a&gt;0;</code> will fail,
as <code>a</code> <em>could</em> be greater than zero, but it also could
be less.</p>
<p>For assert, VerCors supports the following alternative syntax:</p>
<ul>
<li><code>â¢ expr;</code></li>
</ul>
<h3 id="ghost-code">Ghost Code</h3>
<p>Recall that annotations must never have side-effects on the program
state, otherwise the results of methods would be different between
VerCors (which takes the annotations into account) and the compiler
(which treats them as comments). However, it can be useful to extend the
program state, for example introducing additional helper variables to
keep track of intermediate results. This helper code, which only exists
for the purpose of verification, is called <em>ghost code</em>, and the
respective variables form the <em>ghost state</em>.</p>
<p>Ghost code can occur inside method bodies, but also outside, for
instance as global ghost variables. In principle, ghost code can be any
construct that the target language supports; for example when verifying
Java programs, you could define ghost classes, and in C programs, you
may use pointers in ghost code. Additionally, the ghost code can use the
extensions that the specification language adds to the target language,
such as the new type <code>seq&lt;T&gt;</code> (see section
"Expressions" below).</p>
<p>Keep in mind that ghost code does not exist for the compiler, so it
cannot have side effects on the program state, and "real" code cannot
refer e.g. to ghost variables. However, it is possible to read from
"regular" variables (e.g. to create a ghost variable with the same
value).</p>
<p>When using constructs from the target language (such as variable
declarations), the keyword <code>ghost</code> is required before the use
of the construct.</p>
<p>Here is an example for ghost code inside a method:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
  requires x&gt;=0 &amp;&amp; y&gt;=0;
  ensures \result == (x&lt;y ? 5*x : 5*y);
@*/
public int minTimes5(int x, int y) {
  //@ ghost int min = (x&lt;y ? x : y);
  int res = 0;
  //@ loop_invariant i&lt;=5;
  //@ loop_invariant res == i*min;
  //@ loop_invariant min&lt;=x &amp;&amp; min&lt;=y &amp;&amp; (min==x || min==y); 
  for (int i=0; i&lt;5; i++) {
    if (x&lt;y) {
      res = res + x;
    } else {
      res = res + y;
    }
  }
  /*@ 
  ghost if (x&lt;y) {
    assert res == 5*x;
  } else {
    assert res == 5*y;
  }
  @*/
  return res;
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-ghost-code-1
//:: verdict Pass
//:: tools silicon
final class Test {
    /*@
      requires x&gt;=0 &amp;&amp; y&gt;=0;
      ensures \result == (x&lt;y ? 5*x : 5*y);
    @*/
    public int minTimes5(int x, int y) {
      //@ ghost int min = (x&lt;y ? x : y);
      int res = 0;
      //@ loop_invariant i&lt;=5;
      //@ loop_invariant res == i*min;
      //@ loop_invariant min&lt;=x &amp;&amp; min&lt;=y &amp;&amp; (min==x || min==y); 
      for (int i=0; i&lt;5; i++) {
        if (x&lt;y) {
          res = res + x;
        } else {
          res = res + y;
        }
      }
      /*@ 
      ghost if (x&lt;y) {
        assert res == 5*x;
      } else {
        assert res == 5*y;
      }
      @*/
      return res;
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Note the definition of a ghost variable <code>min</code> at the
beginning of the method, and the ghost <code>if</code> statement at its
end.</p>
<h4 id="ghost-methods-and-functions">Ghost Methods and Functions</h4>
<p>You can use ghost code not only within methods but also to declare
entire ghost methods:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
ghost
requires x &gt; 0;
ensures \result == (cond ? x+y : x);
static int cond_add(boolean cond, int x, int y) {
  if (cond) {
    return x+y;
  } else {
    return x;
  }
}
@*/

//@ requires val1 &gt; 0 &amp;&amp; val2&gt;0 &amp;&amp; z==val1+val2;
void some_method(int val1, int val2, int z) {
  //@ ghost int z2 = cond_add(val2&gt;0, val1, val2);
  //@ assert z == z2;
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-ghost-code-ghost-methods-and-functions-1
//:: verdict Pass
//:: tools silicon
final class Test {
    /*@
    ghost
    requires x &gt; 0;
    ensures \result == (cond ? x+y : x);
    static int cond_add(boolean cond, int x, int y) {
      if (cond) {
        return x+y;
      } else {
        return x;
      }
    }
    @*/
    
    //@ requires val1 &gt; 0 &amp;&amp; val2&gt;0 &amp;&amp; z==val1+val2;
    void some_method(int val1, int val2, int z) {
      //@ ghost int z2 = cond_add(val2&gt;0, val1, val2);
      //@ assert z == z2;
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>The conditional addition <code>cond_add</code> is defined as a ghost
method. Otherwise, it looks like any normal method, including having a
method contract (in this case, just a single precondition). Note that
the precondition is not wrapped in the special comment <code>//@</code>,
like the precondition of <code>some_method</code> is, because the entire
ghost method already is inside a special comment <code>/*@</code>. We
then use this ghost method in the body of <code>some_method</code> (but
only inside annotations!).</p>
<h5 id="functions-and-pure-methods">Functions and Pure Methods</h5>
<p><em>Functions</em> are, in a way, a special kind of ghost methods.
They look like any method, but they are pure by design (as signified by
the keyword <code>pure</code>) and their body is a single expression
following an <code>=</code>, rather than a block of statements:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
requires x &gt; 0;
pure int cond_add(boolean cond, int x, int y) 
  = cond ? x+y : x;
@*/<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-ghost-code-ghost-methods-and-functions-functions-and-pure-methods-1
//:: verdict Pass
//:: tools silicon
final class Test {
    /*@
    requires x &gt; 0;
    pure int cond_add(boolean cond, int x, int y) 
      = cond ? x+y : x;
    @*/
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Note that the <code>ghost</code> keyword is not used: It is only
required when using a construct from the target language (e.g.
<code>if</code>, variable declarations, etc), <em>not</em> for
specification-internal constructs like defining a function. However,
using a stand-alone call statement to call the function (e.g. invoke a
lemma directly and not in an <code>assert</code>) still needs the
<code>ghost</code> keyword, as method calls are constructs from the
target language: <code>//@ ghost myLemma();</code>. The important
distinction to normal methods, apart from the fact that they have just
one expression, is that functions <em>must be pure, i.e. must be without
side-effects</em>, even on the ghost state. Thus, the body cannot
contain for instance calls to non-pure methods.</p>
<p>Remember that in VerCors, only the contract of a method is used to
reason about the behaviour of a method call, the actual behaviour of the
method body is not taken into account at this point. For functions, this
restriction is not as strict: For simple functions like the one above,
VerCors actually uses the "real" behaviour of the function to analyse
the behaviour of a call to that function. Thus, the behaviour does not
need to be specified explicitly in a post-condition, like it does for
other methods. However, this only works for simple functions, and for
example a recursive function may still need a post-condition specifying
its behaviour.</p>
<p>You can also add the <code>pure</code> keyword to a "real" method.
This indicates that the method does not have side-effects, and can
therefore be used e.g. in method contracts, while still being accessible
by the "real" code. However, for a method to be pure, it has to be
actually without side-effects, therefore only a limited number of
constructs are allowed in methods that are designated pure:
<code>if</code> statements, return statements and variable
declarations.</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
requires x &gt; 0;
@*/
static /*@ pure @*/ int cond_add(boolean cond, int x, int y) {
  if (cond) {
    return x+y;
  } else {
    return x;
  }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-ghost-code-ghost-methods-and-functions-functions-and-pure-methods-2
//:: verdict Pass
//:: tools silicon
final class Test {
    /*@
    requires x &gt; 0;
    @*/
    static /*@ pure @*/ int cond_add(boolean cond, int x, int y) {
      if (cond) {
        return x+y;
      } else {
        return x;
      }
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h5 id="abstract-methods-and-functions">Abstract Methods and
Functions</h5>
<p>Ghost functions and methods do not require a body. Sometimes, you are
only interested in the assertions that a function or method gives in its
post-condition, and do not care about the actual implementation. In such
a case, you can omit the body, turning the method or function
<em>abstract</em>. Given that method calls are usually reasoned about
only based on the contract, the call site does not see a difference
between an abstract method and a "real" method. However, this removes
the assurance that it is actually possible to derive the post-condition
from the pre-condition by some computation. Consider a post-condition
<code>false</code>: The call site will simply assume that the method
establishes its post-condition, and treat it as a known fact. Normally,
verifying the method body will check that the post-condition is actually
fulfilled; but for an abstract method, this check is missing. Since
<code>false</code> implies everything, this can easily lead to
unsoundness. Therefore, from the perspective of correctness, it is
always better to have a body proving that the post-condition can
actually be established based on the pre-condition.</p>
<p>However, making a method abstract relieves VerCors from the effort to
check that the method body actually adheres to the contract. Therefore,
it can be an interesting option to speed up the re-run of an analysis:
Once you proved that a method can indeed derive its post-condition, you
can turn the method abstract and focus on other parts of the code
without checking this method every time you re-run the analysis.</p>
<p>Syntactically, an abstract method or function has a semicolon in
place of its body:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ requires a&gt;0 &amp;&amp; b&gt;0;
//@ ensures \result == a*b;
public int mult(int a, int b);
// commented out body for the sake of speeding up the analysis:
//{
//  int res = 0;
//  // loop_invariant res == i*a;
//  // loop_invariant i &lt;= b;
//  for (int i=0; i&lt;b; i++) {
//    res += a;
//  }
//  return res;
//}

/*@
  ghost
  requires a&gt;0 &amp;&amp; b&gt;0;
  ensures \result == a+b;
public pure int add(int a, int b);
@*/<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-ghost-code-ghost-methods-and-functions-abstract-methods-and-functions-1
//:: verdict Pass
//:: tools silicon
final class Test {
    //@ requires a&gt;0 &amp;&amp; b&gt;0;
    //@ ensures \result == a*b;
    public int mult(int a, int b);
    // commented out body for the sake of speeding up the analysis:
    //{
    //  int res = 0;
    //  // loop_invariant res == i*a;
    //  // loop_invariant i &lt;= b;
    //  for (int i=0; i&lt;b; i++) {
    //    res += a;
    //  }
    //  return res;
    //}
    
    /*@
      ghost
      requires a&gt;0 &amp;&amp; b&gt;0;
      ensures \result == a+b;
    public pure int add(int a, int b);
    @*/
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Note that VerCors can also work with abstract methods that are not
ghost methods (like <code>mult</code> in the example above), but your
compiler may complain about missing method definitions.</p>
<h5 id="inline-functions">Inline Functions</h5>
<p>Inline functions are like macros in C: You can write an expression
that occurs frequently in your code as a macro and then use it as if it
were a function; but before verifying the program, VerCors replaces
every call to the inline function with the function's body as if you had
written out the body in place of the function call. Therefore, during
the analysis, the "real" behaviour of the function is taken into
account, rather than just the specification of the function's contract.
However, inline functions are only possible if the body of the function
is simple enough; for example a recursive function cannot be used in
that way, otherwise there would be an infinite loop of replacing a
function call with the body, which again contains a call. Inline
functions are declared using the <code>inline</code> keyword.</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ inline pure int min(int x, int y) = (x&lt;y ? x : y);<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-ghost-code-ghost-methods-and-functions-inline-functions-1
//:: verdict Pass
//:: tools silicon
final class Test {
    //@ inline pure int min(int x, int y) = (x&lt;y ? x : y);
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Note that the <code>inline</code> keyword is also used for inline
predicates (see chapter <a
href="https://github.com/utwente-fmt/vercors/wiki/Predicates">"Predicates"</a>),
which are a similar concept.</p>
<h4 id="ghost-parameters-and-results">Ghost Parameters and Results</h4>
<p>You can extend the header of an existing method, by adding additional
parameters and return values to a method. This is done by using the
<code>given</code> and <code>yields</code> keywords in the method
contract, respectively. To assign and retrieve the values when calling
the method, use <code>given</code> and <code>yields</code>
symmetrically:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
given int x;
given int y;
yields int modified_x;
requires x &gt; 0;
ensures modified_x &gt; 0;
@*/
int some_method(boolean real_arg) {
  int res = 0;
  /* ... */
  //@ ghost modified_x = x + 1;
  /* ... */
  return res;
}

void other_method() {
  //@ ghost int some_ghost;
  int some_result = some_method(true) /*@ given {y=3, x=2} @*/ /*@ yields {some_ghost=modified_x} @*/;
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-ghost-code-ghost-parameters-and-results-1
//:: verdict Pass
//:: tools silicon
final class Test {
    /*@
    given int x;
    given int y;
    yields int modified_x;
    requires x &gt; 0;
    ensures modified_x &gt; 0;
    @*/
    int some_method(boolean real_arg) {
      int res = 0;
      /* ... */
      //@ ghost modified_x = x + 1;
      /* ... */
      return res;
    }
    
    void other_method() {
      //@ ghost int some_ghost;
      int some_result = some_method(true) /*@ given {y=3, x=2} @*/ /*@ yields {some_ghost=modified_x} @*/;
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>There are several points of interest in this example: Note that the
pre- and post-condition of <code>some_method</code> can reference the
ghost parameter and result just like normal parameters. If the ghost
parameters and results are not just primitive integers, but heap
objects, then permissions are needed to access them, just like with
normal parameters and results (see <a
href="https://github.com/utwente-fmt/vercors/wiki/Permissions">following
chapter</a>). There is no explicit <code>return</code> statement for the
ghost result; instead, the ghost result is whatever value the variable
has when the method returns. Therefore, make sure when your method
returns that you always have a defined value assigned to your ghost
result variable! In <code>other_method</code>, the <code>given</code>
keyword is followed by a list of bindings to the ghost parameters. The
parameters are named, so the assignment can be in any order, and need
not adhere to the order in which the ghost parameters are defined. Make
sure to assign a value to each ghost parameter! Otherwise, the method
will be missing a parameter, just as if you called a method
<code>void foo(int x)</code> as <code>foo();</code>. Similarly, the
<code>yields</code> keyword is followed by a block of bindings that
retrieve the yielded values. The yielded values may only be immediately
assigned to a local variable. The respective local variable,
<code>some_ghost</code>, must be a ghost variable, otherwise you would
affect the "real" program state from inside an annotation. Note that it
is not required to have an output for every yielded value. Both the
<code>given</code> and the <code>yields</code> are placed in a
specification comment between the method call and the respective
semicolon.</p>
<h3 id="expressions">Expressions</h3>
<p>As mentioned above, expressions in specifications are an extension of
the expressions available in the target language. So if you analyse a
Java program, you can use expressions like <code>a&amp;&amp;b</code> or
<code>x==y+1</code> in the specifications just like in Java. However,
specifications must be free of side-effects (on the program state) and
for example calls to non-pure methods are not allowed.</p>
<p>VerCors extends the expressions of the target language by a few more
features that you can use in specifications. One of them is the
implication operator <code>==&gt;</code>, which works like you would
expect from a logical implication. A common usage is
<code>requires x!=null ==&gt; &lt;some statement about fields of x&gt;</code>.
Note that the implication binds less than equality or conjunction, so
<code>a==&gt;b&amp;&amp;c</code> is equivalent to
<code>a==&gt;(b&amp;&amp;c)</code>. You need to explicitly use
parentheses if the operators shall associate differently.</p>
<p>A related new operator is the null-coalescing operator
<code>?.</code>. It can be used as <code>expr?.fun(args)</code>, which
is a shorthand for <code>expr!=null ==&gt; expr.fun(args)</code>. One
use-case, where this comes in handy, is when using predicates in the
place of the function <code>fun</code> (see chapter <a
href="https://github.com/utwente-fmt/vercors/wiki/Predicates">"Predicates"</a>).</p>
<p>Two other new operators are <code>**</code> and <code>-*</code> from
separation logic. <code>**</code> is the separating conjunct, while
<code>-*</code> is the separating implication (or "magic wand"). For
more on this, see the chapters on <a
href="https://github.com/utwente-fmt/vercors/wiki/Permissions">Permissions</a>
and <a
href="https://github.com/utwente-fmt/vercors/wiki/Magic-Wands">Magic
Wands</a>.</p>
<p>The target language is also extended to include new data types. A
simple case is the boolean type <code>bool</code>, which can be useful
in specifications if the target language has no boolean type (e.g. old
C). If the target language does support boolean (e.g. Java), this is not
needed (but can be used nonetheless). More interestingly, the new types
include generic axiomatic data types such as <code>set&lt;T&gt;</code>
and <code>option&lt;T&gt;</code> (with <code>T</code> being a type). For
more information on them and their supported operations (such as getting
the size, and indexing elements), see the <a
href="https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types">respective
chapter</a>.</p>
<p>An important new type are fractions, <code>frac</code>. VerCors uses
concurrent separation logic (CSL) to manage the ownership and
permissions to access heap locations. A permission is a value from the
interval (0,1], and the type <code>frac</code> represents such a value.
To give a value to a variable of type <code>frac</code>, the new
operator of <em>fractional division</em> can be used: While
<code>2/3</code> indicates the classical integer division, which in this
example gives <code>0</code>, using the backslash instead gives a
fraction: <code>2\3</code>. For more on this topic, including some
additional keywords for short-hand notations, see the chapter <a
href="https://github.com/utwente-fmt/vercors/wiki/Permissions">"Permissions"</a>.</p>
<p>Sometimes, you might create complicated expressions and want to use
helper variables to simplify them. However, certain constructs only
allow for expressions, and not for statements such as variable
declarations. To alleviate that, there is the <code>\let</code>
construct, which defines a variable just for a single expression:
<code>( \let type name = expr1 ; expr2 )</code>, where <code>type</code>
is the type of the helper variable, <code>name</code> its name,
<code>expr1</code> defines its value, and <code>expr2</code> the
complicated expression that you can now simplify by using the helper
variable. Example:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">//@ assert (\let int abs_x = (x&lt;0 ? -x : x); y==(z==null ? abs_x : 5*abs_x));</span></span></code></pre></div>
<h4 id="quantifiers">Quantifiers</h4>
<p>Note that most target languages, such as Java and C, support array
types, such as <code>int[]</code>. Sometimes, you might want to reason
about all elements of the array. To do that, VerCors supports using
<em>quantifiers</em> in the specifications:
<code>(\forall varDecl, varDecl...; cond; expr)</code>. The syntax is
similar to the header of a for loop: <code>varDecl</code> declares a
variable (e.g. <code>int i</code>); <code>cond</code> is a boolean
expression describing a boundary condition, restricting the declared
variable to the applicable cases (e.g. defining the range of the integer
<code>0&lt;=i &amp;&amp; i&lt;arr.length</code>); and <code>expr</code>
is the boolean expression you are interested in, such as a statement you
want to assert. Note that the parentheses are mandatory. Here is an
example to specify that all elements in the given array are
positive:</p>
<!-- standaloneSnip Quantifiers1
//:: cases Quantifiers1
//:: tools silicon
//:: verdict Pass

class Test {
//@ requires arr != null;
//@ requires Perm(arr[*], 1\2);
-->

<!-- codeSnip Quantifiers1 -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ requires arr != null;
//@ requires (\forall int i ; 0&lt;=i &amp;&amp; i&lt;arr.length ; arr[i]&gt;0);
void foo(int[] arr) { /* ... */ }<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases Quantifiers1
//:: tools silicon
//:: verdict Pass

class Test {
//@ requires arr != null;
//@ requires Perm(arr[*], 1\2);
//@ requires arr != null;
//@ requires (\forall int i ; 0&lt;=i &amp;&amp; i&lt;arr.length ; arr[i]&gt;0);
void foo(int[] arr) { /* ... */ }}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<!-- standaloneSnip Quantifiers1
}
-->

<p>Note that in practice, you would also have to specify permissions to
access the values in the array. More on that in the <a
href="https://github.com/utwente-fmt/vercors/wiki/Permissions">next
chapter</a>.</p>
<p><strong>Tip</strong> If you want to quantify over more than one
variable (e.g. saying <code>arr1[i] != arr2[j]</code> for all
<code>i</code> and <code>j</code>), do <em>not</em> use nesting, this
commonly hurts proof performance. Instead, use a list of bindings:
<code>(\forall int i, int j; 0&lt;=i &amp;&amp; i&lt;arr1.length &amp;&amp; 0&lt;=j &amp;&amp; j&lt;arr2.length; arr1[i]!=arr2[j])</code>.</p>
<p>If your boundary condition is an interval (like in the examples
above), you can use the shorter notation
<code>(\forall type name = e1 .. e2 ; expr)</code>, where
<code>type</code> must be an integral type (e.g. <code>int</code>),
<code>name</code> is the name of the quantified variable,
<code>e1</code> and <code>e2</code> are expressions defining the
interval bounds (lower bound inclusive, upper bound exclusive) and
<code>expr</code> is the expression you are interested in:
<code>(\forall int i = 0 .. arr.length ; arr[i]&gt;0)</code>. Note that,
depending on the circumstances, spaces are necessary around the
<code>..</code>.</p>
<p>You may freely mix normal bindings and range bindings, and omit the
condition as you like. For example, all these quantifiers are
equivalent:</p>
<ul>
<li><code>(\forall int i, int j; 0 &lt;= i &amp;&amp; i &lt; n &amp;&amp; i &lt; j &amp;&amp; j &lt; n ==&gt; xs[i] &lt; xs[j])</code></li>
<li><code>(\forall int i=0..n, int j; i &lt; j &amp;&amp; j &lt; n; xs[i] &lt; xs[j])</code></li>
<li><code>(\forall int i=0..n, int j=i+1..n; xs[i] &lt; xs[j])</code></li>
</ul>
<p>There also is an <code>\exists</code> quantifier analogous to the
<code>forall</code> quantifier:
<code>(\exists varDecl, ...; cond; expr)</code>. For instance, we could
use a similar example as above, but requiring that <em>at least one</em>
array element is positive:</p>
<!-- standaloneSnip Quantifiers2
//:: cases Quantifiers2
//:: tools silicon
//:: verdict Pass

class Test {
//@ requires arr != null;
//@ requires Perm(arr[*], 1\2);
-->

<!-- codeSnip Quantifiers2 -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ requires arr != null;
//@ requires (\exists int i ; 0&lt;=i &amp;&amp; i&lt;arr.length ; arr[i]&gt;0);
void foo(int[] arr) { /* ... */ }<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases Quantifiers2
//:: tools silicon
//:: verdict Pass

class Test {
//@ requires arr != null;
//@ requires Perm(arr[*], 1\2);
//@ requires arr != null;
//@ requires (\exists int i ; 0&lt;=i &amp;&amp; i&lt;arr.length ; arr[i]&gt;0);
void foo(int[] arr) { /* ... */ }}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<!-- standaloneSnip Quantifiers2
}
-->

<p>Again, note that in practice, you would also have to specify
permissions to access the values in the array.</p>
<p><strong>Note</strong> <code>\forall</code> quantifiers are easier to
reason about than <code>\exists</code>, because they can be applied
indiscriminately whenever an element is encountered, while
<code>\exists</code> needs to find the element to which it can be
applied. Therefore, <code>\exists</code> quantifiers are more likely to
cause problems with VerCors (e.g. non-termination of the analysis), and
they should be <strong>used with care</strong>!</p>
<p><em>Note: Further sections explain advanced concepts: new users may
want to skip those.</em></p>
<h5 id="alternative-quantifier-syntax">Alternative quantifier
syntax</h5>
<p>In case brevity is needed for readability, you can use the
appropriate unicode symbols instead of <code>\forall</code> and
<code>\exists</code>:</p>
<ul>
<li><code>(âvarDecl+; (cond ;)? expr)</code></li>
<li><code>(âvarDecl+; (cond ;)? expr)</code></li>
</ul>
<p>For <code>\forall*</code> the following alternative notations are
available:</p>
<ul>
<li><code>(â*varDecl+; (cond ;)? expr)</code></li>
<li><code>(â»varDecl+; (cond;)? expr)</code></li>
</ul>
<p>The IntelliJ plugin <a
href="https://plugins.jetbrains.com/plugin/14267-spec--math-symbols">Spec
&amp; Math Symbols</a> may be useful to type these symbols.</p>
<h5 id="triggers">Triggers</h5>
<p>A quantifier
<code>(\forall int i = 0 .. arr.length ; arr[i]&gt;0)</code> is a rather
generic piece of knowledge; to apply it to a concrete case, for example
when encountering <code>arr[1]</code>, the quantifier must be
<em>instantiated</em>. This basically replaces the quantified
variable(s), in this case <code>i</code>, with concrete values. But this
is only done when necessary, so when the concrete case
<code>arr[1]</code> is actually encountered. Recognising that the
quantifier must be instantiated was fairly easy in this case, but for
more complex expression it can become rather difficult. In those cases,
VerCors might use heuristics, and even randomisation. This can lead to
VerCors verifying a program successfully, and when you call it again
with the exact same program, the analysis takes forever. So if you
experience such behaviour, quantified expressions are a likely
cause.</p>
<p>To avoid that, you can explicitly tell VerCors what kind of
expression should cause instantiating the quantifier, disabling the
internal heuristics. This is called a <em>trigger</em> (or
<em>pattern</em>, e.g. by Z3); for more information see the <a
href="http://viper.ethz.ch/tutorial/?page=1&amp;section=#quantifiers">Viper
tutorial on triggers</a>. In VerCors, to mark a part of an expression as
a trigger, it is enclosed in <code>{:</code> and <code>:}</code>:</p>
<!-- standaloneSnip Triggers1
//:: cases Triggers1
//:: tools silicon
//:: verdict Pass

class Test {
//@ requires arr != null;
//@ requires Perm(arr[*], 1\2);
-->

<!-- codeSnip Triggers1 -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ requires arr!=null &amp;&amp; arr.length&gt;3;
//@ requires (\forall int i ; 0&lt;=i &amp;&amp; i&lt;arr.length ; {: arr[i] :} &gt; 0);
void foo(int[] arr) {
  assert arr[3]&gt;0;   // the trigger recognises &#34;arr[3]&#34; and instantiates the quantifier, setting i to 3
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases Triggers1
//:: tools silicon
//:: verdict Pass

class Test {
//@ requires arr != null;
//@ requires Perm(arr[*], 1\2);
//@ requires arr!=null &amp;&amp; arr.length&gt;3;
//@ requires (\forall int i ; 0&lt;=i &amp;&amp; i&lt;arr.length ; {: arr[i] :} &gt; 0);
void foo(int[] arr) {
  assert arr[3]&gt;0;   // the trigger recognises &#34;arr[3]&#34; and instantiates the quantifier, setting i to 3
}}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<!-- standaloneSnip Triggers1
}
-->

<p>(Again, <a
href="https://github.com/utwente-fmt/vercors/wiki/Permissions">Permissions</a>
were omitted.)</p>
<p>Note that the trigger must involve all quantified variables. So if
you have a quantifier with multiple bindings
<code>(\forall int i, int j; ... ; expr)</code>, a trigger in
<code>expr</code> must be about both <code>i</code> and <code>j</code>.
Also note that you cannot use arithmetic expressions or relations as
triggers. Most other operators e.g. about sequences and sets may appear
in triggers. For instance in the example above,
<code>{: arr[i]&gt;0 :}</code> would <strong>not</strong> be a valid
trigger.</p>
<p><strong>Warning</strong> A wrong choice of triggers can lead to
failed verifications of true statements:</p>
<!-- testMethod Fail -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@ pure @*/ int f(int a, int b);
    
//@ requires x&gt;0;
//@ requires (\forall int k ; 0&lt;=k &amp;&amp; k&lt;=x ; {: f(k, y) :} == 0);
//@ requires (\forall int k ; 0&lt;=k &amp;&amp; k&lt;=x ; {: f(k, y) :} == 0 ==&gt; f(k, z) == 0);
void bar(int x, int y, int z) {
    //@ assert f(x, y) == 0;     // this assertion verifies, because &#34;f(x,y)&#34; triggers the first quantifier
    //@ assert f(x/2, z) == 0;   // this assertion fails, even though the quantifiers includes this knowledge
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases specification-syntax-auxiliary-annotations-expressions-quantifiers-triggers-1
//:: verdict Fail
//:: tools silicon
final class Test {
    /*@ pure @*/ int f(int a, int b);
        
    //@ requires x&gt;0;
    //@ requires (\forall int k ; 0&lt;=k &amp;&amp; k&lt;=x ; {: f(k, y) :} == 0);
    //@ requires (\forall int k ; 0&lt;=k &amp;&amp; k&lt;=x ; {: f(k, y) :} == 0 ==&gt; f(k, z) == 0);
    void bar(int x, int y, int z) {
        //@ assert f(x, y) == 0;     // this assertion verifies, because &#34;f(x,y)&#34; triggers the first quantifier
        //@ assert f(x/2, z) == 0;   // this assertion fails, even though the quantifiers includes this knowledge
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>In this example, the first quantifier asserts that
<code>f(x/2, y) == 0</code>. From that, the second quantifier could
derive <code>f(x/2, z) == 0</code>, so the second assertion should hold.
However, the second quantifier has no trigger for <code>f(k,z)</code>,
so the quantifier does not get instantiated and the knowledge remains
hidden. Removing the trigger around <code>f(k,y)</code> in the second
quantifier leads to a successful verification, because without explicit
triggers, VerCors' heuristics finds the correct trigger
<code>f(k,z)</code> automatically.</p>
<h6 id="advanced-trigger-syntax">Advanced trigger syntax</h6>
<p>It is possible to specify multiple triggers for a single quantifier.
In this case, the solver requires all triggers to be present before
instantiating the quantifier. This also relaxes the requirement that all
bindings must occur in a trigger: instead they must collectively occur
in the set of all triggers. For example, a quantifier might state a
pairwise equality:</p>
<pre><code>(forall int i, int j; 0 &lt;= i &amp;&amp; i &lt; |xs| &amp;&amp; 0 &lt;= j &amp;&amp; j &lt; |ys|; {:xs[i]:} + {:ys[j]:} == i + j)</code></pre>
<p>This quantifier is only instantiated when both a term of the shape
<code>xs[?]</code> and a term of the shape <code>ys[?]</code> is
encountered by the solver. <code>{xs[i], ys[i]}</code> is also referred
to as a trigger set.</p>
<p>In some cases it is useful to specify multiple trigger sets. In that
case, <em>all</em> terms must be matched of <em>any</em> of the trigger
sets. By default, a trigger is part of trigger set <code>0</code>. For
example:</p>
<pre><code>(â`seq`&lt;T&gt; xs, int i, T t;
    0 &lt;= i &amp;&amp; i &lt; seq_length(xs) ==&gt; {:1:seq_length({:2:seq_update(xs, i, t):}):} == {:2:seq_length(xs):})</code></pre>
<p>This quantifier is instantiated when a term of the shape
<code>seq_length(seq_update(xs, i, t))</code> is encountered,
<em>or</em> both a term of the shape <code>seq_update(xs, i, t)</code>
<em>and</em> <code>seq_length(xs)</code>. In such a case, it is required
that the <code>xs</code> appearing in both patterns are equal before the
quantifier is instantiated.</p>
<p>Finally, nested quantifiers are essentially instantiated separately:
in principle the inner quantifier is never instantiated, unless the
outer quantifier is instantiated. When specifying a trigger that is not
meant for the innermost quantifier, you can use some number of
<code>&lt;</code> symbols to indicate the trigger belongs to the
quantifier that many levels up. For example:</p>
<pre><code>(âint i; (âint j; {:&lt;:xs[i]:} == {:xs[j]:}))</code></pre>
<h6 id="other-trigger-sources">Other trigger sources</h6>
<p>We recommend the following sources for more examples and explanations
of how triggers work.</p>
<ul>
<li>The paper "Trigger Selection Strategies to Stabilize Program
Verifiers" gives an accesible and thorough introduction of triggers.
They also describes problems of triggers, and automated solutions. These
automated solutions can also be applied manually to PVL programs.
<ul>
<li><a
href="https://pit-claudel.fr/clement/papers/dafny-trigger-selection-CAV16.pdf">pdf</a>,
<a href="http://doi.org/10.1007/978-3-319-41528-4_20">doi</a></li>
</ul></li>
<li><a
href="https://github.com/dafny-lang/dafny/wiki/FAQ#how-does-dafny-handle-quantifiers-ive-heard-about-triggers-what-are-those">Dafny
FAQ: How does Dafny handle quantifiers? I've heard about "triggers",
what are those?</a></li>
<li><a
href="http://viper.ethz.ch/tutorial/?page=1&amp;section=#quantifiers">Viper
tutorial on triggers</a></li>
<li><a
href="https://stackoverflow.com/questions/50668693/what-are-triggers-in-dafny-boogie">Stack
Overflow: quantifiers - What are triggers in Dafny/Boogie?</a></li>
<li><a href="http://purl.utwente.nl/essays/80892">Extending Support for
Axiomatic Datatypes in VerCors, Section 2.3</a>. Masters thesis by Ãmer
Åakar. Includes a visual explanation of the workings of triggers using
Axiom Profiler, a quantifier instantiation debugging tool.</li>
</ul>
<h1 id="permissions">Permissions</h1>
<p><em>This feature is supported for all languages.</em></p>
<p>This section discusses the basics of handling ownership using a
simple toy example. Ownership is used to express whether a thread (or
synchronization object) has access to a specific element on the heap.
This access can be shared among multiple threads (or synchronization
objects), which allows the threads to read the value of this element, or
it can be unique to one, in which case the value can written to or read
from. Permission annotations are used to express ownership. We start by
considering the following simple example program, written in Java:</p>
<!-- test Fail -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Counter {
  public int val;

  void incr(int n) {
    this.val = this.val + n;
  }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases permissions-1
//:: verdict Fail
//:: tools silicon
class Counter {
  public int val;

  void incr(int n) {
    this.val = this.val + n;
  }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>If you wish, you can store this file as, say,
<code>counter.java</code>, and try to run VerCors on this file by
running <code>vct --silicon counter.java</code> in a console (assuming
you have VerCors installed). This program currently does not contain any
annotations, but we will eventually annotate the program to verify the
following simple property: after calling the <code>incr</code> function,
the value of <code>val</code> has been increased by an amount
<code>n</code>. This can be expressed as a postcondition for the
<code>incr</code> method:
<code>ensures this.val == \old(this.val) + n</code>. The
<code>\old(_)</code> expression is used to evaluate an expression in an
earlier state. By default this is in the state as it was just after the
precondition. This is explained further <a href="#old-heap-state">later
on</a>.</p>
<p>However, if you run VerCors on this example, as it is now, you will
see that VerCors fails to verify the correctness of the program and
reports an 'AssignmentFailed: InsufficientPermission' error, since the
caller of the method has insufficient permission to access
<code>this.val</code>. First observe that <code>this.val</code> is
shared-memory; there may be other threads that also access the
<code>val</code> field, since the field is public. In order to prevent
other threads from accessing <code>this.val</code> while the calling
thread is executing <code>incr</code>, we need to specify that threads
may only call <code>c.incr</code> (on any object <code>c</code> that is
an instance of <code>Counter</code>) when they have <em>write
permission</em> for <code>c.val</code>:</p>
<!-- test -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Counter {
  public int val;

  /*@
    requires Perm(this.val, 1);
    ensures Perm(this.val, 1);
    ensures this.val == \old(this.val) + n;
  */
  void incr(int n) {
    this.val = this.val + n;
  }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases permissions-2
//:: verdict Pass
//:: tools silicon
class Counter {
  public int val;

  /*@
    requires Perm(this.val, 1);
    ensures Perm(this.val, 1);
    ensures this.val == \old(this.val) + n;
  */
  void incr(int n) {
    this.val = this.val + n;
  }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>We added three things to the counter program. The first is a
<code>requires</code> clause, which is a precondition expressing that
<code>incr</code> can only be called when the calling thread has
permission to write to <code>val</code>. The second is an
<code>ensures</code> clause, which is a postcondition expressing that,
given that the <code>incr</code> function terminates (which is trivial
in the above example), the function returns write permission for
<code>val</code> to the thread that made the call to <code>incr</code>.
The third is a postcondition that states that after <code>incr</code>
has terminated, the value of <code>this.val</code> has indeed been
increased by <code>n</code>. If you run this annotated program with
VerCors, you will see that it now passes. The remainder of this section
mostly focuses on how to use the <code>Perm</code> ownership
predicates.</p>
<p>Observe that the clause <code>Perm(this.val, 1)</code> expresses
write permission for <code>this.val</code>. Recall that VerCors has a
very explicit notion of ownership, and that ownership is expressed via
fractional permissions. The second argument to the <code>Perm</code>
predicate is a <em>fractional permission</em>; a rational number
<code>q</code> in the range <code>0 &lt; q &lt;= 1</code>. The ownership
system in VerCors enforces that all permissions for a shared memory
location together cannot exceed <code>1</code>. This implies that, if
some thread has permission <code>1</code> for a shared-memory location
at some point, then no other thread can have any permission predicate
for that location at that point, for otherwise the total amount of
permissions for that location exceeds <code>1</code> (since fractional
permissions are strictly larger than <code>0</code>). For this reason,
we refer to permission predicates of the form <code>Perm(o.f, 1)</code>
as <em>write permissions</em>, and <code>Perm(o.f, q)</code> with
<code>q &lt; 1</code> as <em>read permissions</em>. Threads are only
allowed to read from shared memory if they have read permission for that
shared memory, and may only write to shared memory if they have write
permission. In the above example, the function <code>incr</code> both
reads and writes <code>this.val</code>, which is fine: having write
permission for a field implies having read permission for that
field.</p>
<p>Let us now go a bit deeper into the ownership system of VerCors. If
one has a permission predicate <code>Perm(o.f, q)</code>, then this
predicate can be <em>split</em> into
<code>Perm(o.f, q\2) ** Perm(o.f, q\2)</code>. Moreover, a formula of
the form <code>Perm(o.f, q1) ** Perm(o.f, q2)</code> can be
<em>merged</em> back into <code>Perm(o.f, q1 + q2)</code>. For example,
if we change the program annotations as shown below, the program still
verifies successfully:</p>
<!-- standaloneSnip mergedPerm 
//:: case MergedPermission
//:: tools silicon
//:: verdict Pass
class Counter {
public int val;
-->

<!-- codeSnip mergedPerm -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
  requires Perm(this.val, 1\2) ** Perm(this.val, 1\2);
  ensures Perm(this.val, 1\2) ** Perm(this.val, 1\2);
  ensures this.val == \old(this.val) + n;
*/
void incr(int n) {
  this.val = this.val + n;
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: case MergedPermission
//:: tools silicon
//:: verdict Pass
class Counter {
public int val;
/*@
  requires Perm(this.val, 1\2) ** Perm(this.val, 1\2);
  ensures Perm(this.val, 1\2) ** Perm(this.val, 1\2);
  ensures this.val == \old(this.val) + n;
*/
void incr(int n) {
  this.val = this.val + n;
}}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<!-- standaloneSnip mergedPerm
}
-->

<p>For splitting and merging we use the <code>**</code> operator, which
is known as the separating conjunction, a connective from separation
logic. A formula of the form <code>P ** Q</code> can be read as:
"<code>P</code>, and <em>separately</em> <code>Q</code>", and comes
somewhat close to the standard logical conjunction. In essence,
<code>P ** Q</code> expresses that the subformulas <code>P</code> and
<code>Q</code> both hold, and in addition, that all ownership resources
in <code>P</code> and <code>Q</code> are together <em>disjoint</em>,
meaning that all the permission components together do not exceed
<code>1</code> for any field. Consider the formula
<code>Perm(x.f, 1) ** Perm(y.f, 1)</code>. The permissions for a field
<code>f</code> cannot exceed <code>1</code>, therefore we can deduce
that <code>x != y</code>.</p>
<p>One may also try to verify the following alteration, which obviously
does not pass, since write permission for <code>this.val</code> is
needed, but only read permission is obtained via the precondition.
VerCors will again give an 'InsufficientPermission' failure on this
example.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*@</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">  requires Perm(this.val, 1\2);</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">  ensures Perm(this.val, 1\2);</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">  ensures this.val == \old(this.val) + n;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">incr</span><span class="op">(</span><span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">val</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">val</span> <span class="op">+</span> n<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If you replace both ownership predicates for
<code>Perm(this.val, 3/2)</code>, then the tool will report a
'MethodPreConditionUnsound: MethodPreConditionFalse' error because the
precondition can then never by satisfied by any caller, since no thread
can have permission greater than <code>1</code> for any shared-memory
location. VerCors is a verification tool for <em>partial
correctness</em>; if the precondition of a method cannot be satisfied
because it is absurd, then the program trivially verifies. To illustrate
this, try to change the precondition into <code>requires false</code>
and see what happens when running VerCors. Note that VerCors does try to
help the user identify these cases by showing a
'MethodPreConditionUnsound' if it can derive that the precondition is
unsatisfiable. But one has to be a bit careful about the assumptions
made on the program as preconditions.</p>
<h2 id="self-framing">Self-framing</h2>
<p>Consider the following variant on our program. Would this verify?</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*@</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">  requires Perm(this.val, 1);</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">  ensures this.val == \old(this.val) + n;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">incr</span><span class="op">(</span><span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">val</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">val</span> <span class="op">+</span> n<span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This program does not verify and gives an 'InsufficientPermission'
failure when given to VerCors. The reason is that, also in the
specifications one cannot read from shared-memory without the required
permissions. In this program, the <code>ensures</code> clause accesses
<code>this.val</code>, however no ownership for <code>this.val</code> is
ensured by the <code>incr</code> method. Note that, without a notion of
ownership, one cannot establish the postcondition: perhaps some other
thread changed the contents of <code>this.val</code> while evaluating
the postcondition. By having a notion of ownership, no other thread can
change the contents of <code>this.val</code> while we evaluate the
postcondition of the call, since no other threads can have resources to
do so.</p>
<p>Moreover, the order of specifying permissions and functional
properties does matter. For example, the following program also does not
verify, even though it ensures enough permissions to establish the
postcondition:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*@</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">  requires Perm(this.val, 1);</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">  ensures this.val == \old(this.val) + n;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">  ensures Perm(this.val, 1);</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">incr</span><span class="op">(</span><span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">val</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">val</span> <span class="op">+</span> n<span class="op">;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>VerCors enforces that shared-memory accesses are <em>framed</em> by
ownership resources. Before accessing <code>this.val</code> in the first
<code>ensures</code> clause, the permissions for <code>this.val</code>
must already be known! In the program given above, the access to
<code>this.val</code> in the postcondition is <em>not</em> framed by the
ownership predicate: it comes too late.</p>
<h2 id="permission-leaks">Permission leaks</h2>
<p>So what about the following change? Can VerCors successfully verify
the following program?</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*@</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">  requires Perm(this.val, 1);</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">  ensures Perm(this.val, 1\2);</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">  ensures this.val == \old(this.val) + n;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">incr</span><span class="op">(</span><span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">val</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">val</span> <span class="op">+</span> n<span class="op">;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>VerCors is able to verify the example program given above. However,
less permission for <code>this.val</code> is ensured then is required,
meaning that any thread that calls <code>c.incr</code> will need to give
up write permission for <code>c.val</code>, but only receives read
permission back in return, after <code>incr</code> has terminated. So
this example has a <em>permission leak</em>. Recall that threads need
full permission in order to write to shared heap locations, so
essentially, calling <code>c.incr</code> has the effect of losing the
ability to ever write to <code>c.val</code> again. In some cases this
can be problematic, while in other cases this can be helpful, as losing
permissions in such a way causes shared-memory to become read-only,
specification-wise. However, in the scenario given below the permission
leak will prevent successful verification:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*@</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co">  requires Perm(this.val, 1);</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">  ensures Perm(this.val, 1\2);</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">  ensures this.val == \old(this.val) + n;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">incr</span><span class="op">(</span><span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">val</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">val</span> <span class="op">+</span> n<span class="op">;</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">/*@</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">  requires Perm(this.val, 1);</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">incr2</span><span class="op">(</span><span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">incr</span><span class="op">(</span>n<span class="op">);</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">incr</span><span class="op">(</span>n<span class="op">);</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>In the <code>incr2</code> method, the first call <code>incr(n)</code>
will consume write permission for <code>this.val</code>, but only
produce read permission in return. Therefore, the requirements of the
second call <code>incr(n)</code> cannot be satisfied, which causes the
verification to be unsuccessful.</p>
<h2 id="some-extra-notation">Some extra notation</h2>
<p>We end the section by mentioning some notational enhancements for
handling permissions. Instead of writing <code>Perm(o.f, 1)</code>, one
may also write <code>Perm(o.f, write)</code>, which is perhaps a more
readable way to express write permission for <code>o.f</code>.</p>
<p>Similarly, one can write <code>Perm(o.f, read)</code> to express a
non-zero read permission. Note that if this is used in a pre- and
postcondition, it is not guaranteed to be the same amount of
permissions. The underlying amount of permissions is an unspecified
fraction and can therefore not be merged back into a write permission.
This can be observed in the following program where the
<code>assert</code> fails:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Counter <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> val<span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*@</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    requires Perm(this.val, write);</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ensures Perm(this.val, write);</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ensures this.val == \old(this.val) + n;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">incr</span><span class="op">(</span><span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> oldValue <span class="op">=</span> <span class="fu">getValue</span><span class="op">();</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">//@ assert Perm(this.val, write);</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">val</span> <span class="op">=</span> oldValue <span class="op">+</span> n<span class="op">;</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*@</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">    requires Perm(this.val, read);</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co">    ensures Perm(this.val, read);</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co">    ensures \result == this.val;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="fu">getValue</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">val</span><span class="op">;</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>read</code> is mostly useful for specifying immutable data
structures. One can also write <code>Value(o.f)</code> to express read
permission to <code>o.f</code>, where the value of the fractional
permission does not matter. Consequently, <code>Value</code> ownership
predicates can be split indefinitely.</p>
<p>If you instead want to express that you require some non-zero amount
of read permission and that the same amount of permission is returned
you an either add a ghost parameter of type <code>frac</code> which must
be provided at every call site to specify the amount of available read
permission, or you can use <code>AutoValue(o.f)</code>. Similarly to
<code>Value</code>, <code>AutoValue</code> expresses that some amount of
read permission is required. However, unlike <code>Value</code> no
amount of read permission is removed when <code>AutoValue</code> is
exhaled, it merely checks that there exists some amount of read
permission. When the <code>AutoValue</code> in a precondition is inhaled
you gain a symbolic non-zero, non-write amount of read permission which
must be exhaled at the end of the context again. If the same
<code>AutoValue</code> expression does not appear in the postcondition
an automatic leak check is added. Usage looks like this (unlike the
previous example the assert now passes):</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Counter <span class="op">{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> val<span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*@</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">    requires Perm(this.val, write);</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ensures Perm(this.val, write);</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ensures this.val == \old(this.val) + n;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">incr</span><span class="op">(</span><span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> oldValue <span class="op">=</span> <span class="fu">getValue</span><span class="op">();</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">//@ assert Perm(this.val, write);</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">val</span> <span class="op">=</span> oldValue <span class="op">+</span> n<span class="op">;</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*@</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co">    requires AutoValue(this.val);</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co">    ensures AutoValue(this.val);</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co">    ensures \result == this.val;</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="fu">getValue</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">val</span><span class="op">;</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<blockquote>
<p>[!NOTE] Note that <code>AutoValue</code> may only be used in
combination with <code>**</code>, <code>==&gt;</code>,
<code>\let .. in ..</code>, and <code>.. ? .. : ..</code>. For the
implication, let, and ternary expressions the <code>AutoValue</code> may
only appear on the right-hand side and in the postcondition the
left-hand side will automatically be wrapped in <code>\old(_)</code>
because the leak check must always occur at the end of the scope to
prevent unsoundness.</p>
</blockquote>
<p>If you want to express that a thread has no ownership over a certain
heap element, then one can use the keyword <code>none</code>, e.g.
<code>Perm(o.f, none)</code>. This is equivalent to writing
<code>true</code>. It can be useful in situations where the amount of
permission is conditional, e.g.
<code>Perm(o.f, cond ? 1\2 : none)</code>.</p>
<p>If you want to express permissions to multiple locations, one may use
<code>\forall* vars; range; expr</code>. For example,
<code>(\forall* int j; j &gt;= 0 &amp;&amp; j &lt; array.length; Perm(array[j], write)</code>
denotes that the thread has write access to all elements in
<code>array</code>. It is equivalent to writing
<code>Perm(array[0], write) ** Perm(array[1], write) ** â¦ ** Perm(array[array.length-1], write)</code>.
Another way to specify permissions of all array elements is to use
<code>Perm(array[*], write)</code> which is equivalent to the previous
expression.</p>
<p>If you want to reason about the value that the variable refers to as
well then you can use <code>PointsTo(var, p, val)</code> which denotes
that you have permission <code>p</code>for variable <code>var</code>
which has value <code>val</code>. It is similar to saying
<code>Perm(var, p)</code> and <code>var == val</code>.</p>
<h3 id="old-heap-state">Old Heap State</h3>
<p>As mentioned earlier, you can use <code>\old(_)</code> to evaluate an
expression in an older state. By state here we mean strictly the heap,
and not any local variables. By default, the <code>\old</code> predicate
uses the heap just after the precondition as the heap to evaluate the
expression in. You can specify a different heap with
<code>\old[l](_)</code>, where <code>l</code> is either a ghost label
(<code>//@ ghost label l</code>) or a regular label in your input
language.</p>
<p>As an example, consider the following method:</p>
<!-- test -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Obj { int f; }

context Perm(x.f, write) ** Perm(y.f, write);
void test(Obj x, Obj y) {
    Obj z = x;
    
    y.f = 2;
    label a;
    
    z.f = 30;
    label b;
    
    z.f = 400;
    label c;
    
    z = y;
    z.f = 3000;
    label d;
    
    assert
        z.f + // (1)
        \old[a](
            z.f + // (2) 
            \old[b](
                z.f + // (3) 
                \old[c](
                    z.f + // (4)
                    \old[d](
                        z.f // (5)
                    )
                )
            )
        ) == 6006;
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases permissions-some-extra-notation-old-heap-state-1
//:: verdict Pass
//:: tools silicon
class Obj { int f; }

context Perm(x.f, write) ** Perm(y.f, write);
void test(Obj x, Obj y) {
    Obj z = x;
    
    y.f = 2;
    label a;
    
    z.f = 30;
    label b;
    
    z.f = 400;
    label c;
    
    z = y;
    z.f = 3000;
    label d;
    
    assert
        z.f + // (1)
        \old[a](
            z.f + // (2) 
            \old[b](
                z.f + // (3) 
                \old[c](
                    z.f + // (4)
                    \old[d](
                        z.f // (5)
                    )
                )
            )
        ) == 6006;
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Any time that an expression uses the heap to evaluate itself, we look
where the nearest <code>\old</code> expression is. For us, that is:</p>
<ul>
<li>(1) has no <code>\old</code> above it, so it is simply the current
heap.</li>
<li>(2) has <code>\old[a]</code> as its closest parent
<code>\old</code>, so it is evaluated in the heap at label
<code>a</code></li>
<li>(3) is evaluated in the heap at label <code>b</code></li>
<li>(4) is evaluated at label <code>c</code></li>
<li>(5) is evaluated at label <code>d</code>, which is the same heap
that (1) is evaluated with</li>
</ul>
<p>Now, why is the answer <code>6006</code>? This is because the
expression <code>z.f</code> is evaluated with an old heap, but
<em>not</em> with an older value of the variable <code>z</code>. Thus:
it only counts that <code>z</code> aliases the same object as
<code>y</code> when we enter the assertion. The value for
<code>y.f</code> at all our heaps are, repspectively:</p>
<ul>
<li>(1) <code>y.f == 2</code>, since we just assigned it</li>
<li>(2) <code>y.f == 2</code>, since an assignment to <code>x</code> has
no effect on <code>y</code></li>
<li>(3) <code>y.f == 2</code>, idem</li>
<li>(4) <code>y.f == 3000</code>, since we just assigned it</li>
<li>(5) <code>y.f == 3000</code> still, since the heap at (1) is the
same heap as at label <code>d</code></li>
</ul>
<blockquote>
<p>[!NOTE] This is just an illustrative example, and as a matter of
style you should try to keep the expression you evaluate in an
<code>\old</code> as small as possible. Certainly it should not be
necessary to nest them.</p>
</blockquote>
<p>Another important detail is how <code>\old</code> interacts with
<code>\unfolding</code>. (In case you are reading this tutorial in
order, you can come back to this section after reading about
predicates). The intuition is that <code>\unfolding</code> takes the
current heap, and temporarily unfolds a predicate while its body is
evaluated, whereas <code>\old</code> discards the current heap and
replaces it with a different one. The consequence of this is that
nesting them can lead to unexpected effects:</p>
<ul>
<li>An <code>\unfolding</code> nested in an <code>\old</code>: first the
<code>\old</code> has replaced the current heap, after which the
<code>\unfolding</code> unfolds a predicate in the old heap</li>
<li>An <code>\old</code> nested in an <code>\unfolding</code>: first the
<code>\unfolding</code> unfolds a predicate in the current heap, but
this action is thrown away by <code>\old</code>, since it replaces the
entire heap.</li>
</ul>
<p>An example of the second situation is a program like this:</p>
<!-- test -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Problem {  
  int x;
  resource state() = Perm(x, 1);

  requires state();
  //                                                   [-
  ensures state() ** (\unfolding state() \in (x == \old(x) + 1));
  //                                                    -]
  // ERROR: There may be insufficient permission to access this field here
  void inc() {
    unfold state();
    x++;
    fold state();
  }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases permissions-some-extra-notation-old-heap-state-2
//:: verdict Pass
//:: tools silicon
class Problem {  
  int x;
  resource state() = Perm(x, 1);

  requires state();
  //                                                   [-
  ensures state() ** (\unfolding state() \in (x == \old(x) + 1));
  //                                                    -]
  // ERROR: There may be insufficient permission to access this field here
  void inc() {
    unfold state();
    x++;
    fold state();
  }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>It is clear what the intended behaviour is: we simply want to relate
the value of <code>x</code> between the pre- and postcondition, so we
temporarily unfold it and compare the values. This does not work,
because the <code>\old</code> nested under <code>\unfolding</code>
replaces the whole heap with a heap as it was just past the
precondition. In this heap, we can derive from the precondition that it
just contains <code>state()</code>, so we do not have permission to
<code>x</code>.</p>
<p>The solution is to unfold twice: once in the current heap, and once
in the old heap. We first have to enter the old heap before we unfold
its state.</p>
<!-- test -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Solution {  
  int x;
  resource state() = Perm(x, 1);

  requires state();
  ensures state() ** (\unfolding state() \in x) == \old((\unfolding state() \in x)) + 1;
  // Verified
  void inc() {
    unfold state();
    x++;
    fold state();
  }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases permissions-some-extra-notation-old-heap-state-3
//:: verdict Pass
//:: tools silicon
class Solution {  
  int x;
  resource state() = Perm(x, 1);

  requires state();
  ensures state() ** (\unfolding state() \in x) == \old((\unfolding state() \in x)) + 1;
  // Verified
  void inc() {
    unfold state();
    x++;
    fold state();
  }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h1 id="gpgpu-verification">GPGPU Verification</h1>
<p>This section explains how to verify GPGPU programs in VerCors. The
tool supports both OpenCL and CUDA languages. The synchronization
feature (i.e., barrier) in these languages is also supported by VerCors.
To demonstrate GPGPU verification, we show two examples in both OpenCl
and CUDA, one without barrier and the other one with barrier.</p>
<h3 id="openclcuda-without-barrier">OpenCL/CUDA without Barrier</h3>
<p>This simple method shows an OpenCL program that adds two arrays and
stores the result in another array:</p>
<!-- test -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">#include &lt;opencl.h&gt;
/* 1  */ /*@
         context \pointer_index(a, get_global_id(0), read);
         context \pointer_index(b, get_global_id(0), read);
         context \pointer_index(c, get_global_id(0), write);
         ensures c[get_global_id(0)] == a[get_global_id(0)] + b[get_global_id(0)];
         @*/
/* 7  */ __kernel void openCLAdd(int a[], int b[], int c[]) {
/* 8  */    int tid = get_global_id(0);
/* 9  */    c[tid] = a[tid] + b[tid];
/* 10 */ }  <span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases gpgpu-verification-?-openclcuda-without-barrier-1
//:: verdict Pass
//:: tools silicon
#include &lt;opencl.h&gt;
/* 1  */ /*@
         context \pointer_index(a, get_global_id(0), read);
         context \pointer_index(b, get_global_id(0), read);
         context \pointer_index(c, get_global_id(0), write);
         ensures c[get_global_id(0)] == a[get_global_id(0)] + b[get_global_id(0)];
         @*/
/* 7  */ __kernel void openCLAdd(int a[], int b[], int c[]) {
/* 8  */    int tid = get_global_id(0);
/* 9  */    c[tid] = a[tid] + b[tid];
/* 10 */ }  </textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>and this method shows the same example in CUDA:</p>
<!-- test -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">#include &lt;cuda.h&gt;
/* 1  */  /*@
          context \pointer_index(a, threadIdx.x, read);
          context \pointer_index(b, threadIdx.x, read);
          context \pointer_index(c, threadIdx.x, write);
          ensures c[threadIdx.x] == a[threadIdx.x] + b[threadIdx.x];
          @*/
/* 7  */  __global__ void CUDAAdd(int a[], int b[], int c[]) {
/* 8  */     int tid = threadIdx.x;
/* 9  */     c[tid] = a[tid] + b[tid];
/* 10 */  }  <span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases gpgpu-verification-?-openclcuda-without-barrier-2
//:: verdict Pass
//:: tools silicon
#include &lt;cuda.h&gt;
/* 1  */  /*@
          context \pointer_index(a, threadIdx.x, read);
          context \pointer_index(b, threadIdx.x, read);
          context \pointer_index(c, threadIdx.x, write);
          ensures c[threadIdx.x] == a[threadIdx.x] + b[threadIdx.x];
          @*/
/* 7  */  __global__ void CUDAAdd(int a[], int b[], int c[]) {
/* 8  */     int tid = threadIdx.x;
/* 9  */     c[tid] = a[tid] + b[tid];
/* 10 */  }  </textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>In both examples, first we should include the header files (i.g.,
opencl.h and cuda.h). Next we obtain thread identifiers and then each
thread does the computation (lines 8-9 of OpenCL and 8-9 of CUDA
examples). As we can see obtaining the global thread identifiers are
different in OpenCL and CUDA.</p>
<p>In the specification of the methods, we specify read permission for
each thread in arrays "<em>a</em>" and "<em>b</em>" and write permission
in array "<em>c</em>" as pre- and postcondition. The keyword
"\<em>pointer_index</em>" is used with three arguments, array name,
index and permission to indicate which thread has what permission to
which location. Finally in the last postcondition we specify the result
of the methods that each location in array "<em>c</em>" contains the sum
of the values in the corresponding locations in arrays "<em>a</em>" and
"<em>b</em>". Note that in the specification we can use the shorthand
keyword "\<em>gid</em>" instead of "<em>get_global_id(0)</em>" and
"<em>threadIdx.x</em>" in the tool.</p>
<p><em>Note:</em> In CUDA, to compute the global id, normally
<code>threadIdx</code> is combined with <code>blockDim</code>.
Unfortunately, <code>blockDim</code> is not yet supported in VerCors, so
the examples in this chapter only use <code>threadIdx</code>.</p>
<h3 id="openclcuda-with-barrier">OpenCL/CUDA with Barrier</h3>
<p>In GPU programming, when there is only one thread block, there is a
mechanism to sunchronize threads. This example shows an OpenCL program
that uses barrier to synchronize threads:</p>
<!-- No test is added here because I couldn't get the example working with vercors from the dev branch as of 2021-11-03.
     Besides the fact that "array.length" doesn't work (which can be worked around with "\pointer(array, size, 0)"),
     there is also a triggering problem. Some forall in the produced viper code cannot be proven, even though it is there
     as a precondition.
-->

<div class="sourceCode" id="cb16"><pre
class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ot">#include &lt;opencl.h&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">/* 1  */</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">/* 2  */</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">/* 3  */</span> <span class="co">/*@</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">         context_everywhere opencl_gcount == 1;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">         context_everywhere array != null &amp;&amp; array.length == size;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">         requires get_local_id(0) != size-1 ==&gt; \pointer_index(array, get_local_id(0)+1, 1\2);</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">         requires get_local_id(0) == size-1 ==&gt; \pointer_index(array, 0, 1\2);</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">         ensures \pointer_index(array, get_local_id(0), 1);</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">         ensures get_local_id(0) != size-1 ==&gt; array[get_local_id(0)] == \old(array[get_local_id(0)+1]);</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">         ensures get_local_id(0) == size-1 ==&gt; array[get_local_id(0)] == \old(array[0]);</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co">         @*/</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">/* 12 */</span> <span class="kw">__kernel</span> <span class="dt">void</span> openCLLeftRotation<span class="op">(</span><span class="dt">int</span> array<span class="op">[],</span> <span class="dt">int</span> size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">/* 13 */</span>    <span class="dt">int</span> tid <span class="op">=</span> get_local_id<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">/* 14 */</span>    <span class="dt">int</span> temp<span class="op">;</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">/* 15 */</span>    <span class="kw">if</span><span class="op">(</span>tid <span class="op">!=</span> size<span class="dv">-1</span><span class="op">){</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co">/* 16 */</span>     temp <span class="op">=</span> array<span class="op">[</span>tid<span class="op">+</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co">/* 17 */</span>    <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co">/* 18 */</span>     temp <span class="op">=</span> array<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co">/* 19 */</span>    <span class="op">}</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co">/* 20 */</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="co">/* 21 */</span>    <span class="co">/*@</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co">            requires get_local_id(0) != size-1 ==&gt; \pointer_index(array, get_local_id(0)+1, 1\2);</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="co">            requires get_local_id(0) == size-1 ==&gt; \pointer_index(array, 0, 1\2);</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="co">            ensures \pointer_index(array, get_local_id(0), 1);</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="co">            @*/</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="co">/* 26 */</span>    barrier<span class="op">(</span>CLK_LOCAL_MEM_FENCE<span class="op">);</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="co">/* 27 */</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="co">/* 28 */</span>    array<span class="op">[</span>tid<span class="op">]</span> <span class="op">=</span> temp<span class="op">;</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="co">/* 29 */</span> <span class="op">}</span>  </span></code></pre></div>
<p>And this is the CUDA version of the example:</p>
<!-- This example is also not included in testing, for similar reasons as above.
     If the above example works fine, then this one should also be enabled.
-->

<pre class="cuda"><code>#include &lt;cuda.h&gt;
/* 1  */ 
/* 2  */
/* 3  */ /*@
         context_everywhere opencl_gcount == 1;
         context_everywhere array.length == size;
         requires threadIdx.x != size-1 ==&gt; \pointer_index(array, threadIdx.x+1, 1\2);
         requires threadIdx.x == size-1 ==&gt; \pointer_index(array, 0, 1\2);
         ensures \pointer_index(array, threadIdx.x, 1);
         ensures threadIdx.x != size-1 ==&gt; array[threadIdx.x] == \old(array[threadIdx.x+1]);
         ensures threadIdx.x == size-1 ==&gt; array[threadIdx.x] == \old(array[0]);
         @*/
/* 12 */ __global__ void CUDALeftRotation(int array[], int size) {
/* 13 */    int tid = threadIdx.x;
/* 14 */    int temp;
/* 15 */    if(tid != size-1){
/* 16 */     temp = array[tid+1];
/* 17 */    }else{
/* 18 */     temp = array[0];
/* 19 */    }
/* 20 */
/* 21 */    /*@
            requires threadIdx.x != size-1 ==&gt; \pointer_index(array, threadIdx.x+1, 1\2);
            requires threadIdx.x == size-1 ==&gt; \pointer_index(array, 0, 1\2);
            ensures \pointer_index(array, threadIdx.x, 1);
            @*/
/* 26 */    __syncthreads();
/* 27 */
/* 28 */    array[tid] = temp;
/* 29 */ }  </code></pre>
<p>The above examples illustrate GPU programs that rotates the elements
of an array to the left. Each thread ("<em>tid</em>") stores its right
neighbor in a temporary location (i.e., "<em>temp</em>"), except thread
"<em>size</em>-1" which stores the first element in the array (lines
15-19). Then each thread synchronizes in a barrier (line 26). After
that, each thread writes the value read into its own location at index
"<em>tid</em>" in the array (line 28).</p>
<p>We specify that there is only one thread block in the specification
of the programs using the keyword "<em>opencl_gcount</em>" (the first
precondition). The precondition of the barrier follows from the
precondition of the function and the computations before the barrier. If
the precondition of the barrier holds, the postcondition can be assumed
after the barrier. Then, the postcondition of the method can follow from
the postcondition of the barrier. Note that in the specification we can
use the shorthand keyword "\<em>lid</em>" instead of
"<em>get_local_id(0)</em>" and "<em>threadIdx.x</em>" in the tool.</p>
<h1 id="axiomatic-data-types">Axiomatic Data Types</h1>
<p><em>This section discusses axiomatic data types supported by
VerCors.</em></p>
<p>Axiomatic data types are data types that are defined by a set of
uninterpreted functions and axioms that define the behavior of these
functions. This is in contrast to concrete data types which are defined
by their implementation in a programming language such as Java or C++.
Axiomatic datatypes are not to be confused with <em>algebraic</em>
datatypes.</p>
<p>In the sections below, we are going to go over all ADTs supported by
VerCors, give the definition of each, and show examples of common
operations defined on them. A reference table can be found at the end
showing all the operations defined on the ADTs.</p>
<p>The axiomatizations used by VerCors and its back end Viper can be
found <a
href="https://github.com/viperproject/silicon/tree/master/src/main/resources/dafny_axioms">here</a>
(for sequences sets and bags) and <a
href="https://github.com/utwente-fmt/vercors/tree/dev/res/universal/res/adt">here</a>
(for the other ADTs).</p>
<p>Finally, it is also possible to create custom ADTs, though with
limited syntax support. This is discussed at the end of this
section.</p>
<h2 id="sequence">Sequence</h2>
<p>Sequences are an ordered/enumerated collection also commonly referred
to as lists. Sequences are finite and immutable (i.e. once created they
cannot be altered).</p>
<p>There are two ways to construct a sequence: the explicit syntax and
the implicit syntax. The explicit syntax requires the type of the
sequence to be explicitly defined. For example, <code>s1</code> is a
sequence of integers initialized with the values 1, 2 and 3 and
<code>s2</code> is an empty sequence of integers.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">seq&lt;int&gt; s1 = seq&lt;int&gt; { 1, 2, 3 };
seq&lt;int&gt; s2 = seq&lt;int&gt; { };<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        seq&lt;int&gt; s1 = seq&lt;int&gt; { 1, 2, 3 };
        seq&lt;int&gt; s2 = seq&lt;int&gt; { };
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>The implicit syntax is a shorter syntax. If the sequence is
initialized with at least one value (using the implicit syntax), VerCors
infers the type of the sequence. An empty sequence can be constructed by
providing the type of the sequence. For example, <code>s3</code> is
equivalent to <code>s1</code> and <code>s4</code> is equivalent to
<code>s2</code>. Notice how there is no space between <code>[</code> and
<code>t</code>, this is mandated by the VerCors grammar.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">seq&lt;int&gt; s3 = [ 1, 2, 3 ];
seq&lt;int&gt; s4 = [t: int ];<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-2
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        seq&lt;int&gt; s3 = [ 1, 2, 3 ];
        seq&lt;int&gt; s4 = [t: int ];
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<br>

<p>Once we have a sequence, we can query different properties of that
sequence. The syntax <code>s5[i]</code> can be used to retrieve the
element at index <code>i</code> from sequence <code>s5</code>. The
notation <code>s5.head</code> is shorthand for <code>s5[0]</code>. The
length of a sequence <code>s5</code> can be obtained by using the
notation <code>|s5|</code>. Two sequences can be compared using the
<code>==</code> operator where they are equal iff they are of the same
length and the elements at the same indices are equal.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">seq&lt;int&gt; s5 = [ 1, 2, 4, 8, 16 ];
assert s5[3] == 8;
assert |s5| == 5;
assert s5 == seq&lt;int&gt; { 1, 2, 4, 8, 16 };<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-3
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        seq&lt;int&gt; s5 = [ 1, 2, 4, 8, 16 ];
        assert s5[3] == 8;
        assert |s5| == 5;
        assert s5 == seq&lt;int&gt; { 1, 2, 4, 8, 16 };
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<br>

<h3 id="constructing-sequences-from-existing-sequences">Constructing
sequences from existing sequences</h3>
<p>As mentioned above sequences are immutable, however it is possible to
construct a new sequence from an existing sequence.</p>
<p>Elements can be added to a sequence in two ways. The first way is by
concatenating two sequences <code>s6 + s7</code>. This expression
represents a new sequence with the elements of <code>s6</code> followed
by the elements of <code>s7</code>. The second way is to add a single
value to the front of a sequence. The syntax <code>e::s6</code> is used
to prepend <code>e</code> at the front of <code>s6</code>.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">seq&lt;int&gt; s6 = [ 1, 2, 4, 8, 16 ];
assert 0::s6 == [ 0, 1, 2, 4, 8, 16 ];

seq&lt;int&gt; s7 = [ 32, 64, 128 ];
assert s6 + s7 == [ 1, 2, 4, 8, 16, 32, 64, 128 ];<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-constructing-sequences-from-existing-sequences-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        seq&lt;int&gt; s6 = [ 1, 2, 4, 8, 16 ];
        assert 0::s6 == [ 0, 1, 2, 4, 8, 16 ];
        
        seq&lt;int&gt; s7 = [ 32, 64, 128 ];
        assert s6 + s7 == [ 1, 2, 4, 8, 16, 32, 64, 128 ];
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>It is also possible to take a subsequence from an existing sequence.
The syntax <code>s8[i..j]</code> is used to take the elements from
<code>s8</code> from index <code>i</code> to index <code>j</code>
(exclusive). By omitting either the lower bound or upper bound, one can
take or drop from a sequence. The notation <code>s8.tail</code> can be
used as a shorthand for <code>s8[1..]</code>.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">seq&lt;int&gt; s8 = [ 1, 2, 4, 8, 16 ];
assert s8[1..4] == [ 2, 4, 8 ];
assert s8[..2] == [ 1, 2 ];
assert s8.tail == s8[1..]; <span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-constructing-sequences-from-existing-sequences-2
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        seq&lt;int&gt; s8 = [ 1, 2, 4, 8, 16 ];
        assert s8[1..4] == [ 2, 4, 8 ];
        assert s8[..2] == [ 1, 2 ];
        assert s8.tail == s8[1..]; 
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="examples">Examples</h3>
<h4 id="sortedness">Sortedness</h4>
<p>Sortedness is a property that is often used in the verification of
sorting algorithms. The sortedness property for a sequence of integers
could be defined as follows:</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">pure boolean sorted(seq&lt;int&gt; xs) = (\forall int i ; 0 &lt;= i &amp;&amp; i &lt; |xs|-1; xs[i] &lt;= xs[i+1]);<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-examples-sortedness-1
//:: verdict Pass
//:: tools silicon
class Test {
    pure boolean sorted(seq&lt;int&gt; xs) = (\forall int i ; 0 &lt;= i &amp;&amp; i &lt; |xs|-1; xs[i] &lt;= xs[i+1]);
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h4 id="distinct-element">Distinct Element</h4>
<p>Another property on sequences is the uniqueness of the elements. This
property could be expressed for a sequence of integers as follows:</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">pure boolean distinct(seq&lt;int&gt; s) =
    (\forall int i; 0 &lt;= i &amp;&amp; i &lt; s.length; 
        (\forall int j; 0 &lt;= j &amp;&amp; j &lt; s.length &amp;&amp; s[i] == s[j]; i == j)
    );<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-examples-distinct-element-1
//:: verdict Pass
//:: tools silicon
class Test {
    pure boolean distinct(seq&lt;int&gt; s) =
        (\forall int i; 0 &lt;= i &amp;&amp; i &lt; s.length; 
            (\forall int j; 0 &lt;= j &amp;&amp; j &lt; s.length &amp;&amp; s[i] == s[j]; i == j)
        );
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h4 id="maximum-element">Maximum element</h4>
<p>Recursive functions are often used to transform or reduce a sequence.
The example below goes over a sequence to get its maximum value. This
function could be defined for a sequence of integers as follows:</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">requires |xs| &gt; 0;
ensures (\forall int i; 0 &lt;= i &amp;&amp; i &lt; |xs|; xs[i] &lt;= \result);
pure int max(seq&lt;int&gt; xs) =
    1 == |xs| ?
        xs[0]:
        (xs[0] &gt; max(xs[1..]) ?
            xs[0]:
            max(xs[1..]
        )
);<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-sequence-examples-maximum-element-1
//:: verdict Pass
//:: tools silicon
class Test {
    requires |xs| &gt; 0;
    ensures (\forall int i; 0 &lt;= i &amp;&amp; i &lt; |xs|; xs[i] &lt;= \result);
    pure int max(seq&lt;int&gt; xs) =
        1 == |xs| ?
            xs[0]:
            (xs[0] &gt; max(xs[1..]) ?
                xs[0]:
                max(xs[1..]
            )
    );
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h2 id="set">Set</h2>
<p>Sets are an unordered collection with unique values. Sets are finite
and immutable (i.e. once created they cannot be altered).</p>
<p>Similar to sequences, there are two ways to construct a set: the
explicit syntax and the implicit syntax. The explicit syntax requires
the type of the set explicitly defined. For example, <code>s1</code> is
a set of integers initialized with the values 1, 2 and 3 and
<code>s2</code> is an empty set of integers.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">set&lt;int&gt; s1 = set&lt;int&gt; { 1, 2, 3, 2 };
set&lt;int&gt; s2 = set&lt;int&gt; { };<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-set-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        set&lt;int&gt; s1 = set&lt;int&gt; { 1, 2, 3, 2 };
        set&lt;int&gt; s2 = set&lt;int&gt; { };
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>The implicit syntax is a shorter syntax. If the set is initialized
with at least one value (using the implicit syntax), VerCors infers the
type of the set. An empty set can be constructed by providing the type
of the set. For example, <code>s3</code> is equivalent to
<code>s1</code> and <code>s4</code> is equivalent to <code>s2</code>.
Notice how there is no space between <code>{</code> and <code>t</code>,
this is mandated by the VerCors grammar.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">set&lt;int&gt; s3 = { 1, 2, 2, 3 };
set&lt;int&gt; s4 = {t: int };<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-set-2
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        set&lt;int&gt; s3 = { 1, 2, 2, 3 };
        set&lt;int&gt; s4 = {t: int };
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Once we have a set, we can query different properties of that set.
The length of a set <code>s5</code> can be obtained by using the
notation <code>|s5|</code>. Two set <code>s6</code> and <code>s7</code>
can be compared using the <code>==</code> operator where they are equal
iff all elements of <code>s6</code> are in <code>s7</code> and all
elements of <code>s7</code> are in <code>s6</code>. The syntax
<code>e1 \in s8</code> is used to check if set <code>s8</code> contains
the element <code>e1</code>. The <code>&lt;</code> and
<code>&lt;=</code> operators denote the strict subset and subset
operators respectively.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">set&lt;int&gt; s5 = { 1, 2, 2, 3 };
set&lt;int&gt; s6 = { 3, 4, 5, 6 };
set&lt;int&gt; s7 = { 1, 2 };
set&lt;int&gt; s8 = { 2, 3 };
int e1 = 3;

assert |s5| == 3;
assert s6 != s7;
assert e1 \in s8;
assert s8 &lt; s5;<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-set-3
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        set&lt;int&gt; s5 = { 1, 2, 2, 3 };
        set&lt;int&gt; s6 = { 3, 4, 5, 6 };
        set&lt;int&gt; s7 = { 1, 2 };
        set&lt;int&gt; s8 = { 2, 3 };
        int e1 = 3;
        
        assert |s5| == 3;
        assert s6 != s7;
        assert e1 \in s8;
        assert s8 &lt; s5;
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="constructing-sets-from-existing-sets">Constructing sets from
existing sets</h3>
<p>As mentioned above sets are immutable, however it is possible to
construct a new set from an existing set.</p>
<p>There are several operations defined on sets that are part of set
theory. The union of two sets is denoted by <code>s5 + s6</code>, the
difference between two sets is denoted by <code>s5 - s6</code> and the
intersection of two sets is denoted by <code>s5 * s6</code>.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">set&lt;int&gt; s5 = { 1, 2, 2, 3 };
set&lt;int&gt; s6 = { 3, 4, 5, 6 };

assert s5 + s6 == { 1, 2, 3, 4, 5, 6 };
assert s5 - s6 == { 1, 2 };
assert s6 - s5 == { 4, 5, 6};
assert s5 * s6 == { 3 };<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-set-constructing-sets-from-existing-sets-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        set&lt;int&gt; s5 = { 1, 2, 2, 3 };
        set&lt;int&gt; s6 = { 3, 4, 5, 6 };
        
        assert s5 + s6 == { 1, 2, 3, 4, 5, 6 };
        assert s5 - s6 == { 1, 2 };
        assert s6 - s5 == { 4, 5, 6};
        assert s5 * s6 == { 3 };
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="set-comprehension">Set comprehension</h3>
<p><em>Please note that set comprehensions are <a
href="https://github.com/utwente-fmt/vercors/discussions/1068">currently
not supported</a>.</em></p>
<p>An advanced way to create a set is using <em>set comprehension</em>.
The syntax is <code>set&lt;T&gt; { main | variables; selector }</code>
and consists of three parts: the <code>main</code>, the
<code>variables</code> and the <code>selector</code>.</p>
<p>The <code>variables</code> are the variables that are quantified over
and these variables can be bound or unbound. From the quantified
variables, we can select specific values by using the
<code>selector</code> expression. This is a Boolean expression that
selects (a part of) the quantified variables. With the selected set of
variables to quantify over, we express the value that is going to be
part of the resulting set using the <code>main</code> expression.</p>
<p>For example, we can construct the set of all even integers from 0 to
9 as follows:</p>
<pre><code>set&lt;int&gt; {x | int x &lt;- {0, 1, 2, 3, 4, 5, 6, 7, 8, 9}; x % 2 == 0};</code></pre>
<p>To use more complex <code>main</code> expressions (i.e. non-identity
functions), it is recommended to wrap the expression in a function and
use that function in the <code>main</code> expression. For example,
suppose we have a set of integers from 0 to 5 (inclusive) and we want to
construct the set of integers where each element is doubled, we could
use set comprehension as follows:</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class SetComp {
    requires 0 &lt;= j &amp;&amp; j &lt; 5;
    void myMethod(int j) {
       set&lt;int&gt; a = set&lt;int&gt; {SetComp.plus(x, x) | int x; x &gt;= 0 &amp;&amp; x &lt;= 5 };
       assert plus(1, 1) in a; 
       assert plus(j, j) in a; 
    }

    pure int plus(int a, int b) = a+b;
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-set-set-comprehension-1
//:: verdict Pass
//:: tools silicon
class SetComp {
    requires 0 &lt;= j &amp;&amp; j &lt; 5;
    void myMethod(int j) {
       set&lt;int&gt; a = set&lt;int&gt; {SetComp.plus(x, x) | int x; x &gt;= 0 &amp;&amp; x &lt;= 5 };
       assert plus(1, 1) in a; 
       assert plus(j, j) in a; 
    }

    pure int plus(int a, int b) = a+b;
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Here we define a function <code>plus</code> to wrap the expression
<code>a+b</code> and use an invokation of the <code>plus</code> function
as the <code>main</code> of our set comprehension.</p>
<h2 id="bag">Bag</h2>
<p>A bag (also called a multiset) is an unordered collection. They are
equivalent to sequences without order, or sets with duplicates. Bags are
finite and immutable (i.e. once created they cannot be altered).</p>
<p>Similar to sequences and sets, there are two ways to construct a bag:
the explicit syntax and the implicit syntax. The explicit syntax
requires the type of the bag explicitly defined. For example,
<code>b1</code> is a bag of integers initialized with the values 1, 2, 2
and 3 and <code>b2</code> is an empty bag of integers.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">bag&lt;int&gt; b1 = bag&lt;int&gt; { 1, 2, 3, 2 };
bag&lt;int&gt; b2 = bag&lt;int&gt; { };<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-bag-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        bag&lt;int&gt; b1 = bag&lt;int&gt; { 1, 2, 3, 2 };
        bag&lt;int&gt; b2 = bag&lt;int&gt; { };
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>The implicit syntax is a shorter syntax. If the bag is initialized
with at least one value (using the implicit syntax), VerCors infers the
type of the bag. An empty bag can be constructed by providing the type
of the bag. For example, <code>b3</code> is equivalent to
<code>b1</code> and <code>b4</code> is equivalent to <code>b2</code>.
Notice how there is no space between <code>b{</code> and <code>t</code>,
this is mandated by the VerCors grammar.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">bag&lt;int&gt; b3 = b{ 1, 2, 2, 3 };
bag&lt;int&gt; b4 = b{t: int };<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-bag-2
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        bag&lt;int&gt; b3 = b{ 1, 2, 2, 3 };
        bag&lt;int&gt; b4 = b{t: int };
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Once we have a bag, we can query different properties of that bag.
The length of a bag <code>b5</code> can be obtained by using the
notation <code>|b5|</code>. The syntax <code>e1 \in b6</code> is used to
get the multiplicity (or number of occurrences) of an element
<code>e1</code> in the bag <code>b6</code>. Two bags <code>b7</code> and
<code>b8</code> can be compared using the <code>==</code> operator where
they are equal iff for all elements <code>e2</code>, the multiplicity of
<code>e2</code> in <code>b7</code> and <code>b8</code> are equal. The
<code>&lt;</code> and <code>&lt;=</code> operators denote the strict
subset and subset operators respectively.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">bag&lt;int&gt; b5 = b{ 1, 2, 2, 3 };
bag&lt;int&gt; b6 = b{ 3, 4, 5, 6, 5 };
bag&lt;int&gt; b7 = b{ 1, 2, 3, 2, 2, 6 };
bag&lt;int&gt; b8 = b{ 6, 1, 2, 2, 2, 3 };
int e1 = 5;


assert |b5| == 4;
assert (e1 \in b6) == 2;
assert b5 &lt;= b7 &amp;&amp; b5 &lt; b8;
assert b7 == b8;<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-bag-3
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        bag&lt;int&gt; b5 = b{ 1, 2, 2, 3 };
        bag&lt;int&gt; b6 = b{ 3, 4, 5, 6, 5 };
        bag&lt;int&gt; b7 = b{ 1, 2, 3, 2, 2, 6 };
        bag&lt;int&gt; b8 = b{ 6, 1, 2, 2, 2, 3 };
        int e1 = 5;
        
        
        assert |b5| == 4;
        assert (e1 \in b6) == 2;
        assert b5 &lt;= b7 &amp;&amp; b5 &lt; b8;
        assert b7 == b8;
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="constructing-bags-from-existing-bags">Constructing bags from
existing bags</h3>
<p>As mentioned above bags are immutable, however it is possible to
construct a new bag from an existing bag.</p>
<p>The union of two bags is denoted by <code>b9 + b10</code>, the
difference between two bags is denoted by <code>b11 - b12</code> and the
intersection of two bags is denoted by <code>b13 * b14</code>.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">bag&lt;int&gt; b9 = bag&lt;int&gt; { 3 };
bag&lt;int&gt; b10 = bag&lt;int&gt; { 3, 4 };
bag&lt;int&gt; b11 = bag&lt;int&gt; { 1, 2, 2, 3 };
bag&lt;int&gt; b12 = bag&lt;int&gt; { 2, 3, 3, 4 };
bag&lt;int&gt; b13 = bag&lt;int&gt; { 1, 1, 2, 3 };
bag&lt;int&gt; b14 = bag&lt;int&gt; { 2, 3, 3, 4 };

assert b9 + b10 == bag&lt;int&gt; { 3, 3, 4 };
assert b12 - b11 == bag&lt;int&gt; { 3, 4 };
assert b11 - b12 == bag&lt;int&gt; { 1, 2 };
assert b13 * b14 == bag&lt;int&gt; { 2, 3 };<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-bag-constructing-bags-from-existing-bags-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        bag&lt;int&gt; b9 = bag&lt;int&gt; { 3 };
        bag&lt;int&gt; b10 = bag&lt;int&gt; { 3, 4 };
        bag&lt;int&gt; b11 = bag&lt;int&gt; { 1, 2, 2, 3 };
        bag&lt;int&gt; b12 = bag&lt;int&gt; { 2, 3, 3, 4 };
        bag&lt;int&gt; b13 = bag&lt;int&gt; { 1, 1, 2, 3 };
        bag&lt;int&gt; b14 = bag&lt;int&gt; { 2, 3, 3, 4 };
        
        assert b9 + b10 == bag&lt;int&gt; { 3, 3, 4 };
        assert b12 - b11 == bag&lt;int&gt; { 3, 4 };
        assert b11 - b12 == bag&lt;int&gt; { 1, 2 };
        assert b13 * b14 == bag&lt;int&gt; { 2, 3 };
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="examples-1">Examples</h3>
<p><code>TODO</code></p>
<h2 id="map">Map</h2>
<p>Maps are an unordered, collection of key/value pairs with unique
keys. Maps are finite and immutable (i.e. once created they cannot be
altered).</p>
<p>A map can be constructed using the syntax
<code>map&lt;K,V&gt; { k1 -&gt; v1, k2 -&gt; v2, ...}</code>. This
syntax constructs a map with keys/value pairs <code>(k1, v1)</code> and
<code>(k2, v2)</code> (of type <code>K</code> and type <code>V</code>
respectively). An empty map can be constructed by declaring no key/value
pair.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">map&lt;int, boolean&gt; m1 = map&lt;int,boolean&gt;{1 -&gt; true, 2 -&gt; true, 0 -&gt; false};
map&lt;int, boolean&gt; m2 = map&lt;int,boolean&gt;{1 -&gt; true, 2 -&gt; true, 0 -&gt; false, 1 -&gt; false, 1 -&gt; true};
assert m1 == m2;<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-map-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        map&lt;int, boolean&gt; m1 = map&lt;int,boolean&gt;{1 -&gt; true, 2 -&gt; true, 0 -&gt; false};
        map&lt;int, boolean&gt; m2 = map&lt;int,boolean&gt;{1 -&gt; true, 2 -&gt; true, 0 -&gt; false, 1 -&gt; false, 1 -&gt; true};
        assert m1 == m2;
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Once we have a map, we can query different properties of that map.
Given a key <code>k1</code>, we can get its associated value in map
<code>m1</code> using the syntax <code>m1[k1]</code> or
<code>m1.get(k1)</code>. The cardinality/size of the map can be queried
using the syntax <code>|m1|</code> or <code>m1.size</code>. The size of
a map is equivalent to the size of its key set. The key, value and
key/value pair sets can be obtained using the notations
<code>m1.keys</code>, <code>m1.values</code> and <code>m1.items</code>
respectively.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">map&lt;int, boolean&gt; m1 = map&lt;int,boolean&gt;{1 -&gt; true, 2 -&gt; true, 0 -&gt; false};

assert |m1| == 3;
assert m1[0] == false;
assert m1[1] == true;
assert m1[2] == true;

assert m1.keys == { 1, 2, 0 };
assert m1.values == { true, false };
assert tuple&lt;int, boolean&gt; { 0, false } \in m1.items;
assert tuple&lt;int, boolean&gt; { 1, true } \in m1.items;
assert tuple&lt;int, boolean&gt; { 2, true } \in m1.items;<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-map-2
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        map&lt;int, boolean&gt; m1 = map&lt;int,boolean&gt;{1 -&gt; true, 2 -&gt; true, 0 -&gt; false};
        
        assert |m1| == 3;
        assert m1[0] == false;
        assert m1[1] == true;
        assert m1[2] == true;
        
        assert m1.keys == { 1, 2, 0 };
        assert m1.values == { true, false };
        assert tuple&lt;int, boolean&gt; { 0, false } \in m1.items;
        assert tuple&lt;int, boolean&gt; { 1, true } \in m1.items;
        assert tuple&lt;int, boolean&gt; { 2, true } \in m1.items;
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>We can add a key/value pair <code>(k4, v4)</code> to the map
<code>m4</code> using the syntax <code>m4.add(k4, v4)</code>. If the key
was already present in <code>m4</code>, its value gets updated. We can
also remove a key <code>k5</code> from a map <code>m5</code> using the
function <code>m5.remove(k5)</code>.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">map&lt;int, int&gt; m1 = map&lt;int,int&gt;{};
map&lt;int, int&gt; m2 = m1.add(1, 1).add(2, 4).add(3, 9);
map&lt;int, int&gt; m3 = m2.remove(2);
map&lt;int, int&gt; m4 = m3.remove(3).remove(1);

assert |m1| == 0;
assert m2[1] == 1;
assert m2[2] == 4;
assert m2[3] == 9;

assert !(2 \in m3.keys);
assert m3[1] == 1;
assert m3[3] == 9;

assert |m4| == 0;<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-map-3
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        map&lt;int, int&gt; m1 = map&lt;int,int&gt;{};
        map&lt;int, int&gt; m2 = m1.add(1, 1).add(2, 4).add(3, 9);
        map&lt;int, int&gt; m3 = m2.remove(2);
        map&lt;int, int&gt; m4 = m3.remove(3).remove(1);
        
        assert |m1| == 0;
        assert m2[1] == 1;
        assert m2[2] == 4;
        assert m2[3] == 9;
        
        assert !(2 \in m3.keys);
        assert m3[1] == 1;
        assert m3[3] == 9;
        
        assert |m4| == 0;
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="examples-2">Examples</h3>
<p><code>TODO</code></p>
<h2 id="tuple">Tuple</h2>
<p>A tuple is an ordered, immutable collection containing exactly two
elements.</p>
<p>A tuple can be constructed using the syntax
<code>tuple&lt;F,S&gt; { fst, snd }</code>. This syntax constructs a
tuple with the first value <code>fst</code> of type <code>F</code> and
the second value <code>snd</code> of type <code>S</code>. A tuple can
also be deconstructed into its first and second value by using the
functions <code>t2.fst</code> and <code>t2.snd</code> respectively. For
example, a tuple <code>t1</code> with values <code>(1, false)</code> is
constructed as:</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">tuple&lt;int, boolean&gt; t1 = tuple&lt;int, boolean&gt; { 1, false };
assert t1.fst == 1;
assert t1.snd == false;<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-tuple-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        tuple&lt;int, boolean&gt; t1 = tuple&lt;int, boolean&gt; { 1, false };
        assert t1.fst == 1;
        assert t1.snd == false;
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="examples-3">Examples</h3>
<p><code>TODO</code></p>
<h2 id="option">Option</h2>
<p>The option data type is a container that either represents the
presence of an element in the container or the absence of it.</p>
<p>An option type can be constructed with the constructors
<code>Some(e)</code> or <code>None</code>. The constructor
<code>Some(e)</code> represents the presence of the value <code>e</code>
in the option type and the constructor <code>None</code> represents the
absence of an element.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">option&lt;int&gt; o1 = None;
option&lt;int&gt; o2 = Some(3);<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-option-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        option&lt;int&gt; o1 = None;
        option&lt;int&gt; o2 = Some(3);
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Option types can be compared to each other where two options
<code>o3</code> and <code>o4</code> are equivalent iff they both contain
an element <code>e3</code> and <code>e4</code> respectively and
<code>e3</code> equals <code>e4</code>, or both are empty.</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">option&lt;int&gt; o3 = Some(6);
option&lt;int&gt; o4 = Some(6);
option&lt;int&gt; o5 = Some(1);
option&lt;int&gt; o6 = None;

assert o3 == o4;
assert o4 != o5;
assert o5 != o6;<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases axiomatic-data-types-option-2
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        option&lt;int&gt; o3 = Some(6);
        option&lt;int&gt; o4 = Some(6);
        option&lt;int&gt; o5 = Some(1);
        option&lt;int&gt; o6 = None;
        
        assert o3 == o4;
        assert o4 != o5;
        assert o5 != o6;
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="examples-4">Examples</h3>
<p><code>TODO</code></p>
<h2 id="adt-reference">ADT Reference</h2>
<p>The tables below are a reference for all the functions/operations
that are defined on the different ADTs.</p>
<h3 id="sequence-1">Sequence</h3>
<table>
<thead>
<tr class="header">
<th>Short Description</th>
<th>Return type</th>
<th>Syntax</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Constructor</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>seq&lt;T&gt; { e1, e2, ... }</code><br>Constructs a sequence
with elements of type <code>T</code> initiliazed with values
<code>e1</code>, <code>e2</code>, etc. When the sequence is not
initialized, an empty sequence is constructed.</td>
</tr>
<tr class="even">
<td>Constructor</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>[ e1, e2, ... ]</code><br>Constructs a sequence with elements
of type <code>T</code> initiliazed with values <code>e1</code>,
<code>e2</code>, etc. This syntax requires the sequence to be
initialized.</td>
</tr>
<tr class="odd">
<td>Constructor</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>[t: T ]</code><br>Constructs an empty sequence with element of
type <code>T</code></td>
</tr>
<tr class="even">
<td>Length</td>
<td><code>int</code></td>
<td>`</td>
</tr>
<tr class="odd">
<td>Empty</td>
<td><code>boolean</code></td>
<td><code>s1.isEmpty</code><br>Returns whether `</td>
</tr>
<tr class="even">
<td>Comparison</td>
<td><code>boolean</code></td>
<td><code>s1 == s2</code><br>Returns <code>true</code> if
<code>s1</code> and <code>s2</code> are equivalent</td>
</tr>
<tr class="odd">
<td>Concatenation</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>s1 + s2</code> or <code>s1.concat(s2)</code><br>Denotes the
sequence with elements from <code>s1</code> followed by the elements of
<code>s2</code></td>
</tr>
<tr class="even">
<td>Contains</td>
<td><code>boolean</code></td>
<td><code>e \in xs</code> or <code>xs.contains(e)</code>. True if
<code>e</code> is in <code>xs</code>.</td>
</tr>
<tr class="odd">
<td>Indexing</td>
<td><code>T</code></td>
<td><code>s1[i]</code><br>Returns the element at index <code>i</code> of
sequence <code>s1</code></td>
</tr>
<tr class="even">
<td>Head</td>
<td><code>T</code></td>
<td><code>s1.head</code><br>Returns the first element of sequence
<code>s1</code></td>
</tr>
<tr class="odd">
<td>Tail</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>s1.tail</code><br>Denotes the sequence with the elements from
<code>s1</code> excluding the first element</td>
</tr>
<tr class="even">
<td>Prepend</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>x::xs</code> or <code>xs.prepend(x)</code><br>Denotes the
sequence with elements of <code>xs</code> prepended with the element
<code>x</code></td>
</tr>
<tr class="odd">
<td>Slicing</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>s1[i..j]</code> or <code>s1.slice(i, j)</code><br>Denotes the
subsequence of sequence <code>s1</code> from index <code>i</code> until
index <code>j</code> (exclusive)</td>
</tr>
<tr class="even">
<td>Dropping</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>s1[i..]</code> or <code>s1.drop(i)</code><br>Denotes the
subsequence starting at <code>i</code></td>
</tr>
<tr class="odd">
<td>Taking</td>
<td><code>seq</code><T>`</td>
<td><code>s1[..j]</code> or <code>s1.take(j)</code><br>Denotes the
subsequence of the first <code>j</code> elements</td>
</tr>
<tr class="even">
<td>Updating</td>
<td><code>seq&lt;T&gt;</code></td>
<td><code>s1[i -&gt; v]</code> or
<code>s1.update(i, v)</code><br>Denotes the sequence with elements from
<code>s1</code> where index <code>i</code> has been updated to value
<code>v</code></td>
</tr>
<tr class="odd">
<td>Removing</td>
<td><code>seq</code><T></td>
<td><code>s1.removeAt(i)</code><br>Denotes the sequence where the
element at index <code>i</code> is removed. Equivalent to
<code>s1[..i] + s1[i+1..]</code></td>
</tr>
<tr class="even">
<td>Summation</td>
<td>int</td>
<td><code>(\sum int i; low &lt;=i &amp;&amp; i&lt; up; s1[i]);</code><br>Sum
the elements of a sequence of integers <code>s1</code> between the
indices <code>low</code> and <code>up</code> (exclusive)</td>
</tr>
</tbody>
</table>
<h3 id="set-1">Set</h3>
<table>
<thead>
<tr class="header">
<th>Short Description</th>
<th>Return type</th>
<th>Syntax</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Constructor</td>
<td><code>set&lt;T&gt;</code></td>
<td><code>set&lt;T&gt; { e1, e2, ... }</code><br>Constructs a set with
elements of type <code>T</code> initiliazed with values <code>e1</code>,
<code>e2</code>, etc. When the set is not initialized, an empty set is
constructed.</td>
</tr>
<tr class="even">
<td>Constructor</td>
<td><code>set&lt;T&gt;</code></td>
<td><code>{ e1, e2, ... }</code><br>Constructs a set with elements of
type <code>T</code> initiliazed with values <code>e1</code>,
<code>e2</code>, etc. This syntax requires the set to be
initiliazed.</td>
</tr>
<tr class="odd">
<td>Constructor</td>
<td><code>set&lt;int&gt;</code></td>
<td><code>{ e1 .. e2 }</code><br>Constructs a set with all elements
between e1 (inclusive) and e2 (exclusive).</td>
</tr>
<tr class="even">
<td>Constructor</td>
<td><code>set&lt;T&gt;</code></td>
<td><code>{t: T }</code><br>Constructs an empty set with element of type
<code>T</code></td>
</tr>
<tr class="odd">
<td>Length</td>
<td><code>int</code></td>
<td>`</td>
</tr>
<tr class="even">
<td>Empty</td>
<td><code>boolean</code></td>
<td><code>s1.isEmpty</code><br>Returns whether `</td>
</tr>
<tr class="odd">
<td>Comparison</td>
<td><code>boolean</code></td>
<td><code>s1 == s2</code><br>Returns <code>true</code> if
<code>s1</code> and <code>s2</code> are equivalent</td>
</tr>
<tr class="even">
<td>Membership</td>
<td><code>boolean</code></td>
<td><code>e \in s1</code> or <code>s1.contains(e)</code><br>Returns
<code>true</code> if the value <code>e</code> is in the set
<code>s1</code></td>
</tr>
<tr class="odd">
<td>Set Union</td>
<td><code>set&lt;T&gt;</code></td>
<td><code>s1 + s2</code> or <code>s1.union(s2)</code><br>Denotes the set
of all elements from sets <code>s1</code> and <code>s2</code> of the
same type <code>T</code></td>
</tr>
<tr class="even">
<td>Set Difference</td>
<td><code>set&lt;T&gt;</code></td>
<td><code>s1 - s2</code> or <code>s1.difference(s2)</code><br>Denotes
the set of all elements from set <code>s1</code> that are not in set
<code>s2</code></td>
</tr>
<tr class="odd">
<td>Subset</td>
<td><code>boolean</code></td>
<td><code>s1 &lt;= s2</code> or <code>s1.subsetOf(s2)</code><br>Returns
<code>true</code> if set <code>s1</code> is a subset of set
<code>s2</code></td>
</tr>
<tr class="even">
<td>Strict Subset</td>
<td><code>boolean</code></td>
<td><code>s1 &lt; s2</code> or
<code>s1.strictSubsetOf(s2)</code><br>Returns <code>true</code> if set
<code>s1</code> is a strict subset of set <code>s2</code></td>
</tr>
<tr class="odd">
<td>Intersection</td>
<td><code>set&lt;T&gt;</code></td>
<td><code>s1.intersect(s2)</code><br>Denotes the set of all elements
that are both in sets <code>s1</code> and <code>s2</code></td>
</tr>
<tr class="even">
<td>Set Comprehension</td>
<td><code>set&lt;T&gt;</code></td>
<td>`set<T> { main</td>
</tr>
</tbody>
</table>
<h3 id="bag-1">Bag</h3>
<table>
<thead>
<tr class="header">
<th>Short Description</th>
<th>Return type</th>
<th>Syntax</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Constructor</td>
<td><code>bag&lt;T&gt;</code></td>
<td><code>bag&lt;T&gt; { e1, e2, ... }</code><br>Constructs a bag with
elements of type <code>T</code> initiliazed with values <code>e1</code>,
<code>e2</code>, etc. When the bag is not initialized, an empty bag is
constructed.</td>
</tr>
<tr class="even">
<td>Constructor</td>
<td><code>bag&lt;T&gt;</code></td>
<td><code>b{ e1, e2, ... }</code><br>Constructs a bag with elements of
type <code>T</code> initiliazed with values <code>e1</code>,
<code>e2</code>, etc. This syntax requires the bag to be
initiliazed.</td>
</tr>
<tr class="odd">
<td>Constructor</td>
<td><code>bag&lt;T&gt;</code></td>
<td><code>b{t: T }</code><br>Constructs an empty bag with element of
type <code>T</code></td>
</tr>
<tr class="even">
<td>Length</td>
<td><code>int</code></td>
<td>`</td>
</tr>
<tr class="odd">
<td>Empty</td>
<td><code>boolean</code></td>
<td><code>b1.isEmpty</code><br>Returns whether `</td>
</tr>
<tr class="even">
<td>Multiplicity</td>
<td><code>int</code></td>
<td><code>e \in b1</code> or <code>b1.count(e)</code><br>Returns the
number of occurrences of value <code>e</code> in bag
<code>b1</code></td>
</tr>
<tr class="odd">
<td>Comparison</td>
<td><code>boolean</code></td>
<td><code>b1 == b2</code><br>Returns <code>true</code> if
<code>b1</code> and <code>b2</code> are equivalent</td>
</tr>
<tr class="even">
<td>Bag Union</td>
<td><code>bag&lt;T&gt;</code></td>
<td><code>b1 + b2</code> or <code>b1.sum(b2)</code><br>Denotes the bag
of all elements from bags <code>b1</code> and <code>b2</code> of the
same type <code>T</code></td>
</tr>
<tr class="odd">
<td>Bag Difference</td>
<td><code>bag&lt;T&gt;</code></td>
<td><code>b1 - b2</code> or <code>b1.difference(b2)</code><br>Denotes
the bag of all elements from bag <code>b1</code> that are not in bag
<code>b2</code></td>
</tr>
<tr class="even">
<td>Subset</td>
<td><code>boolean</code></td>
<td><code>b1 &lt;= b2</code> or <code>b1.subbagOf(b2)</code><br>Returns
<code>true</code> if bag <code>b1</code> is a subset of bag
<code>b2</code></td>
</tr>
<tr class="odd">
<td>Strict Subset</td>
<td><code>boolean</code></td>
<td><code>b1 &lt; b2</code> or
<code>b1.strictSubbagOf(b2)</code><br>Returns <code>true</code> if bag
<code>b1</code> is a strict subset of bag <code>b2</code></td>
</tr>
<tr class="even">
<td>Intersection</td>
<td><code>bag&lt;T&gt;</code></td>
<td><code>b1 * b2</code> or <code>b1.intersect(b2)</code><br>Denotes the
bag of all elements that are both in bags <code>b1</code> and
<code>b2</code></td>
</tr>
</tbody>
</table>
<h3 id="map-1">Map</h3>
<table>
<thead>
<tr class="header">
<th>Short Description</th>
<th>Return type</th>
<th>Syntax</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Constructor</td>
<td><code>map&lt;K,V&gt;</code></td>
<td><code>map&lt;K,V&gt; { k1 -&gt; v1, k2 -&gt; v2, ...}</code><br>Constructs
a map with key-value pairs of type <code>K</code> and <code>V</code>
respectively initiliazed with pairs <code>k1,v1</code>,
<code>k2,v2</code>, etc.</td>
</tr>
<tr class="even">
<td>Build/Add</td>
<td><code>map&lt;K,V&gt;</code></td>
<td><code>m1.add(k1, v1)</code><br>Adds the key/value pair
<code>(k1,v1)</code> to the map <code>m1</code>. If the key is already
present in <code>m1</code>, update the value of the key.</td>
</tr>
<tr class="odd">
<td>GetByKey</td>
<td><code>V</code></td>
<td><code>m1.get(k1)</code> or <code>map[k1]</code><br>Gets the value
mapped by the key <code>k1</code> from the map <code>m1</code>.</td>
</tr>
<tr class="even">
<td>Remove</td>
<td><code>map&lt;K,V&gt;</code></td>
<td><code>m1.remove(k1)</code><br>Removes the key <code>k1</code> and
its associated value from the map <code>m1</code>.</td>
</tr>
<tr class="odd">
<td>Length</td>
<td><code>int</code></td>
<td><code>m1.size</code> or `</td>
</tr>
<tr class="even">
<td>Empty</td>
<td><code>boolean</code></td>
<td><code>m1.isEmpty</code><br>Returns whether `</td>
</tr>
<tr class="odd">
<td>Comparison</td>
<td><code>boolean</code></td>
<td><code>m1.equals(m2)</code> or <code>m1 == m2</code><br>Returns
<code>true</code> if the keysets of <code>m1</code> and <code>m2</code>
are equivalent and the keys map to the same values.</td>
</tr>
<tr class="even">
<td>Key Set</td>
<td><code>set&lt;K&gt;</code></td>
<td><code>m1.keys</code><br>Returns a set of keys in map
<code>m1</code></td>
</tr>
<tr class="odd">
<td>Value Set</td>
<td><code>set&lt;V&gt;</code></td>
<td><code>m1.values</code><br>Returns a set of the values in map
<code>m1</code></td>
</tr>
<tr class="even">
<td>Item Set</td>
<td><code>set&lt;tuple&lt;K,V&gt;&gt;</code></td>
<td><code>m1.items</code><br>Returns a set of tuples corresponding to
the key-value pairs in map <code>m1</code></td>
</tr>
<tr class="odd">
<td>Disjoint</td>
<td><code>boolean</code></td>
<td><code>m1.disjoint(m2)</code><br>Returns <code>true</code> if no key
is in both the key set of <code>m1</code> and the key set of
<code>m2</code>.</td>
</tr>
</tbody>
</table>
<h3 id="tuple-1">Tuple</h3>
<table>
<thead>
<tr class="header">
<th>Short Description</th>
<th>Return type</th>
<th>Syntax</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Constructor</td>
<td><code>tuple&lt;F,S&gt;</code></td>
<td><code>tuple&lt;F,S&gt; {fst, snd}</code><br>Construct a tuple with
first element <code>fst</code> (of type <code>F</code>) and second
element <code>snd</code> (of type <code>S</code>)</td>
</tr>
<tr class="even">
<td>Get First Element</td>
<td><code>F</code></td>
<td><code>t.fst</code><br> Get the first element of the tuple
<code>t</code> (of type <code>tuple&lt;F,S&gt;</code>)</td>
</tr>
<tr class="odd">
<td>Get Second Element</td>
<td><code>S</code></td>
<td><code>t.snd</code><br> Get the second element of the tuple
<code>t</code> (of type <code>tuple&lt;F,S&gt;</code>)</td>
</tr>
</tbody>
</table>
<h3 id="option-1">Option</h3>
<table>
<thead>
<tr class="header">
<th>Short Description</th>
<th>Return type</th>
<th>Syntax</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Constructor</td>
<td><code>option&lt;T&gt;</code></td>
<td><code>Some(e)</code><br> Constructs an option which contains the
element <code>e</code> of type <code>T</code></td>
</tr>
<tr class="even">
<td>Constructor</td>
<td><code>option&lt;T&gt;</code></td>
<td><code>None</code><br> Returns the option <code>None</code></td>
</tr>
<tr class="odd">
<td>Getter</td>
<td><code>T</code></td>
<td><code>e.get</code><br>Returns the value contained in the option if
it is filled</td>
</tr>
<tr class="even">
<td>Getter</td>
<td><code>T</code></td>
<td><code>e.getOrElse(t)</code><br>Returns the value contained in the
option, <code>t</code> otherwise</td>
</tr>
<tr class="odd">
<td>Comparison</td>
<td><code>boolean</code></td>
<td><code>o1 == o2</code> <br> Returns <code>true</code> if the element
contained in the option <code>o1</code> is equivalent to the element
wrapped in the option <code>o2</code>, or both are empty</td>
</tr>
</tbody>
</table>
<h2 id="custom-adts">Custom ADTs</h2>
<p>ADTs can be useful to provide VerCors with domain-specific
assumptions. For example, a custom int-tuple ADT can be defined in PVL
as follows:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>adt MyTuple <span class="op">{</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  pure MyTuple <span class="fu">cons</span><span class="op">(</span><span class="dt">int</span> l<span class="op">,</span> <span class="dt">int</span> r<span class="op">);</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  pure <span class="dt">int</span> <span class="fu">left</span><span class="op">(</span>MyTuple t<span class="op">);</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  pure <span class="dt">int</span> <span class="fu">right</span><span class="op">(</span>MyTuple t<span class="op">);</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axiom</span> <span class="op">(</span>\forall <span class="dt">int</span> l<span class="op">,</span> <span class="dt">int</span> r<span class="op">;</span> <span class="fu">left</span><span class="op">(</span><span class="fu">cons</span><span class="op">(</span>l<span class="op">,</span> r<span class="op">))</span> <span class="op">==</span> l<span class="op">);</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axiom</span> <span class="op">(</span>\forall <span class="dt">int</span> l<span class="op">,</span> <span class="dt">int</span> r<span class="op">;</span> <span class="fu">right</span><span class="op">(</span><span class="fu">cons</span><span class="op">(</span>l<span class="op">,</span> r<span class="op">))</span> <span class="op">==</span> r<span class="op">);</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axiom</span> <span class="op">(</span>\forall <span class="dt">int</span> l1<span class="op">,</span> <span class="dt">int</span> l2<span class="op">,</span> <span class="dt">int</span> r1<span class="op">,</span> <span class="dt">int</span> r2<span class="op">;</span> </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="fu">cons</span><span class="op">(</span>l1<span class="op">,</span> r1<span class="op">)</span> <span class="op">==</span> <span class="fu">cons</span><span class="op">(</span>l2<span class="op">,</span> r2<span class="op">))</span> <span class="op">==&gt;</span> <span class="op">(</span>l1 <span class="op">==</span> l2 <span class="op">&amp;&amp;</span> r1 <span class="op">==</span> r2<span class="op">));</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">testTuple</span><span class="op">(</span>MyTuple t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">assert</span> MyTuple<span class="op">.</span><span class="fu">cons</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">)</span> <span class="op">==</span> MyTuple<span class="op">.</span><span class="fu">cons</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">assert</span> MyTuple<span class="op">.</span><span class="fu">cons</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">)</span> <span class="op">!=</span> MyTuple<span class="op">.</span><span class="fu">cons</span><span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">);</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Note however that it is easy to make mistakes and define axioms from
which false can be derived. If this happens, and your custom ADT is used
in your code or contracts, from that point on VerCors assumes false,
which makes every proof obligation after that point trivial to prove.
Furthermore, when writing quantifiers in ADTs it is important to also
define triggers. VerCors and its backend can often infer some trigger,
but these are usually suboptimal.</p>
<p>Custom ADTs are supported in all frontends.</p>
<h1 id="arrays-and-pointers">Arrays and Pointers</h1>
<p><em>This tutorial explains how to specify arrays and pointers in
vercors. Java and PVL support arrays, whereas C and the GPGPU frontends
only support pointers. The tutorial assumes you are familiar with arrays
and pointers already.</em></p>
<h2 id="array-permissions">Array permissions</h2>
<p>We have learned already how to specify ownership of variables on the
heap. Arrays generalize this concept by treating each element of the
array as a separate location on the heap. For example, you might
specify:</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*@</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">requires ar != null &amp;&amp; ar.length == 3;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">context Perm(ar[0], write) ** Perm(ar[1], write) ** Perm(ar[2], write);</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">example1</span><span class="op">(</span><span class="dt">int</span><span class="op">[]</span> ar<span class="op">);</span></span></code></pre></div>
<p>This means we require the length to be 3, and require and return
permission over each of the elements of the array. Length is treated in
a special way here: even though it is a "field", we do not need
permission to read it, because the length of an array cannot be changed
and it is baked into Vercors.</p>
<p>Of course writing a specific length and manually asserting permission
over each location is cumbersome, so we can write a contract that
accepts arrays of any length as such:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*@</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co">requires ar != null;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; ar.length; Perm(ar[i], write));</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">example2</span><span class="op">(</span><span class="dt">int</span><span class="op">[]</span> ar<span class="op">);</span></span></code></pre></div>
<p>As mentioned in the permissions tutorial, the permissions are
combined with <code>**</code> to
<code>Perm(ar[0], write) ** Perm(ar[1], write) ** â¦ ** Perm(ar[ar.length-1], write)</code>.
Please note the <code>*</code> after <code>forall</code>, which denotes
that the body of the forall is combined with separating conjunction
(<code>**</code>) and not boolean conjunction
(<code>&amp;&amp;</code>).</p>
<p>As you might expect, we can also use forall to specify properties
about the values of the array:</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*@</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co">requires ar != null;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; ar.length; Perm(ar[i], write));</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">ensures (\forall int i; 0 &lt;= &amp;&amp; i &lt; ar.length; ar[i] == i);</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">identity</span><span class="op">(</span><span class="dt">int</span><span class="op">[]</span> ar<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ar<span class="op">.</span><span class="fu">length</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*@</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">    loop_invariant (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; ar.length; Perm(ar[i], write));</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">    loop_invariant (\forall int j; 0 &lt;= j &amp;&amp; j &lt; i; ar[j] == j); */</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        ar<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="syntactic-sugar">Syntactic sugar</h2>
<p>Specifying arrays quickly leads to prefix a lot of statements with
<code>\forall* int i; 0 &lt;= i &amp;&amp; i &lt; ar.length;</code>, so
there is some syntactic sugar. First, you might want to use
<code>context_everywhere</code> for the permission specification of the
array, so that it is automatically propagates to loop invariants:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*@</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co">context_everywhere (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; ar.length; Perm(ar[i], write));</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co">ensures (\forall int i; 0 &lt;= &amp;&amp; i &lt; ar.length; ar[i] == i);</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">identity</span><span class="op">(</span><span class="dt">int</span><span class="op">[]</span> ar<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ar<span class="op">.</span><span class="fu">length</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*@</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">    loop_invariant (\forall int j; 0 &lt;= j &amp;&amp; j &lt; i; ar[j] == j); */</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        ar<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This whole forall* can also be written as
<code>Perm(ar[*], write)</code>, which still means write permission over
all the elements of the array:</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*@</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co">requires ar != null;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co">context_everywhere Perm(ar[*], write);</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">ensures (\forall int i; 0 &lt;= &amp;&amp; i &lt; ar.length; ar[i] == i);</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">identity</span><span class="op">(</span><span class="dt">int</span><span class="op">[]</span> ar<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ar<span class="op">.</span><span class="fu">length</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*@</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">    loop_invariant (\forall int j; 0 &lt;= j &amp;&amp; j &lt; i; ar[j] == j); */</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        ar<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If you want to specify the length of an array, you can write as well:
<code>\array(ar, N)</code> which is equivalent to
<code>ar != null &amp;&amp; ar.length == N</code>. More interestingly,
there is also <code>\matrix(mat, M, N)</code>, which is equivalent
to:</p>
<pre><code>mat != null ** mat.length == M **
(\forall* int i; 0 &lt;= i &amp;&amp; i &lt; M; Perm(mat[i], read)) **
(\forall int i; 0 &lt;= i &amp;&amp; i &lt; M; mat[i].length == N) **
(\forall int i; 0 &lt;= i &amp;&amp; i &lt; M; (\forall int j; 0 &lt;= j &amp;&amp; j &lt; M &amp;&amp; mat[i] == mat[j]; i == j))</code></pre>
<p>The last line is interesting here. In Java there is no such thing as
a true matrix: instead we can make an array of arrays. However, there is
nothing preventing you from putting the same row array instance in
multiple rows. The last statement says that if we have valid row indices
i, j, we know that <code>i != j ==&gt; mat[i] != mat[j]</code> (and the
contrapositive).</p>
<h2 id="pointers">Pointers</h2>
<p>Pointers themselves are quite well-supported, but we don't support
casting and structs in C, making the end result quite limited. For the
support that we do have, pointers can be specified with two constructs:
<code>\pointer</code> and <code>\pointer_index</code>.</p>
<p>We write <code>\pointer(p, size, perm)</code> to express that
<code>p != NULL</code>, the pointer <code>p</code> is valid from (at
least) <code>0</code> to <code>size-1</code>, and we assert
<code>perm</code> permission over those locations.</p>
<p>We write <code>\pointer_index(p, index, perm)</code> to express that
<code>p != NULL</code>, <code>(p+i)</code> is a valid location, and we
have permission <code>perm</code> at that location.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*@</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co">requires \pointer(a, 10, write);</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> test<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>a<span class="op">)</span> <span class="op">{</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//@ assert \pointer(a, 10, write);</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">//@ assert \pointer(a, 8, write);</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">//@ assert (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; 10; \pointer_index(a, i, write));</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>b <span class="op">=</span> a<span class="op">+</span><span class="dv">5</span><span class="op">;</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">//@ assert a[5] == b[0];</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">//@ assert \pointer(b, 5, write);</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2
id="injectivity-object-arrays-and-efficient-verification">Injectivity,
object arrays and efficient verification</h2>
<p><em>This section contains advanced information, and can be skipped on
a first read.</em></p>
<p>Due to a technical limitation in the backend of VerCors, the location
denoted by a permission expression in a quantified expression must be
unique for each binding of the quantifier. For example, if we write:</p>
<!-- test Fail -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Box {
    int value;

    void test() {
        Box box1 = new Box();
        seq&lt;Box&gt; boxes = seq&lt;Box&gt;{box1, box1};
        exhale (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; |boxes|; Perm(boxes[i].value, 1\10));
    }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases arrays-and-pointers-injectivity-object-arrays-and-efficient-verification-1
//:: verdict Fail
//:: tools silicon
class Box {
    int value;

    void test() {
        Box box1 = new Box();
        seq&lt;Box&gt; boxes = seq&lt;Box&gt;{box1, box1};
        exhale (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; |boxes|; Perm(boxes[i].value, 1\10));
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>This could be correct: we only exhale <code>2\10</code> permission of
<code>box1.value</code>. The expression is however not well-formed:
<code>i==0</code> and <code>i==1</code> cause the expression
<code>boxes[i].value</code> to point to the same location. (Please note
that it seems that the error from our backend currently is not
propagated correctly. Silicon reports "Receiver of boxes[i].value might
not be injective." and VerCors translates this into
"ExhaleFailed:InsufficientPermission".)</p>
<p>The reason we refer to this as injectivity, is that we should be able
to construct a function that assigns bindings for a location, e.g. for a
given <code>Box</code> we can either find a unique <code>i</code> that
points to the <code>Box</code>, or the <code>Box</code> does not appear
in <code>boxes</code>. That function is the inverse of the expression in
the <code>Perm</code>. The truth value of a <code>\forall*</code>
carries with it this property of injectivity. This means, for example,
that in a method definition a requirement assumes that
<code>\forall*</code> statements are injective with repsect to
locations, whereas we must prove it in ensures statements. This usually
follows directly from a requirement. In method invokations then as per
usual it's the opposite: we must prove that <code>\forall*</code>
statements in the requirements are injective and may assume it for
ensures statements.</p>
<p>This limitation is especially important in for example arrays of
objects:</p>
<!-- test Fail -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Box {
    int value;

    requires a != null ** (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; a.length; Perm(a[i], read));
    requires (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; a.length; a[i] != null ** Perm(a[i].value, write));
    void test(Box[] a) {
        
    }

    void foo() {
        Box box = new Box();
        Box[] boxes = new Box[2];
        boxes[0] = box;
        boxes[1] = box;
        test(boxes); // fails
    }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases arrays-and-pointers-injectivity-object-arrays-and-efficient-verification-2
//:: verdict Fail
//:: tools silicon
class Box {
    int value;

    requires a != null ** (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; a.length; Perm(a[i], read));
    requires (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; a.length; a[i] != null ** Perm(a[i].value, write));
    void test(Box[] a) {
        
    }

    void foo() {
        Box box = new Box();
        Box[] boxes = new Box[2];
        boxes[0] = box;
        boxes[1] = box;
        test(boxes); // fails
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>In common use however we have to know about duplicate elements
anyway. For example, in the example above we require <code>write</code>
permission over the boxes, so indirectly we already require all the
boxes to be distinct. As for the array elements themselves: we have an
internal axiom about arrays that expresses exactly that the locations of
an array correspond to only one index and one array.</p>
<h1 id="parallel-blocks">Parallel Blocks</h1>
<p>In this section we explain how to verify parallel algorithms by
creating parallel blocks in PVL. First, we give an example of a simple
method using parallel block. Then, we discuss a more complex example
with a barrier inside the parallel block. A barrier is used to
synchronize threads inside a parallel block.</p>
<h3 id="simple-parallel-blocks">Simple Parallel Blocks</h3>
<h4 id="parallel-block-without-barrier">Parallel Block without
Barrier</h4>
<p>This example shows a simple method that adds two arrays in parallel
and stores the result in another array:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/* 1  */ context_everywhere a != null &amp;&amp; b != null &amp;&amp; c != null;
/* 2  */ context_everywhere a.length == size &amp;&amp; b.length == size &amp;&amp; c.length == size;
/* 3  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(a[i], 1\2));
/* 4  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(b[i], 1\2));
/* 5  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(c[i], 1));
/* 6  */ ensures (\forall int i; i &gt;= 0 &amp;&amp;  i &lt; size; c[i] == a[i] + b[i]);
/* 7  */ void Add(int[] a, int[] b, int[] c, int size){
/* 8  */
/* 9  */    par threads (int tid = 0 .. size)
/* 10 */     context Perm(a[tid], 1\2) ** Perm(b[tid], 1\2) ** Perm(c[tid], 1);
/* 11 */     ensures c[tid] == a[tid] + b[tid];
/* 12 */    {
/* 13 */       c[tid] = a[tid] + b[tid];
/* 14 */    }
/* 15 */  }<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases parallel-blocks-?-simple-parallel-blocks-parallel-block-without-barrier-1
//:: verdict Pass
//:: tools silicon
class Test {
    /* 1  */ context_everywhere a != null &amp;&amp; b != null &amp;&amp; c != null;
    /* 2  */ context_everywhere a.length == size &amp;&amp; b.length == size &amp;&amp; c.length == size;
    /* 3  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(a[i], 1\2));
    /* 4  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(b[i], 1\2));
    /* 5  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(c[i], 1));
    /* 6  */ ensures (\forall int i; i &gt;= 0 &amp;&amp;  i &lt; size; c[i] == a[i] + b[i]);
    /* 7  */ void Add(int[] a, int[] b, int[] c, int size){
    /* 8  */
    /* 9  */    par threads (int tid = 0 .. size)
    /* 10 */     context Perm(a[tid], 1\2) ** Perm(b[tid], 1\2) ** Perm(c[tid], 1);
    /* 11 */     ensures c[tid] == a[tid] + b[tid];
    /* 12 */    {
    /* 13 */       c[tid] = a[tid] + b[tid];
    /* 14 */    }
    /* 15 */  }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>In this method there is a parallel block (lines 9-14) named
"<em>threads</em>". The keyword "<em>par</em>" is used to define a
parallel block, followed by an arbitrary name after that defines the
name of that block. Moreover, we define the number of threads in the
parallel block as well as a name for the thread identifier. In this
example, we have "<em>size</em>" threads in the range from 0 to
"<em>size</em>-1" and "<em>tid</em>" is used as thread identifier to
refer to each thread.</p>
<p>In addition to the specification of the method (lines 1-6), we add
thread-level specification to the parallel block (lines 10-11). The
precondition of the method indicates that we have read permission over
all locations in arrays "<em>a</em>" and "<em>b</em>" and write
permission for array "<em>c</em>" (lines 3-5). In the parallel block, we
specify that each thread ("<em>tid</em>") has read permission to its own
location in arrays "<em>a</em>" and "<em>b</em>" and write permission to
its own location in array "<em>c</em>" (line 10). After termination of
the parallel block as postcondition (1) we have the same permission
(line 10) and (2) the result of each location in array "<em>c</em>" is
the sum of the two corresponding locations in arrays "<em>a</em>" and
"<em>b</em>" (line 11). From the postcondition of the parallel block, we
can derive the postcondition of the method using universal quantifier
for all locations in the arrays (line 3-6).</p>
<h4 id="parallel-block-with-barrier">Parallel Block with Barrier</h4>
<p>Next we show an example of a parallel block which uses a barrier to
synchronize threads:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/* 1  */ context_everywhere array != null &amp;&amp; array.length == size;
/* 2  */ requires (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(array[i], write));
/* 3  */ ensures (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(array[i], write));
/* 4  */ ensures (\forall int i; i &gt;= 0 &amp;&amp;  i &lt; size; (i != size-1 ==&gt; array[i] == \old(array[i+1])) &amp;&amp; 
/* 5  */                                              (i == size-1 ==&gt; array[i] == \old(array[0])) );
/* 6  */ void leftRotation(int[] array, int size){
/* 7  */
/* 8  */   par threads (int tid = 0 .. size)
/* 9  */    requires tid != size-1 ==&gt; Perm(array[tid+1], write);
/* 10 */    requires tid == size-1 ==&gt; Perm(array[0], write);
/* 11 */    ensures Perm(array[tid], write);
/* 12 */    ensures tid != size-1 ==&gt; array[tid] == \old(array[tid+1]);
/* 13 */    ensures tid == size-1 ==&gt; array[tid] == \old(array[0]);
/* 14 */   {
/* 15 */      int temp;
/* 16 */      if (tid != size-1) {
/* 17 */        temp = array[tid+1];
/* 18 */      } else {
/* 19 */        temp = array[0];
/* 20 */      }
/* 21 */
/* 22 */      barrier(threads)
/* 23 */      requires tid != size-1 ==&gt; Perm(array[tid+1], write);
/* 24 */      requires tid == size-1 ==&gt; Perm(array[0], write);
/* 25 */      ensures Perm(array[tid], write);
/* 26 */      { /* Automatic proof */ }
/* 27 */
/* 28 */      array[tid] = temp;
/* 29 */   }
/* 30 */ }<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases parallel-blocks-?-simple-parallel-blocks-parallel-block-with-barrier-1
//:: verdict Pass
//:: tools silicon
class Test {
    /* 1  */ context_everywhere array != null &amp;&amp; array.length == size;
    /* 2  */ requires (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(array[i], write));
    /* 3  */ ensures (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(array[i], write));
    /* 4  */ ensures (\forall int i; i &gt;= 0 &amp;&amp;  i &lt; size; (i != size-1 ==&gt; array[i] == \old(array[i+1])) &amp;&amp; 
    /* 5  */                                              (i == size-1 ==&gt; array[i] == \old(array[0])) );
    /* 6  */ void leftRotation(int[] array, int size){
    /* 7  */
    /* 8  */   par threads (int tid = 0 .. size)
    /* 9  */    requires tid != size-1 ==&gt; Perm(array[tid+1], write);
    /* 10 */    requires tid == size-1 ==&gt; Perm(array[0], write);
    /* 11 */    ensures Perm(array[tid], write);
    /* 12 */    ensures tid != size-1 ==&gt; array[tid] == \old(array[tid+1]);
    /* 13 */    ensures tid == size-1 ==&gt; array[tid] == \old(array[0]);
    /* 14 */   {
    /* 15 */      int temp;
    /* 16 */      if (tid != size-1) {
    /* 17 */        temp = array[tid+1];
    /* 18 */      } else {
    /* 19 */        temp = array[0];
    /* 20 */      }
    /* 21 */
    /* 22 */      barrier(threads)
    /* 23 */      requires tid != size-1 ==&gt; Perm(array[tid+1], write);
    /* 24 */      requires tid == size-1 ==&gt; Perm(array[0], write);
    /* 25 */      ensures Perm(array[tid], write);
    /* 26 */      { /* Automatic proof */ }
    /* 27 */
    /* 28 */      array[tid] = temp;
    /* 29 */   }
    /* 30 */ }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>This example illustrates a method named "<em>leftRotation</em>" that
rotates the elements of an array to the left. In this example, we also
have "<em>size</em>" threads in the range from 0 to "<em>size</em>-1"
and "<em>tid</em>" is used as thread identifier. Inside the parallel
block each thread ("<em>tid</em>") stores its right neighbor in a
temporary location (i.e., "<em>temp</em>"), except thread
"<em>size</em>-1" which stores the first element in the array (lines
15-20). Then each thread synchronizes at the barrier (line 22). The
keyword "<em>barrier</em>" and the name of the parallel block as an
argument (e.g., "<em>threads</em>" in the example) are used to define a
barrier in PVL. After that, each thread writes the value read into its
own location at index "<em>tid</em>" in the array (line 28).</p>
<p>To verify this method in VerCors, we annotate the barrier, in
addition to the method and the parallel block. As precondition of the
method, we have read permission over all locations in the array (line
2). At the beginning of the parallel block, each thread reads from its
right neighbor, except thread "<em>size</em>-1" which reads from
location 0 (lines 16-20). Therefore, we specify read permissions as
precondition of the parallel block in lines 9-10. Since after the
barrier each thread ("<em>tid</em>") writes into its own location at
index ("<em>tid</em>"), we change the permissions in the barrier in such
that each thread has write permissions to its own location (lines
23-25). When a thread reaches the barrier, it has to fulfill the barrier
preconditions, and then it may assume the barrier postconditions.
Moreover, the barrier postconditions must follow from the barrier
preconditions.</p>
<p>As postcondition of the parallel block (1) first each thread has
write permission to its own location (this comes from the postcondition
of the barrier) in line 11 and (2) the elements are truly shifted to the
left (lines 12-13). From the postcondition of the parallel block, we can
establish the same postcondition for the method (lines 3-5).</p>
<h4 id="caution-barrier-syntax">Caution: barrier syntax</h4>
<p>In this chapter syntax is introduced for barriers. There is a caveat
to using barriers, which we want to explain first so it is not missed.
Barrier syntax in VerCors has two forms. Form 1:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>barrier<span class="op">(</span>barrierName<span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  requires P<span class="op">;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  ensures Q<span class="op">;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Form 2:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>barrier<span class="op">(</span>barrierName<span class="op">)</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  requires P<span class="op">;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  ensures Q<span class="op">;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="op">}</span></span></code></pre></div>
<p>Notice how in form 1, the contract is inside the curly braces. In
form 2, the contract resides between the barrier declaration and the
curly braces.</p>
<p>There is a <em>big</em> difference between these two syntaxes. In
form 1, the contract of the barrier <em>is not actually checked</em> by
VerCors. This means that if you would add <code>ensures false;</code> to
your barrier using the syntax of form 1, VerCors will not indicate this
is a problematic contract. For form 2, however, the contract <em>is
actually checked</em>. Therefore, when using barriers, form 2 should be
preferred. Form 1 should only be used if there is a proof external to
VerCors.</p>
<h3 id="complicated-parallel-blocks">Complicated Parallel Blocks</h3>
<h4 id="nested-parallel-blocks">Nested Parallel Blocks</h4>
<p>In the previous examples, we defined a parallel block of threads to
work on one-dimensional arrays. It is also possible to define
two-dimensional thread layouts to work on two-dimensional arrays. As an
example we define a two-dimensional thread layout to transpose a matrix
in parallel:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">context_everywhere inp != null &amp;&amp; out != null; /// &amp;&amp; out == size;
context_everywhere inp.length == size &amp;&amp; out.length == size; 
context_everywhere (\forall int i; 0 &lt;= i &amp;&amp; i &lt; size; inp[i].length == size &amp;&amp; out[i].length == size);
context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
         (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(inp[i][j], read)));
context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
         (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(out[i][j], write)));
ensures (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
         (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; out[i][j] == inp[j][i]));
void transpose(int[][] inp, int[][] out, int size){

  par threadX (int tidX = 0 .. size)
   context (\forall* int i; i &gt;= 0 &amp;&amp; i &lt; size; Perm(inp[i][tidX], read));
   context (\forall* int i; i &gt;= 0 &amp;&amp; i &lt; size; Perm(out[tidX][i], write));
   ensures (\forall int i; i &gt;= 0 &amp;&amp; i &lt; size; out[tidX][i] == inp[i][tidX]);
  {
    par threadY (int tidY = 0 .. size)
     context Perm(inp[tidY][tidX], read);
     context Perm(out[tidX][tidY], write);
     ensures out[tidX][tidY] == inp[tidY][tidX];
    {
      out[tidX][tidY] = inp[tidY][tidX]; 
    } 
  }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases parallel-blocks-?-complicated-parallel-blocks-nested-parallel-blocks-1
//:: verdict Pass
//:: tools silicon
class Test {
    context_everywhere inp != null &amp;&amp; out != null; /// &amp;&amp; out == size;
    context_everywhere inp.length == size &amp;&amp; out.length == size; 
    context_everywhere (\forall int i; 0 &lt;= i &amp;&amp; i &lt; size; inp[i].length == size &amp;&amp; out[i].length == size);
    context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
             (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(inp[i][j], read)));
    context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
             (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(out[i][j], write)));
    ensures (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
             (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; out[i][j] == inp[j][i]));
    void transpose(int[][] inp, int[][] out, int size){
    
      par threadX (int tidX = 0 .. size)
       context (\forall* int i; i &gt;= 0 &amp;&amp; i &lt; size; Perm(inp[i][tidX], read));
       context (\forall* int i; i &gt;= 0 &amp;&amp; i &lt; size; Perm(out[tidX][i], write));
       ensures (\forall int i; i &gt;= 0 &amp;&amp; i &lt; size; out[tidX][i] == inp[i][tidX]);
      {
        par threadY (int tidY = 0 .. size)
         context Perm(inp[tidY][tidX], read);
         context Perm(out[tidX][tidY], write);
         ensures out[tidX][tidY] == inp[tidY][tidX];
        {
          out[tidX][tidY] = inp[tidY][tidX]; 
        } 
      }
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>As we can see defining nested parallel blocks allow us to define
thread layout in different dimensions. We can simplify the above example
syntactically into one parallel block:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">context_everywhere inp != null &amp;&amp; out != null;
context_everywhere inp.length == size &amp;&amp; out.length == size; 
context_everywhere (\forall int i; 0 &lt;= i &amp;&amp; i &lt; size; inp[i].length == size &amp;&amp; out[i].length == size);
context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
         (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(inp[i][j], read)));
context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
         (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(out[i][j], write)));
ensures (\forall int i; 0 &lt;= i &amp;&amp; i &lt; size; 
         (\forall int j; 0 &lt;= j &amp;&amp; j &lt; size; out[i][j] == inp[j][i]));
void transpose(int[][] inp, int[][] out, int size){

  par threadXY (int tidX = 0 .. size, int tidY = 0 .. size)
   context Perm(inp[tidY][tidX], read);
   context Perm(out[tidX][tidY], write);
   ensures out[tidX][tidY] == inp[tidY][tidX];
  {
    out[tidX][tidY] = inp[tidY][tidX]; 
  } 
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases parallel-blocks-?-complicated-parallel-blocks-nested-parallel-blocks-2
//:: verdict Pass
//:: tools silicon
class Test {
    context_everywhere inp != null &amp;&amp; out != null;
    context_everywhere inp.length == size &amp;&amp; out.length == size; 
    context_everywhere (\forall int i; 0 &lt;= i &amp;&amp; i &lt; size; inp[i].length == size &amp;&amp; out[i].length == size);
    context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
             (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(inp[i][j], read)));
    context (\forall* int i; 0 &lt;= i &amp;&amp; i &lt; size; 
             (\forall* int j; 0 &lt;= j &amp;&amp; j &lt; size; Perm(out[i][j], write)));
    ensures (\forall int i; 0 &lt;= i &amp;&amp; i &lt; size; 
             (\forall int j; 0 &lt;= j &amp;&amp; j &lt; size; out[i][j] == inp[j][i]));
    void transpose(int[][] inp, int[][] out, int size){
    
      par threadXY (int tidX = 0 .. size, int tidY = 0 .. size)
       context Perm(inp[tidY][tidX], read);
       context Perm(out[tidX][tidY], write);
       ensures out[tidX][tidY] == inp[tidY][tidX];
      {
        out[tidX][tidY] = inp[tidY][tidX]; 
      } 
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h4 id="simultaneous-parallel-blocks">Simultaneous Parallel Blocks</h4>
<p>There might be some scenarios that we have multiple parallel blocks
and all threads in each parallel block are working in disjoint memory
locations. In this case we can define multiple parallel blocks to run
simultaneously. That means, threads in each parallel block run
independently of other threads in different parallel blocks. Below is an
example of such a scenario:</p>
<!-- testMethod -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/* 1  */ context_everywhere a != null &amp;&amp; b != null &amp;&amp; c != null;
/* 2  */ context_everywhere a.length == size &amp;&amp; b.length == size &amp;&amp; c.length == size; 
/* 3  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(a[i], write));
/* 4  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(b[i], write));
/* 5  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(c[i], write));
/* 6  */ ensures (\forall int i; i &gt;= 0 &amp;&amp;  i &lt; size; a[i] == \old(a[i]) + 1 &amp;&amp; b[i] == \old(b[i]) + 1 &amp;&amp; 
/* 7  */                                              c[i] == \old(c[i]) + 1);
/* 8  */ void simPar(int[] a, int[] b, int[] c, int size){
/* 9  */
/* 10 */   par thread1 (int tid1 = 0 .. size)
/* 11 */    context Perm(a[tid1], write);
/* 12 */    ensures a[tid1] == \old(a[tid1]) + 1;
/* 13 */   {
/* 14 */     a[tid1] = a[tid1] + 1; 
/* 15 */   } and
/* 16 */   thread2 (int tid2 = 0 .. size)
/* 17 */    context Perm(b[tid2], write);
/* 18 */    ensures b[tid2] == \old(b[tid2]) + 1;
/* 19 */   {
/* 20 */     b[tid2] = b[tid2] + 1;
/* 21 */   } and
/* 22 */   thread3 (int tid3 = 0 .. size)
/* 23 */    context Perm(c[tid3], write);
/* 24 */    ensures c[tid3] == \old(c[tid3]) + 1;
/* 25 */   {
/* 26 */     c[tid3] = c[tid3] + 1;
/* 27 */   }
/* 28 */ }<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases parallel-blocks-?-complicated-parallel-blocks-simultaneous-parallel-blocks-1
//:: verdict Pass
//:: tools silicon
class Test {
    /* 1  */ context_everywhere a != null &amp;&amp; b != null &amp;&amp; c != null;
    /* 2  */ context_everywhere a.length == size &amp;&amp; b.length == size &amp;&amp; c.length == size; 
    /* 3  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(a[i], write));
    /* 4  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(b[i], write));
    /* 5  */ context (\forall* int i; i &gt;= 0 &amp;&amp;  i &lt; size; Perm(c[i], write));
    /* 6  */ ensures (\forall int i; i &gt;= 0 &amp;&amp;  i &lt; size; a[i] == \old(a[i]) + 1 &amp;&amp; b[i] == \old(b[i]) + 1 &amp;&amp; 
    /* 7  */                                              c[i] == \old(c[i]) + 1);
    /* 8  */ void simPar(int[] a, int[] b, int[] c, int size){
    /* 9  */
    /* 10 */   par thread1 (int tid1 = 0 .. size)
    /* 11 */    context Perm(a[tid1], write);
    /* 12 */    ensures a[tid1] == \old(a[tid1]) + 1;
    /* 13 */   {
    /* 14 */     a[tid1] = a[tid1] + 1; 
    /* 15 */   } and
    /* 16 */   thread2 (int tid2 = 0 .. size)
    /* 17 */    context Perm(b[tid2], write);
    /* 18 */    ensures b[tid2] == \old(b[tid2]) + 1;
    /* 19 */   {
    /* 20 */     b[tid2] = b[tid2] + 1;
    /* 21 */   } and
    /* 22 */   thread3 (int tid3 = 0 .. size)
    /* 23 */    context Perm(c[tid3], write);
    /* 24 */    ensures c[tid3] == \old(c[tid3]) + 1;
    /* 25 */   {
    /* 26 */     c[tid3] = c[tid3] + 1;
    /* 27 */   }
    /* 28 */ }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>As we can see we use "<em>and</em>" between each parallel block
(lines 15 and 21) to define simultaneous parallel blocks. This
construction can be used in a situation where we decide to run
simultaneous instructions. That means, we do not define threads in the
parallel blocks, but the par blocks run simultaneously. Below is an
example in this situation where "<em>a</em>", "<em>b</em>" and
"<em>c</em>" are objects included a field "<em>val</em>":</p>
<!-- test -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class HasVal {
    int val;
}

class Main {
    context Perm(a.val, write) ** Perm(b.val, write) ** Perm(c.val, write);
    ensures a.val == \old(a.val) + 1 &amp;&amp; b.val == \old(b.val) + 1 &amp;&amp; c.val == \old(c.val) + 1;                                            
    void IncPar(HasVal a, HasVal b, HasVal c){
      par 
       context Perm(a.val, write);
       ensures a.val == \old(a.val) + 1;
      {
        a.val = a.val + 1; 
      } and
       context Perm(b.val, write);
       ensures b.val == \old(b.val) + 1;
      {
        b.val = b.val + 1;
      } and
       context Perm(c.val, write);
       ensures c.val == \old(c.val) + 1;
      {
        c.val = c.val + 1;
      }
    }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases parallel-blocks-?-complicated-parallel-blocks-simultaneous-parallel-blocks-2
//:: verdict Pass
//:: tools silicon
class HasVal {
    int val;
}

class Main {
    context Perm(a.val, write) ** Perm(b.val, write) ** Perm(c.val, write);
    ensures a.val == \old(a.val) + 1 &amp;&amp; b.val == \old(b.val) + 1 &amp;&amp; c.val == \old(c.val) + 1;                                            
    void IncPar(HasVal a, HasVal b, HasVal c){
      par 
       context Perm(a.val, write);
       ensures a.val == \old(a.val) + 1;
      {
        a.val = a.val + 1; 
      } and
       context Perm(b.val, write);
       ensures b.val == \old(b.val) + 1;
      {
        b.val = b.val + 1;
      } and
       context Perm(c.val, write);
       ensures c.val == \old(c.val) + 1;
      {
        c.val = c.val + 1;
      }
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>In the above example, for each object we increase its "<em>val</em>"
by one in parallel. As we can see, thread blocks are without names and
thread identifiers in this case.</p>
<h1 id="atomics-and-locks">Atomics and Locks</h1>
<p>VerCors supports three forms of synchronization primitives. Two can
only be used in PVL: built-in locks, and atomics. One can only be used
in Java: the <code>synchronized</code> block. Each form will be
discussed individually in the next sections.</p>
<p>Warning: at the time of writing, VerCors supports only non-reentrant
locks. This means locking twice in a row is unsound, which could have
implications for code that uses Java's <code>synchronized</code>. See
the caveats section at the end of this document for more info.</p>
<h2 id="pvl-built-in-locks">PVL: Built-in locks</h2>
<p>Using built-in locks in PVL consists of the following parts:</p>
<ul>
<li>Lock invariant, which describes the resources that the lock
guards</li>
<li>The <code>lock</code> statement</li>
<li>The <code>unlock</code> statement</li>
<li>The <code>commit</code> statement and <code>committed(l)</code>
expression, which indicate whether or not a lock is initialized.</li>
</ul>
<h3 id="lock-invariant">Lock invariant</h3>
<p>A lock invariant can be defined for a class with the following
syntax:</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">lock_invariant true /* or: resource expression involving permissions and boolean assertions */;
class C {

}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases atomics-and-locks-pvl-built-in-locks-lock-invariant-1
//:: verdict Pass
//:: tools silicon
lock_invariant true /* or: resource expression involving permissions and boolean assertions */;
class C {

}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Because a lock invariant is defined for a class, it is always related
to a specific class instance. Therefore, it is possible to make
assertions about instance fields in the lock invariant. For example, a
lock invariant could be specified that contains the permissions for a
field, and also the fact that that field must have a value greater than
10, using the following syntax:</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">lock_invariant Perm(f, write) ** f &gt; 10;
class C {
    int f;

    constructor() {
        f = 11;
        // Lock invariant must hold here!
    }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases atomics-and-locks-pvl-built-in-locks-lock-invariant-2
//:: verdict Pass
//:: tools silicon
lock_invariant Perm(f, write) ** f &gt; 10;
class C {
    int f;

    constructor() {
        f = 11;
        // Lock invariant must hold here!
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>The lock invariant must hold at the end of the constructor. If
VerCors cannot prove this, the program will be rejected.</p>
<p>Using Java terminology, in the above example the field <code>f</code>
is "guarded" by the built-in lock of the object that has the field
<code>f</code>. That is, to write permission for <code>this.f</code>,
and hence access to <code>this.f</code>, first the lock on
<code>this</code> needs to be acquired. This is done using the
<code>lock</code> statement, which is described in the next section.</p>
<h3 id="lock-statement"><code>lock</code> statement</h3>
<p>The lock statement has the following syntax:</p>
<!-- standaloneSnip onlyLockStatement
lock_invariant true;
class C {
    void m(C o) {
-->

<!-- codeSnip onlyLockStatement -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">lock o;<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >lock_invariant true;
class C {
void m(C o) {
lock o;} }
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<!-- standaloneSnip onlyLockStatement
} }
-->

<p>Where <code>o</code> can be an arbitrary expression. The only
constraint is that <code>o</code> is not <code>null</code>. The default
lock invariant for a class is <code>true</code>, so by default
<code>lock o</code> does not give you extra information, until a
<code>lock_invariant</code> is specified.</p>
<p>The lock statement ensures that only one thread at a time can lock on
an object. Once the lock has been acquired, the lock invariant of the
object <code>o</code> may be assumed. For example, after the
<code>lock</code> statement, often fields of the object <code>o</code>
can be accessed or written to. For example, consider the code snippet
below. It is similar to the previous example, with the addition of an
increment method:</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">lock_invariant Perm(f, write);
class C {
    int f;

    requires committed(this);
    void increment() {
        lock this;
        assert Perm(f, write);
        f = f + 1;
    }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases atomics-and-locks-pvl-built-in-locks-lock-statement-1
//:: verdict Pass
//:: tools silicon
lock_invariant Perm(f, write);
class C {
    int f;

    requires committed(this);
    void increment() {
        lock this;
        assert Perm(f, write);
        f = f + 1;
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Notice how the lock is acquired before <code>f</code> is incremented.
Because after lock statement the lock invariant may be assumed, this
ensures the thread that is executing <code>increment</code> has
<code>write</code> permission for <code>f</code>, which in turn allows
reading and writing to <code>f</code>. Additionally, this excludes any
data races on <code>f</code>, as the thread that has the lock will be
the only thread currently incrementing <code>f</code>. We will explain
the <code>committed</code> annotation shortly.</p>
<p>The above example is still incomplete: when <code>f</code> has been
incremented, the lock should be unlocked again. This is done with the
<code>unlock</code> statement, which we describe next.</p>
<h3 id="unlock-statement"><code>unlock</code> statement</h3>
<p>The unlock statement has the following syntax:</p>
<pre class="pvl"><code>unlock o;</code></pre>
<p>Similar to the <code>lock</code> statement, <code>o</code> must be
non-null.</p>
<p>The <code>unlock</code> statement behaves as the inverse of the
<code>lock</code> statement. For the program to progress beyond
<code>unlock</code>, the lock invariant must be re-established. If this
is not possible, VerCors will reject the program. If the lock invariant
can be re-established, the lock is unlocked, and the program proceeds.
Because the lock is now unlocked, other threads can lock it, and gain
access to the resources protected by the lock.</p>
<p>In the code snippet, the previous code snippet is completed with the
missing <code>unlock</code> statement:</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">lock_invariant Perm(f, write);
class C {
    int f;

    requires committed(this);
    void increment() {
        lock this;
        assert Perm(f, write);
        f = f + 1;
        unlock this;
    }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases atomics-and-locks-pvl-built-in-locks-unlock-statement-1
//:: verdict Pass
//:: tools silicon
lock_invariant Perm(f, write);
class C {
    int f;

    requires committed(this);
    void increment() {
        lock this;
        assert Perm(f, write);
        f = f + 1;
        unlock this;
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Because the only thing we did between <code>lock</code> and
<code>unlock</code> was increment <code>f</code>, the write permission
for <code>f</code> is still available, and hence VerCors can trivially
prove that the lock invariant can be re-established. Hence, this example
verifies.</p>
<h3 id="commit-statement"><code>commit</code> statement</h3>
<p>Before a lock can be locked, it must be initialized. In VerCors, a
lock is initialized when it is "committed". This is done using the
<code>commit e;</code> statement. The lock must be committed before the
end of the constructor. After any <code>commit e;</code> statement, the
expression <code>committed(e)</code> is guaranteed to be true.</p>
<p>In the following example, the lock invariant of <code>C</code>
requires permission for the field <code>f</code>, and that
<code>f</code> has value 3. The constructor writes 3 to <code>f</code>,
and then commits the invariant. This ensures that the
<code>tryLock</code> method can lock on a newly created object of type
<code>C</code>. Without the <code>commit</code> statement, an error
would occur. In addition, the postcondition contains
<code>committed(this)</code>, to indicate that after the constructor the
new object is lockable.</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">lock_invariant Perm(f, 1) ** f == 3;
class C {
  int f;

  ensures committed(this);
  constructor() {
    f = 3;
    commit this;
    assert committed(this);
  }
}

void tryLock() {
  C c = new C();
  lock c;
  assert Perm(c.f, 1) ** c.f == 3;
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases atomics-and-locks-pvl-built-in-locks-commit-statement-1
//:: verdict Pass
//:: tools silicon
lock_invariant Perm(f, 1) ** f == 3;
class C {
  int f;

  ensures committed(this);
  constructor() {
    f = 3;
    commit this;
    assert committed(this);
  }
}

void tryLock() {
  C c = new C();
  lock c;
  assert Perm(c.f, 1) ** c.f == 3;
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="built-in-lock-caveats">Built-in lock: caveats</h3>
<p>There are several caveats to look out for when using built-in locks
in PVL.</p>
<h4 id="avoid-locking-a-lock-twice">Avoid: locking a lock twice</h4>
<p>PVL locks are non-reentrant: locking a lock twice, without unlocking
the lock inbetween, will result in a deadlock. VerCors does not warn
about this situation if it occurs. Hence, it needs to be checked
manually that this situation does not occur.</p>
<h4 id="avoid-deadlocking-interleavings">Avoid: deadlocking
interleavings</h4>
<p>Deadlocks can occur when using multiple locks. For example, consider
a situation with two locks, <code>l1</code> and <code>l2</code>. Process
A first locks <code>l1</code>, and then tries to acquire
<code>l2</code>. Process B locks <code>l2</code>, and then tries to
acquire <code>l1</code>. Since built-in locks in PVL are blocking, this
interleaving will deadlock. VerCors does not warn about this situation
if it occurs. Hence, it needs to be checked manually that this situation
does not occur, because it can otherwise allow unsoundness to occur.</p>
<h2 id="pvl-atomics">PVL: Atomics</h2>
<p>For this section, we assume you are familiar with the concept of
"lock invariant", as introduced int the previous section.</p>
<p>Atomics in PVL are used through two statements: the
<code>invariant</code> statement and the <code>atomic</code> statement.
We will discuss them separately.</p>
<h4 id="invariant-block"><code>invariant</code> block</h4>
<p>The syntax of the <code>invariant</code> block is as follows:</p>
<!-- testBlock Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">invariant invName(true) {
    // ...
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases atomics-and-locks-pvl-atomics-?-invariant-block-1
//:: verdict Pass
//:: tools silicon
class Test {
    void test() {
        invariant invName(true) {
            // ...
        }
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>An invariant block consists of the keyword <code>invariant</code>,
then a name, and finally an expression that is the atomic invariant of
the block. The invariant block may only occur in methods or procedures,
and may be nested, provided that the names of each invariant block are
unique.</p>
<p>The invariant block will ensure that the atomic invariant holds at
the beginning of the block. Inside the invariant block, you will not
have access to the atomic invariant, as it is removed from the state at
the beginning of the invariant block. You can get access to the atomic
invariant using the <code>atomic</code> block, which is explained in the
next section. After the invariant block, the atomic invariant may be
assumed again.</p>
<h4 id="atomic-block"><code>atomic</code> block</h4>
<p>The syntax of the <code>atomic</code> block is as follows:</p>
<!-- standaloneSnip onlyAtomicBlock
class C {
    void m() {
        invariant invName(true) {
-->

<!-- codeSnip onlyAtomicBlock -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">atomic(invName) {
    // ...
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >class C {
void m() {
invariant invName(true) {
atomic(invName) {
    // ...
}} } }
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<!-- standaloneSnip onlyAtomicBlock
} } }
-->

<p>The atomic block consists of the keyword <code>atomic</code>,
followed by the name of the invariant the atomic block synchronizes on.
The atomic block may only occur in methods or procedures, may not be
nested, and the invariant that is referred to must enclose the atomic
block.</p>
<p>The atomic block will ensure only one thread at a time will
synchronize on the invariant. At the beginning of the atomic block, the
atomic invariant is assumed. At any point in the atomic block, this
atomic invariant can be used and broken. Finally, when the program exits
the atomic block, the atomic invariant needs to be re-established. If
VerCors cannot prove that this is always possible, VerCors will reject
the program and verification will fail.</p>
<p>The atomic block is similar to the lock invariant and
<code>lock</code>/<code>unlock</code> statements, with two subtle
differences:</p>
<ol type="1">
<li>The synchronization done by the atomic block is scoped, so unlocking
is done automatically.</li>
<li>Declaration of the invariant is done at the method level, instead of
at the class level.</li>
</ol>
<h2 id="java-synchronized">Java: synchronized</h2>
<p>The <code>synchronized</code> statement allows you to work with lock
invariants in Java. It is a combination of built-in locks from PVL, and
atomics from PVL, which are both explained in previous sections.
Specifically, VerCors supports the lock invariant syntax for Java
classes, and <code>synchronized</code> blocks work almost identically to
atomic blocks. Both concepts will be discussed in the next sections.</p>
<h3 id="java-lock-invariants">Java: lock invariants</h3>
<p>VerCors supports the lock invariant syntax for Java classes. The
syntax is as follows:</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ lock_invariant true;
class C  {
    C() {
        // Lock invariant is established here!
    }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases atomics-and-locks-java-synchronized-java-lock-invariants-1
//:: verdict Pass
//:: tools silicon
//@ lock_invariant true;
class C  {
    C() {
        // Lock invariant is established here!
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Notice how the syntax is identical to the PVL syntax, except that it
must now be placed in ghost code, as indicated by the <code>//@</code>
marker. In the above example the trivial lock invariant
<code>true</code> is used, but in principle the lock invariant can
contain the same things as in PVL: permissions about fields, arrays, and
properties about those fields and arrays.</p>
<p>The lock invariant has to hold at the end of a constructor, otherwise
verification will fail. The lock invariant is assumed at the beginning
of <code>synchronized</code> blocks, and has to be re-established at the
end of synchronized blocks. If it cannot be re-established, VerCors will
reject the program and verification will fail.</p>
<h3 id="java-synchronized-block">Java: synchronized block</h3>
<p>VerCors supports Java's syntax for synchronized blocks. The syntax is
as follows:</p>
<!-- standaloneSnip onlySynchronizedBlock
//@ lock_invariant true;
class C {
    void m() {
        Object expr = this;
-->

<!-- codeSnip onlySynchronizedBlock -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">synchronized (expr) {
    // ...
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//@ lock_invariant true;
class C {
void m() {
Object expr = this;
synchronized (expr) {
    // ...
}} }
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<!-- standaloneSnip onlySynchronizedBlock
} }
-->

<p>Note the similarity to the <code>atomic</code> block statement. The
only requirement is that <code>expr</code> is non-null and of type
class. If no lock invariant is specified on the class, the default
invariant <code>true</code> will be used.</p>
<p>The only additional behaviour of the <code>synchronized</code> expr
is that it accounts for exceptions. That is, when an exception is thrown
before the end of the synchronized block, the lock is still closed, and
hence the lock invariant still needs to be re-established.</p>
<h3 id="caveats">Caveats</h3>
<p>There are some caveats to verifying Java locks in VerCors.</p>
<h4 id="avoid-locking-in-the-constructor">Avoid: locking in the
constructor</h4>
<p>Similar to PVL, VerCors does not allow locking on an object before
the lock invariant is established. However, VerCors does not check for
this, so the user must manually ensure that this does not occur.</p>
<h4 id="avoid-locking-on-an-object-twice">Avoid: locking on an object
twice</h4>
<p>Similar to PVL, VerCors models Java's locks as single-entrant locks.
This is inaccurate, as Java's locks are actually re-entrant. We are
working on improving this, but this is currently not yet implemented.
Therefore, users have to take care that locking twice on a single object
does not occur. If it does occur, it might cause unsoundness.</p>
<h4 id="avoid-deadlocking-interleavings-1">Avoid: deadlocking
interleavings</h4>
<p>Some interleaving of <code>synchronized</code> locking sequences
might deadlock. VerCors does not warn, nor check for this. Therefore, it
is the user's responsibility to ensure that this does not occur.</p>
<h1 id="process-algebra-models">Process Algebra Models</h1>
<p>Process Algebra Models allow users to specify processes in PVL
programs. PVL programs must then be annotated to indicate which
locations in the program correspond to transitions in the process model.
Properties specified in the process model may be assumed by VerCors at
the locations in the program, provided that these properties of the
process model are proven using an external tool, such as the model
checker mCRL2.</p>
<p>Support for checking if a PVL program adheres to a process model is
automatic, and implemented in VerCors 1.4.0. Checking if a process model
adheres to the specified properties can be automated, but currently is
not, and hence has to be done manually.</p>
<p>For the theoretical background on Process Algebra Models, we refer
the reader to Wytse Oortwijn's PhD thesis: <a
href="https://doi.org/10.3990/1.9789036548984">https://doi.org/10.3990/1.9789036548984</a>.</p>
<p>For more practical sources, we refer the reader to the following
urls:</p>
<ol type="1">
<li><a
href="https://github.com/wytseoortwijn/SupplementaryMaterialsThesis">https://github.com/wytseoortwijn/SupplementaryMaterialsThesis</a>:
The repository of supplementary materials of Wytse Oortwijn's PhD
thesis</li>
<li><a
href="https://github.com/wytseoortwijn/csl-abstractions">https://github.com/wytseoortwijn/csl-abstractions</a>:
Supplementary materials of "An Abstraction Technique for Verifying
Shared-Memory Concurrency", which is a generalisation of chapter 5 of
Wytse Oortwijn's PhD thesis</li>
<li>The VerCors example directory:
<ul>
<li><a
href="https://github.com/utwente-fmt/vercors/tree/dev/examples/futures">https://github.com/utwente-fmt/vercors/tree/dev/examples/futures</a></li>
<li><a
href="https://github.com/utwente-fmt/vercors/tree/dev/examples/known-problems/futures">https://github.com/utwente-fmt/vercors/tree/dev/examples/known-problems/futures</a></li>
</ul></li>
</ol>
<p>For any aspects not covered by the above summary, please contact the
VerCors team.</p>
<h1 id="predicates">Predicates</h1>
<!-- 
* Why predicates?
  * Permissions are useful for indicating access rights and modifications to data
  * But this leaks implementation details
  * Consider the following example
    * It is clear that the counter class modifies some internal state to the client
    * But when the counter changes implementation, client code will have to be modified as well
  * It is desirable that permissions are managed such that client code does not depend on irrelevant details
  * Predicates allow this.
* Predicate syntax and usage
  * A predicate is defined as follows
    * Consists of arguments and a body where arguments can be used
  * To gain a predicate, the contents of the body must be exchanged for a predicate instance
    * This is called "folding"
  * A predicate can also be "unfolded"
    * This exchanges a predicate instance for its body
* Previous example, with predicates
  * Note how the counter class is now free to change its internal composition
  * Only relevant details are exposed through the predicate
    * In this case, the value of the counter
* Reserved/internal predicates
  * ```lock_invariant```
    * See atomics/locks
  * Threads
    * held, idle, running
    * See PVL-Syntax
* Advanced usage
  * Recursive predicates
  * Scaling & splitting
  * Inline predicates
  * Inheritance
* Known problems
  * Using predicates in while loops
-->

<p>This section discusses syntax and semantics of predicates. First a
motivating example is given why predicates are needed. Then an overview
is given of the syntax and semantics of predicates. The introductory
example is then rewritten using predicates. Finally, we discuss some
internal and reserved predicates, and finish this part of the tutorial
with a brief overview of advanced usages of predicates and known
problems.</p>
<p>In this section, the language used for the code examples is Java.
However, the concepts presented apply to PVL as well.</p>
<h2 id="why-predicates">Why predicates?</h2>
<p>Permissions are useful for indicating access rights and modifications
to data. But, adding permissions to private members in the contract
leaks implementation details. Consider the following example:</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Counter {
  int count;
  
  //@ context Perm(count, write);
  //@ ensures count == \old(count) + n;
  void increment(int n);
}

class MyProgram {
  //@ requires c != null;
  //@ requires Perm(c.count, write);
  //@ requires c.count == 0;
  void foo(Counter c) {
    //@ assert c.count == 0;
    c.increment(2);
    //@ assert c.count == 2;
  }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-why-predicates-1
//:: verdict Pass
//:: tools silicon
class Counter {
  int count;
  
  //@ context Perm(count, write);
  //@ ensures count == \old(count) + n;
  void increment(int n);
}

class MyProgram {
  //@ requires c != null;
  //@ requires Perm(c.count, write);
  //@ requires c.count == 0;
  void foo(Counter c) {
    //@ assert c.count == 0;
    c.increment(2);
    //@ assert c.count == 2;
  }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>It is clear from the contract of <code>increment</code> that it
modifies the internal state of the <code>Counter</code> object.
Therefore, when <code>Counter</code> changes its internal layout, client
code will have to be modified as well. For example, if in the previous
example <code>Counter</code> adds some internal field, the client code
will also have to be changed. This is shown in the next example:</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class CounterExtended {
  int count;
  int numIncrements;
  
  //@ context Perm(count, write) ** Perm(numIncrements, write);
  //@ ensures count == \old(count) + n;
  //@ ensures numIncrements == \old(numIncrements) + 1;
  void increment(int n);
}

class MyProgram {
  //@ requires c != null;
  //@ requires Perm(c.count, write) ** Perm(c.numIncrements, write);
  //@ requires c.count == 0;
  void foo(CounterExtended c) {
    //@ assert c.count == 0;
    c.increment(2);
    //@ assert c.count == 2;
  }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-why-predicates-2
//:: verdict Pass
//:: tools silicon
class CounterExtended {
  int count;
  int numIncrements;
  
  //@ context Perm(count, write) ** Perm(numIncrements, write);
  //@ ensures count == \old(count) + n;
  //@ ensures numIncrements == \old(numIncrements) + 1;
  void increment(int n);
}

class MyProgram {
  //@ requires c != null;
  //@ requires Perm(c.count, write) ** Perm(c.numIncrements, write);
  //@ requires c.count == 0;
  void foo(CounterExtended c) {
    //@ assert c.count == 0;
    c.increment(2);
    //@ assert c.count == 2;
  }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>It is desirable that permissions are managed such that client code
does not depend on irrelevant details, to avoid this rippling effect of
modifications. Predicates help with this.</p>
<h2 id="predicate-syntax-and-usage">Predicate syntax and usage</h2>
<p>A predicate is declared as follows:</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">//@ resource myPredicate(int a, bool b, ...) = body;</span></span></code></pre></div>
<p>A predicate consists of the name of the predicate, zero or more
arguments, and a body where arguments can be used. In Java, the
declaration must be written as a verification annotation (e.g. using
<code>//@</code>). In PVL, it is a plain declaration.</p>
<p>One can think of a predicate as a function returning type
<code>resource</code>, similar to how a permission (<code>Perm</code>)
is a <code>resource</code>. Except that, predicates are never called,
but created and destroyed using unfold and folds. We will explain this
next.</p>
<p>To create a predicate instance, the contents of the predicate body
must be exchanged for a predicate instance. This is called "folding".
Specifically, folding a predicate means any permissions present in the
predicate body are removed from the program state. In return, an
instance of the predicate is added to the state. In the following
example folding is shown. The method <code>foo</code> receives a
permission for the field <code>x</code>. At the end of the method, the
permission for this field <code>x</code> has been exchanged for an
instance of the predicate <code>state</code>. Note how the permission
for <code>x</code> and the predicate <code>state</code> are mutually
exclusive: both cannot be in the program state simultaneously.</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">int x;

//@ resource state(int val) = Perm(x, write) ** x == val;

//@ requires Perm(x, write) ** x == n;
//@ ensures state(n);
void foo(int n) {
    // Now we have Perm(x, write).
    //@ fold state(n);
    // Now Perm(x, write) is gone, but state(n) is present.
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-predicate-syntax-and-usage-1
//:: verdict Pass
//:: tools silicon
final class Test {
    int x;
    
    //@ resource state(int val) = Perm(x, write) ** x == val;
    
    //@ requires Perm(x, write) ** x == n;
    //@ ensures state(n);
    void foo(int n) {
        // Now we have Perm(x, write).
        //@ fold state(n);
        // Now Perm(x, write) is gone, but state(n) is present.
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>A predicate can also be "unfolded". This exchanges a predicate
instance for its body.</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">int x;

//@ resource state(int val) = Perm(x, write) ** x == val;

//@ requires state(n);
//@ ensures Perm(x, write) ** x == n;
void foo(int n) {
    // Now we have state(n);
    //@ unfold state(n);
    // Now state(n) is gone, but Perm(x, write) is present.
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-predicate-syntax-and-usage-2
//:: verdict Pass
//:: tools silicon
final class Test {
    int x;
    
    //@ resource state(int val) = Perm(x, write) ** x == val;
    
    //@ requires state(n);
    //@ ensures Perm(x, write) ** x == n;
    void foo(int n) {
        // Now we have state(n);
        //@ unfold state(n);
        // Now state(n) is gone, but Perm(x, write) is present.
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>The previous two examples also show that fields of the current class
can be used in the predicate body. This is because a predicate instance
is implicitly bound to an instance of the class it is defined in. The
following example verifies, because the <code>this</code> part of the
predicate instance is implicit. It also shows how to name predicates on
objects other than <code>this</code>.</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">final class Cell {
    int x;

    //@ resource state(int val) = Perm(x, write) ** x == val;

    // &#34;this&#34; is implicit:
    //@ requires this.state(n);
    //@ ensures state(n);
    void foo(int n) {

    }

    // Predicates can appear on distinct objects too:
    //@ given int n;
    //@ given int m;
    //@ context other.state(m);
    //@ requires state(n);
    //@ ensures state(n+m);
    void combine(Cell other) {
        //@ unfold state(n);
        //@ unfold other.state(m);
        x += other.x;
        //@ fold other.state(m);
        //@ fold state(n+m);
    }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-predicate-syntax-and-usage-3
//:: verdict Pass
//:: tools silicon
final class Cell {
    int x;

    //@ resource state(int val) = Perm(x, write) ** x == val;

    // &#34;this&#34; is implicit:
    //@ requires this.state(n);
    //@ ensures state(n);
    void foo(int n) {

    }

    // Predicates can appear on distinct objects too:
    //@ given int n;
    //@ given int m;
    //@ context other.state(m);
    //@ requires state(n);
    //@ ensures state(n+m);
    void combine(Cell other) {
        //@ unfold state(n);
        //@ unfold other.state(m);
        x += other.x;
        //@ fold other.state(m);
        //@ fold state(n+m);
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Predicates can be used anywhere <code>Perm</code> can be used, and
hence must also be composed using the separating conjunction
(<code>**</code>) operator.</p>
<h2 id="the-counter-example-now-with-predicates">The
<code>Counter</code> example, now with predicates</h2>
<p>In the next snippet we redefine the <code>Counter</code> class to use
predicates, instead of plain permissions:</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class Counter {
  int count;

  //@ resource state(int val) = Perm(count, write) ** count == val;
  
  //@ given int oldCount;
  //@ requires state(oldCount);
  //@ ensures state(oldCount + n);
  void increment(int n);
}

class MyProgram {
  //@ requires c != null ** c.state(0);
  //@ ensures c.state(2);
  void foo(Counter c) {
    //@ assert c.state(0);
    c.increment(2) /*@ with { oldCount = 0; } @*/;
    //@ assert c.state(2);
  }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-the-counter-example-now-with-predicates-1
//:: verdict Pass
//:: tools silicon
class Counter {
  int count;

  //@ resource state(int val) = Perm(count, write) ** count == val;
  
  //@ given int oldCount;
  //@ requires state(oldCount);
  //@ ensures state(oldCount + n);
  void increment(int n);
}

class MyProgram {
  //@ requires c != null ** c.state(0);
  //@ ensures c.state(2);
  void foo(Counter c) {
    //@ assert c.state(0);
    c.increment(2) /*@ with { oldCount = 0; } @*/;
    //@ assert c.state(2);
  }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>The client only uses the predicate when expressing how it manipulates
the counter. Therefore, the counter class is now free to change its
internal composition without affecting any of its clients. This is
possible because only relevant details are exposed through the
predicate. In this case, this is the value of the counter. For example,
adding a plain field does not break the client.</p>
<p>If the interface of <code>Counter</code> changes, the client code
will have to change too. However, the client code does not have to
manage any extra permissions: it only has to specify how it uses the
interface from <code>CounterExtended</code>. The next example shows
this.</p>
<!-- test Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">class CounterExtended {
  int count;
  int numIncrements;

  /*@ resource state(int val, int val2) = Perm(count, write) ** count == val 
        ** Perm(numIncrements, write) ** numIncrements == val2;
    @*/
  
  //@ given int oldCount;
  //@ given int oldIncrements;
  //@ requires state(oldCount, oldIncrements);
  //@ ensures state(oldCount + n, oldIncrements + 1);
  void increment(int n);
}

class MyProgram {
  //@ given int oldIncrements;
  //@ requires c != null ** c.state(0, oldIncrements);
  //@ ensures c.state(2, oldIncrements + 1);
  void foo(CounterExtended c) {
    //@ assert c.state(0, oldIncrements);
    c.increment(2) /*@ with { oldCount = 0; oldIncrements = oldIncrements; } @*/;
    //@ assert c.state(2, oldIncrements + 1);
  }
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-the-counter-example-now-with-predicates-2
//:: verdict Pass
//:: tools silicon
class CounterExtended {
  int count;
  int numIncrements;

  /*@ resource state(int val, int val2) = Perm(count, write) ** count == val 
        ** Perm(numIncrements, write) ** numIncrements == val2;
    @*/
  
  //@ given int oldCount;
  //@ given int oldIncrements;
  //@ requires state(oldCount, oldIncrements);
  //@ ensures state(oldCount + n, oldIncrements + 1);
  void increment(int n);
}

class MyProgram {
  //@ given int oldIncrements;
  //@ requires c != null ** c.state(0, oldIncrements);
  //@ ensures c.state(2, oldIncrements + 1);
  void foo(CounterExtended c) {
    //@ assert c.state(0, oldIncrements);
    c.increment(2) /*@ with { oldCount = 0; oldIncrements = oldIncrements; } @*/;
    //@ assert c.state(2, oldIncrements + 1);
  }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>To summarise, predicates are very effective at hiding implementation
details. They allow encapsulation. However, predicates do not protect
the client from breaking changes. If the interface changes, any clients
will have to change too.</p>
<h2 id="reservedinternal-predicates">Reserved/internal predicates</h2>
<p>There are a few situations where VerCors attaches special meanings to
certain predicate names.</p>
<h3 id="for-atomicslocks">For atomics/locks</h3>
<p>For atomics and locks a predicate <code>lock_invariant</code> is
defined. This predicate cannot be folded/unfolded, and has to be
manipulated through locking and unlocking.</p>
<p>Additionally, it can be checked if a lock is currently held through
the <code>held(x)</code> syntax. <code>held</code> is in this case
effectively a predicate that cannot be unfolded. Therefore, any
semantics and techniques for manipulating predicates discussed in this
part of the tutorial can be applied to <code>held</code>, such as
splitting and scaling, except for folding and unfolding.</p>
<p>For more information, see the <a
href="https://github.com/utwente-fmt/vercors/wiki/Atomics-and-Locks">Atomics
and Locks</a> section.</p>
<h3 id="threads">Threads</h3>
<p>A thread can be in several states, such as idle and running. The
syntax for this is <code>idle(thread)</code> and
<code>running(thread)</code>. <code>idle</code> and <code>running</code>
are effectively predicates that cannot be unfolded. Therefore, any
semantics and techniques for manipulating predicates discussed in this
part of the tutorial can be applied to <code>held</code> (such as
splitting and scaling).</p>
<p>See the <a
href="https://github.com/utwente-fmt/vercors/wiki/PVL-Syntax-Reference">PVL
Syntax Reference</a> section for more details.</p>
<h2 id="advanced-usage-of-predicates">Advanced usage of predicates</h2>
<h3
id="unfolding-predicates-within-expressions-using-unfolding">Unfolding
predicates within expressions using <code>\unfolding</code></h3>
<p>Sometimes it is necessary to briefly open a predicate within an
expression, for example, to temporarily gain access to a field. This can
be achieved using the <code>\unfolding</code> operator. It has the
following concrete syntax:</p>
<pre><code>\unfolding myPredicate(arg1, arg2, ...) \in expression</code></pre>
<p>It takes the instance of the predicate that needs unfolding, followed
by <code>\in</code>, and then an expression in which the predicate must
be unfolded. After evaluating the internal expression, the predicate is
folded again, without any changes to the predicate or the program state.
For Java, the alternative syntax is <code>\Unfolding</code> (notice the
capital U), since <code>\unfolding</code> causes a compiler error.</p>
<p>Below is an example usage of <code>\unfolding</code> in a
<code>Cell</code> class where the predicate does not have a parameter
for the value inside the <code>Cell</code>. To work around this,
<code>\unfolding</code> is used.</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Cell <span class="op">{</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">//@ ensures state() ** \unfolding state() \in x == 0;</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Cell</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//@ fold state();</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">//@ resource state() = Perm(x, write);</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> x<span class="op">;</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  Cell c <span class="op">=</span> <span class="kw">new</span> <span class="fu">Cell</span><span class="op">();</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">//@ assert \unfolding c.state() \in c.x == 0;</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="recursive-predicates">Recursive predicates</h3>
<p>Predicates can directly and indirectly recurse without problems,
provided they are not <code>inline</code>. This can be used to for
example model permissions over data structures with a size that cannot
be known statically, such as a linked list. In the below code example,
an instance of <code>state</code> predicate of the class
<code>LinkedListNode</code> contains the permission for one field, as
well as permissions for all fields of the tail of the list.
Additionally, the argument of the <code>state</code> predicate reflects
the numbers stored in the linked list.</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LinkedListNode <span class="op">{</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">//@ resource state(seq&lt;int&gt; data) = Perm(v, write) ** Perm(next, write) ** v == data[0] ** (next != null ==&gt; next.state(tail(data)));</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> v<span class="op">;</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  LinkedListNode next<span class="op">;</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="scaling--splitting">Scaling &amp; splitting</h3>
<p>VerCors offers syntax to specify fractions of predicates, similar to
how permissions can be specified in fractions. This can be useful to,
for example, allow one half of a state predicate to be passed to one
thread, and one to another. For a predicate <code>state(args)</code> on
a variable <code>x</code>, the syntax for specifying a fraction
<code>f</code> of the predicate is: <code>[f]x.state(args)</code>. The
code below shows an example of how scaling can be used.</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Cell <span class="op">{</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">//@ ensures state(0);</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Cell</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//@ fold state(0);</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">//@ resource state(int v) = Perm(x, write) ** v == x;</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> x<span class="op">;</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co">//@ requires [1\2]c.state(0);</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">startThread</span><span class="op">(</span>Cell c<span class="op">);</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  Cell c <span class="op">=</span> <span class="kw">new</span> <span class="fu">Cell</span><span class="op">();</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Constructing a cell yields a state predicate</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">//@ assert c.state(0);</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// We can split this into fractions of a predicate</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">//@ assert [1\2]c.state(0) ** [1\2]c.state(0);</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// startThread will claim half of the predicate</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">startThread</span><span class="op">(</span>c<span class="op">);</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// The other half can be used for something else</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">//@ assert [1\2]c.state(0);</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="inline-predicates">Inline predicates</h3>
<p>Predicates can be given the <code>inline</code> attribute:</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> C <span class="op">{</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">//@ inline resource state() = Perm(x, write);</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> x<span class="op">;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If the <code>inline</code> attribute is given to a predicate, VerCors
will inline the definition of that predicate wherever the predicate
occurs. This means that the following code snippet:</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">//@ requires c.state();</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">foo</span><span class="op">(</span>C c<span class="op">)</span> <span class="op">{</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">//@ assert c.state();</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Is equal to:</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">//@ requires Perm(c.x, write);</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">foo</span><span class="op">(</span>C c<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">//@ assert Perm(c.x, write);</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Because of this inlining semantics, <code>inline</code> predicates
cannot be recursive. However, besides that limitation they are equal to
regular predicates, and hence support arguments and scaling.</p>
<p>Furthermore, because of this inlining semantics, folding and
unfolding inline predicates do not change the program state. However,
for the ease of flexibility, VerCors allows them, interpreting them as a
check for whether or not the contents of a predicate is present.</p>
<h3 id="inheritance">Inheritance</h3>
<p>Inheritance is not yet supported for predicates.</p>
<h3 id="thread-local-predicates">Thread-local predicates</h3>
<p>There is informal &amp; incomplete support for predicates with
thread-dependent resources. For this, the predicate must be defined with
the <code>thread_local</code> modifier. The <code>\current_thread</code>
keyword can be used inside <code>thread_local</code> predicates to get
the integer identifier of the current thread. This can be useful to
assign e.g. array indices to individual threads in a global manner.</p>
<p>To restrict the number of threads, and hence the possible values of
<code>\current_thread</code>, assumptions can be made. This can be done
either in preconditions, or in predicate bodies. For example, for some
<code>N</code>:</p>
<pre class="silver"><code>requires 0 &lt;= \current_thread &amp;&amp; \current_thread &lt; N;</code></pre>
<h2 id="known-problems">Known problems</h2>
<h3 id="vercors-crashes-when-predicates-are-unfolded">VerCors crashes
when predicates are unfolded</h3>
<p>When using predicates, VerCors might yield the following error:</p>
<pre><code>Verification aborted exceptionally: java.util.concurrent.ExecutionException: java.util.concurrent.ExecutionException: java.util.NoSuchElementException: None.get
  Cause: java.util.concurrent.ExecutionException: java.util.NoSuchElementException: None.get</code></pre>
<p>This is because the current implementation of Java inheritance in
VerCors is incomplete. There are two workarounds for this.</p>
<p>First, a predicate declaration can be marked as <code>final</code>.
This ensures that the inheritance-related logic in VerCors is not
applied to that predicate, which means it can be used as described in
this chapter. In the code below we show an example usage of this
workaround.</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">int x;

//@ final resource state(int val) = Perm(x, write) ** x == val;

//@ requires Perm(x, write) ** x == n;
//@ ensures state(n);
void foo(int n) {
    //@ fold state(n);
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-known-problems-vercors-crashes-when-predicates-are-unfolded-1
//:: verdict Pass
//:: tools silicon
final class Test {
    int x;
    
    //@ final resource state(int val) = Perm(x, write) ** x == val;
    
    //@ requires Perm(x, write) ** x == n;
    //@ ensures state(n);
    void foo(int n) {
        //@ fold state(n);
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Second, if a class has many predicates, or the first workaround does
not seem to work, the whole class can be marked as <code>final</code>.
This ensures the inheritance-related logic in VerCors is not applied to
the class at all.</p>
<p>Both workarounds do not change the semantics of Java code that does
not use inheritance.</p>
<p>Finally, if neither of the workarounds work, please file an
issue.</p>
<h3 id="interaction-between-loop-conditions-and-predicates">Interaction
between loop conditions and predicates</h3>
<p>Consider the following example:</p>
<!-- testMethod Fail -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ resource wrapX(int val) = Perm(x, write) ** x == val;
int x;

//@ requires wrapX(5);
void m() {
  //@ ghost int i = 5;

  //@ loop_invariant wrapX(i);
  //@ loop_invariant \unfolding wrapX(i) \in 5 &lt;= x &amp;&amp; x &lt;= 10;
  while (x &lt; 10) {
    //@ unfold wrapX(i);
    x++;
    //@ ghost i++;
    //@ fold wrapX(i);
  } 
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-known-problems-interaction-between-loop-conditions-and-predicates-1
//:: verdict Fail
//:: tools silicon
final class Test {
    //@ resource wrapX(int val) = Perm(x, write) ** x == val;
    int x;
    
    //@ requires wrapX(5);
    void m() {
      //@ ghost int i = 5;
    
      //@ loop_invariant wrapX(i);
      //@ loop_invariant \unfolding wrapX(i) \in 5 &lt;= x &amp;&amp; x &lt;= 10;
      while (x &lt; 10) {
        //@ unfold wrapX(i);
        x++;
        //@ ghost i++;
        //@ fold wrapX(i);
      } 
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>This will give an error on the <code>while</code> condition, stating
that there is no permission for <code>x</code>. This is to be expected,
since permission for <code>x</code> is contained in the predicate
<code>wrapX(i)</code>. Since we did not give instructions to
<code>unfold</code> it, the loop condition cannot access <code>x</code>.
Intuitively, the following extra syntax should work:</p>
<!-- testMethod Error -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ resource wrapX(int val) = Perm(x, write) ** x == val;
int x;

//@ requires wrapX(5);
void m() {
  //@ ghost int i = 5;

  //@ loop_invariant wrapX(i);
  //@ loop_invariant \unfolding wrapX(i) \in 5 &lt;= x &amp;&amp; x &lt;= 10;
  while (/*@ \unfolding wrapX(i) \in @*/ x &lt; 10) {
    //@ unfold wrapX(i);
    x++;
    //@ ghost i++;
    //@ fold wrapX(i);
  } 
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-known-problems-interaction-between-loop-conditions-and-predicates-2
//:: verdict Error
//:: tools silicon
final class Test {
    //@ resource wrapX(int val) = Perm(x, write) ** x == val;
    int x;
    
    //@ requires wrapX(5);
    void m() {
      //@ ghost int i = 5;
    
      //@ loop_invariant wrapX(i);
      //@ loop_invariant \unfolding wrapX(i) \in 5 &lt;= x &amp;&amp; x &lt;= 10;
      while (/*@ \unfolding wrapX(i) \in @*/ x &lt; 10) {
        //@ unfold wrapX(i);
        x++;
        //@ ghost i++;
        //@ fold wrapX(i);
      } 
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>However, this syntax is currently <em>not</em> supported by VerCors.
Instead, it is recommended to use an inline predicate if possible (see
the <a href="#inline-predicates">Inline Predicates</a> section for more
info). Applying this workaround results in the following program:</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ inline resource wrapX(int val) = Perm(x, write) ** x == val;
int x;

//@ requires wrapX(5);
void m() {
  //@ ghost int i = 5;

  //@ loop_invariant wrapX(i);
  //@ loop_invariant 5 &lt;= x &amp;&amp; x &lt;= 10;
  while (x &lt; 10) {
    x++;
    //@ ghost i++;
  } 
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-known-problems-interaction-between-loop-conditions-and-predicates-3
//:: verdict Pass
//:: tools silicon
final class Test {
    //@ inline resource wrapX(int val) = Perm(x, write) ** x == val;
    int x;
    
    //@ requires wrapX(5);
    void m() {
      //@ ghost int i = 5;
    
      //@ loop_invariant wrapX(i);
      //@ loop_invariant 5 &lt;= x &amp;&amp; x &lt;= 10;
      while (x &lt; 10) {
        x++;
        //@ ghost i++;
      } 
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Alternatively, the condition can be lifted into its own boolean
variable as in the example below. However, this 1) leads to verbose
code, and 2) requires modification of non-ghost code. Note that, for
presentation reasons, the loop condition <code>p</code> is also more
strict than in the previous examples.</p>
<!-- testMethod Pass -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">//@ resource wrapX(int val) = Perm(x, write) ** x == val;
int x;

//@ requires wrapX(5);
void m() {
  // Put the loop condition in a separate variable. This requires unfolding the predicate temporarily.
  //@ unfold wrapX(5);
  boolean p = 5 &lt;= x &amp;&amp; x &lt; 10;
  //@ fold wrapX(5);

  //@ ghost int i = 5;

  //@ loop_invariant wrapX(i);
  //@ loop_invariant \unfolding wrapX(i) \in 5 &lt;= x &amp;&amp; x &lt;= 10;
  // Require that loop maintains that p equals the previous loop condition
  //@ loop_invariant p == \unfolding wrapX(i) \in (5 &lt;= x &amp;&amp; x &lt; 10);
  while (p) {
    //@ unfold wrapX(i);
    x++;
    //@ ghost i++;

    // Before the while loop ends, check the loop condition manually
    // And put the result in p again.
    p = 5 &lt;= x &amp;&amp; x &lt; 10;
    //@ fold wrapX(i);
  }

  //@ assert wrapX(10);
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases predicates-known-problems-interaction-between-loop-conditions-and-predicates-4
//:: verdict Pass
//:: tools silicon
final class Test {
    //@ resource wrapX(int val) = Perm(x, write) ** x == val;
    int x;
    
    //@ requires wrapX(5);
    void m() {
      // Put the loop condition in a separate variable. This requires unfolding the predicate temporarily.
      //@ unfold wrapX(5);
      boolean p = 5 &lt;= x &amp;&amp; x &lt; 10;
      //@ fold wrapX(5);
    
      //@ ghost int i = 5;
    
      //@ loop_invariant wrapX(i);
      //@ loop_invariant \unfolding wrapX(i) \in 5 &lt;= x &amp;&amp; x &lt;= 10;
      // Require that loop maintains that p equals the previous loop condition
      //@ loop_invariant p == \unfolding wrapX(i) \in (5 &lt;= x &amp;&amp; x &lt; 10);
      while (p) {
        //@ unfold wrapX(i);
        x++;
        //@ ghost i++;
    
        // Before the while loop ends, check the loop condition manually
        // And put the result in p again.
        p = 5 &lt;= x &amp;&amp; x &lt; 10;
        //@ fold wrapX(i);
      }
    
      //@ assert wrapX(10);
    }
}</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h1 id="inheritance-1">Inheritance</h1>
<p>Currently, support for inheritance is very limited. Bob Rubbens is
working on improving support for inheritance as part of his PhD
position. You can read theoretical work on this in his masters thesis:
<a
href="https://essay.utwente.nl/81338/">https://essay.utwente.nl/81338/</a>,
or contact Bob at <a href="r.b.rubbens@utwente.nl"><a
href="mailto:r.b.rubbens@utwente.nl">r.b.rubbens@utwente.nl</a></a>. As
support improves, this wiki page will improve accordingly.</p>
<h1 id="exceptions--goto">Exceptions &amp; Goto</h1>
<p>This section discusses support for exceptions and goto in VerCors.
The following topics are discussed:</p>
<ul>
<li>The support that is currently implemented and support that is still
being worked on is listed <a
href="https://github.com/utwente-fmt/vercors/wiki/Exceptions-&amp;-Goto#support">here</a>.</li>
<li>Then a brief summary of exceptions in Java is given <a
href="https://github.com/utwente-fmt/vercors/wiki/Exceptions-&amp;-Goto#java-exceptions-example">here</a>.</li>
<li>Then we discuss the <code>signals</code> contract clause <a
href="https://github.com/utwente-fmt/vercors/wiki/Exceptions-&amp;-Goto#the-signals-clause">here</a>,
which models exceptions in VerCors.</li>
<li>Finally, support for goto is discussed <a
href="https://github.com/utwente-fmt/vercors/wiki/Exceptions-&amp;-Goto#goto-and-labels">here</a>.</li>
</ul>
<h2 id="exceptions">Exceptions</h2>
<h3 id="support">Support</h3>
<p>VerCors currently only supports Java exceptions. They are not
supported in PVL. We also do not support signal handlers in C. The table
below lists which facets of exceptions in Java are currently supported
in VerCors.</p>
<table>
<thead>
<tr class="header">
<th>Feature</th>
<th>Supported</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>throw</code></td>
<td>Yes</td>
</tr>
<tr class="even">
<td><code>throws</code></td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><code>try-catch</code></td>
<td>Yes</td>
</tr>
<tr class="even">
<td><code>try-finally</code></td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><code>try-catch-finally</code></td>
<td>Yes</td>
</tr>
<tr class="even">
<td><code>try-with-resources</code></td>
<td>No</td>
</tr>
<tr class="odd">
<td>Multi-catch</td>
<td>No</td>
</tr>
<tr class="even">
<td>Defining custom exceptions</td>
<td>Yes, but only if directly inheriting from one of: Exception,
RuntimeException, Throwable, Error. This limitation is temporary.</td>
</tr>
<tr class="odd">
<td>JML <code>signals</code></td>
<td>Yes</td>
</tr>
<tr class="even">
<td>JML <code>signals_only</code></td>
<td>No</td>
</tr>
</tbody>
</table>
<p>Support for exceptions is still being worked on currently. Progress
on the implementation can be followed <a
href="https://github.com/utwente-fmt/vercors/pull/464">here</a>.</p>
<h3 id="java-exceptions-example">Java Exceptions Example</h3>
<p>We will now discuss a basic artificial example of exception usage in
Java. For a more thorough overview, we refer the reader to the Java
tutorial on exceptions: <a
href="https://docs.oracle.com/javase/tutorial/essential/exceptions/index.html">https://docs.oracle.com/javase/tutorial/essential/exceptions/index.html</a>.</p>
<p>In the following code example, the <code>find</code> method
determines if an array contains a specific integer value:</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyFind <span class="op">{</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">boolean</span> <span class="fu">find</span><span class="op">(</span><span class="dt">int</span><span class="op">[]</span> xs<span class="op">,</span> <span class="dt">int</span> value<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> xs<span class="op">.</span><span class="fu">length</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>xs<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>xs<span class="op">[</span>i<span class="op">]</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>                <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Exception</span><span class="op">();</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span><span class="op">[]</span> myXs <span class="op">=</span> <span class="dt">int</span><span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>        myXs<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>        myXs<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>        myXs<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span><span class="dv">3</span><span class="op">;</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>            <span class="fu">find</span><span class="op">(</span>myXs<span class="op">,</span> <span class="dv">22</span><span class="op">);</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;An error occurred&quot;</span><span class="op">);</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If the <code>find</code> method encounters a negative array element
while searching, it throws an exception. The fact that the method throws
an exception at all is indicated by the <code>throws Exception</code>
modifier when the <code>find</code> method is defined. Specifically, the
exception is thrown by the <code>throw new Exception()</code> statement
in the <code>find</code> method.</p>
<p>The thrown exception is handled in the <code>main</code> method by
wrapping the call to <code>find</code> in a <code>try-catch</code>
block. Whenever an exception is thrown within a <code>try-catch</code>
block, the exception is passed to the <code>catch</code> block of the
type of the exception that matches the type of the <code>catch</code>
block. This catch block can then handle the exception to allow the
program to continue, or perform cleanup such that the program can exit
safely. If none of the catch blocks can handle the exception, it is
passed further up the call stack, possibly terminating the program if it
is not caught and handled.</p>
<!-- this should not be visible -->

<h3 id="the-signals-clause">The signals clause</h3>
<p>The signals clause supported in VerCors is very similar to the
signals clauses supported in JML (documented <a
href="http://www.eecs.ucf.edu/~leavens/JML/jmlrefman/jmlrefman_9.html#SEC109">here</a>).
It is a contract element like <code>requires</code> or
<code>ensures</code>, and declares the postcondition in case an
exception is thrown. The declared postcondition holds when the thrown
type matches the type stated in the <code>signals</code> clause. When an
exception is thrown, normal <code>ensures</code> post-conditions never
hold, and instead only relevant <code>signals</code> clauses hold.</p>
<p>As an artificial example, we can define a <code>signals</code> clause
for a method that sums two numbers. The method throws an exception if
one of the numers is equal to five.</p>
<!--
TODO: Nice example would be overflowing addition here. But we do not have that yet in vercors
-->

<!-- standalone-snip plainSum
class C {
-->

<!-- snip plainSum -->

<div class="sourceCode" id="cb41"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">//@ signals (Exception e) a == 5 || b == 5;</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co">//@ ensures \result == (a + b);</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">sum</span><span class="op">(</span><span class="dt">int</span> a<span class="op">,</span> <span class="dt">int</span> b<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>a <span class="op">==</span> <span class="dv">5</span> <span class="op">||</span> b <span class="op">==</span> <span class="dv">5</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Exception</span><span class="op">();</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> a <span class="op">+</span> b<span class="op">;</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<!-- standalone-snip plainSum
}
-->

<p>Similar to the <code>throws</code> attribute, the
<code>signals</code> clause can name both checked and unchecked
exceptions. The only limitation is that the type must extend
<code>Throwable</code>.</p>
<h5 id="signals-does-not-guarantee-an-exception">Signals does not
guarantee an exception</h5>
<p>A frequently occurring use-case is to guarantee that an exception is
thrown, if a certain condition occurs. Furthermore, this is also how the
semantics of the <code>signals</code> clause is sometimes
misinterpreted. Applying this line of though to the previous example,
one might expect the method <code>sum</code> to <em>always</em> throw if
one of the arguments equals five. However, this is not the case. The
implementation for <code>pickySum</code> below demonstrates this. The
implementation for <code>pickySum</code> also satisfies the contract for
<code>sum</code>, but clearly <code>pickySum</code> does not
<em>always</em> throw an exception if one of the arguments equals 5:</p>
<!-- standalone-snip pickySum
class C {
-->

<!-- snip pickySum -->

<div class="sourceCode" id="cb42"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">//@ signals (Exception e) a == 5 || b == 5;</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co">//@ ensures \result == (a + b);</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">pickySum</span><span class="op">(</span><span class="dt">int</span> a<span class="op">,</span> <span class="dt">int</span> b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>a <span class="op">==</span> <span class="dv">5</span> <span class="op">||</span> b <span class="op">==</span> <span class="dv">5</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu">dayOfTheWeek</span><span class="op">()</span> <span class="op">==</span> <span class="st">&quot;tuesday&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Exception</span><span class="op">();</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> a <span class="op">+</span> b<span class="op">;</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<!-- standalone-snip pickySum
}
-->

<p>Instead, <code>pickySum</code> only throws an exception if one of the
arguments equals five, <em>and</em> today is tuesday. Would
<code>pickySum</code> be called on a monday with 5 and 10, an exception
would not be thrown, and instead 15 would be returned.</p>
<p>This artificial example shows how a signals clause should be
interpreted: when an exception of the appropriate type is thrown, the
<code>signals</code> clause can be assumed to hold. We call this the
"reactive" semantics.</p>
<p>It is <em>not</em> guaranteed that an exception is thrown if a
<code>signals</code> condition occurs. We call this the "causal"
semantics. VerCors does <em>not</em> implement this currently.</p>
<p>If needed, there is a way to model the causal semantics using an
additional <code>ensures</code> clause. To do this, an
<code>ensures</code> clause needs to be added that implies
<code>false</code> when the <code>signals</code> condition occurs. For
example, <code>pickySum</code> can be made consistent as follows:</p>
<!-- standalone-snip consistentSum
class C {
-->

<!-- snip consistentSum -->

<div class="sourceCode" id="cb43"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">//@ signals (Exception e) a == 5 || b == 5;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co">//@ ensures (a == 5 || b == 5) ==&gt; false;</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">//@ ensures \result == (a + b);</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">consistentSum</span><span class="op">(</span><span class="dt">int</span> a<span class="op">,</span> <span class="dt">int</span> b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>a <span class="op">==</span> <span class="dv">5</span> <span class="op">||</span> b <span class="op">==</span> <span class="dv">5</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Exception</span><span class="op">();</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> a <span class="op">+</span> b<span class="op">;</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<!-- standalone-snip consistentSum
}
-->

<p>By ensuring that the method cannot terminate normally if one of the
arguments equals 5, it is guaranteed that an exception is thrown when
one of the arguments equals 5. This encodes the causal semantics using
the reactive semantics supported by VerCors.</p>
<h5 id="exception-guarantees">Exception guarantees</h5>
<p>Java guarantees that methods only throw checked exceptions if they
are explicitly mentioned in the <code>throws</code> attribute. Unchecked
exceptions can always be thrown.</p>
<p>VerCors does not implement this exact semantics. Instead, it assumes
that any exception that can be thrown is mentioned in either the
<code>throws</code> attribute or in a <code>signals</code> clause. In
other words, if a method has no <code>throws</code> clauses, nor
<code>signals</code> clauses, it is 100% exception safe according to
VerCors. A downside of this is that the VerCors exception semantics does
not 100% reflect the Java semantics. The upside is that VerCors can now
guarantee that all specified exceptions are caught, as all relevant
exceptions are stated explicitly.</p>
<p>For example, if a method does not have a <code>signals</code> clause
stating it throws a <code>RuntimeException</code>, VerCors assumes this
exception will never be thrown by the method. Another example, if a
<code>throw new RuntimeException()</code> statement occurs in method M,
VerCors will give an error if M does not have a <code>signals</code>
clause for RuntimeException.</p>
<p>In some situations it might be necessary to opt into the more
realistic Java semantics of unchecked exceptions. VerCors does not
support this directly, but it can be moddeled with an additional
<code>signals</code> clause. To do this, an additional
<code>signals</code> clause must be added with the condition
<code>true</code>. For example, we can modify the contract of the
earlier presented <code>sum</code> method to allow throwing a
<code>RuntimeException</code> randomly:</p>
<!-- header-snip ExcGuarantees Error -->

<!-- wrap-class-snip ExcGuarantees -->

<div class="sourceCode" id="cb44"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">//@ signals (ArithmeticException e) a == 5 || b == 5;</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co">//@ signals (RuntimeException e) true;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co">//@ ensures \result == (a + b);</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">sum</span><span class="op">(</span><span class="dt">int</span> a<span class="op">,</span> <span class="dt">int</span> b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>a <span class="op">==</span> <span class="dv">5</span> <span class="op">||</span> b <span class="op">==</span> <span class="dv">5</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">ArithmeticException</span><span class="op">();</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> a <span class="op">+</span> b<span class="op">;</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">useSum</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> result <span class="op">=</span> <span class="fu">sum</span><span class="op">(</span><span class="dv">5</span><span class="op">,</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Result: &quot;</span> <span class="op">+</span> result<span class="op">);</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If this example is checked by VerCors, it will yield an error in the
<code>useSum</code> method. The error will complain that
<code>sum</code> might throw a <code>RuntimeException</code>, but that
it is not specified in the contract nor handled in the
<code>useSum</code> body.</p>
<p>A way to resolve this would be to catch the
<code>RuntimeException</code> by wrapping the call to <code>sum</code>
in a <code>try-catch</code> block. However, since catching a
<code>RuntimeException</code> is bad practice, it is sometimes better to
indicate in the contract of <code>useSum</code> that <code>useSum</code>
might also throw a <code>RuntimeException</code>. This propagates the
responsibility for handling the unchecked exception to the caller.</p>
<h3 id="the-signals_only-clause">The signals_only clause</h3>
<p>The <code>signals_only</code> clause from JML (documented <a
href="http://www.eecs.ucf.edu/~leavens/JML/jmlrefman/jmlrefman_9.html#SEC110">here</a>)
is not supported by VerCors. It guarantees that the only types that will
be thrown by the method are the types listed in the
<code>signals_only</code> clause.</p>
<p>To simulate the functionality of
<code>signals_only T1, ..., Tn</code>, a signals clause with the
condition <code>true</code> can be added for each <code>Ti</code>. For
example, the clause <code>signals_only T1, T2;</code> can be simulated
by adding two <code>signals</code> clauses to a method contract as
follows:</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">//@ signals (T1 e) true;</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co">//@ signals (T2 e) true;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">m</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Alternatively, the abbreviation of <code>signals_only</code>
documented in <a
href="http://www.eecs.ucf.edu/~leavens/JML/jmlrefman/jmlrefman_9.html#SEC110">Section
9.9.5 of the JML reference manual</a> can also be used to approximate
the semantics of <code>signals_only</code> in VerCors.</p>
<h2 id="goto-and-labels">Goto and labels</h2>
<p>PVL has support for <code>goto</code> and <code>label</code>. They
are useful for modeling control flow primitives not yet supported in
VerCors. The semantics are standard: when the <code>goto l</code>
statement is encountered, control flow is immediately transferred to the
location indicated by the label <code>l</code>. For example, the
following program verifies:</p>
<!-- header-snip GotoEx1 -->

<!-- wrap-method-snip GotoEx1 -->

<div class="sourceCode" id="cb46"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> x <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="cf">goto</span> l<span class="op">;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>label l<span class="op">;</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> x <span class="op">==</span> <span class="dv">3</span><span class="op">;</span></span></code></pre></div>
<p>As PVL does not have a construct like <code>finally</code> in Java,
there are no exceptions for the semantics of <code>goto</code> in
PVL.</p>
<p>One example where use of <code>goto</code> might lead to confusing
results is the following. In the below example, <code>goto</code> is
used to exit the <code>while</code> loop. Because <code>goto</code>
redirects control flow to the destination label immediately, checking
the loop invariant is skipped.</p>
<!-- header-snip GotoEx2 -->

<!-- wrap-method-snip GotoEx2 -->

<div class="sourceCode" id="cb47"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> r <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>loop_invariant r <span class="op">==</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  r <span class="op">=</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">goto</span> lbl2<span class="op">;</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> r <span class="op">==</span> <span class="dv">10</span><span class="op">;</span> <span class="co">// Never executed</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>label lbl2<span class="op">;</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> r <span class="op">==</span> <span class="dv">20</span><span class="op">;</span></span></code></pre></div>
<p>If it is desired that the loop invariant is checked at
<code>goto</code> as well, this can be modeled by adding asserts at the
exit labels of the <code>while</code> loop.</p>
<h1 id="vercors-by-error">VerCors by Error</h1>
<!--
Note to editor:

The anchors (<a id='..'></a>) refer to the error codes in the VerCors source. Links are generated next to errors that link to the website, so this page should exhaustively list all error codes in VerCors.

GitHub transforms the anchor in a particular way: this does not matter to us, because we link to the website version of the tutorial. There the fragment is rendered exactly as it is written in this source.
-->

<p><a id='assertFailed:false'></a></p>
<h3 id="assertion-failed-expression-may-be-false">Assertion failed:
expression may be false</h3>
<h1 id="veymont">VeyMont</h1>
<p>VeyMont is a tool for verification of concurrent message passing
programs, also called choreographies. It is implemented as an extension
of VerCors. VeyMont generates an implementation from a choreography
using the endpoint projection. In this implementation, each endpoint is
executed as a thread, and is responsible for a part of the choreography.
When these threads are all executed in parallel, the behaviour follows
the choreography. Essentially, this projection preserves functional
correctness, which is proven with VerCors on the choreography, and
guarantees deadlock-freedom. In addition, contracts written in proper
form are preserved and projected to the proper endpoint. This allows
re-verification of the generated implementation, decreasing the need to
trust the implementation of VeyMont, as well as allowing modifications
to the generated implementation.</p>
<p>We will introduce the syntax of choreographies through a simple
example. Then we will show how to verify it using the permission
generation capabilities of VeyMont. Finally, we will introduce the
syntax for choreography contracts &amp; permissions, and channel
invariants. Using these, we will verify a property of the example. We
will assume the reader is familiar with PVL concepts such as
permissions, the separating conjunction, contracts and classes. At the
end of this section we will give some further directions for reading, as
well as an overview of all syntax that VeyMont supports.</p>
<h2 id="choreography-syntax">Choreography syntax</h2>
<p>Choreographies are defined using the <code>choreography</code>
keyword. They have a name, arguments, and a body. For example, the next
code snippet defines a choreography named <code>Example</code>, and has
two parameters, the integers <code>x</code> and <code>y</code>.</p>
<pre><code>choreography Example(int x, int y) {
  // Empty body
}</code></pre>
<p>The body of a choreography consists of endpoint definitions and a
single run definition. Endpoint definitions have a name, a class type,
and arguments. For example, we can add a <code>Store</code> class with
two integer fields. We then define two endpoints using the
<code>Store</code> class. We initialize the endpoints with the
<code>x</code> and <code>y</code> parameters from the main arguments of
the choreography.</p>
<pre><code>class Store {
  int v;
  int temp;

  constructor(int init) {
    v = init;
  }
}

choreography Example(int x, int y) {
  endpoint alex = Store(x);
  endpoint bobby = Store(y);
}</code></pre>
<p>The <code>Store</code> class is a regular PVL class, for more
information we refer the reader to the PVL documentation <a
href="https://github.com/utwente-fmt/vercors/wiki/PVL-Syntax-Reference">here</a>.
It is sometimes omitted in this documentation, but it should be included
when verifying the choreography, as otherwise the program cannot be
typechecked.</p>
<p>The run definition of a choreography contains the logic of the
choreography, and determines the interactions between the endpoints. It
is defined using the <code>run</code> keyword and a block of
choreographic statements. The next example exchanges the two values
using choreographic statements. First, each endpoint sends their
<code>v</code> value to the <code>temp</code> field of the other
endpoint using the <code>communicate</code> statement. Then, each
endpoint copies the value in their <code>temp</code> fields to their
<code>v</code> fields using <code>:=</code>, the choreographic
assignment operator. The difference between choreographic assignment and
regular assignment, is that a choreographic assignment may only read and
write to memory that is owned by the endpoint being assigned to.</p>
<pre><code>choreography Example(int x, int y) {
  endpoint alex = Store(x);
  endpoint bobby = Store(y);

  run {
    communicate alex.v -&gt; bobby.temp;
    communicate bobby.v -&gt; alex.temp;
    alex.v := alex.temp;
    bobby.v := bobby.temp;
  }
}</code></pre>
<h2
id="using-veymont-choreographic-verification--permission-generation">Using
VeyMont: choreographic verification &amp; permission generation</h2>
<p>This example lacks contracts and permissions. However, it can still
be verified, and an implementation can also be generated. This can be
done using the following command:</p>
<pre><code>$ vercors --veymont example.pvl --generate-permissions --veymont-output example_output.pvl
[INFO] Start: VeyMont (at 10:52:56)
[INFO] Choreography verified successfully (duration: 00:00:10)
[INFO] Writing unknown.pvl to example_output.pvl
[INFO] Implementation generated successfully
[INFO] Implementation verified successfully (duration: 00:00:07)
[INFO] Done: VeyMont (at 10:53:14, duration: 00:00:17</code></pre>
<p>This command executes several steps:</p>
<ul>
<li>Permissions are generated according to the single-owner policy. This
means that each endpoint owns its own fields, and is not allowed to read
or write fields of other endpoints.</li>
<li>The choreography is verified. This succeeds, as the program is
memory safe: each endpoint only reads and writes its own fields.</li>
<li>An implementation is generated using the endpoint projection. All
generated permissions are projected to the endpoint that contains the
field referenced in the permissions. As the
<code>--veymont-output</code> is also present, the implementation is
also written to the path given.</li>
<li>The generated implementation is verified. This again verifies, as
expected for this simple example, because the choreography verified as
well. This is not always the case, as we will show in a later
section.</li>
</ul>
<p>If you want to use only one of these steps, you can use the
<code>--choreography</code>, <code>--generate</code>, and
<code>--implementation</code> flags, respectively, to make veymont skip
the other steps.</p>
<h2 id="choreographic-contracts">Choreographic contracts</h2>
<p>Channel invariants &amp; choreographic contracts can be used to
specify &amp; verify functional correctness and memory safety. Using
choreographic contracts, we can manually specify the permissions that
VeyMont generated for us with the <code>--generate-permissions</code>
flag:</p>
<pre><code>class Store {
  int v;
  int temp;

  ensures Perm(v, 1) ** v == init;
  ensures Perm(temp, 1);
  constructor(int init) {
    v = init;
  }
}

choreography Example(int x, int y) {
  endpoint alex = Store(x);
  endpoint bobby = Store(y);

  requires (\endpoint alex;
    Perm(alex.v, 1) **
    Perm(alex.temp, 1));
  requires (\endpoint bobby;
    Perm(bobby.v, 1) **
    Perm(bobby.temp, 1));
  run {
    communicate alex.v -&gt; bobby.temp;
    communicate bobby.v -&gt; alex.temp;
    alex.v := alex.temp;
    bobby.v := bobby.temp;
  }
}</code></pre>
<p>Specifically, we add permissions to the constructor of
<code>Store</code>, and permissions to the precondition of
<code>run</code>. We use the <code>\endpoint</code> expression to
indicate the endpoint for which the expressions is relevant. The
endpoint projection uses this information to decide which endpoint to
project an expression to. VeyMont knows a very simple inference rule,
which allows us to omit the <code>\endpoint</code> expressions in some
cases. Essentially, whenever the endpoint context is directly inferrable
from the expression, VeyMont tries to do so. In this case, this shortens
the contract to the following:</p>
<pre><code>choreography Example(int x, int y) {
  endpoint alex = Store(x);
  endpoint bobby = Store(y);

  requires Perm(alex.v, 1) ** Perm(alex.temp, 1);
  requires Perm(bobby.v, 1) ** Perm(bobby.temp, 1);
  run {
    communicate alex.v -&gt; bobby.temp;
    communicate bobby.v -&gt; alex.temp;
    alex.v := alex.temp;
    bobby.v := bobby.temp;
  }
}</code></pre>
<p>VeyMont verifies the above two examples successfully.</p>
<h2 id="channel-invariants--functional-correctness">Channel invariants
&amp; functional correctness</h2>
<p>We will now go one step further and specify functional correctness of
the above example. Specifically, we will verify that, if <code>x</code>
and <code>y</code> are positive and negative respectively, the fields
<code>bobby.v</code> and <code>alex.v</code> will also be positive and
negative, respectively, after executing the choreography. We do this by
adding a contract to the main choreography, to constrain <code>x</code>
and <code>y</code>. We also enhance the contract of <code>run</code> by
adding this requirement. This results in the following choreography:</p>
<pre><code>requires x &gt; 0 &amp;&amp; y &lt; 0;
choreography Example(int x, int y) {
  endpoint alex = Store(x);
  endpoint bobby = Store(y);

  requires Perm(alex.v, 1) ** Perm(alex.temp, 1) ** alex.v &gt; 0;
  requires Perm(bobby.v, 1) ** Perm(bobby.temp, 1) ** bobby.v &lt; 0;
  ensures Perm(alex.v, 1) ** alex.v &lt; 0;
  ensures Perm(bobby.v, 1) ** bobby.v &gt; 0;
  run {
    communicate alex.v -&gt; bobby.temp;
    communicate bobby.v -&gt; alex.temp;
    alex.v := alex.temp;
    bobby.v := bobby.temp;
  }
}</code></pre>
<p>This version does not yet verify. VeyMont reports an error on the
postcondition of the above choreograpy, reporting that
<code>alex.v</code> and <code>bob.v</code> might not be negative and
positive, respectively. Note that this error is discovered only after
the choreography is verified! This shows an interesting aspect of
VeyMont: at the choreography level, properties over the transferred
values are included in the reasoning of VeyMont. While this is only
matters for primitive values like integers, it is ocasionally useful for
verifying choreographies. Note that, while the generated implementation
would not verify, it is not because of a bug: there are simply some
annotations missing.</p>
<blockquote>
<p>In deductive program verification terms, there is a modularity
boundary at the communicate statement, in the sense of modular
verification. When verifying the choreography, this modularity boundary
is transparent. When verifying the implementation, this modularity
boundary is opaque. The decision of when and where to draw the
modularity boundary is a topic of ongoing research, and might change in
future versions of VeyMont.</p>
</blockquote>
<p>We will now finish verifying the implementation by adding a property
over the message that is sent. This type of property is specified using
a channel invariant. Channel invariants are defined using the
<code>channel_invariant</code> keyword, followed by an expression.
Channel invariants must directly precede the communicate statement they
apply to. Within a channel invariant, the special expressions
<code>\msg</code>, <code>\sender</code> and <code>\receiver</code> are
available. They refer to the message being sent, the sending and the
receiving endpoint, respectively. Within a channel invariant, there can
be no endpoint ownership expressions, as the owners are implictly
determined by the sending and receiving endpoint.</p>
<p>Adding the constraints as channel invariants results in the following
choreography:</p>
<pre><code>requires x &gt; 0 &amp;&amp; y &lt; 0;
choreography Example(int x, int y) {
  endpoint alex = Store(x);
  endpoint bobby = Store(y);

  requires Perm(alex.v, 1) ** Perm(alex.temp, 1) ** alex.v &gt; 0;
  requires Perm(bobby.v, 1) ** Perm(bobby.temp, 1) ** bobby.v &lt; 0;
  ensures Perm(alex.v, 1) ** alex.v &lt; 0;
  ensures Perm(bobby.v, 1) ** bobby.v &gt; 0;
  run {
    channel_invariant \msg &gt; 0;
    communicate alex.v -&gt; bobby.temp;
    channel_invariant \msg &lt; 0;
    communicate bobby.v -&gt; alex.temp;
    alex.v := alex.temp;
    bobby.v := bobby.temp;
  }
}</code></pre>
<p>The generated implementation of this final version of the
choreography verifies.</p>
<h2 id="what-next">What next?</h2>
<p>More choreographies can be found in the test suite of VeyMont, as
well as in the tool papers.</p>
<h2 id="publications">Publications</h2>
<ul>
<li>The base theory of VeyMont: <a
href="https://doi.org/10.1007/978-3-030-99336-8_19">https://doi.org/10.1007/978-3-030-99336-8_19</a></li>
<li>The first tool paper, introducing the base VeyMont implementation:
<a
href="https://doi.org/10.1007/978-3-031-27481-7_19">https://doi.org/10.1007/978-3-031-27481-7_19</a>
<ul>
<li>The artefact: <a
href="https://doi.org/10.5281/zenodo.7410640">https://doi.org/10.5281/zenodo.7410640</a></li>
</ul></li>
<li>The second tool paper, introducing the contract- and
permission-preserving endpoint projection: <em>(published at iFM 2024,
DOI pending)</em>
<ul>
<li>The artefact: <a
href="https://doi.org/10.4121/93f68b2c-5f85-4afd-9679-5e92c634a1b0">https://doi.org/10.4121/93f68b2c-5f85-4afd-9679-5e92c634a1b0</a></li>
</ul></li>
</ul>
<h2 id="veymont-syntax-overview">VeyMont syntax overview</h2>
<h5 id="choreography-declarations">Choreography declarations</h5>
<ul>
<li><p><code>[contract] choreography Name(parameters...) { choreographic declarations... }</code></p>
<p>Defines a choreography named "Name", with zero or more parameters and
a body of choreographic declarations. The choreography declaration may
be preceded with a contract, which can be used to constrain the
arguments.</p></li>
<li><p><code>endpoint a = ClassType(args...);</code></p>
<p>Defines an endpoint named <code>a</code> of type
<code>ClassType</code>. When <code>a</code> is initialized, the
constructor of <code>ClassType</code> will be called with arguments
<code>args...</code>.</p></li>
<li><p><code>[contract] run { choreographic statements... }</code></p>
<p>The <code>run</code> declaration defines the interactions between
endpoints. It contains zero or more choreographic statements.</p></li>
</ul>
<h5 id="choreographic-contract-expressions">Choreographic contract
expressions</h5>
<ul>
<li><p><code>(\endpoint a; expr)</code></p>
<p>Specifies that expression <code>expr</code> belongs to endpoint
<code>a</code>. This means that expression <code>expr</code> will be
evaluated in the context of <code>a</code>, using memory only available
to <code>a</code>. The endpoint projection also uses this to decide
where to project an expression to.</p></li>
<li><p><code>(\chor expr)</code></p>
<p>Specifies that expression <code>expr</code> belongs to no endpoint in
particular. It will be included when verifying the choreography, but
when generating an implementation this expression is discarded and
replaced with <code>true</code>. This means that the generated
implementation might not verify. Essentially, <code>\chor</code> is a
debugging construct, similar to the <code>assume</code> statement. It is
useful to verify properties at the choreographic while they cannot be
verified at the generated implementation level yet.</p></li>
<li><p><code>Perm[a](obj.f, p)</code></p>
<p>This is shorthand syntax for
<code>(\endpoint a; Perm(obj.f, p))</code>.</p></li>
</ul>
<h5 id="choreographic-statements">Choreographic statements</h5>
<ul>
<li><p><code>channel_invariant expr;</code></p>
<p>Specifies a property over a message being sent. Must directly precede
a communicate statement.</p></li>
<li><p><code>communicate a.f -&gt; b.f;</code></p>
<p>Indicates that a message is exchanged between endpoint <code>a</code>
and <code>b</code>, the value being the <code>f</code> field of
<code>a</code>, the destination being the <code>f</code> field of
<code>b</code>.</p></li>
<li><p><code>communicate a: message -&gt; b: target;</code></p>
<p>Extended form of the communicate statement, with <code>a</code> and
<code>b</code> being endpoints, <code>message</code> being the
expression of the message to be sent, and <code>target</code> an
assignable memory location for which <code>b</code> has write
permission.</p></li>
<li><p><code>a.f := expr;</code></p>
<p>Assigns <code>expr</code> to <code>a.f</code>, in the context of
endpoint <code>a</code>. This means VeyMont will report an error if
<code>expr</code> tries to read memory that <code>a</code> does not
own.</p></li>
<li><p><code>a: target := expr;</code></p>
<p>Assigns <code>expr</code> to <code>target</code> in the context of
endpoint <code>a</code>. Used as a fallback when VeyMont cannot infer
the endpoint context directly from <code>target</code>.</p></li>
</ul>
<h5 id="channel-invariant-expressions">Channel invariant
expressions</h5>
<ul>
<li><p><code>\msg</code></p>
<p>Refers to the message being sent.</p></li>
<li><p><code>\sender</code>, <code>\receiver</code></p>
<p>Refer to the sender and receiver of the communicate
statement.</p></li>
</ul>
<h1 id="term-rewriting-rules">Term Rewriting Rules</h1>
<p>VerCors allows you to define your own term rewriting rules via
<code>pvl</code> files. This chapter shows you how.</p>
<h1 id="magic-wands">Magic Wands</h1>
<p>The handling of magic wands is non-trivial, so this chapter takes a
closer look at that. For further reading, see e.g. <em>"Witnessing the
elimination of magic wands". Blom, S.; and Huisman, M. STTT, 17(6):
757â781. 2015</em>.</p>
<p>Also take a look at the Viper tutorial for wands: <a
href="http://viper.ethz.ch/tutorial/?page=1&amp;section=#magic-wands">http://viper.ethz.ch/tutorial/?page=1&amp;section=#magic-wands</a></p>
<!-- PB: note to editor: if VerCors starts supporting "\applying" in contracts, please edit the section about \old where it is explained how \old interacts with \unfolding -->

<h2 id="what-are-magic-wands">What are Magic Wands?</h2>
<p>The "Magic Wand" or <em>separating implication</em> is a connective
in separation logic using the symbol <code>-*</code>. It represents a
part of a resource (see <a
href="https://github.com/utwente-fmt/vercors/wiki/Predicates">"Predicates"</a>)
or "resource with a hole": <code>A -* B</code> means "if you give me an
<code>A</code>, I can give you a <code>B</code> in return". Thus, it is
similar to a logical implication <code>A ==&gt; B</code>; however, it
consumes the <code>A</code> when it is exchanged for a
<code>B</code>.</p>
<p>A common use case is if you have a predicate defining a recursive
data structure like a linked list or a binary tree, and you take a part
of that data structure to reason about explicitly, like a sub-tree. You
can use the recursive predicate to reason about the sub-tree, but it is
more difficult to reason about the <em>remainder</em> of the original
tree: Since you took out the sub-tree and have explicit permission for
it, the recursive predicate for the whole tree can no longer have the
permission for that part, so it would have to stop recursing at a
certain point. With a wand, you can resolve this: For a tree
<code>T</code> with left sub-tree <code>L</code> and right sub-tree
<code>R</code>, and a recursive predicate <code>Tree(x)</code>, you can
split <code>Tree(T)</code> into
<code>Tree(L) ** (Tree(L)-*Tree(T))</code>. So you have the explicit
resource for the left sub-tree, and a wand such that if you join the
sub-tree back into it, you get the predicate for the whole tree back.
This joining is called <em>applying</em> the wand.</p>
<h2 id="syntax-in-vercors">Syntax in VerCors</h2>
<p>We will use the following binary tree as example:</p>
<!-- standaloneSnip magicWandAndTree
//:: cases magicWandAndTree
//:: verdict Pass
//:: tool silicon
-->

<!-- codeSnip magicWandAndTree -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">final class Tree {
  int value;
  int priority;
  Tree left;
  Tree right;

  /*@
  resource tree() = Perm(value, write) ** Perm(priority, write) ** Perm(left, write) ** Perm(right, write) 
    ** (left != null ==&gt; left.tree()) ** (right != null ==&gt; right.tree());

  requires t.tree();
  static pure boolean sorted(Tree t) 
  = t != null ==&gt; \unfolding t.tree() \in 
    (t.left != null ==&gt; sorted(t.left) &amp;&amp; \unfolding t.left.tree() \in t.priority &gt;= t.left.priority) 
    &amp;&amp; (t.right!= null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority);
  @*/<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases magicWandAndTree
//:: verdict Pass
//:: tool silicon
final class Tree {
  int value;
  int priority;
  Tree left;
  Tree right;

  /*@
  resource tree() = Perm(value, write) ** Perm(priority, write) ** Perm(left, write) ** Perm(right, write) 
    ** (left != null ==&gt; left.tree()) ** (right != null ==&gt; right.tree());

  requires t.tree();
  static pure boolean sorted(Tree t) 
  = t != null ==&gt; \unfolding t.tree() \in 
    (t.left != null ==&gt; sorted(t.left) &amp;&amp; \unfolding t.left.tree() \in t.priority &gt;= t.left.priority) 
    &amp;&amp; (t.right!= null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority);
  @*//*@
requires t != null;
requires t.tree();
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures \result.tree() -* t.tree();
@*/
static Tree get_left(Tree t) {
  //@ unfold t.tree();
  Tree res = t.left;
  /*@
  create {
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    fold t.tree();
    qed res.tree() -* t.tree();
  }
  @*/
  return res;
}/*@
context t != null;
context t.tree();
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority(Tree t, int max_priority) {
  Tree left = get_left(t);
  // now we have tree(left) and a wand tree(left) -* tree(t)
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply left.tree() -* t.tree();
  // now left.tree() is no longer directly available, but t.tree() is back
  return res;
}/*@
requires t != null ** t.tree();
static boolean wand_helper(Tree t, int max_prio)
  = \unfolding t.tree() \in t.priority &lt;= max_prio;
@*/

/*@
yields int root_prio;
requires t != null;
requires t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures sorted(\result) &amp;&amp; wand_helper(\result, root_prio);
ensures \result.tree() ** sorted(\result) ** wand_helper(\result, root_prio) 
        -* 
        t.tree() ** sorted(t);
@*/
static Tree get_left_sorted(Tree t) {
  //@ unfold t.tree();
  //@ ghost root_prio = t.priority;
  Tree res = t.left;
  /*@
  create {
    // necessary parts for t.tree()
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    // necessary parts for t.sorted()
    use res != null;
    use t.priority == root_prio;
    use t.right != null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority;
    // assemble parts
    fold t.tree();
    qed res.tree() ** sorted(res) ** wand_helper(res, root_prio) 
        -* 
        t.tree() ** sorted(t);
  }
  @*/
  return res;
}

/*@
context t != null;
context t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority_sorted(Tree t, int max_priority) {
  //@ ghost int root_prio;
  Tree left = get_left_sorted(t) /*@ then { root_prio = root_prio; } @*/;
  // now we have left.tree(), sorted(left) and wand_helper(left, root_prio), as well as the wand
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply (left.tree() ** sorted(left) ** wand_helper(left, root_prio)) -* (t.tree() ** sorted(t));
  // now left.tree() is no longer directly available, but t.tree() is back and sorted
  return res;
}} // Closing brace for class Tree, which started at the beginning of this chapter
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>So a <code>Tree</code> contains a data item <code>value</code>, a
priority and two references to the sub-trees; the <code>tree</code>
resource contains write permissions for all those fields, as well as
recursive permissions for the sub-trees; and the <code>sorted</code>
function ensures that the priority in the root node is the largest in
the <code>Tree</code> (like in a priority queue).</p>
<h3 id="creating-a-wand">Creating a Wand</h3>
<p>To create a wand, use the keyword <code>create {...}</code>. Inside
the curly braces, you have to provide the necessary information to
create the wand:</p>
<p>You need to explicitly specify which resources from the current
context should be folded into the wand. The keyword for this is
<code>use</code>. Note that, like with folding a normal predicated, any
permissions folded into the wand are no longer available in the
environment. You can also <code>use</code> boolean facts from the
current context, e.g. <code>use a==b;</code>.</p>
<p>When creating a wand <code>A-*B</code>, you need to describe how
exactly to merge <code>A</code> with the content of the wand to obtain
<code>B</code>. For example, <code>A</code> may contain permissions for
the left sub-tree and the wand those for the right sub-tree, and to get
the full tree, you need to perform a <code>fold</code>. All necessary
permissions and boolean facts for such a merger must be provided via
<code>use</code>.</p>
<p>The final statement within the curly braces of <code>create</code>
has to be <code>qed A-*B;</code>, with <code>A-*B</code> being replaced
by the wand you created.</p>
<p><strong>Note</strong> that the wand operator <code>-*</code> has the
precedence like an implication, thus it is less binding than the
separating conjunct <code>**</code> and boolean connectives like
<code>&amp;&amp;</code>.</p>
<!-- codeSnip magicWandAndTree -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
requires t != null;
requires t.tree();
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures \result.tree() -* t.tree();
@*/
static Tree get_left(Tree t) {
  //@ unfold t.tree();
  Tree res = t.left;
  /*@
  create {
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    fold t.tree();
    qed res.tree() -* t.tree();
  }
  @*/
  return res;
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases magicWandAndTree
//:: verdict Pass
//:: tool silicon
final class Tree {
  int value;
  int priority;
  Tree left;
  Tree right;

  /*@
  resource tree() = Perm(value, write) ** Perm(priority, write) ** Perm(left, write) ** Perm(right, write) 
    ** (left != null ==&gt; left.tree()) ** (right != null ==&gt; right.tree());

  requires t.tree();
  static pure boolean sorted(Tree t) 
  = t != null ==&gt; \unfolding t.tree() \in 
    (t.left != null ==&gt; sorted(t.left) &amp;&amp; \unfolding t.left.tree() \in t.priority &gt;= t.left.priority) 
    &amp;&amp; (t.right!= null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority);
  @*//*@
requires t != null;
requires t.tree();
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures \result.tree() -* t.tree();
@*/
static Tree get_left(Tree t) {
  //@ unfold t.tree();
  Tree res = t.left;
  /*@
  create {
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    fold t.tree();
    qed res.tree() -* t.tree();
  }
  @*/
  return res;
}/*@
context t != null;
context t.tree();
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority(Tree t, int max_priority) {
  Tree left = get_left(t);
  // now we have tree(left) and a wand tree(left) -* tree(t)
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply left.tree() -* t.tree();
  // now left.tree() is no longer directly available, but t.tree() is back
  return res;
}/*@
requires t != null ** t.tree();
static boolean wand_helper(Tree t, int max_prio)
  = \unfolding t.tree() \in t.priority &lt;= max_prio;
@*/

/*@
yields int root_prio;
requires t != null;
requires t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures sorted(\result) &amp;&amp; wand_helper(\result, root_prio);
ensures \result.tree() ** sorted(\result) ** wand_helper(\result, root_prio) 
        -* 
        t.tree() ** sorted(t);
@*/
static Tree get_left_sorted(Tree t) {
  //@ unfold t.tree();
  //@ ghost root_prio = t.priority;
  Tree res = t.left;
  /*@
  create {
    // necessary parts for t.tree()
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    // necessary parts for t.sorted()
    use res != null;
    use t.priority == root_prio;
    use t.right != null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority;
    // assemble parts
    fold t.tree();
    qed res.tree() ** sorted(res) ** wand_helper(res, root_prio) 
        -* 
        t.tree() ** sorted(t);
  }
  @*/
  return res;
}

/*@
context t != null;
context t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority_sorted(Tree t, int max_priority) {
  //@ ghost int root_prio;
  Tree left = get_left_sorted(t) /*@ then { root_prio = root_prio; } @*/;
  // now we have left.tree(), sorted(left) and wand_helper(left, root_prio), as well as the wand
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply (left.tree() ** sorted(left) ** wand_helper(left, root_prio)) -* (t.tree() ** sorted(t));
  // now left.tree() is no longer directly available, but t.tree() is back and sorted
  return res;
}} // Closing brace for class Tree, which started at the beginning of this chapter
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<p>Notice how in the example, all the permissions necessary for folding
<code>tree(t)</code> are provided with <code>use</code>,
<strong>except</strong> the part that is in the premise of the wand,
<code>tree(t.left)</code>. If we had provided that as well, it would
have become part of the wand, rather than being the "missing piece", and
the first post-condition <code>ensures tree(\result)</code> would have
failed for lack of permission (since this permission is bundled into the
wand, and no longer directly available). Additionally, we had to provide
the fact that <code>res</code> is the left sub-tree of <code>t</code>,
so that <code>fold tree(t)</code> knows that the premise of the wand
fits into the missing part of the predicate.</p>
<h3 id="applying-a-wand">Applying a Wand</h3>
<p>To combine the "missing piece" with the wand and obtain the full
resource, use the keyword <code>apply</code>. Since we already specified
how the merging works when we created the wand, no further logic is
needed now:</p>
<!-- codeSnip magicWandAndTree -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
context t != null;
context t.tree();
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority(Tree t, int max_priority) {
  Tree left = get_left(t);
  // now we have tree(left) and a wand tree(left) -* tree(t)
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply left.tree() -* t.tree();
  // now left.tree() is no longer directly available, but t.tree() is back
  return res;
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases magicWandAndTree
//:: verdict Pass
//:: tool silicon
final class Tree {
  int value;
  int priority;
  Tree left;
  Tree right;

  /*@
  resource tree() = Perm(value, write) ** Perm(priority, write) ** Perm(left, write) ** Perm(right, write) 
    ** (left != null ==&gt; left.tree()) ** (right != null ==&gt; right.tree());

  requires t.tree();
  static pure boolean sorted(Tree t) 
  = t != null ==&gt; \unfolding t.tree() \in 
    (t.left != null ==&gt; sorted(t.left) &amp;&amp; \unfolding t.left.tree() \in t.priority &gt;= t.left.priority) 
    &amp;&amp; (t.right!= null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority);
  @*//*@
requires t != null;
requires t.tree();
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures \result.tree() -* t.tree();
@*/
static Tree get_left(Tree t) {
  //@ unfold t.tree();
  Tree res = t.left;
  /*@
  create {
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    fold t.tree();
    qed res.tree() -* t.tree();
  }
  @*/
  return res;
}/*@
context t != null;
context t.tree();
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority(Tree t, int max_priority) {
  Tree left = get_left(t);
  // now we have tree(left) and a wand tree(left) -* tree(t)
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply left.tree() -* t.tree();
  // now left.tree() is no longer directly available, but t.tree() is back
  return res;
}/*@
requires t != null ** t.tree();
static boolean wand_helper(Tree t, int max_prio)
  = \unfolding t.tree() \in t.priority &lt;= max_prio;
@*/

/*@
yields int root_prio;
requires t != null;
requires t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures sorted(\result) &amp;&amp; wand_helper(\result, root_prio);
ensures \result.tree() ** sorted(\result) ** wand_helper(\result, root_prio) 
        -* 
        t.tree() ** sorted(t);
@*/
static Tree get_left_sorted(Tree t) {
  //@ unfold t.tree();
  //@ ghost root_prio = t.priority;
  Tree res = t.left;
  /*@
  create {
    // necessary parts for t.tree()
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    // necessary parts for t.sorted()
    use res != null;
    use t.priority == root_prio;
    use t.right != null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority;
    // assemble parts
    fold t.tree();
    qed res.tree() ** sorted(res) ** wand_helper(res, root_prio) 
        -* 
        t.tree() ** sorted(t);
  }
  @*/
  return res;
}

/*@
context t != null;
context t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority_sorted(Tree t, int max_priority) {
  //@ ghost int root_prio;
  Tree left = get_left_sorted(t) /*@ then { root_prio = root_prio; } @*/;
  // now we have left.tree(), sorted(left) and wand_helper(left, root_prio), as well as the wand
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply (left.tree() ** sorted(left) ** wand_helper(left, root_prio)) -* (t.tree() ** sorted(t));
  // now left.tree() is no longer directly available, but t.tree() is back and sorted
  return res;
}} // Closing brace for class Tree, which started at the beginning of this chapter
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<h3 id="more-complex-expressions">More Complex Expressions</h3>
<p>Sometimes, we may want to reason about the things contained in a
wand; for example we decompose a sorted tree, and want to say it will be
sorted again after the merger. However, as long as <code>tree(t)</code>
is split into the sub-tree and the wand, we cannot call
<code>sorted(t)</code> as it needs the full predicate
<code>tree(t)</code>. But simply ignoring the sortedness when splitting
and later merging again would mean that we can no longer make any
assertions about sortedness afterwards. As a solution, we encode the
property into the wand, by adding conjuncts to the premise and
antecedence of the wand: <code>A**B -* C**D</code>. We can only apply
such a wand if we hold the permissions of <code>A</code> <em>and</em>
the properties in <code>B</code> hold. This stricter requirement is
rewarded with the fact that we will get both the permissions in
<code>C</code> and the properties of <code>D</code> after applying the
wand.</p>
<p><strong>Note</strong> that VerCors currently only allows method calls
as conjuncts in wands, so properties like an equality <code>a==b</code>
must be wrapped in a function in order to be used.</p>
<!-- codeSnip magicWandAndTree -->


<div class="verification-container">
    
        <pre style="position: relative; margin-bottom: 0" class="verification-text">/*@
requires t != null ** t.tree();
static boolean wand_helper(Tree t, int max_prio)
  = \unfolding t.tree() \in t.priority &lt;= max_prio;
@*/

/*@
yields int root_prio;
requires t != null;
requires t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures sorted(\result) &amp;&amp; wand_helper(\result, root_prio);
ensures \result.tree() ** sorted(\result) ** wand_helper(\result, root_prio) 
        -* 
        t.tree() ** sorted(t);
@*/
static Tree get_left_sorted(Tree t) {
  //@ unfold t.tree();
  //@ ghost root_prio = t.priority;
  Tree res = t.left;
  /*@
  create {
    // necessary parts for t.tree()
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    // necessary parts for t.sorted()
    use res != null;
    use t.priority == root_prio;
    use t.right != null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority;
    // assemble parts
    fold t.tree();
    qed res.tree() ** sorted(res) ** wand_helper(res, root_prio) 
        -* 
        t.tree() ** sorted(t);
  }
  @*/
  return res;
}

/*@
context t != null;
context t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority_sorted(Tree t, int max_priority) {
  //@ ghost int root_prio;
  Tree left = get_left_sorted(t) /*@ then { root_prio = root_prio; } @*/;
  // now we have left.tree(), sorted(left) and wand_helper(left, root_prio), as well as the wand
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply (left.tree() ** sorted(left) ** wand_helper(left, root_prio)) -* (t.tree() ** sorted(t));
  // now left.tree() is no longer directly available, but t.tree() is back and sorted
  return res;
}<span class="code-buttons"><span style="display: none" class="fa fa-times-circle code-close-button plain-close"></span><span class="fa fa-pencil code-edit-button"></span><span class="fa fa-play code-run-button"></span></span></pre>
    
    <div class="verification-widget verification-non-plain" style="display: none">
        <div style="position: relative">
            <textarea name="examplecode" rows="20" >//:: cases magicWandAndTree
//:: verdict Pass
//:: tool silicon
final class Tree {
  int value;
  int priority;
  Tree left;
  Tree right;

  /*@
  resource tree() = Perm(value, write) ** Perm(priority, write) ** Perm(left, write) ** Perm(right, write) 
    ** (left != null ==&gt; left.tree()) ** (right != null ==&gt; right.tree());

  requires t.tree();
  static pure boolean sorted(Tree t) 
  = t != null ==&gt; \unfolding t.tree() \in 
    (t.left != null ==&gt; sorted(t.left) &amp;&amp; \unfolding t.left.tree() \in t.priority &gt;= t.left.priority) 
    &amp;&amp; (t.right!= null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority);
  @*//*@
requires t != null;
requires t.tree();
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures \result.tree() -* t.tree();
@*/
static Tree get_left(Tree t) {
  //@ unfold t.tree();
  Tree res = t.left;
  /*@
  create {
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    fold t.tree();
    qed res.tree() -* t.tree();
  }
  @*/
  return res;
}/*@
context t != null;
context t.tree();
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority(Tree t, int max_priority) {
  Tree left = get_left(t);
  // now we have tree(left) and a wand tree(left) -* tree(t)
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply left.tree() -* t.tree();
  // now left.tree() is no longer directly available, but t.tree() is back
  return res;
}/*@
requires t != null ** t.tree();
static boolean wand_helper(Tree t, int max_prio)
  = \unfolding t.tree() \in t.priority &lt;= max_prio;
@*/

/*@
yields int root_prio;
requires t != null;
requires t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
ensures \result != null ** \result.tree();
ensures sorted(\result) &amp;&amp; wand_helper(\result, root_prio);
ensures \result.tree() ** sorted(\result) ** wand_helper(\result, root_prio) 
        -* 
        t.tree() ** sorted(t);
@*/
static Tree get_left_sorted(Tree t) {
  //@ unfold t.tree();
  //@ ghost root_prio = t.priority;
  Tree res = t.left;
  /*@
  create {
    // necessary parts for t.tree()
    use Perm(t.value, write) ** Perm(t.priority, write) ** Perm(t.left, write) ** Perm(t.right, write);
    use t.right != null ==&gt; t.right.tree();
    use res == t.left;
    // necessary parts for t.sorted()
    use res != null;
    use t.priority == root_prio;
    use t.right != null ==&gt; sorted(t.right) &amp;&amp; \unfolding t.right.tree() \in t.priority &gt;= t.right.priority;
    // assemble parts
    fold t.tree();
    qed res.tree() ** sorted(res) ** wand_helper(res, root_prio) 
        -* 
        t.tree() ** sorted(t);
  }
  @*/
  return res;
}

/*@
context t != null;
context t.tree() ** sorted(t);
requires \unfolding t.tree() \in t.left != null;
@*/
static boolean check_left_priority_sorted(Tree t, int max_priority) {
  //@ ghost int root_prio;
  Tree left = get_left_sorted(t) /*@ then { root_prio = root_prio; } @*/;
  // now we have left.tree(), sorted(left) and wand_helper(left, root_prio), as well as the wand
  //@ unfold left.tree();
  boolean res = left.priority &lt;= max_priority;
  //@ fold left.tree();
  //@ apply (left.tree() ** sorted(left) ** wand_helper(left, root_prio)) -* (t.tree() ** sorted(t));
  // now left.tree() is no longer directly available, but t.tree() is back and sorted
  return res;
}} // Closing brace for class Tree, which started at the beginning of this chapter
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" >PVL</option>
                
                    <option value="java" selected="">Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

<!-- standaloneSnip magicWandAndTree
} // Closing brace for class Tree, which started at the beginning of this chapter
-->

<p>Now, when creating the wand, we need to <code>use</code> additional
information in order to be able to ensure sortedness after the merger:
The condition for the right side can simply be provided. The condition
for the left side is part of the premise of the wand (in particular
<code>sorted</code>). The comparison between the priority of the root
and the priority of the left node is wrapped into a helper function,
<code>wand_helper</code>. Since the premise of the wand contains no
permissions for <code>t.priority</code>, we use a ghost variable
<code>root_prio</code> to communicate that value.</p>
<p>Applying the wand is nearly as simple as before. However, we again
need to use the ghost variable <code>root_prio</code> as an intermediate
storage for the priority of <code>t</code>.</p>
<p>You see that adding such additional constraints about the wand's
resources is possible, but can carry significant overhead of helper
functions, <code>use</code> statements, etc.</p>
<h1 id="inhale-and-exhale">Inhale and exhale</h1>
<p>// TODO: Explain inhale and exhale statements (add warning!)</p>
<h1 id="what-does-this-vercors-error-message-mean">What does this
VerCors error message mean?</h1>
<p>This page is to explain what the different error messages in VerCors
mean. We try to keep this page alphabetically ordered by error message
(case insensitive sorting. For sentences: spaces come before letters in
the alphabet). If you have a question about error messages, please add a
question to this wiki page. If you know the answer to a question asked
here, please replace the question with the answer (or with a link to the
answer elsewhere on the wiki).</p>
<h4 id="assignmentfailed-insufficient-permission">AssignmentFailed:
insufficient permission</h4>
<p>This means you are trying to write to a variable (at the left hand
side of an assignment) to which VerCors cannot establish a
write-permission. The statement <code>assert(Perm(lhs,1));</code> in
which <code>lhs</code> is the left hand side of this assignment will
fail at this point in your code, but should be provable.</p>
<h4 id="illegal-argument-count">Illegal argument count</h4>
<p>This is a internal VerCors error, that might be due to a parse-error
in your script. We have opened a issue for this <a
href="https://github.com/utwente-fmt/vercors/issues/125">here</a>.</p>
<h4 id="illegal-iteration-invariant">Illegal iteration invariant</h4>
<p>This seems to happen when you try to specify a
<code>loop_invariant</code> in a <code>for</code>-loop, where you're
using a resource as invariant. Try using <code>context</code> (short for
<code>ensures</code> and <code>requires</code> combined) instead. Are
you getting this message in a different situation? Do let us know!</p>
<h4 id="javalang">java.lang.*</h4>
<p>This is never supposed to happen, but unfortunately, it did. Thank
you for finding this bug in VerCors. Try searching our issue tracker to
see if you believe this bug is already being addressed. If not, please
let us know about it by adding it!</p>
<h4 id="no-viable-alternative-at-">No viable alternative at ...</h4>
<p>This is a parsing error, you may have made a typo, or inadvertently
used a reserved keyword as a variable. Check your code at the position
indicated. If this is the start of a line, make sure there is a
semicolon <code>;</code> at the previous line.</p>
<h4
id="notwellformedinsufficientpermission">NotWellFormed:InsufficientPermission</h4>
<p>This error is shown at a specification. We require rules to be 'self
framing', this means that you need read-permission in order to access
variables, even inside specifications. Furthermore, checks like array
accesses being within bounds need to hold. The order of the
specifications makes a difference here: the lines of your specifications
are checked from top to bottom, and from left to right. In order to
establish permissions and bounds, add a line of specification before the
line that gives you trouble, asserting that you have read permission, or
that the access is within bounds.</p>
<p>If you see this error in the <code>\old(..)</code> part of an ensures
expression, you need permission to that variable before executing the
function. For constructors (e.g. <code>foo</code> method of class
<code>foo</code>), there is no <code>\old(this.x)</code>, as the
variable <code>this.x</code> is only created when the constructor is
called.</p>
<h4
id="pre-condition-of-constructor-may-not-refer-to-this">Pre-condition of
constructor may not refer to this</h4>
<p>When calling the constructor method of a class, the class variables
are not yet initialised. Therefore, you should not refer to them. Do you
need write-permission? Don't worry, the class constructor already has it
by definition (as it implicitly creates the variables)! In particular,
use <code>ensures</code> instead of <code>context</code>.</p>
<h4 id="type-of-leftright-argument-is-resource-rather-than-boolean">Type
of left/right argument is Resource rather than Boolean:</h4>
<p>This is a type error. You are using a symbol like
<code>&amp;&amp;</code> that requires boolean values on both sides.
Changing <code>&amp;&amp;</code> to <code>**</code>, or breaking up your
specification into multiple lines might solve the problem for you.</p>
<h4
id="verification-aborted-exceptionally-javautilconcurrentexecutionexception-javautilconcurrentexecutionexception-javautilnosuchelementexception-noneget">Verification
aborted exceptionally: java.util.concurrent.ExecutionException:
java.util.concurrent.ExecutionException:
java.util.NoSuchElementException: None.get</h4>
<p>See <a
href="https://github.com/utwente-fmt/vercors/wiki/Predicates#vercors-crashes-when-predicates-are-unfolded">VerCors
crashes when predicates are unfolded</a>.</p>
<h4
id="not-injective-or-resource-may-not-be-unique-with-regards-to-the-quantified-variables-or-similar">"Not
injective", or "resource may not be unique with regards to the
quantified variables", or similar</h4>
<p>Viper requires that all <code>forall</code> with permission
expressions (<code>forall*</code> in VerCors) are "injective". That
means that different values for the quantified variable(s) must result
in different memory locations in the permission expression. For example
in
<code>(\forall* int k; 0&lt;=k &amp;&amp; k&lt;arr.length; Perm(arr[k].myField, 1))</code>,
different <code>k</code> must point to different array elements, i.e.
<code>arr[i]</code> must be different from <code>arr[j]</code> if
<code>i!=j</code>. You need to add a condition like
<code>(\forall int i, int j; 0&lt;=i &amp;&amp; i&lt;j &amp;&amp; j&lt;arr.length; arr[i] != arr[j])</code>
before the quantifier that "may not be unique". And if
<code>myField</code> is an object, you might need to do the same for
<code>arr[i].myField</code> and <code>arr[j].myField</code>. More info
is <a
href="https://github.com/utwente-fmt/vercors/wiki/Arrays-and-Pointers#injectivity-object-arrays-and-efficient-verification">here</a>.</p>
<h1 id="pvl-syntax-reference">PVL Syntax Reference</h1>
<p>On this page you can find a description of the specification language
of VerCors. In general, the specification language extends the language
that is verified, like Java. That means that all types, (pure)
operators, etc. from the source language can also be used in the
specifications, together with the specification-only constructs
described below.</p>
<p>Additionally, this page describes PVL, the Prototypal Verification
Language. It is a language similar to Java or C and can be verified like
them, so the same specification constructs are available. However, it is
developed specifically for VerCors, so we also provide the information
that is usually found in the language documentation, like the C
standard.</p>
<h2 id="general">General</h2>
<ul>
<li><p>Specifications are usually embedded in JML-like comments:
<code>/*@ spec @*/</code> or <code>//@ spec line</code>.
<strong>Exception</strong>: In PVL, specifications are
<strong>not</strong> embedded in comments, instead they are written into
the code directly.</p></li>
<li><p>In PVL, <strong>identifiers</strong> can consist of the
characters a-z, A-Z, 0-9 and _. However, they must
<strong>start</strong> with an underscore or letter (a-z, A-Z).</p>
<p>In specifications, the same rules apply for identifiers as in the
language that is specified, e.g. Java identifiers in specifications of
Java.</p>
<p>Note that the following words are reserved and can therefore
<strong>not</strong> be used as identifiers: create, action, destroy,
send, recv, use, open, close, atomic, from, merge, split, process,
apply, label, \result, write, read, none, empty and current_thread.
However, keywords can be wrapped in backticks, to turn them into
identifiers, e.g. <code>create</code> cannot be used as an identifier,
but <code>`create`</code> is an identifier.</p></li>
<li><p>Most specification constructs are self-contained statements, like
preconditions, loop invariants or ghost assignments. Those end with a
semicolon <code>;</code>. However, a few elements, like
<code>with</code> side conditions, are parts of another statement, and
do not have their own semicolon.</p></li>
</ul>
<h3 id="pvl">PVL</h3>
<ul>
<li>At the top level of a program, there can be methods directly (like
in C). But more commonly, those are defined within a
<code>class</code>:</li>
</ul>
<!-- -->

<pre><code>class ClassName {
    // Here you can add any constructors, class variables and method declarations
}</code></pre>
<ul>
<li>The keyword <code>this</code> is used to refer to the current
object, <code>null</code> for the null reference ("pointer to
nothing").</li>
<li>You can write single-line or multi-line comments as follows:</li>
</ul>
<!-- -->

<pre><code>// This is a single-line comment
/* 
    This is a 
    multi-line comment 
*/</code></pre>
<ul>
<li>Like in C or Java, statements in PVL should end with a semi-colon
<code>;</code>.</li>
<li>For a more detailed description, see <a
href="https://github.com/utwente-fmt/vercors/wiki/Prototypal-Verification-Language">https://github.com/utwente-fmt/vercors/wiki/Prototypal-Verification-Language</a></li>
</ul>
<h2 id="types-and-data-structures">Types and Data Structures</h2>
<p>The following table lists the basic and composed data types supported
in the specification language.</p>
<table>
<thead>
<tr class="header">
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>resource</code></td>
<td>Boolean-like type that also allows reasoning about permissions. See
<a
href="https://github.com/utwente-fmt/vercors/wiki/Predicates">https://github.com/utwente-fmt/vercors/wiki/Predicates</a></td>
</tr>
<tr class="even">
<td><code>frac</code></td>
<td>Fraction, used for permission amounts. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Permissions">https://github.com/utwente-fmt/vercors/wiki/Permissions</a></td>
</tr>
<tr class="odd">
<td><code>zfrac</code></td>
<td>Fraction that can also be zero.</td>
</tr>
<tr class="even">
<td><code>rational</code></td>
<td>Unbounded rational number</td>
</tr>
<tr class="odd">
<td><code>bool</code></td>
<td>Boolean value that is either <code>true</code> or
<code>false</code></td>
</tr>
<tr class="even">
<td><code>string</code></td>
<td>Text, i.e. a string of characters</td>
</tr>
<tr class="odd">
<td><code>ref</code></td>
<td>Reference to an object, similar to Viper's <code>Ref</code> type.
Mostly for internal usage, e.g. ADT definitions.</td>
</tr>
<tr class="even">
<td><code>process</code></td>
<td>Type of actions and defined processes in process algebra models. See
<a
href="https://github.com/utwente-fmt/vercors/wiki/Process-Algebra-Models">https://github.com/utwente-fmt/vercors/wiki/Process-Algebra-Models</a></td>
</tr>
<tr class="odd">
<td><code>any</code></td>
<td>Artificial type that is a supertype of any other type. Mostly for
internal usage, e.g. rewrite rules.</td>
</tr>
<tr class="even">
<td><code>nothing</code></td>
<td>Artificial type that is a subtype of any other type. Mostly for
internal usage, e.g. rewrite rules.</td>
</tr>
<tr class="odd">
<td><code>seq&lt;T&gt;</code></td>
<td>Defines an immutable ordered list (sequence). <code>T</code> should
be replaced by a type. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types">https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types</a></td>
</tr>
<tr class="even">
<td><code>set&lt;T&gt;</code></td>
<td>Defines an immutable orderless collection that does not allow
duplicates ("set"). <code>T</code> should be replaced by a type. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types">https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types</a></td>
</tr>
<tr class="odd">
<td><code>bag&lt;T&gt;</code></td>
<td>Defines an immutable orderless collection that does allow duplicates
("bag" or "multiset"). <code>T</code> should be replaced by a type. See
<a
href="https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types">https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types</a></td>
</tr>
<tr class="even">
<td><code>map&lt;T1, T2&gt;</code></td>
<td>Defines an immutable orderless collection of key/value pairs that
does not allow duplicate keys ("map", "record" or "dictionary").
<code>T1</code> and <code>T2</code> should be replaced by Types. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types">https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types</a></td>
</tr>
<tr class="odd">
<td><code>option&lt;T&gt;</code></td>
<td>Extends type <code>T</code> with an extra element <code>None</code>.
Each element is then either <code>None</code> or of the style
<code>Some(e)</code> where <code>e</code> is of type <code>T</code>.
<code>T</code> should be replaced by a type. Options cannot be unpacked
at the moment. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types">https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types</a></td>
</tr>
<tr class="even">
<td><code>tuple&lt;T1,T2&gt;</code></td>
<td>Defines a pair, where the first entry is of type <code>T1</code> and
the second of type <code>T2</code>. Can be nested to create larger
tuples. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types">https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types</a></td>
</tr>
<tr class="odd">
<td><code>pointer&lt;T&gt;</code></td>
<td>Defines the type of a pointer to an element of type <code>T</code>.
<code>T</code> should be replaced by a type. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Arrays-and-Pointers">https://github.com/utwente-fmt/vercors/wiki/Arrays-and-Pointers</a></td>
</tr>
<tr class="even">
<td><code>type&lt;T&gt;</code></td>
<td>Used to define type variables that are subtype of <code>T</code>.
Mostly used for rewrite rules, e.g.
<code>(\forall type&lt;any&gt; T; (\forall T t; expr))</code></td>
</tr>
<tr class="odd">
<td><code>either&lt;T1, T2&gt;</code></td>
<td>Defines the type of an object <code>o</code> that is either of type
<code>T1</code> or of type <code>T2</code>. See TODO</td>
</tr>
<tr class="even">
<td>language type</td>
<td>A type from the base language, e.g. Java, can also be used in the
specifications for that language. This usually provides basic types like
<code>int</code>.</td>
</tr>
</tbody>
</table>
<h3 id="pvl-1">PVL</h3>
<p>In PVL, the specification types above can also be used in the regular
program. Additionally, the following types are available:</p>
<table>
<thead>
<tr class="header">
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>int</code></td>
<td>Integer</td>
</tr>
<tr class="even">
<td><code>boolean</code></td>
<td><code>true</code> or <code>false</code></td>
</tr>
<tr class="odd">
<td><code>void</code></td>
<td>Used when a method does not return anything</td>
</tr>
<tr class="even">
<td><code>float32</code></td>
<td>32-bit floating point number (Note: support still limited)</td>
</tr>
<tr class="odd">
<td><code>float64</code></td>
<td>64-bit floating point number (Note: support still limited)</td>
</tr>
<tr class="even">
<td><code>char</code></td>
<td>Character</td>
</tr>
<tr class="odd">
<td><code>T[]</code></td>
<td>Array which contains elements of type <code>T</code>. <code>T</code>
should be replaced by a type. Note that when you initialize a new array,
you should always define the length of the array, e.g.
<code>new int[3]</code> instead of <code>new int[]</code>.</td>
</tr>
</tbody>
</table>
<h2 id="expressions-1">Expressions</h2>
<h3 id="operators">Operators</h3>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>\</code></td>
<td>Division that creates a <code>frac</code>, rather than integer
rounding. Same precedence as multiplication and division.</td>
</tr>
<tr class="even">
<td><code>==&gt;</code></td>
<td>Logical implication. The left side should be boolean-typed, the
right side boolean or resource. Lower precedence than disjunction `</td>
</tr>
<tr class="odd">
<td><code>**</code></td>
<td>Separating conjunction. <code>a ** b</code> denotes that
<code>a</code> and <code>b</code> point to different variables on the
heap and that both expressions must evaluate to true. This is used to
reason about multiple resources. Same precedence as conjunction
<code>&amp;&amp;</code>. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Permissions">https://github.com/utwente-fmt/vercors/wiki/Permissions</a></td>
</tr>
<tr class="even">
<td><code>-*</code></td>
<td>"Magic wand" or "separating implication". Same precedence as
implication <code>==&gt;</code>. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Magic-Wands">https://github.com/utwente-fmt/vercors/wiki/Magic-Wands</a></td>
</tr>
<tr class="odd">
<td><code>[p]pred(&lt;args&gt;)</code></td>
<td><code>[p]</code> before a predicate invocation scales all
permissions in <code>pred</code> by a factor of <code>p</code>. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Predicates">https://github.com/utwente-fmt/vercors/wiki/Predicates</a></td>
</tr>
<tr class="even">
<td><code>Left(e)</code></td>
<td>// unclear. Seems related to type "either" TODO</td>
</tr>
<tr class="odd">
<td><code>Right(e)</code></td>
<td>// unclear. Seems related to type "either" TODO</td>
</tr>
<tr class="even">
<td><code>?.</code></td>
<td><code>o?.m(&lt;args&gt;)</code> is a conditional invocation of
method <code>m</code>, equivalent to
<code>o!=null ==&gt; o.m(&lt;args&gt;)</code>. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax">https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax</a></td>
</tr>
<tr class="odd">
<td><code>m() given {a=b, c=d}</code></td>
<td>Invokes method <code>m</code> with expression <code>b</code> as
value of ghost parameter <code>a</code> and similar for <code>c</code>
and <code>d</code>. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax">https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax</a></td>
</tr>
<tr class="even">
<td><code>m() yields {a=b, c=d}</code></td>
<td>Invokes method <code>m</code>, and storing ghost return value
<code>b</code> in <code>a</code> and similar for <code>c</code> and
<code>d</code>. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax">https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax</a></td>
</tr>
<tr class="odd">
<td><code>with</code></td>
<td>augment an expression with a side effect to happen before evaluating
it, e.g. <code>/*@ with specInit(); @*/ init()</code>. Previously used
for ghost parameters, now obsolete (?) // TODO</td>
</tr>
<tr class="even">
<td><code>then</code></td>
<td>augment an expression with a side effect to happen after evaluating
it, e.g. <code>init() /*@ then specInit(); @*/</code>. Previously used
for ghost return values, now obsolete (?) // TODO</td>
</tr>
<tr class="odd">
<td><code>(\let T t = exprA; exprB)</code></td>
<td>Evaluates <code>exprB</code>, replacing every occurence of
<code>t</code> with the result of evaluating<code>exprA</code>. The
surrounding parentheses <code>(</code> <code>)</code> are required.</td>
</tr>
</tbody>
</table>
<h4 id="adts">ADTs</h4>
<p>Axiomatic Data types have several dedicated operators. Some also have
corresponding functions, e.g. <code>s1.subsetOf(s2)</code> for
<code>s1 &lt;= s2</code>. There are also functions that do not have an
operator equivalence, e.g. <code>xs.removeAt(i)</code>. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types">https://github.com/utwente-fmt/vercors/wiki/Axiomatic-Data-Types</a>
for the full list.</p>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>+</code></td>
<td>Sequence concatenation, Set union, Bag union</td>
</tr>
<tr class="even">
<td><code>-</code></td>
<td>Set difference, Bag difference</td>
</tr>
<tr class="odd">
<td><code>*</code></td>
<td>Set intersection, Bag intersection</td>
</tr>
<tr class="even">
<td><code>&lt;</code>, <code>&lt;=</code></td>
<td>strict subset, or subset-or-equal, respectively (also for bags)</td>
</tr>
<tr class="odd">
<td><code>xs[k]</code></td>
<td>Sequence indexing: <code>k</code>th element of sequence
<code>xs</code>; Map indexing: value associated with key
<code>k</code></td>
</tr>
<tr class="even">
<td><code>::</code></td>
<td><code>x :: xs</code> prepends element <code>x</code> to the front of
sequence <code>xs</code>.</td>
</tr>
<tr class="odd">
<td><code>++</code></td>
<td><code>xs ++ x</code> appends element <code>x</code> to the end of
sequence <code>xs</code>. // Note: Discouraged, support may get
removed.</td>
</tr>
<tr class="even">
<td><code>e[l .. r]</code></td>
<td>Range indexing of sequence <code>e</code> (slicing). Creates a new
sequence with the elements of <code>e</code> between indices
<code>l</code> (incl.) and <code>r</code>(excl.). One of <code>l</code>
or <code>r</code> may be omitted.</td>
</tr>
<tr class="odd">
<td><code>e[k -&gt; v]</code></td>
<td>Updating of map <code>e</code> at index <code>k</code> to new value
<code>v</code> (<strong>not</strong> in-place).</td>
</tr>
<tr class="even">
<td>`</td>
<td>xs</td>
</tr>
<tr class="odd">
<td><code>\values(e1, e2, e3)</code></td>
<td>create a sequence that stores the values from array <code>e1</code>
between indices <code>e2</code> and <code>e3</code>.</td>
</tr>
<tr class="even">
<td><code>Some(e)</code></td>
<td>Turns expression <code>e</code> of type <code>T</code> into an
expression of type <code>option&lt;T&gt;</code> containing
<code>e</code>.</td>
</tr>
<tr class="odd">
<td><code>seq&lt;T&gt;{vals}</code> or <code>[vals]</code></td>
<td>sequence literal containing values <code>vals</code> (of type
<code>T</code>).</td>
</tr>
<tr class="even">
<td><code>set&lt;T&gt;{vals}</code> or <code>{vals}</code></td>
<td>set literal containing values <code>vals</code> (of type
<code>T</code>).</td>
</tr>
<tr class="odd">
<td><code>bag&lt;T&gt;{vals}</code> or <code>b{vals}</code></td>
<td>bag literal containing values <code>vals</code> (of type
<code>T</code>).</td>
</tr>
<tr class="even">
<td><code>map&lt;T1, T2&gt;{k1-&gt;v1, k2-&gt;v2,...}</code></td>
<td>map literal mapping <code>k1</code> (of type <code>T1</code>) to
<code>v1</code> (of type <code>T2</code>), etc.</td>
</tr>
<tr class="odd">
<td><code>tuple&lt;T1, T2&gt;{v1, v2}</code></td>
<td>tuple literal containing the two values <code>v1</code> (of type
<code>T1</code>) and <code>v2</code> (of type <code>T2</code>).</td>
</tr>
<tr class="even">
<td><code>[t: T]</code>, <code>{t: T}</code>, <code>b{t: T}</code></td>
<td>literal describing the empty <code>seq&lt;T&gt;</code>,
<code>set&lt;T&gt;</code> and <code>bag&lt;T&gt;</code>, respectively.
Note that <code>T</code> is a type parameter that should be replaced
with the appropriate type, while <code>t:</code> is part of the syntax
and should occur literally, e.g.
<code>int[] emp = [t: int];</code>.</td>
</tr>
<tr class="odd">
<td><code>{l .. r}</code></td>
<td>Literal of type <code>set&lt;int&gt;</code> describing the integer
range from <code>l</code> (incl) to <code>r</code> (excl).</td>
</tr>
<tr class="even">
<td>`set<T>{ e</td>
<td>selectors ; filter }`</td>
</tr>
<tr class="odd">
<td><code>x \in xs</code></td>
<td>Membership check if element <code>x</code> is contained in
collection <code>xs</code>. Note: For bags, it returns the number of
occurrences, <strong>not</strong> a boolean.</td>
</tr>
<tr class="even">
<td><code>(\sum int idx; range; e)</code></td>
<td>Sequence summation: sum expression <code>e</code> (which depends on
the index <code>idx</code>) for all indices within the given range.
Note: currently not supported.</td>
</tr>
</tbody>
</table>
<h4 id="pvl-2">PVL</h4>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>==</code>, <code>!=</code></td>
<td>Equals and not equals for reasoning about the equality of
expressions</td>
</tr>
<tr class="even">
<td><code>&amp;&amp;</code>, `</td>
<td></td>
</tr>
<tr class="odd">
<td><code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>,
<code>&gt;=</code></td>
<td>Smaller-than, smaller-or-equal, greater-than and greater-or-equal,
respectively, for comparing numerical expressions.</td>
</tr>
<tr class="even">
<td><code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>,
<code>%</code>, <code>^^</code></td>
<td>Addition, subtraction, multiplication, integer division, modulo and
power/exponentiation respectively.</td>
</tr>
<tr class="odd">
<td><code>++</code>, <code>--</code></td>
<td>As a postfix operator <code>i++</code>, increase <code>i</code> by 1
(resp. decrease for <code>--</code>). Also note the <code>++</code>
binary operator above.</td>
</tr>
<tr class="even">
<td><code>new T(&lt;args&gt;)</code></td>
<td>Creates a new object of type <code>T</code>.</td>
</tr>
<tr class="odd">
<td><code>new T[length]</code></td>
<td>Creates a new array which contains objects of type <code>T</code>
with <code>length</code> number of items.</td>
</tr>
<tr class="even">
<td><code>boolExpr ? exprA : exprB;</code></td>
<td>Evaluates <code>boolExpr</code>, if this is true it will return
<code>exprA</code> and otherwise <code>exprB</code>.</td>
</tr>
</tbody>
</table>
<h3 id="quantified-expressions">Quantified Expressions</h3>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>(\forall vars; cond; boolExpr)</code></td>
<td>Universal quantifier: For all specified variables, if they fulfil
the given condition, they must fulfil the boolean expression.
<code>vars</code> should declare one or more variables over which we
will reason. For integer variables, it can also directly specify their
range. <code>cond</code> can be any boolean expression, often used to
describe the range of <code>vars</code> (if not already defined in
<code>vars</code> itself). <code>cond</code> and the subsequent
semicolon can be omitted. <code>boolExpr</code> is some expression that
should evaluate to a boolean for all variables in the given range.
Example: <code>(\forall int i=0 .. a.length; a[i]&gt;0)</code>, which
means <code>a[0]&gt;0 &amp;&amp; a[1]&gt;0 &amp;&amp; ...</code> Note:
the outer parentheses are required. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax">https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax</a></td>
</tr>
<tr class="even">
<td><code>(\forall* vars; cond; expr)</code></td>
<td>Similar construct to the <code>\forall</code> except that the
expressions are separated by <code>**</code> instead of
<code>&amp;&amp;</code>. One can for example write
<code>(\forall* int j=0 .. a.length; Perm(a[j], write))</code> which
denotes that the thread has writing access to all elements in
<code>a</code>. Note: the outer parentheses are required. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax">https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax</a></td>
</tr>
<tr class="odd">
<td><code>(\exists vars; cond; expr)</code></td>
<td>Evaluates to true if <code>expr</code> evaluates to true for at
least one of the possible assignments to the variables in
<code>vars</code>, where the assignment also satisfies the condition
<code>cond</code>. The latter and the respective semicolon can be
omitted. Note: the outer parentheses are required. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax">https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax</a></td>
</tr>
<tr class="even">
<td><code>array[*]</code></td>
<td>This is syntactic sugar for a <code>\forall*</code> expression that
ranges over all elements in the array <code>array</code>, typically used
in a <code>Perm</code> expression. Instead of the example above for
<code>\forall*</code>, you can then write
<code>Perm(array[*], write)</code>. This <strong>cannot</strong> be used
within nested <code>\forall*</code> expressions. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Permissions">https://github.com/utwente-fmt/vercors/wiki/Permissions</a></td>
</tr>
<tr class="odd">
<td><code>(\forperm T1 o1, ..., Tn on \in loc; expr)</code></td>
<td>Universal quantifier over accessible locations: Boolean expression
<code>expr</code> has to hold for all variables <code>o1</code> of type
<code>T1</code>, ..., <code>on</code> of type <code>Tn</code> for which
we currently have at least read permission to <code>loc</code>. Example:
<code>(\forperm MyClass obj \in obj.f; obj.f==0)</code> Note: the outer
parentheses are required.</td>
</tr>
</tbody>
</table>
<h3 id="specification-only-expressions">Specification-only
Expressions</h3>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>\result</code></td>
<td>The value that the method returns, only allowed in postconditions.
See <a
href="https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax">https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax</a></td>
</tr>
<tr class="even">
<td><code>\old(expr)</code></td>
<td>Refers to the value of <code>expr</code> based on the heap when the
method was called. This expression is typically used in postconditions
(ensures) or loop invariants, but can also occur e.g. in
<code>assert</code> statements. Note: local variables are evaluated to
their current value, <strong>not</strong> their old value. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax">https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax</a></td>
</tr>
<tr class="odd">
<td><code>held(x)</code></td>
<td>Check whether you are holding a non-reentrant lock. <code>x</code>
should refer to the lock invariant. See also: <a
href="https://github.com/utwente-fmt/vercors/blob/dev/examples/waitnotify/Queue.pvl">Queue.pvl</a>.</td>
</tr>
<tr class="even">
<td><code>commited(x)</code></td>
<td>Check whether lock <code>x</code> has been initialised. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Atomics-and-Locks">https://github.com/utwente-fmt/vercors/wiki/Atomics-and-Locks</a></td>
</tr>
<tr class="odd">
<td><code>idle(t)</code></td>
<td>Returns true if thread <code>t</code> is idle (before calling
<code>t.fork()</code> or after calling <code>t.join()</code>). Overall a
thread starts as idle, if the thread is forked, it goes to a 'running'
state. If join is called on a running thread, then it goes back to an
'idle' state. For examples, see <a
href="https://github.com/utwente-fmt/vercors/blob/dev/examples/concepts/forkjoin/">https://github.com/utwente-fmt/vercors/blob/dev/examples/concepts/forkjoin/</a></td>
</tr>
<tr class="even">
<td><code>running(t)</code></td>
<td>Returns true if thread <code>t</code> is running. Overall a thread
can go through the following states: idle --[t.fork()]--&gt; running
--[t.join()]--&gt; idle. For examples, see <a
href="https://github.com/utwente-fmt/vercors/blob/dev/examples/concepts/forkjoin/">https://github.com/utwente-fmt/vercors/blob/dev/examples/concepts/forkjoin/</a></td>
</tr>
<tr class="odd">
<td><code>\polarity_dependent(onInhale, onExhale)</code></td>
<td>Evaluate this expression differently, depending on whether it is
inhaled (e.g. precondition when verifying method body) or exhaled (e.g.
precondition when verifying calling context). <code>onInhale</code> and
<code>onExhale</code> are the two forms of this expression.
<strong>Note: Use with care, can easily cause unsoundness!</strong>
TODO</td>
</tr>
</tbody>
</table>
<h3 id="resources">Resources</h3>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>Perm(var, p)</code></td>
<td>Defines permissions for variable <code>var</code>. If <code>p</code>
is <code>1</code> or <code>write</code> then it denotes write
permission, anything between 0 and 1 or <code>read</code> denotes read
permission. Be aware that you cannot use arithmetic when using
<code>read</code> such as <code>read/2</code> or dividing
<code>read</code> among multiple threads! <code>Perm(...)</code> is of
the type Resource. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Permissions">https://github.com/utwente-fmt/vercors/wiki/Permissions</a></td>
</tr>
<tr class="even">
<td><code>perm(var)</code></td>
<td>The amount of permission currently held for variable
<code>var</code>. <strong>Do not confuse with capitalised
<code>Perm</code> above!</strong> <code>perm(x)</code> is of the type
frac. See TODO</td>
</tr>
<tr class="odd">
<td><code>PointsTo(var, p, val)</code></td>
<td>Denotes permissions <code>p</code> for variable <code>var</code>
similar to <code>Perm()</code>. Moreover, variable <code>var</code>
points to the value <code>val</code>. <code>PointsTo()</code> is of the
type Resource. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Permissions">https://github.com/utwente-fmt/vercors/wiki/Permissions</a></td>
</tr>
<tr class="even">
<td><code>Value(var)</code></td>
<td>Defines a read-only permission on the given variable. This read-only
permission cannot become a write permission and it can duplicate as
often as necessary. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Permissions">https://github.com/utwente-fmt/vercors/wiki/Permissions</a></td>
</tr>
<tr class="odd">
<td><code>HPerm(var, p)</code></td>
<td>History permission, related to process algebra models. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Process-Algebra-Models">https://github.com/utwente-fmt/vercors/wiki/Process-Algebra-Models</a></td>
</tr>
<tr class="even">
<td><code>APerm(var, p)</code></td>
<td>Action permission, related to process algebra models. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Process-Algebra-Models">https://github.com/utwente-fmt/vercors/wiki/Process-Algebra-Models</a></td>
</tr>
<tr class="odd">
<td><code>ArrayPerm(arr, i, step, count, perm)</code></td>
<td>Denotes permission <code>p</code> to <code>arr[i]</code>,
<code>arr[i+step]</code>, ..., <code>arr[i+(count-1)*step]</code>.
Currently not supported. TODO</td>
</tr>
<tr class="even">
<td><code>\array(arr, len)</code></td>
<td>Shortcut for <code>arr != null &amp;&amp; arr.length == len</code>.
Does <strong>not</strong> specify permissions. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Arrays-and-Pointers">https://github.com/utwente-fmt/vercors/wiki/Arrays-and-Pointers</a></td>
</tr>
<tr class="odd">
<td><code>\matrix(mat, m, n)</code></td>
<td>Indicates that <code>mat</code> is an <code>m</code> by
<code>n</code> matrix, i.e. an array of pairwise-distinct arrays.
Contains <code>read</code> permissions for the outer array, but no
permissions for the matrix elements. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Arrays-and-Pointers">https://github.com/utwente-fmt/vercors/wiki/Arrays-and-Pointers</a></td>
</tr>
<tr class="even">
<td><code>\pointer(x, size, p)</code></td>
<td>Indicates that <code>x</code> is a pointer, like an array in C.
Elements <code>x[0]</code> to <code>x[size-1]</code> are not
<code>NULL</code> and can be dereferenced. For each of them, we have
permission <code>p</code>. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Arrays-and-Pointers">https://github.com/utwente-fmt/vercors/wiki/Arrays-and-Pointers</a></td>
</tr>
<tr class="odd">
<td><code>\pointer_index(x, idx, p)</code></td>
<td>Indicates that <code>x</code> is a pointer or array in C, which is
not NULL. For <code>x[idx]</code>, we have permission <code>p</code> (no
statement about other array elements). See <a
href="https://github.com/utwente-fmt/vercors/wiki/Arrays-and-Pointers">https://github.com/utwente-fmt/vercors/wiki/Arrays-and-Pointers</a></td>
</tr>
<tr class="even">
<td><code>\pointer_block_length(x)</code></td>
<td>The length of the pointer block (i.e. C array) that <code>x</code>
is part of. This is the size (in the amount of elements) of the
allocation that <code>x</code> is a part of.</td>
</tr>
<tr class="odd">
<td><code>\pointer_block_offset(x)</code></td>
<td>The offset of <code>x</code> within the pointer block (i.e. C
array). This is the offset (in the amount of elements) of the pointer
<code>x</code> compared to the start of the allocation that
<code>x</code> is a part of.</td>
</tr>
<tr class="even">
<td><code>\pointer_block(x)</code></td>
<td>The block which contains the location <code>x</code>. You may need
to assume that a pointer originates from the same block as another
pointer if VerCors cannot figure out that the two pointers have the same
provenance. (i.e. they originate from the same allocation)</td>
</tr>
<tr class="odd">
<td><code>\pointer_length(x)</code></td>
<td>The remaining length of the pointer block (i.e. C array) that
<code>x</code> is a part of starting at <code>x</code>. This is the
amount of locations for elements (including this one) between
<code>x</code> and the end of the allocation.</td>
</tr>
</tbody>
</table>
<h2 id="control-flow-constructs-pvl">Control flow constructs (PVL)</h2>
<p>PVL provides similar control flow constructs as other languages, e.g.
loops and methods. However, there are also some unique additional
control flow constructs that are explained here.</p>
<table>
<thead>
<tr class="header">
<th>Control flow construct</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>contract returnType methodName(paramType paramName, ...) { ... }</code></td>
<td>Method definition. <code>contract</code> should describe the
specification of the method (see "Verification flow constructs" below).
<code>returnType</code> should be replaced by a PVL type described as
above, depending on what (if anything) the method returns.
<code>methodName</code> should be replaced by the name of the function.
<code>paramType paramName, ...</code> is a comma-separated list of
parameters, for every parameter you should define its type and its name.
It is also possible to have no parameters. The body is placed within
parentheses. Example:
<code>ensures \result == a + b; int sum(int a, int b) { return a + b; }</code></td>
</tr>
<tr class="even">
<td><code>contract returnType methodName(paramType paramName, ...);</code></td>
<td>Abstract method definition. like above, except no implementation is
specified in the body, just a semicolon. **Note: Be careful, it is easy
to create unsoundness with abstract methods! **</td>
</tr>
<tr class="odd">
<td><code>contract pure returnType methodName(paramType paramName, ...) = expr;</code></td>
<td>(Pure) function definition. Similar to a method, except no side
effects are allowed, and the body is just a single expression. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax">https://github.com/utwente-fmt/vercors/wiki/Specification-Syntax</a></td>
</tr>
<tr class="even">
<td><code>return expr;</code></td>
<td>Exit current method and return value of expression
<code>expr</code>. The expression can be omitted for <code>void</code>
methods.</td>
</tr>
<tr class="odd">
<td><code>if(cond) thenStmt else elseStmt</code></td>
<td>Branching control flow, depending on value of boolean expression
<code>cond</code>. Statements <code>thenStmt</code> and
<code>elseStmt</code> can be single statements, or compound statements
using <code>{...}</code>. The <code>else</code> branch can be
omitted.</td>
</tr>
<tr class="even">
<td><code>loopContract for (init; cond; update) stmt</code></td>
<td>Classic <code>for</code> loop. <code>loopContract</code> defines
loop invariants and variants as defined below. The body
<code>stmt</code> can be a single statement, or compound using
<code>{...}</code>. The initialisation <code>init</code> can be one or
more statements separated by comma, or omitted. The same holds for the
<code>update</code> statement(s). The boolean expression
<code>cond</code> can also be omitted.</td>
</tr>
<tr class="odd">
<td><code>loopContract for(T var = lo .. hi) stmt</code></td>
<td>Ranged <code>for</code> loop. <code>loopContract</code> and
<code>stmt</code> as above. The loop variable <code>var</code>(of type
<code>T</code>) ranges from <code>lo</code> (incl.) to <code>hi</code>
(excl.).</td>
</tr>
<tr class="even">
<td><code>loopContract while (cond) stmt</code></td>
<td>Classic <code>while</code> loop. <code>loopContract</code> and
<code>stmt</code> as above, boolean condition <code>cond</code>.</td>
</tr>
<tr class="odd">
<td><code>par identifier(iters) contract { ... }</code></td>
<td>Parallel block. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Parallel-Blocks">https://github.com/utwente-fmt/vercors/wiki/Parallel-Blocks</a></td>
</tr>
<tr class="even">
<td><code>parallel { parBlocks }</code></td>
<td>TODO</td>
</tr>
<tr class="odd">
<td><code>sequential { parBlocks }</code></td>
<td>TODO</td>
</tr>
<tr class="even">
<td><code>vec (iters) { ... }</code></td>
<td>Vector block: A variant of the parallel block where every step is
executed in lock step. <code>iters</code> should define what variables
are iterated over, e.g., <code>int i = 0..10</code>. Not the absence of
a contract, compared to regular <code>par</code> blocks.</td>
</tr>
<tr class="odd">
<td><code>atomic(inv) { ... }</code></td>
<td>Atomic block: performs the actions within the block atomically. See
<a
href="https://github.com/utwente-fmt/vercors/wiki/Atomics-and-Locks">https://github.com/utwente-fmt/vercors/wiki/Atomics-and-Locks</a></td>
</tr>
<tr class="even">
<td><code>invariant invName(expr) { ... }</code></td>
<td>Define resource expression <code>expr</code> as a named invariant
that can then be referenced inside the given block <code>{...}</code>,
e.g. by an <code>atomic</code></td>
</tr>
<tr class="odd">
<td><code>barrier(identifier) contract { ... }</code></td>
<td>Barrier: waits for all threads to reach this point in the program,
then permissions can be redistributed amongst all threads, after which
the threads are allowed to continue. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Parallel-Blocks">https://github.com/utwente-fmt/vercors/wiki/Parallel-Blocks</a></td>
</tr>
<tr class="even">
<td><code>fork expr;</code></td>
<td>starts a new thread.</td>
</tr>
<tr class="odd">
<td><code>join expr;</code></td>
<td>waits for the specified thread to complete.</td>
</tr>
<tr class="even">
<td><code>wait expr;</code></td>
<td>pause the thread until it is notified to continue.</td>
</tr>
<tr class="odd">
<td><code>notify expr;</code></td>
<td>notify another thread that it may continue if it is waiting.</td>
</tr>
<tr class="even">
<td><code>lock expr;</code></td>
<td>Acquire a lock. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Atomics-and-Locks">https://github.com/utwente-fmt/vercors/wiki/Atomics-and-Locks</a></td>
</tr>
<tr class="odd">
<td><code>unlock expr;</code></td>
<td>Release a lock. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Atomics-and-Locks">https://github.com/utwente-fmt/vercors/wiki/Atomics-and-Locks</a></td>
</tr>
<tr class="even">
<td><code>label l;</code></td>
<td>Label: indicates a location in the program that can be jumped to
with <code>goto l</code>.</td>
</tr>
<tr class="odd">
<td><code>goto l;</code></td>
<td>jump to the location of the label <code>l</code>.</td>
</tr>
<tr class="even">
<td><code>communicate x.f1 -&gt; y.f2;</code></td>
<td>VeyMont syntax: send value of field <code>x.f1</code> to field
<code>y.f2</code>. Opposite direction also possible via
<code>&lt;-</code>.</td>
</tr>
</tbody>
</table>
<h2 id="verification-flow-constructs">Verification flow constructs</h2>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>assert expr;</code></td>
<td>Check that boolean or resource expression <code>expr</code> holds at
this program point.</td>
</tr>
<tr class="even">
<td><code>assume expr;</code></td>
<td>Assume without checking that boolean expression <code>expr</code>
holds at this program point. ** Note: Careful, can easily cause
unsoundness! **</td>
</tr>
<tr class="odd">
<td><code>requires expr;</code></td>
<td>Method or function precondition: Boolean or resource expression
<code>expr</code> is checked to hold when calling this method, and
assumed to hold when verifying the method body. Defined as part of a
method contract, as well as e.g. contracts for parallel blocks.</td>
</tr>
<tr class="even">
<td><code>ensures expr;</code></td>
<td>Method or function postcondition: Boolean or resource expression
<code>expr</code> is assumed to hold immediately after calling this
method, and checked to hold when verifying the method body. Defined as
part of a method contract, as well as e.g. contracts for parallel
blocks.</td>
</tr>
<tr class="odd">
<td><code>context expr;</code></td>
<td>Shorthand that combines <code>requires expr</code> and
<code>ensures expr</code>.</td>
</tr>
<tr class="even">
<td><code>loop_invariant expr;</code></td>
<td>Loop invariant: Boolean or resource expression <code>expr</code>
must hold before entering the loop and after each loop iteration. Part
of a loop contract.</td>
</tr>
<tr class="odd">
<td><code>context_everywhere expr;</code></td>
<td>Shorthand that combines <code>requires expr</code> and
<code>ensures expr</code>. Moreover, it also adds
<code>loop_invariant expr;</code> to all loops within the method. Part
of a method contract.</td>
</tr>
<tr class="even">
<td><code>given T p;</code></td>
<td>Ghost input parameter: Defines a specification-only parameter
<code>p</code> of type <code>T</code> that must be passed when this
method is called (see <code>given</code> above). Part of a method
contract.</td>
</tr>
<tr class="odd">
<td><code>yields T p;</code></td>
<td>Ghost output parameter: Defines a specification-only return value
<code>p</code> of type <code>T</code>. <code>p</code> can be assigned in
the method body like a local variable; the last assigned value is
automatically returned to the caller, who can store it in their own
local variable (see <code>yields</code> above). Part of a method
contract.</td>
</tr>
<tr class="even">
<td><code>fold pred(...);</code></td>
<td>Fold a predicate, i.e. wrap permissions inside. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Predicates">https://github.com/utwente-fmt/vercors/wiki/Predicates</a></td>
</tr>
<tr class="odd">
<td><code>unfold pred(...);</code></td>
<td>Unfold predicate, i.e. unwrap the contained permissions. See <a
href="https://github.com/utwente-fmt/vercors/wiki/Predicates">https://github.com/utwente-fmt/vercors/wiki/Predicates</a></td>
</tr>
<tr class="even">
<td><code>\unfolding pred(...) \in expr</code></td>
<td>Temporarily unfold predicate in (pure) expression <code>expr</code>.
See <a
href="https://github.com/utwente-fmt/vercors/wiki/Predicates">https://github.com/utwente-fmt/vercors/wiki/Predicates</a></td>
</tr>
<tr class="odd">
<td><code>refute expr;</code></td>
<td>Disproves <code>expr</code> at this program point. Internally it is
translated to <code>assert !(expr)</code>.</td>
</tr>
<tr class="even">
<td><code>inhale expr;</code></td>
<td>Take in the permissions specified in the resource expression
<code>expr</code>, i.e. add them to the current set of permissions
without checking. Additionally, assume without checking all boolean
properties contained in <code>expr</code>. <strong>Note: Be careful,
this can easily lead to unsoundness!</strong></td>
</tr>
<tr class="odd">
<td><code>exhale expr;</code></td>
<td>Assert all permissions and boolean properties contained in
<code>expr</code>, then discard the specified permissions, i.e. remove
them from the current set of permissions.</td>
</tr>
<tr class="even">
<td><code>witness x;</code></td>
<td>Obsolete syntax to declare witness names for the old backend
Chalice. <em>This feature is deprecated and should no longer be
used</em>.</td>
</tr>
<tr class="odd">
<td><code>send channelName, delta: expr;</code></td>
<td>Transfer permissions and boolean facts contained in the resource
expression <code>expr</code> to another thread, identified via the
channel name. Used within parallelised loops, and <code>delta</code> is
the amount of loop iterations how far the expression is sent ahead.
Example: <code>send S,1: Perm(arr[i+1], 1\2);</code> sends permission
for the next array element to the next iteration. That way, the next
iteration can write to its <code>arr[i]</code>, even if it did not
originally have all the permission. See e.g. <a
href="https://github.com/utwente-fmt/vercors/blob/dev/examples/concepts/arrays/JavaArrayExamples.java">https://github.com/utwente-fmt/vercors/blob/dev/examples/concepts/arrays/JavaArrayExamples.java</a>.
See also <code>recv</code> below.</td>
</tr>
<tr class="even">
<td><code>recv channelName;</code></td>
<td>Receive the expression sent by a <code>send</code> as specified
above, with the matching channel name. Blocks until it is received.</td>
</tr>
</tbody>
</table>
<h3 id="histories--futures-">Histories &amp; Futures
<a name="historiesAndFutures"></a></h3>
<p>Histories and futures, jointly referred to as <a
href="https://github.com/utwente-fmt/vercors/wiki/Process-Algebra-Models">"Process
algebra models"</a> are currently under redesign. Thus, the following
parts may not be up to date.</p>
<h4 id="defining-processes">Defining processes</h4>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>process</code></td>
<td>Type of actions and defined processes in histories.</td>
</tr>
<tr class="even">
<td><code>process1 + process 2</code></td>
<td>Do either <code>process1</code> or <code>process2</code></td>
</tr>
<tr class="odd">
<td><code>process1 * process 2</code></td>
<td>Sequential composition, do <code>process1</code> followed by
<code>process2</code></td>
</tr>
<tr class="even">
<td>`process1</td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="history-related-constructs">History-related constructs</h4>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>History hist</code></td>
<td>Declare a History object called <code>hist</code></td>
</tr>
<tr class="even">
<td><code>HPerm(var, p)</code></td>
<td>History-specific permissions where <code>var</code> refers to a
variable in the history and <code>p</code> is the amount of permissions
(a value between 0 and 1)</td>
</tr>
<tr class="odd">
<td><code>APerm(var, p)</code></td>
<td>History-specific permissions within <code>action</code> blocks where
<code>var</code> refers to a variable in the history and <code>p</code>
is the amount of permissions (a value between 0 and 1)</td>
</tr>
<tr class="even">
<td><code>Hist(var, p, val)</code></td>
<td>Similar to <code>PointsTo</code>, it denotes permissions
<code>p</code> for variable <code>var</code> (which is in a history).
Moreover, variable <code>var</code> points to the value
<code>val</code>.</td>
</tr>
<tr class="odd">
<td><code>AbstractState(h, boolExpr)</code></td>
<td>This can be used to check that the given boolean expression holds in
the history (or future) <code>h</code></td>
</tr>
<tr class="even">
<td><code>action(h, perm, preState, postState) { ... }</code></td>
<td>The action describes how the state of the history (or future) is
changed by the code within <code>{ ... }</code>. The pre- and post-state
describe the state of the history (or future) in terms of processes.
<code>perm</code> describes the permissions we have on the history (or
future) and <code>h</code> is the name of the history (or future)</td>
</tr>
<tr class="odd">
<td><code>create h</code></td>
<td>Create a history. Note that the History class should be instantiated
beforehand.</td>
</tr>
<tr class="even">
<td><code>destroy h, val</code></td>
<td>Destroy a history <code>h</code> which has the value
<code>val</code></td>
</tr>
<tr class="odd">
<td><code>split h, p1, val1, p2, val2</code></td>
<td>Split a history (or future) into two such that the first part has
permissions <code>p1</code> and value <code>val1</code> and the second
part has permissions <code>p2</code> and value <code>val2</code></td>
</tr>
<tr class="even">
<td><code>merge h, p1, val1, p2, val2</code></td>
<td>Merge two histories (or futures) such that resulting history
<code>h</code> has permissions <code>p1+p2</code> and consists of
combination of the actions described in <code>val1</code> and
<code>val2</code></td>
</tr>
<tr class="odd">
<td><code>modifies vars</code></td>
<td>List of locations that might be modified</td>
</tr>
<tr class="even">
<td><code>accessible vars</code></td>
<td>List of locations that might be accessed</td>
</tr>
</tbody>
</table>
<h4 id="future-related-constructs">Future-related constructs</h4>
<table>
<thead>
<tr class="header">
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>Future f</code></td>
<td>Declare a Future object called <code>f</code></td>
</tr>
<tr class="even">
<td><code>Future(f, p, val)</code></td>
<td>It denotes that we have permissions <code>p</code> on future
<code>f</code> of which the state is <code>val</code></td>
</tr>
<tr class="odd">
<td><code>choose f, p1, pre, post</code></td>
<td>//TODO check this support and definition</td>
</tr>
<tr class="even">
<td><code>create f, val</code></td>
<td>Create a future <code>f</code> with the initial state
<code>val</code></td>
</tr>
<tr class="odd">
<td><code>destroy f</code></td>
<td>Destroy the future <code>f</code></td>
</tr>
</tbody>
</table>
<h1 id="vercors-usage--debugging-cheat-sheet">VerCors usage &amp;
debugging cheat sheet</h1>
<h2 id="information--questions">Information &amp; questions</h2>
<p><a
href="https://github.com/utwente-fmt/vercors/wiki">https://github.com/utwente-fmt/vercors/wiki</a></p>
<p>If you're doing a project with VerCors, ask us about the VerCors
community chat.</p>
<h2 id="getting-vercors-up-and-running">Getting VerCors up and
running</h2>
<p>Required: at least java 11</p>
<h3 id="pre-build">Pre-build</h3>
<ul>
<li>Download latest release (1.3.0 at the time of writing, doesn't work
on windows)</li>
<li>Download the build from the dev branch. Download the .tgz file, it
contains a bat script for windows as well. Very likely works, but no
guarantee</li>
</ul>
<p>Should be just unzip and go.</p>
<h3 id="compile-from-source">Compile from source</h3>
<p>Requires java 11 &amp; sbt. Benefits: allows setting breakpoints in
intellij. See VerCors README/Wiki for details.</p>
<h2 id="general-usage">General usage</h2>
<p><code>vercors inputFile.java --backend</code></p>
<p>Where <code>backend</code> can be either <code>silicon</code> or
<code>carbon</code>.</p>
<h2 id="general-flags">General flags</h2>
<p>Of course, <code>--help</code></p>
<p>Backends: <code>--carbon</code> (slower, but based on boogie, so
sometimes more powerful), <code>--silicon</code> (faster, built by ETH
Zurich, sometimes not as smart as Carbon)</p>
<p>Progress printing of individual passes: <code>--progress</code></p>
<p>Slows down execution but prints more debug info upon crashes:
<code>--debug vct.main.Main</code></p>
<p>Triggers a system notification upon completion:
<code>--notify</code></p>
<h2 id="advanced-verification-flags">Advanced verification flags</h2>
<h3 id="detection-of-unsound-preconditions">Detection of unsound
preconditions</h3>
<p>Flag: <code>--disable-sat</code></p>
<p>Turns off detection of unsound preconditions. Not needed in general
use of VerCors. Might be necessary if you have a lot of foralls in
preconditions, and verification is slow.</p>
<p>Java example:</p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> C <span class="op">{</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//@ requires 1 == 2; // &lt;-- Normally this causes an error, --disable-sat turns this off    </span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">m</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="debugging-flags">Debugging flags</h2>
<p>Flags: <code>--show-before passName</code>,
<code>--show-after passName</code></p>
<p>Show textual representation of internal AST before and after a pass.
Pass names can be seen by running VerCors with
<code>--progress</code>.</p>
<h3 id="vscode-plugin--flags-needed">VSCode plugin + flags needed</h3>
<p>Dump AST given to silicon/carbon into a text file:
<code>--encoded temp.sil</code></p>
<p>This can be opened in VScode with the ETH Zurich Viper
plugin/extension installed (see the vscode store for this).</p>
<p>Note:</p>
<ul>
<li>The viper version between VerCors and vscode might be out of
sync</li>
<li>The vscode plugin has a 100 second timeout (though it can be turned
off)</li>
<li>The vscode plugin caches results in a wrong way sometimes (this can
also be turned off)</li>
</ul>
<h2 id="some-starter-example-files">Some starter example files</h2>
<ul>
<li>In the <code>example</code> folder in the repository:
<ul>
<li><code>basic/BasicAssert-e1.java</code></li>
<li><code>parallel/block-par.pvl</code></li>
<li><code>demo/demo1.pvl</code>, <code>demo/demo2.pvl</code></li>
</ul></li>
<li>All examples in the wiki/tutorial</li>
</ul>
<h1 id="case-studies">Case Studies</h1>
<p>This page lists all the case studies that have been done with
VerCors.</p>
<h2 id="published-case-studies">Published case studies</h2>
<ul>
<li><strong>Automated Verification of the Parallel Bellman-Ford
Algorithm</strong>. M. Safari, W. Oortwijn and M. Huisman (SAS 2021).
<ul>
<li>Paper: <a
href="https://doi.org/10.1007/978-3-030-88806-0_17">https://doi.org/10.1007/978-3-030-88806-0_17</a></li>
<li>Code: <a
href="https://github.com/Safari1991/SSSP-Verification">https://github.com/Safari1991/SSSP-Verification</a></li>
<li>Builds on the student project by J. Smits</li>
</ul></li>
<li><strong>Permission-Based Verification of Red-Black Trees and Their
Merging</strong>. L. Armborst and M. Huisman (FormaliSE 2021).
<ul>
<li>Paper: <a
href="https://research.utwente.nl/en/publications/permission-based-verification-of-red-black-trees-and-their-mergin">https://research.utwente.nl/en/publications/permission-based-verification-of-red-black-trees-and-their-mergin</a></li>
<li>Code: <a
href="https://data.4tu.nl/articles/software/_/13611578">https://data.4tu.nl/articles/software/_/13611578</a></li>
<li><em>This is a continuation of the master project by H.M.
Nguyen</em></li>
</ul></li>
<li><strong>Formal Verification of Parallel Stream Compaction and
Summed-Area Table Algorithms</strong>. M. Safari and M. Huisman (ICTAC
2020).
<ul>
<li>Paper: <a
href="https://doi.org/10.1007/978-3-030-64276-1_10">https://doi.org/10.1007/978-3-030-64276-1_10</a></li>
<li>Code: <a
href="https://github.com/Safari1991/Prefixsum-Applications">https://github.com/Safari1991/Prefixsum-Applications</a></li>
</ul></li>
<li><strong>A Generic Approach to the Verification of the Permutation
Property of Sequential and Parallel Swap-Based Sorting
Algorithms</strong>. M. Safari and M. Huisman (IFM 2020).
<ul>
<li>Paper: <a
href="https://doi.org/10.1007/978-3-030-63461-2_14">https://doi.org/10.1007/978-3-030-63461-2_14</a></li>
<li>Code: <a
href="https://github.com/Safari1991/Permutation">https://github.com/Safari1991/Permutation</a></li>
</ul></li>
<li><strong>On the Industrial Application of Critical Software
Verification with VerCors</strong>. M. Huisman and R.E. Monti (ISoLA
2020).
<ul>
<li>Paper: <a
href="https://doi.org/10.1007/978-3-030-61467-6_18">https://doi.org/10.1007/978-3-030-61467-6_18</a></li>
<li>Code: <em>Not publicly available</em></li>
<li>This was in collaboration with the companies <em>Technolution</em>
and <em>Thales</em>.</li>
<li>This case study uses a combination of mCRL2 (model checker) and
VerCors to prove correctness of the software.</li>
</ul></li>
<li><strong>Formal Verification of Parallel Prefix Sum</strong>. M
Safari, W. Oortwijn, S. Joosten and M. Huisman (NFM 2020).
<ul>
<li>Paper: <a
href="https://doi.org/10.1007/978-3-030-55754-6_10">https://doi.org/10.1007/978-3-030-55754-6_10</a></li>
<li>Code: <a
href="https://github.com/Safari1991/Prefixsum">https://github.com/Safari1991/Prefixsum</a></li>
<li>Builds on the student project by T. Wiefferink</li>
</ul></li>
<li><strong>Automated Verification of Parallel Nested DFS</strong>. W.
Oortwijn, M. Huisman, S.J.C. Joosten and J. van de Pol (TACAS 2020).
<ul>
<li>Paper: <a
href="https://doi.org/10.1007/978-3-030-45190-5_14">https://doi.org/10.1007/978-3-030-45190-5_14</a></li>
<li>Code: <a
href="https://doi.org/10.4121/uuid:36c00955-5574-44d9-9b26-340f7a1ea03b">https://doi.org/10.4121/uuid:36c00955-5574-44d9-9b26-340f7a1ea03b</a></li>
</ul></li>
<li><strong>Formal Verification of an Industrial Safety-Critical Traffic
Tunnel Control System</strong>. W. Oortwijn and M. Huisman (IFM 2019).
<ul>
<li>Paper: <a
href="https://doi.org/10.1007/978-3-030-34968-4_23">https://doi.org/10.1007/978-3-030-34968-4_23</a></li>
<li>Code: <em>Not publicly available</em></li>
<li>This was in collaboration with the company
<em>Technolution</em>.</li>
<li>This case study uses a combination of mCRL2 (model checker) and
VerCors to prove correctness of the software.</li>
</ul></li>
</ul>
<h2 id="student-projects">Student projects</h2>
<p>Be aware that not all student projects verify complete functional
correctness!</p>
<h3 id="master-projects">Master projects</h3>
<ul>
<li><strong>Verification of a model checking algorithm in
VerCors</strong>. H. Hollander (2021).
<ul>
<li>Master thesis: <a
href="http://purl.utwente.nl/essays/88268">http://purl.utwente.nl/essays/88268</a></li>
<li>Code: <a
href="https://github.com/HanHollander/SetBasedSCC">https://github.com/HanHollander/SetBasedSCC</a></li>
</ul></li>
<li><strong>Formal verification of a red-black tree data
structure</strong>. H.M. Nguyen (2019).
<ul>
<li>Master thesis: <a
href="http://purl.utwente.nl/essays/77569">http://purl.utwente.nl/essays/77569</a></li>
<li>Code: <a
href="https://fmt.ewi.utwente.nl/media/rbt.zip">https://fmt.ewi.utwente.nl/media/rbt.zip</a></li>
<li>This has been continued in <a
href="https://research.utwente.nl/en/publications/permission-based-verification-of-red-black-trees-and-their-mergin"><strong>Permission-Based
Verification of Red-Black Trees and Their Merging</strong></a> (more
info in the published case studies list above)</li>
</ul></li>
</ul>
<h3 id="bachelor-projects">Bachelor projects</h3>
<ul>
<li><strong>Let's sort this out: GPGPU Verification of Radix
Sort</strong>. D.H.M.A. van Oorschot (2020).
<ul>
<li>Bachelor thesis: <a
href="http://purl.utwente.nl/essays/80589">http://purl.utwente.nl/essays/80589</a></li>
<li>Code: <a
href="https://gist.github.com/Drevanoorschot/4ffaef5cbc430e41a29a30a86dc1de64">Parallel
count algorithm</a>, <a
href="https://gist.github.com/Drevanoorschot/f527b0ac54212117ce75b66d5799ee63">Parallel
reorder algorithm</a>, and <a
href="https://gist.github.com/Drevanoorschot/9d0efb3dd78fa147c720b62ce0d491d7">Parallel
radix sort algorithm</a>.</li>
</ul></li>
<li><strong>GPGPU Verification: Correctness of Odd-Even Transposition
Sort Algorithm</strong>. Y. Kumashev (2020).
<ul>
<li>Bachelor thesis: <a
href="http://purl.utwente.nl/essays/80585">http://purl.utwente.nl/essays/80585</a></li>
<li>Code: <a
href="https://doi.org/10.6084/m9.figshare.11725848.v1">https://doi.org/10.6084/m9.figshare.11725848.v1</a></li>
</ul></li>
<li><strong>Formal Automated Verification of a Work-Stealing
Deque</strong>. C.M. van Kampen (2020).
<ul>
<li>Bachelor thesis: <a
href="http://purl.utwente.nl/essays/80687">http://purl.utwente.nl/essays/80687</a></li>
<li>Code: <a
href="https://github.com/coenvk/lace-vercors">https://github.com/coenvk/lace-vercors</a></li>
</ul></li>
<li><strong>Verifying GPGPU Implementation of Breadth-First Search
Algorithm</strong>. J. Smits (2019).
<ul>
<li>Bachelor thesis: <a
href="https://fmt.ewi.utwente.nl/media/Bachelor_Thesis_Jan_Smits_BFS_Verification_1.2.pdf">https://fmt.ewi.utwente.nl/media/Bachelor_Thesis_Jan_Smits_BFS_Verification_1.2.pdf</a></li>
<li>Code: <em>In bachelor thesis</em></li>
</ul></li>
<li><strong>Optimization, Specification and Verification of the Prefix
Sum Program in an OpenCL Environment</strong>. T. Wiefferink (2015).
<ul>
<li>Bachelor thesis: <a
href="https://fmt.ewi.utwente.nl/media/147.pdf">https://fmt.ewi.utwente.nl/media/147.pdf</a></li>
<li>Code: <a
href="https://fmt.ewi.utwente.nl/media/147_attachment_1.zip">https://fmt.ewi.utwente.nl/media/147_attachment_1.zip</a>,
also available at: <a
href="https://github.com/NLthijs48/PrefixSumVerification">https://github.com/NLthijs48/PrefixSumVerification</a></li>
</ul></li>
</ul>
<h1 id="developing-for-vercors">Developing for VerCors</h1>
<p>In Summer 2024, Pieter wrote this developer's guide on the internals
of VerCors: <a
href="https://pieter-bos.github.io/vercors-doc/">https://pieter-bos.github.io/vercors-doc/</a>.
It provides some useful background on the setup of the project, and how
to do certain tasks.</p>
<h2 id="prbranch-management">PR/Branch management</h2>
<p>Some general guidelines/notes to take into account when developing
for VerCors:</p>
<ul>
<li><strong>Draft PRs:</strong> while a PR is unfinished, mark it as
"draft". Once it is ready for merging, unmark it as draft. Please do
this even for short-lived PRs, so there is a definitive signal that work
on a PR has finished.</li>
<li><strong>Branches &amp; PRs:</strong> if you do work on a branch, it
<strong>must</strong> have a PR. This way we keep track of what everyone
is working on.</li>
<li><strong>PR size:</strong> try to keep your PRs small. If it has been
open for longer than a month, consider bringing the PR in a state where
it can be merged, even though your work might not be finished yet. This
ensures we can still try to do bigger refactorings, while keeping churn
in long-standing branches minimal.</li>
<li><strong>Branch naming:</strong> we don't really have a guideline for
this, proposals welcome. For now: if it's for a specific subsystem
(VeyMont, VeSUV, Pallas), include that. If relevant, feel free to
include the issue number.</li>
<li><strong>VerCors repo or fork:</strong> obviously, you may open PRs
that propose to merge a branch from a VerCors fork. We try to support
this workflow in our CI, as long as it doesn't take too much effort. If
you're a UT student, FMT employee, or research collaborator, get in
touch with us so you can do your development directly in the VerCors
repo, if you prefer.</li>
<li><strong>Branch cleanup:</strong> delete your branch after its PR has
been merged, unless you plan on continuing development on it. Don't
leave it lying around unused.</li>
<li><strong>Quality control:</strong> on the dev &amp; master branch,
all tests (except flaky ones) should pass, and all files should be
formatted using the auto formatter. On your own branch you can pretty
much do whatever you want.</li>
</ul>
<h2 id="example-workflow">Example workflow</h2>
<p><em>Below you can find a description of what a typical workflow looks
like.</em></p>
<ol type="1">
<li>Determine what you want to fix.</li>
<li>If there is an issue for what you want to fix, assign yourself to
the issue. This can be done by navigating to the specific page of the
issue. Then on the right-hand side there is an "Assignees" header.
Beneath this header click on "assign yourself".</li>
<li>Ask for permissions to push to the main VerCors repository. We
prefer to keep an eye on evolving development by asking contributors to
work in branches of the main repository. Alternatively, you can work in
your own fork (but e.g. continuous integration will not work).</li>
<li>Navigate to the VerCors project on your computer in your
terminal.</li>
<li>When you're inside the <code>vercors</code> directory, create a new
branch by executing the following command:
<code>git branch branch_name</code>. Replace <code>branch_name</code> by
the name for your branch. This name can reflect what you will fix. For
example if you are going to fix issue 1, then you can name the branch
"issue1". Or if you add support for automatic generation of invariants,
then you can name the branch "automaticInvariants".</li>
<li>Then switch to the new branch using the command
<code>git checkout branch_name</code>.</li>
<li>You can now start working on your problem!</li>
<li>When you are done with your fix, <strong>commit and push</strong>
your changed files to the branch. To push to your new branch you can use
the following command:<code>git push origin branch_name</code>.</li>
<li>Navigate to the main GitHub page of VerCors (<a
href="https://github.com/utwente-fmt/vercors/">https://github.com/utwente-fmt/vercors/</a>).</li>
<li>Create a new pull request (see also: <a
href="https://help.github.com/articles/creating-a-pull-request-from-a-fork/">https://help.github.com/articles/creating-a-pull-request-from-a-fork/</a>).</li>
<li>GitHub will run the tests, check that there are no unresolved
comments on the pull request, and verify the tests have run with the
most recent upstream changes.</li>
<li>As soon as this pull request has been reviewed by at least one
person, and is accepted, then your fix can be merged into the master
branch. <em>Congratulations you're done with this PR (Pull
Request)!</em></li>
</ol>
<h1 id="project-structure">Project Structure</h1>
<h2 id="functional-overview">Functional Overview</h2>
<p>VerCors verifies programs by going through four stages:</p>
<ul>
<li><strong>The frontend, or parsing</strong>: in this step a collection
of files is read and parsed into COL, the common object language. This
is the internal intermediate representation of programs in VerCors.</li>
<li><strong>Resolution</strong>: here we figure out what names in the
AST mean. Every name must point to (part of) a declaration. Afterwards,
we forget about the name and only remember a pointer to the relevant
declaration.</li>
<li><strong>The rewrite stage</strong>: The COL AST (usually referred to
as just the AST) is transformed into a different AST, or it is checked
for some property, together called a "pass". Depending on user-supplied
options many passes are applied to the AST. They can be divided in
several categories:
<ul>
<li><em>Reducing a feature</em>: The subset of COL used is reduced, by
encoding the proof obligations of a language construct in some other
way. An example is that we reduce <code>for</code> loops to
<code>while</code> loops, by placing the initialization before a new
while loop, retaining the condition, and appending the update to the end
of the loop body.</li>
<li><em>Checking for consistency</em>: in some places it is useful that
the type structure of the AST is not as strict as the set of ASTs we
want to allow. Almost all checks are done in the type check, a single
pass executed many times.</li>
<li><em>Standardization</em>: many passes expect certain properties to
be true about the AST (e.g. "expresions have no side effects"), but on
the other hand it is useful not to constrain passes too much in what
they can generate. Therefor we standardize the AST between passes, to
reduce simple language features.</li>
<li><em>Importing builtins</em>: some features are supported by
importing a header of sorts into the AST.</li>
<li><em>Optimization</em>: optimizing passes transform the AST (in
particular expressions) such that they are faster to prove, or rely less
on heuristics of the backend.</li>
</ul></li>
<li><strong>The backend, or verification</strong>: the very much reduced
AST is transformed once more, into the language of the selected backend.
The backend makes a judgement on the program. This judgement is
translated back into useful information about the program.</li>
</ul>
<p>There are also a few cross-cutting concerns:</p>
<ul>
<li><strong>The origin system</strong> tracks how the frontend parse
tree is transformed via COL into a backend language. This means that if
a message from the backend mentions a part of the AST in the backend
language, it can be translated all the way back to its origin in the
frontend input.</li>
</ul>
<h2 id="technical-setup">Technical Setup</h2>
<p>The VerCors project sources are managed on GitHub, at <a
href="https://github.com/utwente-fmt/vercors">https://github.com/utwente-fmt/vercors</a>.
The unstable development branch is <code>dev</code>, from where we
branch to develop new features and bugfixes. Those with access may push
feature branches to the main repository, or create a fork if they
prefer. A pull request is then made and reviewed by someone
appropriate.</p>
<p>Pushed commits as well as pull requests are checked via continuous
integration, currently Github Actions. Github builds Vercors and runs
the test suite. Once the checks pas and a code review is completed, the
PR is merged in dev. In dev is also where we hope to notice bad
interactions between new features.</p>
<p>We aim to make a new VerCors release once per month, which is done
via a tagged merge commit to the <code>master</code> branch, followed by
a GitHub release.</p>
<p>VerCors is written in java and scala. Code is accepted in either
language, but we encourage you to take the time to learn some Scala - it
is much better suited to manipulating ASTs. The build structure is
defined in the mill build tool.</p>
<h2 id="project-structure-1">Project Structure</h2>
<p><em>NB: this information quickly becomes out of date as vercors is
refactored.</em></p>
<h3><code>/</code></h3>
<ul>
<li><code>build.sc</code> is the root build definition. It configures
global plugin options, wires sub-project dependencies, configures
run-time build information, denotes external dependencies, configures
metadata about the project and configures compiler options.</li>
<li><code>mill</code>/<code>mill.bat</code> bootstrap and run the build
tool Mill.</li>
<li></li>
</ul>
<h3 id="githubworkflows"><code>/.github/workflows</code></h3>
<ul>
<li><code>scalatest.yml</code> configures Github Actions to run the test
suite</li>
<li><code>build-wiki-pdf.yml</code> assembles the Github wiki into a
latex-flavoured pdf</li>
</ul>
<h3 id="bin"><code>/bin</code></h3>
<p>Convenience run scripts that compile and then run VerCors. They are
helpful because they start up slightly quicker than e.g.
<code>./mill vercors.run</code>, and VerCors starts in the foreground so
pretty-printing is supported.</p>
<ul>
<li><code>bashComplete</code> generates a bash command completion
script</li>
</ul>
<h3 id="examples-5"><code>/examples</code></h3>
<p>This directory serves the dual purpose of being an archive of past
case studies and competition results, as well as the test suite of
VerCors. Files in this directory have a header denoting how they are
used in the test suite. Names denoted by "case" or "cases" are
collected, where overlapping names are joined together as one test case.
Files may occur in more than one "case." "tools" denotes the backend
used (silicon by default), "verdict" the expected final result (Pass by
default).</p>
<ul>
<li><code>private</code>: this can be created as a subdirectory and is
ignored by git. Contributing examples (however small) that reproduce
issues are however appreciated.</li>
<li><code>archive</code> contains examples that are broken or
irrelevant: generally a lower priority.</li>
<li><code>concepts</code> contain examples sorted by topic</li>
<li><code>demo</code> is a standard set of demo files, suitable of e.g.
a ~1 hour presentation.</li>
<li><code>publications</code> contains examples that are mentioned or
reproduced in publications by us.</li>
<li><code>technical</code> has no good reason to exist: they should most
likely be inline test fixtures.</li>
<li><code>verifythis</code> is a <a
href="https://www.pm.inf.ethz.ch/research/verifythis.html">verification
competition</a> that takes place every year, this is the archive of our
results there.</li>
</ul>
<h3 id="lib"><code>/lib</code></h3>
<p><code>.jar</code> files that VerCors depends on, that cannot be
specified as e.g. a maven dependency.</p>
<h3 id="out"><code>/out</code></h3>
<p>Output of the mill build tool.</p>
<h3 id="resproject"><code>/res/&lt;project&gt;</code></h3>
<p>Contains the resources root that is related to
<code>&lt;project&gt;</code></p>
<h3 id="resuniversal"><code>/res/universal</code></h3>
<p>Named universal historically after the <a
href="https://www.scala-sbt.org/sbt-native-packager/formats/universal.html">universal
plugin</a>, this directory contains files that must be available on the
classpath, but must not be packed into a jar (e.g. executables)</p>
<h3
id="resuniversaldepsplatform"><code>/res/universal/deps/&lt;platform&gt;</code></h3>
<p>Files that are specific to <code>&lt;platform&gt;</code>, not
included on build for other platforms.</p>
<ul>
<li><code>boogie</code>: The <a
href="https://github.com/boogie-org/boogie">boogie program
verifier</a></li>
<li><code>z3</code>: The <a href="https://github.com/z3prover/z3">Z3
theorem prover</a></li>
</ul>
<h3 id="resuniversalres"><code>/res/universal/res</code></h3>
<p>Files that are included on all platforms</p>
<ul>
<li><code>adt</code>: definitions for VerCors' datatypes</li>
<li><code>c</code>: header files that specify C functions</li>
<li><code>include</code>: miscellaneous library files that are loaded
into vercors</li>
<li><code>jdk</code>: Java files that specify Java methods and
classes</li>
<li><code>simplify</code>: Term rewriting rules for simplifying
expressions</li>
<li><code>systemc/config</code>: Configuration files for the SystemC
component</li>
</ul>
<h3 id="srcproject"><code>/src/&lt;project&gt;</code></h3>
<p>Source files for the <code>&lt;project&gt;</code> project. These may
be in any language, such as scala, Java, antlr g4, etc. See also
<strong><a href="#project-structure-by-package">âProject Structure by
Package</a></strong></p>
<h3 id="testproject"><code>/test/&lt;project&gt;</code></h3>
<p>Source files for testing the <code>&lt;project&gt;</code>
project.</p>
<h3 id="tmp"><code>/tmp</code></h3>
<p>Contains debug output from VerCors, Viper, Boogie, and Z3 when
configured to output it.</p>
<h3 id="util"><code>/util</code></h3>
<ul>
<li><code>editors</code>: various grammar definitions for text editors
(i.e. text highlighting), in various states of disrepair (but still
useful)</li>
<li><code>inheritance</code>: A plan to implement better inheritance
support</li>
<li><code>oldRewriteRules</code>: The old definitions in the term
rewriter, to be scoured for good definitions</li>
<li><code>processalgebra</code>: A plan to implement process algebra
support again</li>
<li><code>release</code>: Utility script to draft a VerCors release</li>
<li><code>SplitVerify</code>: Tool that can focus on a single method in
a verification input, for more rapid prototyping of specifications.</li>
<li><code>stubimpl</code>: Helper script to generate
<code>NodeImpl</code> traits, useful when adding lots of Nodes.</li>
<li><code>stupidUnsatCore</code>: Removes line from an <code>smt2</code>
script until the result is no longer <code>unsat</code>.</li>
<li><code>wiki</code>: Utility script that parses the wiki into
<code>pdf</code>, <code>html</code>, the website navigation menu for
<code>html</code>, a test suite of the examples.</li>
</ul>
<h2 id="project-structure-by-package">Project Structure by Package</h2>
<ul>
<li><code>.</code>: in <code>colhelper</code>: Utilities to generate
helper classes for the Node definitions, such as rewriters, comparators,
subnode recursors, etc.</li>
<li><code>antlr4</code>: Grammar definitions.</li>
<li><code>hre</code>: General utilities not necessarily specific to
VerCors</li>
<li><code>hre/cache</code>: Generates a cache directory in an
appropriate place keyed on customizable values (such as application
version)</li>
<li><code>vct/cache</code>: Uses the cache directory to store
verification results, keyed on the vercors and viper versions.</li>
<li><code>hre/debug</code>: Debugging utilities,</li>
<li><code>hre/io</code>: I/O utilities. <code>Readable</code> and
<code>Writeable</code> are the canonical way to describe a resource that
can be opened for reading/writing in VerCors, with the default
implementation for files <code>RWFile</code></li>
<li><code>hre/perf</code>: Platform-independent profiling utilities,
measuring time usages and resource usage</li>
<li><code>hre/platform</code>: Detects the current platform
(Windows/Unix/Mac), mostly used to determine executable format
(PE/ELF/Mach-O)</li>
<li><code>hre/progress</code>: Utilities to maintain a tree of tasks
currently executing across threads, for accounting profiling information
and display.</li>
<li><code>hre/resource</code>: Utility to locate platform-approriate
resources.</li>
<li><code>hre/stages</code>: Named functions, with an input and output
type that can be chained, and catch <code>VerificationError</code>s by
default.</li>
<li><code>hre/unix</code>: Unix-specific utilities, currently only
<code>getrusage</code> (where MacOS here <em>does</em> count as
unix)</li>
<li><code>hre/util</code>: misc</li>
<li><code>viper</code>: The Viper backend</li>
<li><code>viper.api</code>: Utilities to interface between VerCors and
the Viper backend</li>
<li><code>viper.api.transform</code>: Translate between the Viper
language (historically referred to as "Silver") and the VerCors
intermediate language "COL"</li>
<li><code>viper.api.backend</code>: Implements the interface for Carbon
and Silicon, the two Viper implementations.</li>
<li><code>vct/result</code>: <code>VerificationError</code> may be
thrown, which is either a <code>SystemError</code> (always a bug, need
not be informational) or a <code>UserError</code> (sometimes a bug, but
must describe the situation well)</li>
<li><code>vct/importer</code>: Load library files from resources and
other paths.</li>
<li><code>vct/main</code>: Wires up command line options into executable
vercors runs, assembled of <code>Stage</code>s.</li>
<li><code>vct/modes</code>: A VerCors run is determined by exactly one
mode, the default being verification.</li>
<li><code>vct/stages</code>: The pieces of VerCors that can be chained
together. Might as well be plain functions, the primary difference being
these use the progress framework.</li>
<li><code>vct/stages/Stages.scala::ofOptions</code>: the meat and
potatoes: defines the actual components of VerCors from the command line
options. Each stage is <code>_.run(_)</code> in turn.</li>
<li><code>vct/main/Main.scala</code>: defines
<code>public static void main(String[] args)</code> - the actual entry
point.</li>
<li><code>vct/options</code>: The command line options.</li>
<li><code>vct/resources</code>: Defines the default location for various
resources.</li>
<li><code>vct/parsers</code>: Uses ANTLR to transform various input
sources to a COL tree.</li>
<li><code>vct/parsers/transform</code>: Defines how to transform an
ANTLR tree to a COL tree.</li>
<li><code>vct/rewrite</code>: Transformations on COL ASTs - the most
important part of VerCors.</li>
<li><code>vct/col</code>: All things related to the internal COL
language</li>
<li><code>vct/col/ast</code>: Definitions of all nodes in COL. All
definitions live in <code>Node.scala</code>, but all implementations are
moved into separate subpackages and files.</li>
<li><code>vct/col/check</code>: Check errors and utilities to check
them, for any kind of error that is not a type error.</li>
<li><code>vct/col/debug</code>: Debug utility for checking the lifecycle
of declarations.</li>
<li><code>vct/col/err</code>: Verification errors related to col</li>
<li><code>vct/col/feature</code>: Segments nodes into features, where
there is approximately one rewriter per feature. Currently not used for
anything useful. (PB: I would prefer to move this out of the
<code>col</code> module)</li>
<li><code>vct/col/origin</code>: Contains <code>Origin</code>, which
explains how a node came to be (e.g. from the user input), and
<code>Blame</code>, which explains how to translate errors from the
backend to more pointed errors on the input.</li>
<li><code>vct/col/print</code>: An implementation of <a
href="https://homepages.inf.ed.ac.uk/wadler/papers/prettier/prettier.pdf">"A
prettier printer"</a> that works well with COL. (PB: I would prefer to
move this out of the <code>col</code> module)</li>
<li><code>vct/col/ref</code>: Implements cross-references in the AST.
Rewriters by default make <code>LazyRef</code> such that declarations
can be made later than that they are referenced.</li>
<li><code>vct/col/resolve</code>: Resolves names and types in the AST
according to the semantics of Java, C, PVL and the specification
language. (PB: I would prefer to move this out of the <code>col</code>
module)</li>
<li><code>vct/col/rewrite</code>: Utilities that build on the generated
<code>AbstractRewriter</code>.</li>
<li><code>vct/col/typerules</code>: Defines the typing rules for the COL
language. Transformations can be applied along applications of type
rules using <code>CoercingRewriter</code>.</li>
<li><code>vct/col/util</code>: General AST utilities, such as a
comparator, factory helpers, a subtitutor for expressions and types, and
more.</li>
</ul>
<h1 id="ide-import">IDE Import</h1>
<p>This document gives instructions on how to configure a development
environment for VerCors, using either <strong><a
href="#intellij-idea">âIntellij IDEA</a></strong> or <strong><a
href="#vscode">âVisual Studio Code</a></strong>. Most VerCors developers
use Intellij IDEA. Although VerCors supports Windows, MacOs and other
unixen, most developers use a Linux distribution, so the development
experience is tested more thoroughly on Linux.</p>
<h2 id="basic-setup">Basic setup</h2>
<p>This section describes how to install the prerequisites in more
detail and how to build and run VerCors from a terminal. The
instructions after the basic setup were however tested only under these
conditions:</p>
<ul>
<li>A fresh installation of Ubuntu 22.04</li>
<li>IntelliJ IDEA Community Edition 2023.1.1</li>
</ul>
<h3 id="ubuntu">Ubuntu</h3>
<p>Install required dependencies:</p>
<div class="sourceCode" id="cb59"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install curl git openjdk-17-jdk-headless</span></code></pre></div>
<blockquote>
<p>Note that VerCors will also work with later jdks â it is not
necessary to install an older one. <code>openjdk-17-jdk</code> includes
<code>openjdk-17-jdk-headless</code>.</p>
</blockquote>
<p>Clone the VerCors repository (~500MB):</p>
<pre><code>git clone ssh://git@github.com/utwente-fmt/vercors.git</code></pre>
<blockquote>
<p>If you get an error about access rights, please ensure:</p>
<ul>
<li><code>~/.ssh/id_rsa.pub</code> or another public key exists. If not,
run <code>ssh-keygen</code>;</li>
<li>The key in <code>~/.ssh/id_rsa.pub</code> is associated to your
github account. If not, visit <a
href="https://github.com/settings/keys">https://github.com/settings/keys</a>;</li>
<li>You have push access to the VerCors repository. If not, contact a
member of the team.</li>
</ul>
<p>You can also simply clone VerCors as read-only:</p>
<pre><code>git clone https://github.com/utwente-fmt/vercors.git</code></pre>
</blockquote>
<p>Move into the repository:</p>
<div class="sourceCode" id="cb62"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> vercors</span></code></pre></div>
<p>Compile VerCors:</p>
<div class="sourceCode" id="cb63"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./mill</span> <span class="at">-j</span> 0 vercors.main.compile</span></code></pre></div>
<p>Run an example to verify your setup works:</p>
<div class="sourceCode" id="cb64"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./bin/vct</span> examples/concepts/arrays/array.pvl</span></code></pre></div>
<p>That's it! ð¥³</p>
<h3 id="macos">MacOs</h3>
<p>Yet to be written...</p>
<h3 id="windows">Windows</h3>
<p>Install required dependencies(Git and OpenJDK17)</p>
<blockquote>
<p>Skip this step if you already have them installed:</p>
</blockquote>
<p>Run a command prompt with administrator privileges:</p>
<div class="sourceCode" id="cb65"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="ex">winget</span> install Git.git</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="ex">winget</span> install ms-openjdk-17</span></code></pre></div>
<blockquote>
<p>Note that VerCors will also work with later jdks â it is not
necessary to install an older one.</p>
</blockquote>
<p>Restart the command prompt, navigate to the directory where you want
to install VerCors and clone the VerCors repository (~500MB):</p>
<pre><code>git clone ssh://git@github.com/utwente-fmt/vercors.git</code></pre>
<blockquote>
<p>If you get an error about access rights, please ensure:</p>
<ul>
<li><code>~/.ssh/id_rsa.pub</code> or another public key exists. If not,
run <code>ssh-keygen</code>;</li>
<li>The key in <code>~/.ssh/id_rsa.pub</code> is associated to your
github account. If not, visit <a
href="https://github.com/settings/keys">https://github.com/settings/keys</a>;</li>
<li>You have push access to the VerCors repository. If not, contact a
member of the team.</li>
</ul>
<p>You can also simply clone VerCors as read-only:</p>
<pre><code>git clone https://github.com/utwente-fmt/vercors.git</code></pre>
</blockquote>
<p>Move into the repository:</p>
<div class="sourceCode" id="cb68"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> vercors</span></code></pre></div>
<blockquote>
<p>To be able to properly view the compilation messages hereafter, it is
useful to enable colors for the terminal. To do this, first type
"regedit" in the windows search bar and open the application. Then
navigate to Computer\HKEY_CURRENT_USER\Console. Right-click the folder
"Console" and click on <code>New &gt; Create DWORD (32-bit) Value</code>
and name it <code>VirtualTerminalLevel</code>. Click on the new DWORD
value and set its value to <code>1</code>.</p>
</blockquote>
<p>Compile VerCors:</p>
<div class="sourceCode" id="cb69"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mill.bat</span> <span class="at">-j</span> 0 vercors.main.compile</span></code></pre></div>
<p>Run an example to verify your setup works:</p>
<div class="sourceCode" id="cb70"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span><span class="dt">\b</span>in<span class="dt">\v</span>ct examples<span class="dt">\c</span>oncepts<span class="dt">\a</span>rrays<span class="dt">\a</span>rray.pvl</span></code></pre></div>
<p>That's it! ð¥³</p>
<h2 id="intellij-idea">IntelliJ IDEA</h2>
<blockquote>
<p>Requires <strong><a href="#basic-setup">âBasic Setup</a></strong></p>
</blockquote>
<p>Install IntelliJ IDEA if you do not have it yet:</p>
<div class="sourceCode" id="cb71"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snap</span> install <span class="at">--classic</span> intellij-idea-community</span></code></pre></div>
<blockquote>
<p>Note: intellij-idea-ultimate is free for educational use. See e.g. <a
href="https://education.github.com/pack">here</a>. It includes features
that are useful to us, such as a profiler.</p>
</blockquote>
<p>Install the Scala plugin, e.g. from the splash screen:</p>
<p><img
src="https://user-images.githubusercontent.com/901022/235698934-8ca0d01a-17dd-44f6-83ab-cfe32d7784cf.png"
alt="image" /></p>
<p>Open or import the VerCors project from the root of the repository
(i.e. the <code>vercors</code> directory).</p>
<blockquote>
<p>If you have not yet compiled VerCors at this point, importing may
take approximately 5 minutes. It is also possible that importing fails
with an error. In that case, let the synchronization finish fully, then
go to <code>Build &gt; Reload BSP project</code> (the â² symbol).</p>
</blockquote>
<p><strong>Important</strong>: VerCors requires more stack memory than
normal applications. It is recommended to increase it before adding any
configurations</p>
<ul>
<li>Go to
<code>Run &gt; Edit Configurations &gt; Edit Configuration Templates</code></li>
<li>Edit the <code>Application</code> template</li>
<li>Go to <code>Modidify options &gt; Add VM options</code></li>
<li>Enter <code>-Xss20m</code> in the <code>VM options</code> field</li>
<li>Edit the <code>ScalaTest</code> template</li>
<li>Enter <code>-Xss20m</code> in the <code>VM options</code> field</li>
</ul>
<p>Set the JDK to version 17 or later in
<code>File &gt; Project Structure &gt; Project Settings &gt; Project &gt; SDK</code>.</p>
<h3 id="running-and-debugging-vercors">Running and Debugging
VerCors</h3>
<ul>
<li>Go to <code>Run &gt; Edit Configurations</code> and add an
<code>Application</code> configuration</li>
<li>Set the classpath <code>-cp</code> to <code>vercors</code></li>
<li>Set the <code>Main class</code> to <code>vct.main.Main</code> (and
not <code>vct.main.Main$</code>)</li>
<li>If IntelliJ complains that it cannot find
<code>BuildInfo.buildinfo.properties</code>, you may have to go to
<code>Modify Options &gt; Add before launch task</code> and activate
<code>Use BSP Environment</code>. In the pop-up, you can just click
<code>ok</code> (the target can be blank or filled, doesn't
matter).</li>
<li>Specifically for the IntelliJ Console you need to force enable
progress messages with the program argument <code>-p</code></li>
<li>You can be asked to specify a file every time by adding
<code>$Prompt$</code> to the program arguments, or just append a file
path relative to the <code>vercors</code> root directory.</li>
</ul>
<p>In the end your configuration should look something like this:</p>
<p><img
src="https://user-images.githubusercontent.com/901022/235703710-f63b6d1c-4d82-4db2-bb05-42019a13aac4.png"
alt="image" /></p>
<h3 id="running-the-test-suite">Running the test suite</h3>
<p>The test suite takes approximately 45 minutes to run on a modern
machine. You may wish to push your changes to your branch at the main
repository instead, so that the CI can run chunks of the test suite in
parallel. This currently takes approximately 15 minutes instead.</p>
<p>You can create a <code>ScalaTest</code> run configuration
automatically by right-clicking a directory or file containing tests,
and then clicking
<code>Run 'ScalaTests in &lt;directory or file&gt;'</code>. We currently
do not have a way of running a single test in a file that contains
multiple tests from within IntelliJ IDEA.</p>
<h3 id="unclear-build-errors">Unclear build errors</h3>
<p>If the build error is not clear, it may be helpful to run mill
directly from a terminal, e.g.:</p>
<div class="sourceCode" id="cb72"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./mill</span> <span class="at">-j</span> 0 vercors.compile</span></code></pre></div>
<h3 id="running-the-intellij-build-from-a-terminal">Running the IntelliJ
build from a terminal</h3>
<p>IntelliJ communicates with the mill build system to build VerCors.
The scripts at <code>./bin/vct</code> and <code>bin\vct.cmd</code> will
ask mill how to run VerCors. Consequently, you can always run the most
recent VerCors build from a terminal with this script.</p>
<h2 id="vscode">VSCode</h2>
<blockquote>
<p>The author does not use VSCode, so apologies for any awkward
instructions. Corrections are appreciated.</p>
</blockquote>
<blockquote>
<p>Requires <strong><a href="#basic-setup">âBasic Setup</a></strong></p>
</blockquote>
<p>Install VSCode if you do not have it yet:</p>
<div class="sourceCode" id="cb73"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snap</span> install <span class="at">--classic</span> code</span></code></pre></div>
<p>Install the Metals plugin by going to
<code>Ctrl+Shift+X &gt; Scala (Metals) &gt; Install</code></p>
<p><img
src="https://user-images.githubusercontent.com/901022/235708408-50f14cb9-c376-4334-b1be-2160238ec63f.png"
alt="image" /></p>
<p>This will add a Metals symbol in the left tray.</p>
<p>Open the VerCors project from the root of the repository (i.e. the
<code>vercors</code> directory) at <code>File &gt; Open Folder</code>.
When prompted by the Metals extension, click
<code>Import build</code>.</p>
<blockquote>
<p>If you hid the notification, it may be in your notifications on the
bottom right. Alternatively you can click <code>Import build</code> from
the Metals pane on the left.</p>
</blockquote>
<p>To build VerCors, click <code>Metals &gt; Cascade compile</code>.</p>
<h3 id="running-and-debugging-vercors-1">Running and Debugging
VerCors</h3>
<p>Go to <code>Run and Debug &gt; Create a launch.json file</code>.
Then:</p>
<ul>
<li>Type "Scala" in the configurations array, and select
<code>Scala: run main class</code> from the suggestions;</li>
<li>Set <code>mainClass</code> to <code>vct.main.Main</code>;</li>
<li>Specifically for the Debug Console you need to force enable progress
messages with the program argument <code>-p</code>;</li>
<li>Set the arguments, for example
<code>["-p", "examples/concepts/arrays/array.pvl"]</code>;</li>
<li>Set the JVM options to <code>["-Xss20m"]</code>.</li>
</ul>
<p>Your launch configuration should look something like this:</p>
<div class="sourceCode" id="cb74"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;0.2.0&quot;</span><span class="fu">,</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;configurations&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="fu">{</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;scala&quot;</span><span class="fu">,</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;request&quot;</span><span class="fu">:</span> <span class="st">&quot;launch&quot;</span><span class="fu">,</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;VerCors&quot;</span><span class="fu">,</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;mainClass&quot;</span><span class="fu">:</span> <span class="st">&quot;vct.main.Main&quot;</span><span class="fu">,</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;args&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;-p&quot;</span><span class="ot">,</span> <span class="st">&quot;examples/concepts/arrays/array.pvl&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;jvmOptions&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;-Xss20m&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;env&quot;</span><span class="fu">:</span> <span class="fu">{}</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">]</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 id="running-the-test-suite-1">Running the test suite</h3>
<p>The test suite takes approximately 45 minutes to run on a modern
machine. You may wish to push your changes to your branch at the main
repository instead, so that the CI can run chunks of the test suite in
parallel. This currently takes approximately 15 minutes instead.</p>
<p>You can simply run tests yourself from the Test pane on the left (the
â symbol).</p>
<h3 id="running-the-metals-build-from-a-terminal">Running the Metals
build from a terminal</h3>
<p>VSCode communicates with the mill build system to build VerCors. The
scripts at <code>./bin/vct</code> and <code>bin\vct.cmd</code> will ask
mill how to run VerCors. Consequently, you can always run the most
recent VerCors build from a terminal with this script.</p>
<h1 id="scalatest">ScalaTest</h1>
<h2 id="running-scalatest">Running ScalaTest</h2>
<p>ScalaTest can be run by the commandline or via the Intellij. For
running with Intellij you need the Scala plugin of JetBrains. VerCors
uses a lot of memory that is why you have to add an VM option to the
ScalaTest template. Go to Run/Debug Configuration. Click on the blue
text "Edit configuration templates..." in the left corner. Select
ScalaTest. Select Configuration. Set VM options to "-Xss128M". You can
run the test by right clicking a test file and selecting the option "Run
'{filename}'". To run a single test you can open the file and clicking
on the run arrow between the line number and the text of the file. The
test files are in "src/test/scala/". Intellij also supports running the
test in debug mode by selecting debug mode. Running from the commandline
can be done using sbt. The following command runs all the tests.
<code>sbt test</code> The following command runs all the test in the
file integration.Generated1Tests.
<code>sbt "testOnly integration.Generated1Tests"</code></p>
<p>More settings can be found in <a
href="https://www.scalatest.org/user_guide/using_scalatest_with_sbt">https://www.scalatest.org/user_guide/using_scalatest_with_sbt</a>
Note that the run settings like classpath and available memory can be
different from Intellij and sbt.</p>
<h1 id="profiling">Profiling</h1>
<p>VerCors can generate a profile in the <a
href="https://github.com/google/pprof">pprof</a> format. This only works
on unix-like systems, and works best on linux. The file
<code>profile.pprof.gz</code> is generated in the current directory when
passing the flag <code>--profile</code>:</p>
<div class="sourceCode" id="cb75"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> vercors <span class="at">--profile</span> some/example.java</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">...</span><span class="kw">)</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls profile.pprof.gz</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="ex">profile.pprof.gz</span></span></code></pre></div>
<p>It's safe to stop vercors with control-C (<code>SIGINT</code>), and
the profile will contain all samples up to that point, with the
exception of <code>childSys</code> and <code>childUser</code> (explained
below).</p>
<p>It can be viewed with e.g. the <a
href="https://github.com/google/pprof">pprof tool</a>, e.g.:</p>
<pre><code>$ pprof -http=:1234 profile.pprof.gz</code></pre>
<p><img
src="https://user-images.githubusercontent.com/901022/226386798-464ff7f7-5948-4c3e-b53a-6c395551acec.png"
alt="image" /></p>
<h3 id="samples">Samples</h3>
<p>The profile contains several different samples, listed under
"Sample":</p>
<ul>
<li><strong>wall</strong>: The amount of real time a task took (as
though you looked at a clock on the wall). Under parallelism this
measurement does not aggregate nicely</li>
<li><strong>(...)User</strong>: The amount of time spent on the CPU.
Under parallelism the time is summed up, i.e. it can go considerably
faster that wall time.</li>
<li><strong>(...)Sys</strong>: The amount of time spent in the kernel,
as requested by the process. Indicative of file i/o etc.</li>
<li><strong>child(...)</strong>: Measures the time spent in child
processes. For VerCors this is strictly the SMT backend, usually z3. It
is only populated once an entire child process has completed, hence in
practice the entire z3 time is accounted under "Verification" without
further specifying.</li>
<li><strong>self(...)</strong>: Measures the time spent in our own
process, excluding any child processes</li>
<li><strong>agg(...)</strong>: aggregate of child and self usage.</li>
<li><strong>agg</strong>: all child and self usage, both system time and
user time, all summed.</li>
</ul>
<h3 id="measuring-for-publication">Measuring for publication</h3>
<p>Use <code>aggUser</code> as a stable measurement for the amount of
computation VerCors has done: it represents the total amount of
computation time VerCors has used.</p>
<h3 id="diagnosing-slow-proof-goals">Diagnosing slow proof goals</h3>
<p><code>View &gt; Flame Graph</code> is most useful for this. You can
use <code>selfUser</code> to diagnose cases where silicon itself
(without z3) is slow. <code>wall</code> is most useful when including
<code>z3</code>, since unfortunately <code>childUser</code> cannot track
the individual usage by verifier or goal.</p>
<p>The width of bars in the flame graph represent the amount of time
spent on them. Click on a bar to zoom into it horizontally, click on
bars above the focused bar to zoom out again.</p>
<p>In silicon we try to compute a hierarchy, trying to obtain in
order:</p>
<ul>
<li>The entity being verified (method, function, predicate)</li>
<li>Then the statement being executed</li>
<li>Then the assertion being in- or exhaled</li>
<li>Then the branch conditions under which we are dealing with the
assertion</li>
</ul>
<p>We also include some "comment" records, indicated with
<code>/*</code> and <code>*/</code>.</p>
<h1 id="wiki-code-snippet-testing-harness">Wiki Code Snippet Testing
Harness</h1>
<p>VerCors supports extracting tests from the tutorial and automatically
running the extracted tests. The following syntax is recognized in the
tutorial. For example usages of this syntax, see the raw version of the
chapter of <a
href="https://raw.githubusercontent.com/wiki/utwente-fmt/vercors/Axiomatic-Data-Types.md">Axiomatic
Data Types</a>. As the annotations will be hidden when viewing the
rendered markdown, click on "edit page"</p>
<h2 id="self-contained-code-blocks">Self-contained code blocks</h2>
<p>Testcases defined by template, e.g.:</p>
<div class="sourceCode" id="cb77"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- testBlock Fail --&gt;</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="in">```java</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div>
<p>There are three possible code block annotations:</p>
<ul>
<li><code>testBlock</code> wraps the code in a method and class</li>
<li><code>testMethod</code> wraps the code in a class</li>
<li><code>test</code> returns the code as is</li>
</ul>
<p><code>testBlock</code> and <code>testMethod</code> are compatible
with Java and PVL.</p>
<p>The case name of the generated test is derived from the heading
structure.</p>
<h2 id="snippets">Snippets</h2>
<p>To combine multiple code blocks into one test case (potentially with
hidden glue code), you can use Snippets. The markdown for that might
look like this:</p>
<div class="sourceCode" id="cb78"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- standaloneSnip smallCase</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="co">//:: cases smallCase</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="co">//:: verdict Fail</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="co">class Test {</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- codeSnip smallCase --&gt;</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="in">```java</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a><span class="dt">boolean</span> <span class="fu">never</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>*Here could be some more explanation about &quot;never&quot;.*</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- standaloneSnip smallCase</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a><span class="co">void test() {</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>Then the following example will **fail**:</span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- codeSnip smallCase --&gt;</span></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a><span class="in">```java</span></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="fu">never</span><span class="op">();</span></span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- standaloneSnip smallCase</span></span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a><span class="co">}</span></span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a><span class="co">}</span></span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span></code></pre></div>
<p>Note that the hidden glue code uses <code>standaloneSnip</code>, and
includes the code inside the HTML comment tags <code>&lt;!--</code> and
<code>--&gt;</code>. The visible code snippets use
<code>codeSnip</code>, and the code is outside the comment tags,
enclosed in triple back-ticks like any displayed code block.</p>
<h1 id="parser-analysis">Parser Analysis</h1>
<p>Over time it's been noticed that there are two large issues with the
parsing stage across multiple input languages:</p>
<ul>
<li>Parsing is slow for certain languages</li>
<li>Memory usage can be extreme due to <code>_sharedContextCache</code>
being a shared static field in each parser</li>
</ul>
<p>We've long suspected that both could be fixed by making the grammar
more straightforward to parse, but so far we haven't conclusively found
what we should change. There are now a couple flags that analyze what is
happening during parsing to help with that. I've tried to add (in an
overly confident tone) what ANTLR is now reporting to us. I'm pretty
sure there are holes in my understanding of ANTLR still, so apologies in
advance.</p>
<h3 id="flags-to-analyse-antlr">Flags to analyse ANTLR</h3>
<p>You can pass <code>--dev-parsing-ambiguities</code> and
<code>--dev-parsing-sensitivities</code>. ANTLR only cares about
ambiguities in the sense that it has to tell you for each rule which
alternative it chose. A decision is considered context-sensitive when we
cannot decide with one token of lookahead what alternative to choose.
While matching a production like
<code>(expr expr)* expr expr expr</code> we do need more lookahead than
one, because it is not clear while reading expressions whether to
continue in the <code>*</code> or read the last three expressions.
Nevertheless this is not context-sensitive, because ANTLR dumps all
terminals/non-terminals flatly into the context that represents the
current production, so even in the face of a context-sensitive decision
like this, the resulting data structure is the same anyway.</p>
<h3 id="format-of-the-output">Format of the output</h3>
<p>When enabling either flag you will receive outputs like this:</p>
<pre><code>======================================
At /tmp/vercors-interpreted-13716491317094529415.ipp
--------------------------------------
   20    void parallel_for(sycl::range&lt;1&gt; numWorkItems, VERCORS::LAMBDA lambda_method);
   21    void parallel_for(sycl::range&lt;2&gt; numWorkItems, VERCORS::LAMBDA lambda_method);
                                                       [---------
   22    void parallel_for(sycl::range&lt;3&gt; numWorkItems, VERCORS::LAMBDA lambda_method);
                                                        ---------]
   23  
   24    void parallel_for(sycl::nd_range&lt;1&gt; numWorkItems, VERCORS::LAMBDA lambda_method);
--------------------------------------
Prediction of rule theTypeName required full context and took 0.00s:
[x] simpleTemplateId
 &gt;  className
 &gt;  enumName
 &gt;  typedefName
======================================</code></pre>
<ul>
<li>The start of the indicated region is the position at which a
context-sensitivity was detected</li>
<li>The end of the region indicates when we have returned to normalcy,
and we know which alternative to choose</li>
<li>The message indicates the name of the rule where an ambiguity
occurred, and how much time it took to run the analysis (this does not
seem to be indicative of anything yet)</li>
<li>The bottom lists the productions for the given rule, potentially
prefixed by an indicator</li>
<li>An indicator of <code>&gt;</code> indicates a definitively viable
alternative</li>
<li>An indicator of <code>[x]</code> indicates an alternative that was
discarded only <em>after</em> running a full-context analysis</li>
<li>No indicator means it was not considered a viable alternative, even
before considering context. (There are no lines without an indicator in
this example)</li>
</ul>
<p><strong>Note 1</strong>: if there are multiple <code>&gt;</code>
lines, this means that there is an <strong>ambiguity</strong> in the
parser: both are valid. If there is only one <code>&gt;</code>, there
must be a <code>[x]</code>: it means the grammar is <strong>sensitive to
context</strong>. I think that context-sensitivities can be normal/fine
if the indicated region is quite small.</p>
<p><strong>Note 2</strong>: The name of the rule refers to the rule in
the input grammar. In the case of left-recursive grammars (e.g. most of
our expressions), the grammar is instead rewritten, so you may see
alternatives that do not make much sense, like this:</p>
<pre><code>======================================
At /home/pieter/vercors/res/universal/res/jdk/java/lang/String.java
--------------------------------------
   61      ensures \result.data() == other.data() + data();
   62      String right+(String other) {
                                             [-
   63          return new String(other.data() + data());
                                              -]
   64      }
   65      @*/
--------------------------------------
Prediction of rule expr required full context and took 0.00s:
 &gt;  ({9 &gt;= _p}? (&#39;==&#39;|&#39;!=&#39;) expr | {28 &gt;= _p}? &#39;.&#39; &#39;new&#39; nonWildcardTypeArguments? innerCreator | {3 &gt;= _p}? impOp expr | {27 &gt;= _p}? &#39;.&#39; &#39;super&#39; superSuffix | {19 &gt;= _p}? (&#39;++&#39;|&#39;--&#39;) | {29 &gt;= _p}? &#39;.&#39; &#39;this&#39; | {24 &gt;= _p}? &#39;-&gt;&#39; javaIdentifier arguments | {11 &gt;= _p}? relOp expr | {7 &gt;= _p}? &#39;^&#39; expr | {15 &gt;= _p}? prependOp expr | {6 &gt;= _p}? &#39;|&#39; expr | {4 &gt;= _p}? &#39;||&#39; expr | {22 &gt;= _p}? postfixOp | {5 &gt;= _p}? andOp expr | {13 &gt;= _p}? (&#39;+&#39;|&#39;-&#39;) expr | {1 &gt;= _p}? assignOp expr | {26 &gt;= _p}? &#39;.&#39; explicitGenericInvocation | {12 &gt;= _p}? shiftOp expr | {2 &gt;= _p}? &#39;?&#39; expr &#39;:&#39; expr | {8 &gt;= _p}? &#39;&amp;&#39; expr | {23 &gt;= _p}? &#39;.&#39; javaIdentifier predicateEntryType? arguments valEmbedGiven? valEmbedYields? | {25 &gt;= _p}? &#39;[&#39; expr &#39;]&#39; | {10 &gt;= _p}? &#39;instanceof&#39; type | {14 &gt;= _p}? mulOp expr | {30 &gt;= _p}? &#39;.&#39; javaIdentifier)+
[x] ()
======================================</code></pre>
<p>Note that the first alternative ends in <code>+</code>. This language
represents the tail part of the left-recursive alternatives of
<code>expr</code>. The operator precedence is here already encoded by
antlr automatically through semantic predicates
<code>{_ &gt;= _p}?</code>, I don't know the exact mechanics.</p>
<p><strong>Note 3</strong>: Note that the alternatives are recovered
from the augmented transition network in the parser, and then
pretty-printed as a production rule. This means that they may not
exactly correspond to the input, even when not left-recursive.
Especially note that a rule such as <code>(a | b?)</code> is
pretty-printed as <code>(a | b)?</code>, which is equivalent (!)</p>
<h3 id="now-what">Now what</h3>
<p>I'm not certain what you should actually change when something is
reported. Nevertheless I offer some thoughts:</p>
<ul>
<li>I think ambiguities are universally bad: an input should really have
at most one derivation. It can be indicative of duplicate rules.</li>
<li>Maybe we should try doing stuff like
<code>exp2: exp1 (('*'|'/') exp1)*</code> instead of
<code>exp2: exp1 | exp2 '*' exp1 | exp2 '/' exp1</code></li>
</ul>
<h1 id="git-hooks">Git Hooks</h1>
<p>For a general explanation on git hooks see <a
href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">here</a>.</p>
<p>We use git hooks for the following purposes:</p>
<ul>
<li>To self-install any updates to the git hooks</li>
<li>To format files that are changed in a commit along the scalafmt
rules.</li>
</ul>
<h2 id="updating-or-installing-git-hooks">Updating or installing git
hooks</h2>
<p>You can install the git hooks for this repository with
<code>./util/gitconfig.sh</code> in a terminal or Git Bash. This causes
the scripts in <code>util/githooks</code> to be run at the listed event.
Currenty only <code>pre-commit</code> does anything interesting.</p>
<h2 id="formatting-files">Formatting files</h2>
<p>It's polite not to introduce formatting changes in commits - this
keeps diffs nice to read. For that reason we run formatting
automatically on the list of files that is changed in a commit just
before actually doing the commit. Please do not manually run formatting
on files that are not touched by your commit.</p>
<p>If something goes wrong: we do not assign much priority to the
formatting being correct, so when in doubt we do not mind commits with
<code>--no-verify</code>.</p>
<h1 id="meta">Meta</h1>
<p>This page lists the software, deployments, credentials and
documentation in the orbit of the VerCors project.</p>
<p>Primary projects:</p>
<ul>
<li><a href="#vercors-the-tool">VerCors, the tool</a></li>
<li><a href="#vercors-website">VerCors Website</a></li>
<li><a href="#vercors-server-online-tool-runner">VerCors Server</a></li>
<li><a href="#the-wiki">The Wiki</a></li>
<li><a href="#gitlab-mirror">GitLab Mirror</a></li>
</ul>
<p>Secondary maintained tooling:</p>
<ul>
<li><a href="#tool-server">tool-server</a></li>
<li><a href="#antlr4-fork">ANTLR4 fork</a></li>
<li><a href="#docker-hub">Docker Hub</a></li>
</ul>
<h2 id="vercors-the-tool">VerCors (the tool)</h2>
<ul>
<li>Code at <a
href="https://github.com/utwente-fmt/vercors">https://github.com/utwente-fmt/vercors</a></li>
</ul>
<h2 id="vercors-website">VerCors Website</h2>
<ul>
<li>Code at <a
href="https://github.com/utwente-fmt/vercors-web">https://github.com/utwente-fmt/vercors-web</a></li>
<li>Auto-rendered via Github Actions to <a
href="https://github.com/utwente-fmt/vercors-web-build">https://github.com/utwente-fmt/vercors-web-build</a></li>
<li>Viewable at <a
href="https://vercors.ewi.utwente.nl/">https://vercors.ewi.utwente.nl/</a></li>
<li>Redirect at <a
href="https://utwente.nl/vercors">https://utwente.nl/vercors</a>
(Maintained by M&amp;C UTwente)</li>
<li>Deployed at <a
href="https://webservice.utwente.nl:8443">https://webservice.utwente.nl:8443</a>
(Ask Pieter Bos for credentials)
<ul>
<li>Auto-pulled from <a
href="https://github.com/utwente-fmt/vercors-web-build">https://github.com/utwente-fmt/vercors-web-build</a></li>
<li>Webhook setup at <a
href="https://github.com/utwente-fmt/vercors-web-build/settings/hooks">https://github.com/utwente-fmt/vercors-web-build/settings/hooks</a></li>
<li>Separate credentials for FTPS access (Ask Pieter Bos)</li>
</ul></li>
</ul>
<h2 id="vercors-server-online-tool-runner">VerCors Server (online tool
runner)</h2>
<p>This simply makes the tool available to run on the internet.</p>
<ul>
<li>Code at <a
href="https://github.com/utwente-fmt/vercors-server">https://github.com/utwente-fmt/vercors-server</a></li>
<li>WebSocket access at <a
href="wss://vercors-server.apps.utwente.nl/">wss://vercors-server.apps.utwente.nl/</a></li>
<li>Deployed at <a
href="https://rancher.utsp.utwente.nl/">https://rancher.utsp.utwente.nl/</a>
(Ask Tom van Dijk)</li>
</ul>
<h2 id="gitlab-mirror">GitLab Mirror</h2>
<ul>
<li>Data at <a
href="https://gitlab.utwente.nl/fmt/vercors/vercors-back-up">https://gitlab.utwente.nl/fmt/vercors/vercors-back-up</a></li>
<li>Note the page will return a 404 without correct permissions</li>
<li>Contact Ãmer Èakar for credentials</li>
</ul>
<h2 id="tool-server">tool-server</h2>
<p>Minimal piece of software that makes a command line tool available to
stream over a websocket. Not meant to be deployed directly.</p>
<ul>
<li>Code at <a
href="https://github.com/utwente-fmt/tool-server">https://github.com/utwente-fmt/tool-server</a></li>
<li>In use by <a
href="https://github.com/utwente-fmt/vercors-server">https://github.com/utwente-fmt/vercors-server</a></li>
</ul>
<h2 id="antlr4-fork">ANTLR4 Fork</h2>
<ul>
<li>Code at <a
href="https://github.com/niomaster/antlr4/">https://github.com/niomaster/antlr4/</a></li>
</ul>
<h2 id="the-wiki">The Wiki</h2>
<ul>
<li>Viewable and code at <a
href="https://github.com/utwente-fmt/vercors/wiki">https://github.com/utwente-fmt/vercors/wiki</a></li>
<li>Mirrored to <a
href="https://vercors.ewi.utwente.nl/wiki">https://vercors.ewi.utwente.nl/wiki</a></li>
</ul>
<h2 id="docker-hub">Docker Hub</h2>
<ul>
<li>Viewable at <a
href="https://hub.docker.com/u/utwentefmt">https://hub.docker.com/u/utwentefmt</a></li>
<li>Contact Tom van Dijk for credentials</li>
</ul>
<h1 id="making-a-new-vercors-release">Making a new VerCors release</h1>
<p>Follow these steps:</p>
<ol type="1">
<li><p><strong>Add an auto-generated release to the github
repo</strong></p>
<p>This is managed by the <a
href="https://github.com/utwente-fmt/vercors/blob/dev/.github/workflows/release.yml"><code>release</code></a>
workflow. It is executed for any commit tagged with a version. So pick
the commit you want to make a release for, tag it, and let the workflow
run.</p></li>
<li><p><strong>Add a changelog to the release</strong></p>
<p>Open the release, click the "edit" button of the release, and click
the "Generate release notes" button at the top. Take case that the
proper "Previous tag" is set, to make sure only commits are included in
the release notes that are actually in the release. Do a brief
readthrough and expand or delete text where necessary.</p></li>
<li><p><strong>Upload a docker image</strong></p>
<p>Build a docker image locally of the commit that you just tagged with
the new version. This is done using the <code>docker</code> target the
build system. Push that to one of the following docker registries. Also
update the <code>latest</code> tag in the respective registry.</p>
<ol type="1">
<li>The container registry in a VerCors repo located on the University
of Twente gitlab. (At the time of writing, this repo does not yet exist.
E.g. <a
href="https://gitlab.utwente.nl/fmt/vercors/vercors-back-up/container_registry">https://gitlab.utwente.nl/fmt/vercors/vercors-back-up/container_registry</a>)</li>
<li><a
href="https://hub.docker.com/r/utwentefmt/vercors/tags">https://hub.docker.com/r/utwentefmt/vercors/tags</a></li>
</ol>
<p>We don't have a policy for which registry to use. Historically
speaking, we've been using dockerhub because it's standard and there's a
utwente-fmt organization. Probably in the long term we should move to
the UT gitlab.</p>
<p>We should also consider using the UT harbor (<a
href="http://harbor.utsp.utwente.nl">http://harbor.utsp.utwente.nl</a>)
for compliance/vulnerability checking.</p></li>
<li><p><strong>Add an announcement</strong></p>
<p>If it is a major version release or a big point release you can
consider adding an announcement on the VerCors website or FMT
website.</p></li>
</ol>
<p>Done!</p>
    </span>
    <span class="wiki-side-menu">
        <ul>
<li>
<a href="#introduction">Introduction</a>
<ul>
<li><a href="#vercors">VerCors</a></li>
</ul>
</li>
<li>
<a href="#background">Background</a>
<ul>
<li><a href="#software-verification">Software Verification</a></li>
<li><a href="#separation-logic">Separation Logic</a></li>
</ul>
</li>
<li>
<a href="#installing-and-running-vercors">Installing and Running VerCors</a>
<ul>
<li><a href="#syntax-highlighting">Syntax highlighting</a></li>
</ul>
</li>
<li>
<a href="#prototypal-verification-language">Prototypal Verification Language</a>
</li>
<li>
<a href="#specification-syntax">Specification Syntax</a>
<ul>
<li><a href="#method-contracts">Method Contracts</a></li>
<li><a href="#auxiliary-annotations">Auxiliary Annotations</a></li>
</ul>
</li>
<li>
<a href="#permissions">Permissions</a>
<ul>
<li><a href="#self-framing">Self-framing</a></li>
<li><a href="#permission-leaks">Permission leaks</a></li>
<li><a href="#some-extra-notation">Some extra notation</a></li>
</ul>
</li>
<li>
<a href="#gpgpu-verification">GPGPU Verification</a>
</li>
<li>
<a href="#axiomatic-data-types">Axiomatic Data Types</a>
<ul>
<li><a href="#sequence">Sequence</a></li>
<li><a href="#set">Set</a></li>
<li><a href="#bag">Bag</a></li>
<li><a href="#map">Map</a></li>
<li><a href="#tuple">Tuple</a></li>
<li><a href="#option">Option</a></li>
<li><a href="#adt-reference">ADT Reference</a></li>
<li><a href="#custom-adts">Custom ADTs</a></li>
</ul>
</li>
<li>
<a href="#arrays-and-pointers">Arrays and Pointers</a>
<ul>
<li><a href="#array-permissions">Array permissions</a></li>
<li><a href="#syntactic-sugar">Syntactic sugar</a></li>
<li><a href="#pointers">Pointers</a></li>
<li><a href="#injectivity-object-arrays-and-efficient-verification">Injectivity, object arrays and efficient verification</a></li>
</ul>
</li>
<li>
<a href="#parallel-blocks">Parallel Blocks</a>
</li>
<li>
<a href="#atomics-and-locks">Atomics and Locks</a>
<ul>
<li><a href="#pvl-built-in-locks">PVL: Built-in locks</a></li>
<li><a href="#pvl-atomics">PVL: Atomics</a></li>
<li><a href="#java-synchronized">Java: synchronized</a></li>
</ul>
</li>
<li>
<a href="#process-algebra-models">Process Algebra Models</a>
</li>
<li>
<a href="#predicates">Predicates</a>
<ul>
<li><a href="#why-predicates">Why predicates?</a></li>
<li><a href="#predicate-syntax-and-usage">Predicate syntax and usage</a></li>
<li><a href="#the-counter-example-now-with-predicates">The <code>Counter</code> example, now with predicates</a></li>
<li><a href="#reservedinternal-predicates">Reserved/internal predicates</a></li>
<li><a href="#advanced-usage-of-predicates">Advanced usage of predicates</a></li>
<li><a href="#known-problems">Known problems</a></li>
</ul>
</li>
<li>
<a href="#inheritance-1">Inheritance</a>
</li>
<li>
<a href="#exceptions--goto">Exceptions & Goto</a>
<ul>
<li><a href="#exceptions">Exceptions</a></li>
<li><a href="#goto-and-labels">Goto and labels</a></li>
</ul>
</li>
<li>
<a href="#vercors-by-error">VerCors by Error</a>
</li>
<li>
<a href="#veymont">VeyMont</a>
<ul>
<li><a href="#choreography-syntax">Choreography syntax</a></li>
<li><a href="#using-veymont-choreographic-verification--permission-generation">Using VeyMont: choreographic verification & permission generation</a></li>
<li><a href="#choreographic-contracts">Choreographic contracts</a></li>
<li><a href="#channel-invariants--functional-correctness">Channel invariants & functional correctness</a></li>
<li><a href="#what-next">What next?</a></li>
<li><a href="#publications">Publications</a></li>
<li><a href="#veymont-syntax-overview">VeyMont syntax overview</a></li>
</ul>
</li>
<li>
<a href="#term-rewriting-rules">Term Rewriting Rules</a>
</li>
<li>
<a href="#magic-wands">Magic Wands</a>
<ul>
<li><a href="#what-are-magic-wands">What are Magic Wands?</a></li>
<li><a href="#syntax-in-vercors">Syntax in VerCors</a></li>
</ul>
</li>
<li>
<a href="#inhale-and-exhale">Inhale and exhale</a>
</li>
<li>
<a href="#what-does-this-vercors-error-message-mean">What does this VerCors error message mean?</a>
</li>
<li>
<a href="#pvl-syntax-reference">PVL Syntax Reference</a>
<ul>
<li><a href="#general">General</a></li>
<li><a href="#types-and-data-structures">Types and Data Structures</a></li>
<li><a href="#expressions-1">Expressions</a></li>
<li><a href="#control-flow-constructs-pvl">Control flow constructs (PVL)</a></li>
<li><a href="#verification-flow-constructs">Verification flow constructs</a></li>
</ul>
</li>
<li>
<a href="#vercors-usage--debugging-cheat-sheet">VerCors usage & debugging cheat sheet</a>
<ul>
<li><a href="#information--questions">Information & questions</a></li>
<li><a href="#getting-vercors-up-and-running">Getting VerCors up and running</a></li>
<li><a href="#general-usage">General usage</a></li>
<li><a href="#general-flags">General flags</a></li>
<li><a href="#advanced-verification-flags">Advanced verification flags</a></li>
<li><a href="#debugging-flags">Debugging flags</a></li>
<li><a href="#some-starter-example-files">Some starter example files</a></li>
</ul>
</li>
<li>
<a href="#case-studies">Case Studies</a>
<ul>
<li><a href="#published-case-studies">Published case studies</a></li>
<li><a href="#student-projects">Student projects</a></li>
</ul>
</li>
<li>
<a href="#developing-for-vercors">Developing for VerCors</a>
<ul>
<li><a href="#prbranch-management">PR/Branch management</a></li>
<li><a href="#example-workflow">Example workflow</a></li>
</ul>
</li>
<li>
<a href="#project-structure">Project Structure</a>
<ul>
<li><a href="#functional-overview">Functional Overview</a></li>
<li><a href="#technical-setup">Technical Setup</a></li>
<li><a href="#project-structure-1">Project Structure</a></li>
<li><a href="#project-structure-by-package">Project Structure by Package</a></li>
</ul>
</li>
<li>
<a href="#ide-import">IDE Import</a>
<ul>
<li><a href="#basic-setup">Basic setup</a></li>
<li><a href="#intellij-idea">IntelliJ IDEA</a></li>
<li><a href="#vscode">VSCode</a></li>
</ul>
</li>
<li>
<a href="#scalatest">ScalaTest</a>
<ul>
<li><a href="#running-scalatest">Running ScalaTest</a></li>
</ul>
</li>
<li>
<a href="#profiling">Profiling</a>
</li>
<li>
<a href="#wiki-code-snippet-testing-harness">Wiki Code Snippet Testing Harness</a>
<ul>
<li><a href="#self-contained-code-blocks">Self-contained code blocks</a></li>
<li><a href="#snippets">Snippets</a></li>
</ul>
</li>
<li>
<a href="#parser-analysis">Parser Analysis</a>
</li>
<li>
<a href="#git-hooks">Git Hooks</a>
<ul>
<li><a href="#updating-or-installing-git-hooks">Updating or installing git hooks</a></li>
<li><a href="#formatting-files">Formatting files</a></li>
</ul>
</li>
<li>
<a href="#meta">Meta</a>
<ul>
<li><a href="#vercors-the-tool">VerCors (the tool)</a></li>
<li><a href="#vercors-website">VerCors Website</a></li>
<li><a href="#vercors-server-online-tool-runner">VerCors Server (online tool runner)</a></li>
<li><a href="#gitlab-mirror">GitLab Mirror</a></li>
<li><a href="#tool-server">tool-server</a></li>
<li><a href="#antlr4-fork">ANTLR4 Fork</a></li>
<li><a href="#the-wiki">The Wiki</a></li>
<li><a href="#docker-hub">Docker Hub</a></li>
</ul>
</li>
<li>
<a href="#making-a-new-vercors-release">Making a new VerCors release</a>
</li>
</ul>
    </span>
</div>

    </section>
</div>


        <div id="footer" class="dark">
            <footer class="container">
                <a href="//www.utwente.nl/en/eemcs/fmt/" target="_blank"><img src="/images/FMT logo.png" alt="Formal Methods & Tools logo" title="Formal Methods & Tools"></a>
                <hr>
                <div class="copyright">
                    <a href="/about/#credits" target="_blank">Copyright <code>&copy</code> The VerCors Project 2007-2025</a>
                    | <a href="//www.utwente.nl/en/eemcs/fmt/" target="_blank">FMT - University of Twente</a>
                    | <a href="/about/">About Us</a>
                </div>
            </footer>
        </div>
    </body>
</html>