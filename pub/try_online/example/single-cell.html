
<!DOCTYPE HTML>
<!--
VerCors Tool --- Formal Methods and Tools Group (EWI)
University of Twente, Enschede, The Netherlands
-->
<html lang="en">
    <head>
        <title>Single cell Â· VerCors Tool FMT | UTwente </title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <meta name="description" content="">
        <meta name="keywords" content="">

        <link rel="stylesheet" href="/css/codemirror.css">
        <link rel="stylesheet" href="/css/codemirror-monokai.css">
        <link rel="stylesheet" href="/css/highlight/default.css">
        <link rel="stylesheet" href="/css/datatables.min.css">
        <link rel="stylesheet" href="/css/style.css">

        <script src="/js/jquery.min.js"></script>
        <script src="/js/highlight.pack.js"></script>
        <script src="/js/codemirror.js"></script>
        <script src="/js/datatables.min.js"></script>
        <script src="/js/vercorsonline.js"></script>
        <script src="/js/init.js"></script>

        <!--<script type="text/javascript">
            hljs.initHighlightingOnLoad();
        </script>-->
    </head>
    <body class="no-sidebar">
        <div id="header">
            <h1 id="logo" style="position: relative">
                <span id="hamburger" onclick="document.querySelector('#nav').classList.toggle('open')" class="fa fa-bars"></span>
                <a href="/">The VerCors Verifier</a>
            </h1>
            <nav id="nav">
                <ul>
                    <li>
                        <a href="/wiki/#introduction">Getting Started</a>
                        <ul>
                            <li><a href="/wiki/#installing-and-running-vercors">Installation Guide</a></li>
                            <li><a href="/wiki/">Tutorial</a></li>
                            <li>
                                <a href="//github.com/utwente-fmt/vercors/issues" target="_blank">
                                    Issue Tracker
                                    <span class="fa fa-external-link" style="font-size: 10pt"></span>
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li><a href="/try_online/examples/">Showcases</a></li>
                    <li><a href="/news/">News</a></li>
                    <li><a href="/publications/">Publications</a></li>
                    <li>
                        <a href="/about/">About</a>
                        <ul>
                            <li><a href="/about/#Team">VerCors Team</a></li>
                            <li><a href="/about/#Contact">Contact</a></li>
                            <li><a href="/about/#Credits">Credits</a></li>
                            <li><a href="/license/">License</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
            <div class="container">
                <div id="banner">
                    <div class="container">
                        <section>
                            
                            <p>
                                <a href="//github.com/utwente-fmt/vercors" class="button alt" target="_blank">
                                    View on Github
                                </a>
                                <a href="/try_online/" class="button alt">Try VerCors Online</a>
                            </p>
                        </section>
                    </div>
                </div>
            </div>
        </div>

        
<div id="main" class="style1 wrapper">
    <div class="container">
        
    <div class="example-view">
        <h1>Single cell</h1>
        <p>An atomic integer is used to protect a data field of SingleCell. Multiple threads trying to assign or find the value of the field. This verification example is very related to the &#34;simple hash table&#34; example.</p>

        <h3>General Information</h3>
        <ul>
            <li><strong>Backend</strong>: Chalice</li>
            <li><strong>Language</strong>: Java</li>
            <li><strong>Features</strong>: Atomics, Witnesses</li>
            <li><strong>Path to Example File</strong>: atomics/SingleCell.java</li>
            <li><strong>Should Verify</strong>: Yes</li>
            <li><strong>Date</strong>: 2017-06-15</li>
            <li><strong>Lines of Code</strong>: 116 (comments not included)</li>
            <li><strong>Lines of Specification</strong>: 34 (29.3% of total)</li>
            
                <li><strong>Computation Time</strong>: 19.4 seconds</li>
            
        </ul>

        
<div class="verification-container">
    
    <div class="verification-widget verification-non-plain" >
        <div style="position: relative">
            <textarea name="examplecode" rows="20" data-code-mirror="true">// -*- tab-width:2 ; indent-tabs-mode:nil -*-
//:: cases SingleCellWitnesses
//:: tools chalice
//:: options --explicit
/*
 Example: 
	SingleCell
 Description: 
	AtomicInteger is used to protect data field of SingleCell.
	Multiple threads trying to assign or find their value.
 Author:
	Afshin Amighi
 Command:
    vct --chalice --explicit SingleCell.java
 Status:
	Pass.
 
*/


public class SingleCellMod{


	/*@	 
	 
	 public resource inv_value(int x) = (x ==0 ==&gt; true) ** ( x== 1 ==&gt; true ) ** (x == 2 ==&gt; Value(data));
	 public resource inv_resource(int x) = (x == 0 ==&gt; Perm(data,100));
	 */
		
	/*@ resource contains(int d)= Value(data) ** data == d; */
	private int data;
	
	public SingleCellMod(){ this.data = -1; }
	
	/*@
	 requires (set_rr:inv_resource(n)) ** set_rv:inv_value(n);
	 ensures set_ev:inv_value(n); 
	 */
	void set(int n);
	
	/*@
	 requires  true;
	 ensures ((\result ==&gt; eql_evp:inv_value(n) ) ** (!\result ==&gt; true)) ;
	 */
	boolean equal(int n);
	
	/*@
	 requires	(cas_rr:inv_resource(n)) ** cas_rv:inv_value(n);
	 ensures	(\result ==&gt; (cas_erp:inv_resource(o)) ** cas_evp:inv_value(o) ) ** 
				(!\result ==&gt; (cas_ern:inv_resource(n)) ** cas_evn:inv_value(n));
	 */
	boolean cas(int o, int n);	
	


	/*@
	 requires true ;
	 ensures \result == 0 ==&gt; (fop_evp:inv_value(2)) ** fop_ecp: contains(d);
	 ensures \result == 1 ==&gt; (fop_evf:inv_value(2)) ** fop_ecf: contains(d);
	 */

	public int find_or_put(int d){
		boolean b;
		// temporary labels
		 /*@ 
		  witness iv_tmp:inv_value(*);
		  witness ir_tmp:inv_resource(*);
		  witness cas_rc_tmp:inv_resource(*);
		  */
		 
		// build cas preconditions
		 /*@ 
		  fold iv_tmp:inv_value(1);
		  fold ir_tmp:inv_resource(1);
		  */
		
		 b= cas(0,1) /*@ with {cas_rv = iv_tmp; cas_rr = ir_tmp; } then { cas_rc_tmp = cas_erp; } */ ;
		
		if(true &amp;&amp; b){

			// unfold cas postcondition to get the write permission
			/*@ 
			 unfold cas_rc_tmp:inv_resource(0);
			 */

			// write
			data = d;

			// data contains the value, build contains predicate 
			// and provide set postconditions
			
			/*@ 
			 fold fop_ecp:contains(d);
			 witness im_tmp:inv_value(*);
			 witness rc_tmp:inv_resource(*);

			 fold im_tmp:inv_value(2);
			 fold rc_tmp:inv_resource(2);
			 */
			
			set(2) /*@ with { set_rr = rc_tmp; set_rv=im_tmp; } then { fop_evp = set_ev; } */;


			return 0;
	
		}
		if (!b) {
			boolean spin = false;
			/*@ loop_invariant true; */

			while(!spin) {
				spin = equal(1);
			}
			boolean check;
			
			/*@ witness eql_v_tmp:inv_value(*) ; */
			check = ( equal(2) /*@ with {} then{ eql_v_tmp=eql_evp; } */);
			
			if (true &amp;&amp; check ){ 
				
				/*@ unfold eql_v_tmp:inv_value(2); */
				if (true &amp;&amp; data == d) {
					/*@ 
					 fold eql_v_tmp:inv_value(2); 
					 fop_evf = eql_v_tmp;
					 fold fop_ecf:contains(d);
					 */

					return 1;
				}
				/*@ fold eql_v_tmp:inv_value(2); */

				return -2;//collision
			}
		}
		
		return -1;//error
	}
}
</textarea>
            <span class="code-buttons">
                <span class="fa fa-times-circle code-close-button"></span>
                <span class="fa fa-play code-run-button"></span>
            </span>
        </div>

        <div style="background-color: #dddddd; padding: 0.4ex 1ex">
            <label class="control-label" for="example-backendid">Language:</label>
            <select name="lang" id="example-backendid" class="form-control">
                
                    <option value="pvl" selected="">PVL</option>
                
                    <option value="java" >Java</option>
                
                    <option value="cu" >Cuda</option>
                
                    <option value="c" >C / OpenMP / OpenCL</option>
                
                    <option value="sil" >Viper</option>
                
            </select>
        </div>
    </div>
    <div class="verification-progress verification-non-plain" style="display: none; background-color: #dddddd; padding: 0.4ex 1ex" >
        <span class="fa"></span>
        <span class="verification-progress-text"></span>
    </div>
    <pre class="verification-log verification-non-plain" style="display: none"></pre>
</div>

    </div>

    </div>
</div>


        <div id="footer">
            <div class="row">
                <a href="//fmt.ewi.utwente.nl" target="_blank"><img src="/images/FMT logo.png" alt=""></a>
                <div class="copyright">
                    <a href="//fmt.ewi.utwente.nl/research/projects/view/vercors/" target="_blank">Copyright <code>&copy</code> The VerCors Project 2007-2022</a>
                    | <a href="//fmt.ewi.utwente.nl" target="_blank">FMT - University of Twente</a>
                    | <a href="/about/">About Us</a>
                </div>
            </div>
        </div>
    </body>
</html>